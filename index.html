<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üç∑</text></svg>">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cave √† Vin MMM</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  /* ============================================================
     VARIABLES & RESET
     ============================================================ */
  :root {
    --bg:     #0e0a0b;
    --bg2:    #16100f;
    --bg3:    #1e1518;
    --bg4:    #261c1f;
    --wine:   #7b1c2e;
    --wine2:  #9e2a3f;
    --wine3:  #c4364f;
    --gold:   #c9a84c;
    --gold2:  #e8c870;
    --gold3:  #f5dfa0;
    --cream:  #f0e6d4;
    --text:   #e0d4c4;
    --text2:  #b0a090;  /* Am√©lior√©: #a09080 ‚Üí #b0a090 pour ratio WCAG AA ‚â• 4.5:1 */
    --text3:  #6a5a50;
    --green:  #2d7a4e;
    --green2: #3da066;
    --border: #2e2028;
    --border2:#3a2830;
    --shadow: 0 8px 40px rgba(0,0,0,0.8);
    --radius: 6px;
    --radius-sm: 3px;
    --transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Cormorant Garamond', serif;
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
  }

  /* ============================================================
     HEADER
     ============================================================ */
  header {
    background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, var(--bg) 100%);
    border-bottom: 1px solid var(--border);
    padding: 16px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }

  .logo {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    color: var(--gold);
    letter-spacing: 3px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo span { color: var(--cream); font-style: italic; font-size: 1.6rem; letter-spacing: 1px; }
  .logo-dot { width: 6px; height: 6px; background: var(--wine3); border-radius: 50%; }

  .stats-bar {
    display: flex;
    gap: 32px;
    font-size: 0.8rem;
    color: var(--text2);
    letter-spacing: 1.5px;
    text-transform: uppercase;
  }
  .stats-bar b { color: var(--gold); font-size: 1rem; font-style: normal; display: block; letter-spacing: 0; margin-bottom: 1px; }
  .stats-bar .stat-item { text-align: center; }

  /* Search */
  .search-wrap { position: relative; flex: 1; max-width: 380px; }
  .search-input {
    width: 100%;
    padding: 9px 16px 9px 38px;
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--text);
    font-family: 'Cormorant Garamond', serif;
    font-size: 1rem;
    border-radius: 20px;
    outline: none;
    transition: var(--transition);
  }
  .search-input:focus { border-color: var(--gold); background: var(--bg4); box-shadow: 0 0 0 3px rgba(201,168,76,0.1); }
  .search-input::placeholder { color: var(--text3); }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text3); font-size: 0.9rem; pointer-events: none; }
  .search-clear { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text2); cursor: pointer; font-size: 0.85rem; display: none; transition: color 0.2s; }
  .search-results-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 200; display: none; }
  .search-results-panel {
    position: fixed; top: 80px; left: 40px; right: 40px;
    max-width: 600px; margin: 0 auto;
    background: var(--bg2);
    border: 1px solid var(--border2);
    border-radius: var(--radius);
    z-index: 201;
    max-height: 70vh; overflow-y: auto;
    box-shadow: var(--shadow);
  }
  .search-result-item { display: flex; gap: 12px; align-items: center; padding: 13px 18px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
  .search-result-item:last-child { border-bottom: none; }
  .search-count { font-size: 0.75rem; color: var(--text2); letter-spacing: 1px; padding: 8px 18px; border-bottom: 1px solid var(--border); text-transform: uppercase; }

  /* ============================================================
     NAVIGATION ‚Äî desktop horizontal, mobile fixe en bas
     ============================================================ */
  .tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    padding: 0 40px;
    background: var(--bg2);
    position: sticky;
    top: 65px;
    z-index: 99;
  }
  .tab {
    padding: 14px 22px;
    cursor: pointer;
    color: var(--text2);
    font-size: 0.78rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    border-bottom: 2px solid transparent;
    transition: var(--transition);
    white-space: nowrap;
    position: relative;
  }
  .tab:hover { color: var(--cream); }
  .tab.active { color: var(--gold); border-bottom-color: var(--gold); }  /* Sur desktop : tab-icon = inline normal, tab-icon-mobile = cach√© */
  .tab .tab-icon-mobile { display: none; }
  .tab.active::after {
    content: '';
    position: absolute;
    bottom: -1px; left: 50%; transform: translateX(-50%);
    width: 6px; height: 6px;
    background: var(--gold);
    border-radius: 50%;
    margin-bottom: -3px;
  }

  /* ============================================================
     CONTENT AREAS
     ============================================================ */
  .content { display: none; padding: 32px 40px; }
  .content.active { display: block; animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

  /* ============================================================
     CAVE 2D VIEW
     ============================================================ */
  .cave-selector { display: flex; gap: 12px; margin-bottom: 22px; align-items: center; flex-wrap: wrap; }
  .cave-btn {
    padding: 8px 20px;
    border: 1px solid var(--border2);
    background: transparent;
    color: var(--text2);
    cursor: pointer;
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.95rem;
    letter-spacing: 1px;
    transition: var(--transition);
    border-radius: 20px;
  }
  .cave-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.08); }

  .cave-legend { margin-left: auto; display: flex; gap: 16px; font-size: 0.75rem; color: var(--text2); align-items: center; flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 6px; }
  .legend-big  { width: 16px; height: 16px; border-radius: 50%; border: 1.5px solid rgba(255,255,255,0.15); }
  .legend-small{ width: 8px;  height: 8px;  border-radius: 50%; border: 1px solid rgba(255,255,255,0.15); }

  .cave-2d-wrap {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow-x: auto;
    overflow-y: auto;
    padding: 20px;
    position: relative;
    display: flex;
    justify-content: center;
    box-shadow: inset 0 0 60px rgba(0,0,0,0.5);
    max-width: 100%;
  }
  .cave-2d-wrap svg {
    max-width: 100%;
    height: auto;
  }

  /* ============================================================
     TOOLTIP & MOBILE BUBBLE
     ============================================================ */
  #mobile-bubble {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: var(--bg2);
    border-top: 1px solid var(--border2);
    border-radius: 16px 16px 0 0;
    padding: 16px 20px 32px;
    z-index: 300;
    display: none;
    box-shadow: 0 -8px 40px rgba(0,0,0,0.7);
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
  }
  #mobile-bubble.open { display: block; transform: translateY(0); }
  #mobile-bubble .mb-handle { width: 40px; height: 4px; background: var(--border2); border-radius: 2px; margin: 0 auto 16px; }
  #mobile-bubble .mb-name { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.15rem; margin-bottom: 4px; }
  #mobile-bubble .mb-info { color: var(--text2); font-size: 0.88rem; line-height: 1.8; }
  #mobile-bubble .mb-actions { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }
  #mobile-bubble .mb-actions button { flex: 1; min-width: 100px; }

  #tooltip {
    position: fixed;
    background: rgba(6,2,4,0.97);
    border: 1px solid var(--gold);
    padding: 13px 17px;
    border-radius: var(--radius-sm);
    font-size: 0.83rem;
    pointer-events: none;
    display: none;
    z-index: 999;
    max-width: 260px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.9);
  }
  #tooltip .tt-name { font-family: 'Playfair Display', serif; color: var(--gold); margin-bottom: 5px; font-size: 0.93rem; }
  #tooltip .tt-info { color: var(--text2); line-height: 1.7; font-size: 0.78rem; }
  #tooltip .tt-empty { color: var(--text3); font-style: italic; }

  /* ============================================================
     MODALS
     ============================================================ */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; animation: fadeIn 0.2s ease; }
  .modal {
    background: var(--bg2);
    border: 1px solid var(--border2);
    padding: 36px;
    width: 780px;
    max-width: 96vw;
    border-radius: var(--radius);
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow);
  }
  .modal h2 { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.4rem; margin-bottom: 22px; border-bottom: 1px solid var(--border); padding-bottom: 14px; }
  .modal-close { position: absolute; top: 16px; right: 18px; background: none; border: none; color: var(--text2); font-size: 1.3rem; cursor: pointer; transition: color 0.2s; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }

  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .form-full { grid-column: 1 / -1; }
  .form-row { display: flex; flex-direction: column; gap: 4px; }
  .form-row label { font-size: 0.72rem; color: var(--text2); letter-spacing: 1.5px; text-transform: uppercase; }
  .form-row input, .form-row select, .form-row textarea {
    padding: 10px 14px;
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--text);
    font-family: 'Cormorant Garamond', serif;
    font-size: 1rem;
    border-radius: var(--radius-sm);
    outline: none;
    transition: var(--transition);
  }
  .form-row input:focus, .form-row select:focus, .form-row textarea:focus { border-color: var(--gold); background: var(--bg4); box-shadow: 0 0 0 3px rgba(201,168,76,0.08); }
  .form-row select option { background: var(--bg3); }

  .btn-wine { padding: 11px 28px; background: linear-gradient(135deg, var(--wine), var(--wine2)); border: none; color: var(--cream); font-family: 'Cormorant Garamond', serif; font-size: 1rem; letter-spacing: 1px; cursor: pointer; border-radius: 20px; transition: var(--transition); }
  .btn-outline { padding: 10px 20px; background: transparent; border: 1px solid var(--border2); color: var(--text2); font-family: 'Cormorant Garamond', serif; font-size: 1rem; cursor: pointer; border-radius: 20px; transition: var(--transition); }
  .btn-danger { padding: 10px 20px; background: transparent; border: 1px solid rgba(107,26,26,0.6); color: #cc4444; font-family: 'Cormorant Garamond', serif; font-size: 1rem; cursor: pointer; border-radius: 20px; transition: var(--transition); }

  /* ‚îÄ‚îÄ Accessibilit√© ‚Äî focus visible pour navigation clavier ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  :focus-visible {
    outline: 2px solid var(--gold) !important;
    outline-offset: 2px;
    box-shadow: 0 0 0 4px rgba(201,168,76,0.15) !important;
  }
  .tab:focus-visible { outline-offset: -2px; }
  /* Supprimer l'outline uniquement pour les clics souris (pas clavier) */
  :focus:not(:focus-visible) { outline: none; }

  .modal-info-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
  .info-cell { background: var(--bg3); padding: 10px 14px; border-radius: var(--radius-sm); border: 1px solid var(--border); transition: var(--transition); }
  .info-cell .lbl { font-size: 0.67rem; color: var(--text3); text-transform: uppercase; letter-spacing: 1.5px; }
  .info-cell .val { font-size: 1.05rem; color: var(--text); margin-top: 3px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 22px; flex-wrap: wrap; }

  /* ============================================================
     TYPE & FORMAT BADGES
     ============================================================ */
  .type-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.68rem; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap; font-weight: 500; }
  .badge-rouge        { background: rgba(123,28,46,0.25);  color: #e06878; border: 1px solid rgba(123,28,46,0.6); }
  .badge-blanc        { background: rgba(201,168,76,0.12); color: #e8c870; border: 1px solid rgba(201,168,76,0.3); }
  .badge-ros√©         { background: rgba(200,100,120,0.18);color: #e8a0b0; border: 1px solid rgba(160,80,100,0.5); }
  .badge-effervescent { background: rgba(100,160,220,0.15);color: #90c8f0; border: 1px solid rgba(80,120,180,0.4); }
  .badge-vdn_blanc    { background: rgba(201,168,76,0.18); color: #f5d97a; border: 1px solid rgba(201,168,76,0.45); }
  .badge-vdn_rouge    { background: rgba(120,40,20,0.22);  color: #d08060; border: 1px solid rgba(140,60,30,0.5); }
  .badge-liquoreux    { background: rgba(200,100,20,0.18); color: #f0a050; border: 1px solid rgba(180,90,20,0.4); }
  .format-badge { display: inline-block; padding: 2px 7px; border-radius: 3px; font-size: 0.65rem; letter-spacing: 0.5px; text-transform: uppercase; background: rgba(201,168,76,0.07); color: var(--text2); border: 1px solid var(--border); }
  .rating-stars { color: var(--gold); letter-spacing: -1px; }

  /* ============================================================
     LIST VIEW ‚Äî TABLE DESKTOP + CARTES MOBILE
     ============================================================ */
  .filter-bar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
  .filter-bar input, .filter-bar select {
    padding: 9px 16px; background: var(--bg2); border: 1px solid var(--border2); color: var(--text);
    font-family: 'Cormorant Garamond', serif; font-size: 0.95rem; border-radius: 20px; outline: none; transition: var(--transition);
  }
  .filter-bar input:focus, .filter-bar select:focus { border-color: var(--gold); }
  .filter-bar input { width: 220px; }

  .wine-table { width: 100%; border-collapse: collapse; font-size: 0.93rem; }
  .wine-table th { text-align: left; padding: 10px 14px; border-bottom: 1px solid var(--border); color: var(--text3); font-weight: 400; letter-spacing: 1.5px; text-transform: uppercase; font-size: 0.7rem; white-space: nowrap; }
  .wine-table td { padding: 11px 14px; border-bottom: 1px solid rgba(46,32,40,0.5); transition: background 0.15s; }

  /* Cartes vins pour mobile */
  .wine-cards { display: none; flex-direction: column; gap: 12px; }
  .wine-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    gap: 14px;
    align-items: flex-start;
  }
  .wine-card-img { width: 52px; height: 72px; object-fit: contain; border-radius: 3px; border: 1px solid var(--border); flex-shrink: 0; background: var(--bg3); display: flex; align-items: center; justify-content: center; font-size: 1.6rem; }
  .wine-card-img img { width: 100%; height: 100%; object-fit: contain; border-radius: 3px; }
  .wine-card-body { flex: 1; min-width: 0; }
  .wine-card-name { font-family: 'Playfair Display', serif; color: var(--text); font-size: 1.05rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .wine-card-sub { font-size: 0.82rem; color: var(--text2); font-style: italic; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .wine-card-tags { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; align-items: center; }
  .wine-card-price { margin-left: auto; text-align: right; flex-shrink: 0; }
  .wine-card-price .price-val { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.1rem; }
  .wine-card-price .price-lbl { font-size: 0.68rem; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; }

  .empty-state { text-align: center; padding: 80px 20px; color: var(--text2); font-size: 1.1rem; font-style: italic; }

  /* ============================================================
     STATS VIEW
     ============================================================ */
  .stats-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 28px; }
  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    padding: 22px 24px;
    border-radius: var(--radius);
    position: relative;
    overflow: hidden;
    transition: var(--transition);
  }
  .stat-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, var(--gold), var(--wine)); border-radius: var(--radius) 0 0 var(--radius); }
  .stat-card .s-val { font-family: 'Playfair Display', serif; font-size: 2rem; color: var(--gold); line-height: 1; }
  .stat-card .s-lbl { font-size: 0.73rem; color: var(--text2); letter-spacing: 1.5px; text-transform: uppercase; margin-top: 8px; line-height: 1.5; }

  .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .chart-card { background: var(--bg2); border: 1px solid var(--border); padding: 22px; border-radius: var(--radius); }
  .chart-card h3 { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--gold2); margin-bottom: 18px; font-weight: 400; letter-spacing: 1px; }
  .bar-chart { display: flex; flex-direction: column; gap: 9px; }
  .bar-row { display: flex; align-items: center; gap: 10px; }
  .bar-label { width: 96px; font-size: 0.77rem; color: var(--text2); text-align: right; flex-shrink: 0; }
  .bar-track { flex: 1; height: 16px; background: var(--bg3); border-radius: 20px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 20px; transition: width 0.6s cubic-bezier(0.4,0,0.2,1); }
  .bar-count { font-size: 0.77rem; color: var(--text2); width: 28px; text-align: right; flex-shrink: 0; }

  /* ============================================================
     FORMS (add wine)
     ============================================================ */
  .add-wine-form { max-width: 800px; }
  .add-wine-form h2 { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.5rem; margin-bottom: 28px; }

  /* ============================================================
     PASSWORD SCREEN
     ============================================================ */
  #pwd-screen {
    position: fixed; inset: 0;
    background: radial-gradient(ellipse at center, #1a0a0e 0%, #0a0406 100%);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999;
    transition: opacity 0.4s ease;
  }
  #pwd-screen.hidden { opacity: 0; pointer-events: none; }
  .pwd-box {
    text-align: center;
    padding: 60px 50px;
    background: rgba(22,16,15,0.95);
    border: 1px solid var(--border2);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    max-width: 380px;
    width: 90vw;
  }
  .pwd-logo { font-family: 'Playfair Display', serif; font-size: 2.2rem; color: var(--gold); margin-bottom: 8px; letter-spacing: 3px; }
  .pwd-sub { color: var(--text2); font-size: 0.85rem; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 36px; }
  .pwd-input {
    width: 100%; padding: 13px 18px; background: var(--bg3); border: 1px solid var(--border2);
    color: var(--text); font-family: 'Cormorant Garamond', serif; font-size: 1.1rem;
    border-radius: var(--radius-sm); outline: none; text-align: center; letter-spacing: 4px;
    transition: var(--transition); margin-bottom: 16px;
  }
  .pwd-input:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201,168,76,0.1); }
  .pwd-btn {
    width: 100%; padding: 13px; background: linear-gradient(135deg, var(--wine), var(--wine2));
    border: none; color: var(--cream); font-family: 'Cormorant Garamond', serif;
    font-size: 1rem; letter-spacing: 2px; text-transform: uppercase;
    cursor: pointer; border-radius: 20px; transition: var(--transition);
  }
  .pwd-btn:hover { background: linear-gradient(135deg, var(--wine2), var(--wine3)); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(123,28,46,0.5); }
  /* NOTE: cette r√®gle est aussi couverte par @media (hover: hover) ‚Äî redondance intentionnelle pour compatibilit√© */
  .pwd-error { color: var(--wine3); font-size: 0.85rem; margin-top: 12px; min-height: 18px; }
  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }

  /* ============================================================
     NOTIFICATIONS
     ============================================================ */
  .notif {
    position: fixed; top: 80px; right: 24px;
    background: var(--bg2); border: 1px solid var(--border2);
    color: var(--text); padding: 13px 20px; border-radius: var(--radius);
    font-size: 0.9rem; z-index: 9999;
    box-shadow: var(--shadow);
    transform: translateX(120%);
    transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
    max-width: 320px;
    border-left: 3px solid var(--gold);
  }
  .notif.show { transform: translateX(0); }
  .notif.error { border-left-color: var(--wine3); }

  /* ============================================================
     SPINNER SYNC INITIAL
     ============================================================ */
  #sync-loading-overlay {
    position: fixed; inset: 0; background: rgba(14,10,11,0.85);
    z-index: 8000; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 20px;
    transition: opacity 0.4s ease;
  }
  #sync-loading-overlay.hidden { opacity: 0; pointer-events: none; }
  .sync-spinner {
    width: 48px; height: 48px;
    border: 3px solid var(--border2);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .sync-spinner-text {
    font-family: 'Cormorant Garamond', serif;
    color: var(--text2); font-size: 0.9rem;
    letter-spacing: 2px; text-transform: uppercase;
  }

  /* ============================================================
     CLASSES UTILITAIRES ‚Äî Boutons actions inline
     Remplacent les styles inline + onmouseover/onmouseout
     ============================================================ */
  .btn-action-wine {
    white-space: nowrap; padding: 9px 14px;
    background: var(--wine); border: none; color: var(--cream);
    font-family: 'Cormorant Garamond', serif; font-size: 0.95rem;
    letter-spacing: 1px; cursor: pointer; border-radius: var(--radius-sm);
    transition: background 0.2s; flex-shrink: 0;
    display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-action-file {
    white-space: nowrap; padding: 9px 14px;
    background: var(--bg3); border: 1px solid var(--border);
    color: var(--text2); font-family: 'Cormorant Garamond', serif;
    font-size: 0.95rem; letter-spacing: 1px; cursor: pointer;
    border-radius: var(--radius-sm); transition: all 0.2s;
    flex-shrink: 0; display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-action-country {
    padding: 4px 10px; background: var(--bg3);
    border: 1px solid #3a2830; color: var(--text2);
    cursor: pointer; border-radius: var(--radius-sm);
    font-size: 0.75rem; font-family: 'Cormorant Garamond', serif;
    transition: all 0.2s;
  }
  .btn-action-edit, .btn-action-del {
    padding: 4px 9px; background: transparent;
    border: 1px solid var(--border); color: var(--text2);
    font-family: 'Cormorant Garamond', serif; font-size: 0.78rem;
    cursor: pointer; border-radius: var(--radius-sm); transition: all 0.2s;
  }

  /* ============================================================
     D√âGUSTATION / HISTORIQUE
     ============================================================ */
  #histo-list { display: flex; flex-direction: column; gap: 12px; }

  /* ============================================================
     HOVER ‚Äî UNIQUEMENT SUR DISPOSITIFS AVEC POINTEUR (PAS TACTILE)
     √âvite les √©tats hover "bloqu√©s" sur mobile apr√®s un tap
     ============================================================ */
  @media (hover: hover) and (pointer: fine) {
    .search-clear:hover { color: var(--gold); }
    .search-result-item:hover { background: var(--bg3); }
    .tab:hover { color: var(--cream); }
    .cave-btn:hover { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.08); }
    .modal-close:hover { color: var(--gold); background: var(--bg3); }
    .btn-wine:hover { background: linear-gradient(135deg, var(--wine2), var(--wine3)); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(123,28,46,0.4); }
    .btn-outline:hover { border-color: var(--wine3); color: var(--wine3); background: rgba(196,54,79,0.06); }
    .btn-danger:hover { background: rgba(107,26,26,0.25); border-color: #cc4444; }
    .info-cell:hover { border-color: var(--border2); }
    .wine-table tr:hover td { background: rgba(201,168,76,0.04); cursor: pointer; }
    .wine-table tr:hover td:first-child { border-left: 2px solid var(--wine2); padding-left: 12px; }
    .stat-card:hover { border-color: var(--border2); }
    .pwd-btn:hover { background: linear-gradient(135deg, var(--wine2), var(--wine3)); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(123,28,46,0.5); }
    .leaflet-control-zoom a:hover { color: #c9a84c !important; border-color: #c9a84c !important; }
    /* Boutons inline avec classes utilitaires */
    .btn-action-wine:hover  { background: var(--wine2) !important; }
    .btn-action-file:hover  { border-color: var(--gold) !important; color: var(--gold) !important; }
    .btn-action-country:hover { border-color: var(--gold) !important; color: var(--gold) !important; }
    .btn-action-edit:hover  { border-color: var(--gold) !important; color: var(--gold) !important; }
    .btn-action-del:hover   { border-color: var(--wine2) !important; color: var(--wine2) !important; }
  }
  /* wine-card: :active conserv√© sur tactile pour feedback visuel */
  .wine-card:active { border-color: var(--border2); background: var(--bg3); transform: translateX(2px); }
  @media (hover: hover) and (pointer: fine) {
    .wine-card:hover { border-color: var(--border2); background: var(--bg3); transform: translateX(2px); }
  }

  /* ============================================================
     RESPONSIVE MOBILE
     ============================================================ */
  @media (max-width: 768px) {
    /* Header compact */
    header { padding: 10px 16px; flex-wrap: wrap; gap: 8px; }
    .logo { font-size: 1.1rem; letter-spacing: 1px; }
    .logo-dot { display: none; }
    .stats-bar { gap: 14px; font-size: 0.7rem; }
    .stats-bar .stat-item { display: none; }
    .stats-bar .stat-item:first-child, .stats-bar .stat-item:last-child { display: block; }
    .search-wrap { max-width: 160px; margin: 0 6px !important; }
    .search-input { font-size: 0.85rem; padding: 7px 10px 7px 30px; }
    .search-results-panel { left: 10px; right: 10px; top: 90px; }

    /* Navigation ‚Äî dispara√Æt en haut, appara√Æt en bas */
    .tabs {
      position: fixed;
      bottom: 0; top: auto;
      left: 0; right: 0;
      padding: 0;
      padding-bottom: env(safe-area-inset-bottom, 0px);
      border-top: 1px solid var(--border);
      border-bottom: none;
      background: rgba(14,10,11,0.97);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 200;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      justify-content: flex-start;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab {
      font-size: 0.62rem;
      padding: 10px 14px 12px;
      letter-spacing: 0;
      flex: 0 0 auto;
      text-align: center;
      border-bottom: none;
      border-top: 2px solid transparent;
      min-width: 68px;
      flex-direction: column;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .tab.active { border-top-color: var(--gold); border-bottom: none; color: var(--gold); }
    .tab.active::after { display: none; }
    /* Ic√¥nes plus grandes sur mobile */
    .tab .tab-icon { font-size: 1.3rem; display: block; line-height: 1; }
    .tab .tab-icon-desktop { display: none; }
    .tab .tab-icon-mobile  {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 1.3rem;        /* m√™me hauteur qu'un emoji 1.3rem */
      line-height: 1;
    }
    .tab .tab-icon-mobile img {
      width: 1.3rem;
      height: 1.3rem;
      display: block;
      vertical-align: top;
    }
    /* Si un tab a une ic√¥ne mobile custom, cacher l'emoji par d√©faut */
    .tab:has(.tab-icon-mobile) .tab-icon { display: none; }
    /* Ic√¥ne cave custom sur mobile ‚Äî remplace l'emoji üó∫ */
    .tab-icon-cave { display:flex; align-items:center; justify-content:center; height:1.3rem; }
    .tab .tab-label { display: block; font-size: 0.58rem; }

    /* Content ‚Äî padding bas pour la nav fixe + safe area iOS */
    .content { padding: 16px 14px calc(80px + env(safe-area-inset-bottom, 0px)); }

    /* Cartes √† la place du tableau */
    .wine-table { display: none; }
    .wine-cards { display: flex; }
    #cave-svg-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg2); }
    #caveSvg { user-select: none; -webkit-user-select: none; }
    #caveSvg circle[data-cave] { cursor: pointer; transition: opacity 0.15s; }
    #drag-ghost { pointer-events: none; }
    .cave-selector { flex-wrap: wrap; gap: 8px; }
    .cave-legend { flex-wrap: wrap; gap: 6px; }

    /* Stats */
    .stats-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
    .charts-row { grid-template-columns: 1fr; }
    .stat-card { padding: 16px 18px; }
    .stat-card .s-val { font-size: 1.6rem; }

    /* Formulaires */
    .form-grid { grid-template-columns: 1fr; }
    .form-full { grid-column: 1; }

    /* Modal */
    .modal { width: 98vw; max-width: 98vw; padding: 20px 16px; margin: 6px auto; }
    .modal-info-panel { grid-template-columns: 1fr 1fr; gap: 8px; }
    .modal-actions { flex-wrap: wrap; gap: 8px; }
    .modal-actions button { flex: 1; min-width: 110px; font-size: 0.88rem; padding: 9px 10px; }

    /* Historique */
    .bar-label { width: 70px; font-size: 0.7rem; }
    #histo-list > div { padding: 12px 14px; }

    /* Cave SVG labels masqu√©s sur mobile */
    #wine-labels-g { display: none; }

    /* Banni√®re apog√©e sur mobile */
    #apogee-alert-banner { padding: 4px 16px !important; font-size: 0.7rem !important; }

    /* Carte pleine largeur sur mobile */
    #carte-wrap { height: 400px !important; }
  }

  /* #wine-labels-g masqu√© sur mobile ‚Äî fusionn√© dans le bloc @media 768px principal */

  /* Leaflet tooltip wine style */
  .leaflet-country-tooltip {
    background: rgba(14,10,11,0.7) !important;
    border: 1px solid #c9a84c55 !important;
    border-radius: 3px !important;
    padding: 3px 8px !important;
    font-family: 'Cormorant Garamond', serif !important;
    font-size: 0.75rem !important;
    color: #c9a84c !important;
    letter-spacing: 0.05em !important;
    box-shadow: none !important;
  }
  .leaflet-country-tooltip::before { display:none !important; }
  .leaflet-wine-tooltip {
    background: rgba(14,10,11,0.96) !important;
    border: 1px solid rgba(201,168,76,0.5) !important;
    border-radius: 5px !important;
    padding: 10px 13px !important;
    box-shadow: 0 4px 24px rgba(0,0,0,0.75) !important;
    font-family: 'Cormorant Garamond', serif !important;
    font-size: 0.82rem !important;
    color: #e0d4c4 !important;
    max-width: 280px !important;
    min-width: 160px !important;
    white-space: normal !important;
    word-break: keep-all !important;
    pointer-events: none !important;
    line-height: 1.5 !important;
  }
  .leaflet-wine-tooltip::before { display: none !important; }
  /* Attribution OSM conserv√©e ‚Äî obligation l√©gale licence ODbL */
  .leaflet-control-attribution {
    background: rgba(14,10,11,0.75) !important;
    color: #a09080 !important;
    font-size: 0.6rem !important;
    border-radius: 3px 0 0 0 !important;
    padding: 2px 6px !important;
  }
  .leaflet-control-attribution a { color: #c9a84c !important; }
  .appel-label-icon { background: none !important; border: none !important; box-shadow: none !important; }
  .leaflet-control-zoom a {
    background: rgba(14,10,11,0.9) !important;
    color: #a09080 !important;
    border-color: #2e2028 !important;
  }
  #carte-leaflet { border-radius: 4px; }

  /* #carte-wrap height ‚Äî fusionn√© dans le bloc @media 768px principal */

  @media (max-width: 480px) {
    .logo { font-size: 0.95rem; }
    .stats-bar { gap: 10px; }
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .modal-info-panel { grid-template-columns: 1fr; }
    .tab { min-width: 44px; padding: 8px 4px 12px; }
  }
</style>
  <!-- Leaflet CSS charg√© en lazy (pr√©charg√© pour √©viter le flash) -->
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"></noscript>
  <!-- TopoJSON, D3 et Leaflet JS charg√©s dynamiquement au premier acc√®s √† l'onglet Carte -->
  <script>
  // Marqueur : librairies cartographiques charg√©es ?
  let _mapLibsLoaded = false;
  let _mapLibsPromise = null;
  function loadMapLibs() {
    if(_mapLibsLoaded) return Promise.resolve();
    if(_mapLibsPromise) return _mapLibsPromise;
    _mapLibsPromise = new Promise((resolve, reject) => {
      function loadScript(src, cb) {
        const s = document.createElement('script');
        s.src = src; s.onload = cb; s.onerror = reject;
        document.head.appendChild(s);
      }
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js', () => {
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js', () => {
          loadScript('https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js', () => {
            _mapLibsLoaded = true;
            resolve();
          });
        });
      });
    });
    return _mapLibsPromise;
  }
  </script>
</head>
<body>


<!-- SYNC LOADING OVERLAY -->
<div id="sync-loading-overlay" class="hidden">
  <div class="sync-spinner"></div>
  <div class="sync-spinner-text">Synchronisation en cours‚Ä¶</div>
</div>

<!-- PASSWORD SCREEN -->
<div id="pwd-screen">
  <div class="pwd-box">
    <h1>üç∑ Cave √† Vin</h1>
    <p>Acc√®s priv√© ‚Äî Entrez votre mot de passe</p>
    <input type="password" class="pwd-input" id="pwd-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
      onkeydown="if(event.key==='Enter') checkPwd()">
    <button class="pwd-btn" onclick="checkPwd()">Acc√©der √† ma cave</button>
    <div class="pwd-error" id="pwd-error"></div>
  </div>
</div>

<header>
  <div class="logo"><span style="font-style:normal;font-size:1.6rem">üç∑Ô∏è</span> Cave √† Vin<div class="logo-dot"></div></div>
  <div class="stats-bar">
    <div class="stat-item"><b id="hdr-total">0</b>bouteilles</div>
    <div class="stat-item"><b id="hdr-c1">0</b>cave 1</div>
    <div class="stat-item"><b id="hdr-c2">0</b>cave 2</div>
    <div class="stat-item"><b id="hdr-val">0 ‚Ç¨</b>valeur</div>
  </div>
</header>

<div class="search-results-overlay" id="search-overlay" onclick="clearSearch()"></div>
<div class="search-results-panel" id="search-panel" style="display:none"></div>

<div class="tabs" role="tablist" aria-label="Navigation principale">
  <div class="tab active" role="tab" aria-selected="true"  aria-controls="view2d"    data-tab="view2d" id="tab-view2d" onclick="switchTab('view2d',this)"><span class="tab-icon">üó∫</span><span class="tab-icon-mobile"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI0IiBoZWlnaHQ9IjEyNCIgdmlld0JveD0iMCAwIDEyNCAxMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnIiB4MT0iMCIgeTE9IjAiIHgyPSIwIiB5Mj0iMSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMyQzMxMzYiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjMTcxQTFEIi8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogICAgPGxpbmVhckdyYWRpZW50IGlkPSJnbGFzcyIgeDE9IjAiIHkxPSIwIiB4Mj0iMSIgeTI9IjEiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMTgpIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iNTAlIiBzdG9wLWNvbG9yPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMDUpIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0icmdiYSgyNTUsMjU1LDI1NSwwLjEyKSIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICAgIDwhLS0gUm91Z2UgYm9yZGVhdXggLS0+CiAgICA8cmFkaWFsR3JhZGllbnQgaWQ9ImJyIiBjeD0iMzUlIiBjeT0iMzUlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2M0MzY0ZiIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM0YTBlMWEiLz4KICAgIDwvcmFkaWFsR3JhZGllbnQ+CiAgICA8IS0tIEJsYW5jL29yIC0tPgogICAgPHJhZGlhbEdyYWRpZW50IGlkPSJiZzIiIGN4PSIzNSUiIGN5PSIzNSUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjZThjODcwIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzdhNWExMCIvPgogICAgPC9yYWRpYWxHcmFkaWVudD4KICAgIDwhLS0gUm9zw6kgLS0+CiAgICA8cmFkaWFsR3JhZGllbnQgaWQ9ImJwIiBjeD0iMzUlIiBjeT0iMzUlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2UwNzA5MCIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM3YTIwNDAiLz4KICAgIDwvcmFkaWFsR3JhZGllbnQ+CiAgICA8IS0tIExpcXVvcmV1eC9hbWJyZSAtLT4KICAgIDxyYWRpYWxHcmFkaWVudCBpZD0iYmwiIGN4PSIzNSUiIGN5PSIzNSUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjZThhMDMwIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzdhNGEwMCIvPgogICAgPC9yYWRpYWxHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIHJ4PSIxNiIKICAgICAgICBmaWxsPSJ1cmwoI2JnKSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utb3BhY2l0eT0iMC41IiBzdHJva2Utd2lkdGg9IjIiLz4KICA8dGV4dCB4PSI2MiIgeT0iMTEiIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiIGZvbnQtc2l6ZT0iOCIKICAgICAgICB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjN0VENkZGIiBvcGFjaXR5PSIwLjg1Ij4xNCYjMTc2OzwvdGV4dD4KICA8ZyBzdHJva2U9IiNGRkZGRkYiIHN0cm9rZS1vcGFjaXR5PSIwLjEwIiBzdHJva2Utd2lkdGg9IjEiPgogICAgPGxpbmUgeDE9IjEwIiB5MT0iMjciIHgyPSIxMTAiIHkyPSIyNyIvPgogICAgPGxpbmUgeDE9IjEwIiB5MT0iNDIiIHgyPSIxMTAiIHkyPSI0MiIvPgogICAgPGxpbmUgeDE9IjEwIiB5MT0iNTciIHgyPSIxMTAiIHkyPSI1NyIvPgogICAgPGxpbmUgeDE9IjEwIiB5MT0iNzIiIHgyPSIxMTAiIHkyPSI3MiIvPgogICAgPGxpbmUgeDE9IjEwIiB5MT0iODciIHgyPSIxMTAiIHkyPSI4NyIvPgogIDwvZz4KICA8Y2lyY2xlIGN4PSIyMiIgY3k9IjE5IiByPSI1LjUiIGZpbGw9InVybCgjYnIpIi8+CiAgPGNpcmNsZSBjeD0iNDgiIGN5PSIxOSIgcj0iNS41IiBmaWxsPSJ1cmwoI2JnMikiLz4KICA8Y2lyY2xlIGN4PSI3NCIgY3k9IjE5IiByPSI1LjUiIGZpbGw9InVybCgjYnApIi8+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTkiIHI9IjUuNSIgZmlsbD0idXJsKCNicikiLz4KICA8Y2lyY2xlIGN4PSIyMiIgY3k9IjM0IiByPSI1LjUiIGZpbGw9InVybCgjYnApIi8+CiAgPGNpcmNsZSBjeD0iNDgiIGN5PSIzNCIgcj0iNS41IiBmaWxsPSJ1cmwoI2JsKSIvPgogIDxjaXJjbGUgY3g9Ijc0IiBjeT0iMzQiIHI9IjUuNSIgZmlsbD0idXJsKCNicikiLz4KICA8Y2lyY2xlIGN4PSIxMDAiIGN5PSIzNCIgcj0iNS41IiBmaWxsPSJ1cmwoI2JnMikiLz4KICA8Y2lyY2xlIGN4PSIyMiIgY3k9IjQ5IiByPSI1LjUiIGZpbGw9InVybCgjYmcyKSIvPgogIDxjaXJjbGUgY3g9IjQ4IiBjeT0iNDkiIHI9IjUuNSIgZmlsbD0idXJsKCNicikiLz4KICA8Y2lyY2xlIGN4PSI3NCIgY3k9IjQ5IiByPSI1LjUiIGZpbGw9InVybCgjYmwpIi8+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iNDkiIHI9IjUuNSIgZmlsbD0idXJsKCNicCkiLz4KICA8Y2lyY2xlIGN4PSIyMiIgY3k9IjY0IiByPSI1LjUiIGZpbGw9InVybCgjYnIpIi8+CiAgPGNpcmNsZSBjeD0iNDgiIGN5PSI2NCIgcj0iNS41IiBmaWxsPSJ1cmwoI2JwKSIvPgogIDxjaXJjbGUgY3g9Ijc0IiBjeT0iNjQiIHI9IjUuNSIgZmlsbD0idXJsKCNiZzIpIi8+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iNjQiIHI9IjUuNSIgZmlsbD0idXJsKCNibCkiLz4KICA8Y2lyY2xlIGN4PSIyMiIgY3k9Ijc5IiByPSI1LjUiIGZpbGw9InVybCgjYmwpIi8+CiAgPGNpcmNsZSBjeD0iNDgiIGN5PSI3OSIgcj0iNS41IiBmaWxsPSJ1cmwoI2JyKSIvPgogIDxjaXJjbGUgY3g9Ijc0IiBjeT0iNzkiIHI9IjUuNSIgZmlsbD0idXJsKCNicCkiLz4KICA8Y2lyY2xlIGN4PSIxMDAiIGN5PSI3OSIgcj0iNS41IiBmaWxsPSJ1cmwoI2JnMikiLz4KICA8Y2lyY2xlIGN4PSIyMiIgY3k9Ijk0IiByPSI1LjUiIGZpbGw9InVybCgjYmcyKSIvPgogIDxjaXJjbGUgY3g9IjQ4IiBjeT0iOTQiIHI9IjUuNSIgZmlsbD0idXJsKCNicCkiLz4KICA8Y2lyY2xlIGN4PSI3NCIgY3k9Ijk0IiByPSI1LjUiIGZpbGw9InVybCgjYnIpIi8+CiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iOTQiIHI9IjUuNSIgZmlsbD0idXJsKCNibCkiLz4KICA8cmVjdCB4PSI0IiB5PSI0IiB3aWR0aD0iMTE2IiBoZWlnaHQ9IjExNiIgcng9IjE0IgogICAgICAgIGZpbGw9InVybCgjZ2xhc3MpIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPgogIDxyZWN0IHg9IjEwIiB5PSI0IiB3aWR0aD0iMTgiIGhlaWdodD0iMTE2IgogICAgICAgIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiIHJ4PSI5Ii8+Cjwvc3ZnPg==" style="border-radius:3px" alt="cave"/></span><span class="tab-label">Cave</span></div>
  <div class="tab" role="tab" aria-selected="false" aria-controls="list"      data-tab="list" id="tab-list" onclick="switchTab('list',this)"><span class="tab-icon">üìã</span><span class="tab-label">Liste</span></div>
  <div class="tab" role="tab" aria-selected="false" aria-controls="historique" data-tab="historique" id="tab-historique" onclick="switchTab('historique',this)"><span class="tab-icon">ü•Ç</span><span class="tab-label">D√©gustation</span></div>
  <div class="tab" role="tab" aria-selected="false" aria-controls="carte"     data-tab="carte" id="tab-carte" onclick="switchTab('carte',this)"><span class="tab-icon">üåç</span><span class="tab-label">Carte</span></div>
  <div class="tab" role="tab" aria-selected="false" aria-controls="apogee"    data-tab="apogee" id="tab-apogee" onclick="switchTab('apogee',this)"><span class="tab-icon">üîî</span><span class="tab-label">Apog√©e</span></div>
  <div class="tab" role="tab" aria-selected="false" aria-controls="accords"   data-tab="accords" id="tab-accords" onclick="switchTab('accords',this)"><span class="tab-icon">üçΩ</span><span class="tab-label">Accords</span></div>
  <div class="tab" role="tab" aria-selected="false" aria-controls="stats"     data-tab="stats" id="tab-stats" onclick="switchTab('stats',this)"><span class="tab-icon">üìä</span><span class="tab-label">Stats</span></div>
  <div class="tab" role="tab" aria-selected="false" aria-controls="add"       data-tab="add" id="tab-add" onclick="switchTab('add',this)"><span class="tab-icon">‚ûï</span><span class="tab-label">Ajouter</span></div>
  <div style="flex:1" class="mobile-hidden"></div>
  <div class="search-wrap" style="margin:0 12px;align-self:center">
    <span class="search-icon">üîç</span>
    <input class="search-input" id="global-search" type="text" placeholder="Rechercher‚Ä¶"
      oninput="handleSearch(this.value)"
      onkeydown="if(event.key==='Escape') clearSearch()">
    <span class="search-clear" id="search-clear" onclick="clearSearch()">‚úï</span>
  </div>
</div>

<!-- ===== 2D CAVE VIEW ===== -->
<div id="view2d" class="content active" role="tabpanel" aria-labelledby="tab-view2d" tabindex="0">
  <div class="cave-selector">
    <button class="cave-btn active" onclick="selectCave(1,this)">Cave 1 ‚Äî 156 empl.</button>
    <button class="cave-btn" onclick="selectCave(2,this)">Cave 2 ‚Äî 110 empl.</button>
    <div class="cave-legend">
      <div class="legend-item"><div class="legend-big" style="background:#8a1828"></div> <span style="color:#e06878">Rouge</span></div>
      <div class="legend-item"><div class="legend-big" style="background:#a88018"></div> <span style="color:#e8c870">Blanc</span></div>
      <div class="legend-item"><div class="legend-big" style="background:#b84068"></div> <span style="color:#e8a0b0">Ros√©</span></div>
      <div class="legend-item"><div class="legend-big" style="background:#1e4870"></div> <span style="color:#90c8f0">Effervescent</span></div>
      <div class="legend-item"><div class="legend-big" style="background:#b8901a"></div> <span style="color:#f5d97a">VDN Blanc</span></div>
      <div class="legend-item"><div class="legend-big" style="background:#6a2010"></div> <span style="color:#d08060">VDN Rouge</span></div>
      <div class="legend-item"><div class="legend-big" style="background:#c06020"></div> <span style="color:#f0a850">Liquoreux</span></div>
      <div class="legend-item"><div class="legend-big" style="background:#1a1014;border:1.5px solid #4a3040"></div> <span style="color:#6a5a50">Vide</span></div>
      <div class="legend-item"><div class="legend-small" style="background:#4a4a4a"></div> <span style="color:#6a5a50">Goulot arri√®re</span></div>
      <div class="legend-item"><div style="width:16px;height:16px;border-radius:50%;background:transparent;border:2.5px solid #c9a84c;box-shadow:0 0 6px rgba(201,168,76,0.6)"></div> <span style="color:#c9a84c">Magnum</span></div>
    </div>
  </div>
  <div class="cave-2d-wrap" id="cave2dWrap">
    <div id="cave-svg-wrap" style="overflow-x:auto;-webkit-overflow-scrolling:touch"><svg id="caveSvg" style="display:block;"></svg></div>
  </div>
</div>

<!-- ===== LIST VIEW ===== -->
<div id="list" class="content" role="tabpanel" aria-labelledby="tab-list" tabindex="0">
  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="Rechercher un vin..." oninput="renderList()">
    <select id="filterCave" onchange="renderList()">
      <option value="">Toutes les caves</option>
      <option value="1">Cave 1</option>
      <option value="2">Cave 2</option>
    </select>
    <select id="filterType" onchange="renderList()">
      <option value="">Tous les types</option>
      <option value="rouge">Rouge</option>
      <option value="blanc">Blanc</option>
      <option value="ros√©">Ros√©</option>
      <option value="effervescent">Effervescent</option>
      <option value="vdn_blanc">VDN Blanc</option>
      <option value="vdn_rouge">VDN Rouge</option>
      <option value="liquoreux">Liquoreux</option>
    </select>
    <select id="sortBy" onchange="renderList()">
      <option value="nom">Trier par nom</option>
      <option value="appellation">Trier par appellation</option>
      <option value="region">Trier par r√©gion</option>
      <option value="domaine">Trier par domaine / producteur</option>
      <option value="annee">Trier par ann√©e</option>
      <option value="prix">Trier par prix</option>
      <option value="type">Trier par type</option>
    </select>
  </div>
  <div id="listContainer"></div>
</div>

<!-- ===== STATS VIEW ===== -->
<div id="stats" class="content" role="tabpanel" aria-labelledby="tab-stats" tabindex="0">
  <div class="stats-grid" id="statsGrid"></div>
  <div class="charts-row">
    <div class="chart-card"><h3>R√©partition par type</h3><div class="bar-chart" id="chartType"></div></div>
    <div class="chart-card"><h3>R√©partition par mill√©sime</h3><div class="bar-chart" id="chartDecade"></div></div>
  </div>
  <div class="charts-row">
    <div class="chart-card"><h3>R√©partition par r√©gion</h3><div class="bar-chart" id="chartRegion"></div></div>
    <div class="chart-card"><h3>R√©partition par appellation</h3><div class="bar-chart" id="chartAppellation"></div></div>
  </div>
  <div class="charts-row" style="grid-template-columns:1fr">
    <div class="chart-card">
      <h3>Occupation des caves</h3>
      <div id="chartCaves" style="display:flex;gap:40px;flex-wrap:wrap;align-items:flex-end;padding:10px 0"></div>
    </div>
  </div>
</div>

<!-- ===== ADD VIEW ===== -->
<div id="add" class="content" role="tabpanel" aria-labelledby="tab-add" tabindex="0">
  <div class="add-wine-form">
    <h2>Ajouter un vin</h2>
    <div class="form-grid">
      <div class="form-row form-full">
        <label>Nom / Cuv√©e *</label>
        <input type="text" id="f-nom" placeholder="ex: Gevrey-Chambertin, La T√¢che...">
      </div>
      <div class="form-row form-full">
        <label>Appellation</label>
        <input type="text" id="f-appellation" placeholder="ex: AOC Bourgogne, AOP C√¥tes du Rh√¥ne...">
      </div>
      <div class="form-row">
        <label>Domaine / Producteur</label>
        <input type="text" id="f-domaine" placeholder="ex: Domaine Leflaive">
      </div>
      <div class="form-row">
        <label>R√©gion</label>
        <input type="text" id="f-region" placeholder="ex: Bordeaux, Bourgogne...">
      </div>
      <div class="form-row">
        <label>Type *</label>
        <select id="f-type">
          <option value="rouge">Rouge</option>
          <option value="blanc">Blanc</option>
          <option value="ros√©">Ros√©</option>
          <option value="effervescent">Effervescent (Champagne, Cr√©mant‚Ä¶)</option>
          <option value="vdn_blanc">VDN Blanc (Muscat, Rivesaltes Ambr√©‚Ä¶)</option>
          <option value="vdn_rouge">VDN Rouge (Banyuls, Maury, Rivesaltes Grenat‚Ä¶)</option>
          <option value="liquoreux">Liquoreux (Sauternes, Juran√ßon, Monbazillac‚Ä¶)</option>
        </select>
      </div>
      <div class="form-row">
        <label>Format</label>
        <select id="f-format">
          <option value="75cl">75 cl (standard)</option>
          <option value="37.5cl">37,5 cl (demi)</option>
          <option value="62cl">62 cl (jaune)</option>
          <option value="150cl">150 cl (Magnum)</option>
          <option value="300cl">300 cl (Double Magnum)</option>
          <option value="autre">Autre</option>
        </select>
      </div>
      <div class="form-row">
        <label>Mill√©sime *</label>
        <input type="number" inputmode="numeric" id="f-annee" placeholder="2018" min="1900" max="2030">
      </div>
      <div class="form-row">
        <label>Cave *</label>
        <select id="f-cave" onchange="updateEtageSelect()">
          <option value="1">Cave 1</option>
          <option value="2">Cave 2</option>
        </select>
      </div>
      <div class="form-row">
        <label>√âtage *</label>
        <select id="f-etage"></select>
      </div>
      <div class="form-row">
        <label>Emplacement *</label>
        <select id="f-slot"></select>
      </div>
      <div class="form-row">
        <label>Prix (‚Ç¨)</label>
        <input type="number" inputmode="decimal" id="f-prix" placeholder="0" min="0">
      </div>
      <div class="form-row">
        <label>Note /5</label>
        <select id="f-note">
          <option value="">‚Äî</option>
          <option value="1">‚òÖ 1</option><option value="2">‚òÖ‚òÖ 2</option>
          <option value="3">‚òÖ‚òÖ‚òÖ 3</option><option value="4">‚òÖ‚òÖ‚òÖ‚òÖ 4</option>
          <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 5</option>
        </select>
      </div>
      <div class="form-row form-full">
        <label>Notes personnelles</label>
        <textarea id="f-notes" rows="3" placeholder="Ar√¥mes, accords mets-vins, occasion..."></textarea>
      </div>
      <div class="form-row">
        <label>D√©but apog√©e (ann√©e)</label>
        <input type="number" inputmode="numeric" id="f-apogee-debut" placeholder="ex: 2026" min="2000" max="2060">
      </div>
      <div class="form-row">
        <label>Fin apog√©e (ann√©e)</label>
        <input type="number" inputmode="numeric" id="f-apogee-fin" placeholder="ex: 2035" min="2000" max="2060">
      </div>
      <div class="form-row form-full">
        <label>Photo √©tiquette</label>
        <div id="img-preview-wrap" style="display:none;margin-bottom:10px;position:relative;width:fit-content">
          <img id="img-preview" src="" alt="Aper√ßu √©tiquette" style="max-height:160px;max-width:100%;object-fit:contain;border-radius:4px;border:1px solid var(--border);box-shadow:0 4px 16px rgba(0,0,0,0.5)">
          <button type="button" onclick="clearImage()" title="Supprimer" style="position:absolute;top:-8px;right:-8px;width:22px;height:22px;border-radius:50%;background:var(--wine2);border:none;color:white;cursor:pointer;font-size:0.75rem;line-height:1">‚úï</button>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
          <label for="f-photo-camera" style="white-space:nowrap;padding:9px 14px;background:var(--wine);border:none;color:var(--cream);font-family:'Cormorant Garamond',serif;font-size:0.95rem;letter-spacing:1px;cursor:pointer;border-radius:2px;transition:background 0.2s;flex-shrink:0;display:inline-flex;align-items:center;gap:6px" class="btn-action-wine">üì∑ Prendre une photo</label>
          <input type="file" id="f-photo-camera" accept="image/*" capture="environment" style="display:none" onchange="handleImageFile(this)">
          <label for="f-photo-file" style="white-space:nowrap;padding:9px 14px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);font-family:'Cormorant Garamond',serif;font-size:0.95rem;letter-spacing:1px;cursor:pointer;border-radius:2px;transition:all 0.2s;flex-shrink:0;display:inline-flex;align-items:center;gap:6px" class="btn-action-file">üñº Depuis la galerie</label>
          <input type="file" id="f-photo-file" accept="image/*" style="display:none" onchange="handleImageFile(this)">
          <button type="button" onclick="searchVivino()" style="white-space:nowrap;padding:9px 14px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);font-family:'Cormorant Garamond',serif;font-size:0.95rem;letter-spacing:1px;cursor:pointer;border-radius:2px;transition:all 0.2s;flex-shrink:0" class="btn-action-file">üçá Vivino</button>
        </div>
        <input type="text" id="f-image" placeholder="ou coller une URL d'image‚Ä¶" style="width:100%;padding:7px 10px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);border-radius:2px;outline:none;font-family:'Cormorant Garamond',serif;font-size:0.88rem" oninput="onImageUrlChange(this.value)" onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='var(--border)'">
        <div id="vivino-results" style="display:none;margin-top:10px;background:var(--bg3);border:1px solid var(--border);border-radius:3px;padding:14px">
          <div id="vivino-loading"></div>
          <div id="vivino-grid"></div>
        </div>
      </div>
    </div>
    <div style="margin-top:20px">
      <button class="btn-wine" onclick="addWine()">Ajouter √† la cave</button>
    </div>
  </div>
</div>

<!-- ===== D√âGUSTATION VIEW (historique cave + hors cave) ===== -->
<div id="historique" class="content" role="tabpanel" aria-labelledby="tab-historique" tabindex="0">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <div>
      <h2 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.4rem">ü•Ç D√©gustations</h2>
      <div style="color:var(--text2);font-size:0.78rem;margin-top:4px;display:flex;gap:14px;flex-wrap:wrap;align-items:center">
        <span>Vins de ma cave</span>
        <span style="border:1px solid rgba(201,168,76,0.3);border-radius:10px;padding:1px 8px;background:rgba(201,168,76,0.07);color:var(--text2)">hors cave</span>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <span id="histo-count" style="color:var(--text2);font-size:0.85rem"></span>
      <button onclick="openAddDegustation()" style="padding:9px 18px;background:var(--wine);border:none;color:var(--cream);font-family:'Cormorant Garamond',serif;font-size:0.95rem;letter-spacing:1px;cursor:pointer;border-radius:2px;transition:background 0.2s;display:flex;align-items:center;gap:6px" class="btn-action-wine">Ôºã Hors cave</button>
    </div>
  </div>
  <!-- Filtres -->
  <div style="display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap;align-items:center">
    <input type="text" id="histo-search" placeholder="Rechercher‚Ä¶" oninput="renderHistorique()"
      style="flex:1;min-width:180px;max-width:320px;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:0.95rem;border-radius:2px;outline:none"
      onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='var(--border)'">
    <select id="histo-filter-source" onchange="renderHistorique()" style="padding:8px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:0.95rem;border-radius:2px;outline:none">
      <option value="">Toutes les sources</option>
      <option value="cave">De ma cave</option>
      <option value="hors_cave">Hors cave</option>
    </select>
    <select id="histo-filter-type" onchange="renderHistorique()" style="padding:8px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:0.95rem;border-radius:2px;outline:none">
      <option value="">Tous les types</option>
      <option value="rouge">Rouge</option>
      <option value="blanc">Blanc</option>
      <option value="ros√©">Ros√©</option>
      <option value="effervescent">Effervescent</option>
      <option value="vdn_blanc">VDN Blanc</option>
      <option value="vdn_rouge">VDN Rouge</option>
      <option value="liquoreux">Liquoreux</option>
    </select>
  </div>
  <div id="histo-empty" style="display:none;text-align:center;padding:60px 0;color:var(--text2);font-style:italic">Aucune d√©gustation enregistr√©e</div>
  <div id="histo-list"></div>
</div>

<!-- ===== ACCORDS VIEW ===== -->
<div id="accords" class="content" role="tabpanel" aria-labelledby="tab-accords" tabindex="0">
  <div style="display:flex;gap:20px;flex-wrap:wrap;margin-bottom:28px">

    <!-- Recherche plat -> vin -->
    <div style="flex:1;min-width:280px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:22px">
      <h3 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.15rem;margin-bottom:6px">üçΩ J'ai un plat, quel vin ?</h3>
      <p style="color:var(--text2);font-size:0.85rem;margin-bottom:16px">Tapez un plat ou un ingr√©dient</p>
      <div style="display:flex;gap:8px">
        <input type="text" id="accord-plat-input" placeholder="ex: agneau, fromage, saumon..."
          style="flex:1;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:1rem;border-radius:2px;outline:none"
          onkeydown="if(event.key==='Enter') rechercherParPlat()"
          onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='var(--border)'">
        <button onclick="rechercherParPlat()" style="padding:9px 18px;background:var(--wine);border:none;color:var(--cream);font-family:'Cormorant Garamond',serif;font-size:1rem;cursor:pointer;border-radius:2px">Chercher</button>
      </div>
      <div id="accord-plat-results" style="margin-top:16px"></div>
    </div>

    <!-- Recherche vin -> plat -->
    <div style="flex:1;min-width:280px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:22px">
      <h3 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.15rem;margin-bottom:6px">üç∑ J'ai un vin, quel plat ?</h3>
      <p style="color:var(--text2);font-size:0.85rem;margin-bottom:16px">Choisissez un vin de votre cave</p>
      <select id="accord-vin-select"
        style="width:100%;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:1rem;border-radius:2px;outline:none"
        onchange="rechercherParVin(this.value)">
        <option value="">‚Äî Choisir un vin ‚Äî</option>
      </select>
      <div id="accord-vin-results" style="margin-top:16px"></div>
    </div>

  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalSlot">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modalSlot')">‚úï</button>
    <h2 id="modal-title">Emplacement</h2>
    <div id="modal-body"></div>
  </div>
</div>

<div id="tooltip">
  <div id="tt-img-wrap" style="margin-bottom:8px;display:none">
    <img id="tt-img" src="" alt="Photo du vin" style="width:100%;height:120px;object-fit:cover;border-radius:3px;border:1px solid var(--border)">
  </div>
  <div class="tt-name" id="tt-name"></div>
  <div class="tt-info" id="tt-info"></div>
</div>
<!-- ===== APOGEE VIEW ===== -->
<div id="apogee" class="content" role="tabpanel" aria-labelledby="tab-apogee" tabindex="0">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px">
    <h2 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.4rem">üîî Alertes d'apog√©e</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button onclick="filtreApogee('tous')" id="btn-ap-tous" class="cave-btn active">Tous</button>
      <button onclick="filtreApogee('maintenant')" id="btn-ap-maintenant" class="cave-btn">üü¢ √Ä boire</button>
      <button onclick="filtreApogee('bientot')" id="btn-ap-bientot" class="cave-btn">üü° Bient√¥t</button>
      <button onclick="filtreApogee('jeune')" id="btn-ap-jeune" class="cave-btn">üîµ Trop jeune</button>
      <button onclick="filtreApogee('depasse')" id="btn-ap-depasse" class="cave-btn">üî¥ D√©pass√©</button>
    </div>
  </div>
  <div id="apogee-list"></div>
</div>

<!-- ===== CARTE DES VIGNOBLES ===== -->
<div id="carte" class="content" role="tabpanel" aria-labelledby="tab-carte" tabindex="0" style="padding:16px 20px">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px">
    <div>
      <h2 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.4rem">üåçÔ∏è Carte des vignobles</h2>
      <div style="color:var(--text2);font-size:0.75rem;margin-top:2px">102 r√©gions ¬∑ couches WMS officielles INAO + fronti√®res pays</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div id="carte-legend" style="display:flex;gap:10px;flex-wrap:wrap;font-size:0.78rem;color:var(--text2)"></div>
    </div>
  </div>
  <!-- Filtres rapides par pays -->
  <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;align-items:center">
    <button onclick="resetToEurope()" style="padding:4px 11px;background:var(--bg2);border:1px solid var(--gold);color:var(--gold);cursor:pointer;border-radius:2px;font-size:0.75rem;font-family:'Cormorant Garamond',serif;transition:all 0.2s;font-weight:600">üåç Europe</button>
    <button id="btn-inao-toggle" onclick="toggleInaoLayer()" style="padding:4px 10px;background:#1a2e1a;border:1px solid #4a8a4a;color:#7aba7a;cursor:pointer;border-radius:2px;font-size:0.75rem;font-family:'Cormorant Garamond',serif;transition:all 0.2s;font-weight:600" title="Afficher/masquer les d√©limitations officielles INAO (France)">üèõÔ∏è AOC France</button>
    <button onclick="carteZoomPays('France')"    style="padding:4px 10px;background:var(--bg3);border:1px solid #3a2830;color:var(--text2);cursor:pointer;border-radius:2px;font-size:0.75rem;font-family:'Cormorant Garamond',serif;transition:all 0.2s" class="btn-action-country">üá´üá∑ France</button>
    <button onclick="carteZoomPays('Espagne')"   style="padding:4px 10px;background:var(--bg3);border:1px solid #3a2830;color:var(--text2);cursor:pointer;border-radius:2px;font-size:0.75rem;font-family:'Cormorant Garamond',serif;transition:all 0.2s" class="btn-action-country">üá™üá∏ Espagne</button>
    <button onclick="carteZoomPays('Portugal')"  style="padding:4px 10px;background:var(--bg3);border:1px solid #3a2830;color:var(--text2);cursor:pointer;border-radius:2px;font-size:0.75rem;font-family:'Cormorant Garamond',serif;transition:all 0.2s" class="btn-action-country">üáµüáπ Portugal</button>
    <button onclick="carteZoomPays('Italie')"    style="padding:4px 10px;background:var(--bg3);border:1px solid #3a2830;color:var(--text2);cursor:pointer;border-radius:2px;font-size:0.75rem;font-family:'Cormorant Garamond',serif;transition:all 0.2s" class="btn-action-country">üáÆüáπ Italie</button>
    <button onclick="carteZoomPays('Allemagne')" style="padding:4px 10px;background:var(--bg3);border:1px solid #3a2830;color:var(--text2);cursor:pointer;border-radius:2px;font-size:0.75rem;font-family:'Cormorant Garamond',serif;transition:all 0.2s" class="btn-action-country">üá©üá™ Allemagne</button>
    <button onclick="carteZoomPays('Autriche')"  style="padding:4px 10px;background:var(--bg3);border:1px solid #3a2830;color:var(--text2);cursor:pointer;border-radius:2px;font-size:0.75rem;font-family:'Cormorant Garamond',serif;transition:all 0.2s" class="btn-action-country">üá¶üáπ Autriche</button>
    <button onclick="carteZoomPays('Gr√®ce')"     style="padding:4px 10px;background:var(--bg3);border:1px solid #3a2830;color:var(--text2);cursor:pointer;border-radius:2px;font-size:0.75rem;font-family:'Cormorant Garamond',serif;transition:all 0.2s" class="btn-action-country">üá¨üá∑ Gr√®ce</button>
    <button onclick="carteZoomPays('Hongrie')"   style="padding:4px 10px;background:var(--bg3);border:1px solid #3a2830;color:var(--text2);cursor:pointer;border-radius:2px;font-size:0.75rem;font-family:'Cormorant Garamond',serif;transition:all 0.2s" class="btn-action-country">üá≠üá∫ Hongrie</button>
  </div>
  <div id="carte-wrap" style="position:relative;background:#0d1520;border:1px solid var(--border);border-radius:4px;overflow:hidden;height:620px">
    <div id="carte-leaflet" style="width:100%;height:100%"></div>
    <div id="carte-tooltip" style="display:none;position:absolute;background:var(--bg2);border:1px solid var(--gold);border-radius:3px;padding:10px 14px;pointer-events:none;z-index:1000;min-width:180px;box-shadow:0 4px 20px rgba(0,0,0,0.6);font-size:0.85rem"></div>
    <div id="carte-zoom-hint" style="position:absolute;bottom:40px;left:10px;color:rgba(255,255,255,0.6);font-size:0.68rem;z-index:999;background:rgba(0,0,0,0.55);padding:3px 8px;border-radius:3px;pointer-events:none;transition:opacity 0.3s">üîç Zoomez sur la France (zoom 10+) pour voir les d√©limitations AOC parcellaires</div>
    <div style="position:absolute;bottom:8px;left:10px;color:rgba(255,255,255,0.4);font-size:0.68rem;z-index:999;background:rgba(0,0,0,0.4);padding:2px 6px;border-radius:2px;pointer-events:none">Molette pour zoomer ¬∑ Glisser pour d√©placer</div>
  </div>
  <div style="margin-top:14px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:16px">
    <div id="carte-region-title" style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1rem;margin-bottom:12px">Cliquez sur un point pour voir les vins</div>
    <div id="carte-region-list"></div>
  </div>
</div>

<!-- ===== D√âGUSTATIONS HORS CAVE ===== -->


<!-- MODAL AJOUT D√âGUSTATION -->
<div class="modal-overlay" id="modalDegustation">
  <div class="modal" style="max-width:640px;max-height:90vh;overflow-y:auto">
    <button class="modal-close" onclick="closeModal('modalDegustation')">‚úï</button>
    <h2 id="deg-modal-title" style="font-family:'Playfair Display',serif;color:var(--gold);margin-bottom:20px">ü•Ç Nouvelle d√©gustation</h2>
    <div class="form-grid">
      <!-- Photo -->
      <div class="form-row form-full">
        <label>Photo √©tiquette</label>
        <div id="deg-img-preview-wrap" style="display:none;margin-bottom:10px;position:relative;width:fit-content">
          <img id="deg-img-preview" src="" alt="Aper√ßu √©tiquette" style="max-height:160px;max-width:100%;object-fit:contain;border-radius:4px;border:1px solid var(--border);box-shadow:0 4px 16px rgba(0,0,0,0.5)">
          <button type="button" onclick="clearDegImageAndNotify()" title="Retirer l'image" style="position:absolute;top:-8px;right:-8px;width:22px;height:22px;border-radius:50%;background:var(--wine2);border:none;color:white;cursor:pointer;font-size:0.75rem;line-height:1">‚úï</button>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <label for="deg-photo-camera" style="padding:8px 14px;background:var(--wine);color:var(--cream);font-family:'Cormorant Garamond',serif;font-size:0.9rem;cursor:pointer;border-radius:2px;display:inline-flex;align-items:center;gap:5px" class="btn-action-wine">üì∑ Photo</label>
          <input type="file" id="deg-photo-camera" accept="image/*" capture="environment" style="display:none" onchange="handleDegImageFile(this)">
          <label for="deg-photo-file" style="padding:8px 14px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);font-family:'Cormorant Garamond',serif;font-size:0.9rem;cursor:pointer;border-radius:2px;display:inline-flex;align-items:center;gap:5px" class="btn-action-file">üñº Galerie</label>
          <input type="file" id="deg-photo-file" accept="image/*" style="display:none" onchange="handleDegImageFile(this)">
        </div>
        <input type="text" id="deg-image" placeholder="ou URL d'image‚Ä¶" style="width:100%;padding:7px 10px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);border-radius:2px;outline:none;font-family:'Cormorant Garamond',serif;font-size:0.88rem" oninput="onDegImageUrlChange(this.value)" onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='var(--border)'">
      </div>
      <!-- Infos vin -->
      <div class="form-row form-full">
        <label>Nom / Cuv√©e *</label>
        <input type="text" id="deg-nom" placeholder="ex: Barolo Cannubi, Sancerre‚Ä¶">
      </div>
      <div class="form-row form-full">
        <label>Appellation</label>
        <input type="text" id="deg-appellation" placeholder="ex: AOC Bourgogne">
      </div>
      <div class="form-row">
        <label>Domaine / Producteur</label>
        <input type="text" id="deg-domaine" placeholder="ex: Domaine Leflaive">
      </div>
      <div class="form-row">
        <label>R√©gion</label>
        <input type="text" id="deg-region" placeholder="ex: Bourgogne, Toscane‚Ä¶">
      </div>
      <div class="form-row">
        <label>Type</label>
        <select id="deg-type">
          <option value="rouge">Rouge</option>
          <option value="blanc">Blanc</option>
          <option value="ros√©">Ros√©</option>
          <option value="effervescent">Effervescent</option>
          <option value="vdn_blanc">VDN Blanc</option>
          <option value="vdn_rouge">VDN Rouge</option>
          <option value="liquoreux">Liquoreux</option>
        </select>
      </div>
      <div class="form-row">
        <label>Mill√©sime</label>
        <input type="number" inputmode="numeric" id="deg-annee" placeholder="2019" min="1900" max="2030">
      </div>
      <div class="form-row">
        <label>Prix pay√© (‚Ç¨)</label>
        <input type="number" inputmode="decimal" id="deg-prix" placeholder="0" min="0">
      </div>
      <div class="form-row">
        <label>Note /5</label>
        <select id="deg-note">
          <option value="">‚Äî</option>
          <option value="1">‚òÖ 1</option><option value="2">‚òÖ‚òÖ 2</option>
          <option value="3">‚òÖ‚òÖ‚òÖ 3</option><option value="4">‚òÖ‚òÖ‚òÖ‚òÖ 4</option>
          <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 5</option>
        </select>
      </div>
      <div class="form-row">
        <label>Date de d√©gustation</label>
        <input type="date" id="deg-date">
      </div>
      <div class="form-row">
        <label>Occasion / Lieu</label>
        <input type="text" id="deg-occasion" placeholder="Restaurant, voyage, cadeau‚Ä¶">
      </div>
      <div class="form-row form-full">
        <label>Commentaire de d√©gustation</label>
        <textarea id="deg-commentaire" rows="3" placeholder="Ar√¥mes, texture, accord, impression g√©n√©rale‚Ä¶"></textarea>
      </div>
      <div class="form-row form-full">
        <label>Racheter ?</label>
        <select id="deg-racheter">
          <option value="">‚Äî</option>
          <option value="oui">‚úÖ Oui, absolument</option>
          <option value="peut-etre">ü§î Peut-√™tre</option>
          <option value="non">‚ùå Non</option>
        </select>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:22px">
      <button class="btn-wine" onclick="saveDegustation()">üíæ Enregistrer</button>
      <button class="btn-outline" onclick="closeModal('modalDegustation')">Annuler</button>
    </div>
  </div>
</div>

<!-- MODAL DEPLACEMENT -->
<div class="modal-overlay" id="modalDeplacer">
  <div class="modal" style="max-width:480px">
    <button class="modal-close" onclick="closeModal('modalDeplacer')">‚úï</button>
    <h2>üì¶ D√©placer la bouteille</h2>
    <p id="deplacer-wine-name" style="color:var(--cream);font-family:'Playfair Display',serif;font-size:1.1rem;margin-bottom:20px"></p>
    <div class="form-grid">
      <div class="form-row">
        <label>Cave</label>
        <select id="dep-cave" onchange="updateDepEtage()">
          <option value="1">Cave 1</option>
          <option value="2">Cave 2</option>
        </select>
      </div>
      <div class="form-row">
        <label>√âtage</label>
        <select id="dep-etage" onchange="updateDepSlot()"></select>
      </div>
      <div class="form-row form-full">
        <label>Emplacement</label>
        <select id="dep-slot"></select>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:20px">
      <button class="btn-wine" onclick="confirmerDeplacement()">üì¶ Confirmer le d√©placement</button>
      <button class="btn-outline" onclick="closeModal('modalDeplacer')">Annuler</button>
    </div>
  </div>
</div>

<!-- MODAL DUPLICATION -->
<div class="modal-overlay" id="modalDupliquer">
  <div class="modal" style="max-width:540px;max-height:90vh;overflow-y:auto">
    <button class="modal-close" onclick="closeModal('modalDupliquer')">‚úï</button>
    <h2>‚ßâ Dupliquer la bouteille</h2>
    <p id="dup-wine-name" style="color:var(--cream);font-family:'Playfair Display',serif;font-size:1.1rem;margin-bottom:4px"></p>
    <p style="color:var(--text2);font-size:0.85rem;margin-bottom:20px">Chaque copie recevra un emplacement et un identifiant unique.</p>
    <div class="form-row form-full" style="margin-bottom:18px">
      <label>Nombre de copies</label>
      <select id="dup-count" onchange="renderDupSlots()">
        <option value="1">1 copie</option>
        <option value="2">2 copies</option>
        <option value="3">3 copies</option>
        <option value="4">4 copies</option>
        <option value="5">5 copies</option>
      </select>
    </div>
    <div id="dup-slots-container"></div>
    <div id="dup-warning" style="display:none;margin-top:12px;padding:10px 14px;background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.25);border-radius:3px;color:var(--text2);font-size:0.85rem"></div>
    <div class="modal-actions" style="margin-top:20px">
      <button class="btn-wine" onclick="confirmerDuplication()">‚ßâ Confirmer la duplication</button>
      <button class="btn-outline" onclick="closeModal('modalDupliquer')">Annuler</button>
    </div>
  </div>
</div>

<!-- MODAL HISTORIQUE (retirer un vin) -->
<div class="modal-overlay" id="modalHistorique">
  <div class="modal" style="max-width:480px">
    <button class="modal-close" onclick="document.getElementById('modalHistorique').classList.remove('open')">‚úï</button>
    <h2>üç∑ Retirer de la cave</h2>
    <p style="color:var(--text2);margin-bottom:20px;font-size:0.95rem">
      Voulez-vous enregistrer <b id="histo-wine-name" style="color:var(--cream)"></b> dans l'historique avant de la retirer ?
    </p>
    <div class="form-grid">
      <div class="form-row">
        <label>Date de d√©gustation</label>
        <input type="date" id="histo-date">
      </div>
      <div class="form-row">
        <label>Note sur 5</label>
        <select id="histo-note">
          <option value="">‚Äî</option>
          <option value="1">‚òÖ 1</option>
          <option value="2">‚òÖ‚òÖ 2</option>
          <option value="3">‚òÖ‚òÖ‚òÖ 3</option>
          <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ 4</option>
          <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 5</option>
        </select>
      </div>
      <div class="form-row form-full">
        <label>Occasion</label>
        <input type="text" id="histo-occasion" placeholder="Repas en famille, anniversaire, seul...">
      </div>
      <div class="form-row form-full">
        <label>Commentaire de d√©gustation</label>
        <textarea id="histo-commentaire" rows="3" placeholder="Ar√¥mes, texture, accord, impression g√©n√©rale..."></textarea>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:20px">
      <button class="btn-wine" onclick="confirmRetirer(true)">üìú Enregistrer et retirer</button>
      <button class="btn-outline" onclick="confirmRetirer(false)">üóë Retirer sans enregistrer</button>
      <button class="btn-outline" onclick="document.getElementById('modalHistorique').classList.remove('open')">Annuler</button>
    </div>
  </div>
</div>

<!-- MODAL √âDITION HISTORIQUE CAVE -->
<div class="modal-overlay" id="modalEditHistorique">
  <div class="modal" style="max-width:580px;max-height:90vh;overflow-y:auto">
    <button class="modal-close" onclick="closeModal('modalEditHistorique')">‚úï</button>
    <h2 id="edit-histo-title" style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.2rem;margin-bottom:18px">‚úèÔ∏è Modifier la d√©gustation</h2>
    <!-- Image -->
    <div class="form-row">
      <label>Photo √©tiquette</label>
      <div id="edit-histo-img-wrap" style="display:none;margin-bottom:10px;position:relative;width:fit-content">
        <img id="edit-histo-img-preview" src="" alt="Aper√ßu √©tiquette" style="max-height:140px;max-width:100%;object-fit:contain;border-radius:4px;border:1px solid var(--border);box-shadow:0 2px 12px rgba(0,0,0,0.5)">
        <button type="button" onclick="clearHistoImage()" title="Supprimer l'image" style="position:absolute;top:-8px;right:-8px;width:22px;height:22px;border-radius:50%;background:var(--wine2);border:none;color:white;cursor:pointer;font-size:0.75rem;line-height:1">‚úï</button>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <label for="edit-histo-photo-camera" style="padding:7px 13px;background:var(--wine);color:var(--cream);font-family:'Cormorant Garamond',serif;font-size:0.88rem;cursor:pointer;border-radius:2px;display:inline-flex;align-items:center;gap:5px" class="btn-action-wine">üì∑ Photo</label>
        <input type="file" id="edit-histo-photo-camera" accept="image/*" capture="environment" style="display:none" onchange="handleHistoImageFile(this)">
        <label for="edit-histo-photo-file" style="padding:7px 13px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);font-family:'Cormorant Garamond',serif;font-size:0.88rem;cursor:pointer;border-radius:2px;display:inline-flex;align-items:center;gap:5px" class="btn-action-file">üñº Galerie</label>
        <input type="file" id="edit-histo-photo-file" accept="image/*" style="display:none" onchange="handleHistoImageFile(this)">
      </div>
      <input type="text" id="edit-histo-image" placeholder="ou URL d'image‚Ä¶" style="width:100%;padding:7px 10px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);border-radius:2px;outline:none;font-family:'Cormorant Garamond',serif;font-size:0.88rem" oninput="onHistoImageUrlChange(this.value)" onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='var(--border)'">
    </div>
    <div class="form-grid" style="margin-top:4px">
      <div class="form-row">
        <label>Date de d√©gustation</label>
        <input type="date" id="edit-histo-date">
      </div>
      <div class="form-row">
        <label>Note /5</label>
        <select id="edit-histo-note">
          <option value="">‚Äî</option>
          <option value="1">‚òÖ 1</option><option value="2">‚òÖ‚òÖ 2</option>
          <option value="3">‚òÖ‚òÖ‚òÖ 3</option><option value="4">‚òÖ‚òÖ‚òÖ‚òÖ 4</option>
          <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 5</option>
        </select>
      </div>
      <div class="form-row form-full">
        <label>Occasion / Lieu</label>
        <input type="text" id="edit-histo-occasion" placeholder="Repas en famille, anniversaire‚Ä¶">
      </div>
      <div class="form-row form-full">
        <label>Commentaire de d√©gustation</label>
        <textarea id="edit-histo-commentaire" rows="3" placeholder="Ar√¥mes, texture, impression g√©n√©rale‚Ä¶"></textarea>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:18px">
      <button class="btn-wine" onclick="saveEditHistorique()">üíæ Enregistrer</button>
      <button class="btn-outline" onclick="closeModal('modalEditHistorique')">Annuler</button>
    </div>
  </div>
</div>

<!-- iframe hidden-sync-frame supprim√©e (inutilis√©e) -->
<div id="notif"></div>

<script>
function formatDateFR(dateStr) {
  if(!dateStr) return '';
  // Nettoyer : prendre uniquement la partie date si c'est un ISO ou Date string complet
  const clean = String(dateStr).trim();
  // Extraire YYYY-MM-DD depuis ISO ou Date string
  const isoMatch = clean.match(/(\d{4})-(\d{2})-(\d{2})/);
  if(isoMatch) {
    const [, y, m, d] = isoMatch;
    return new Date(y, m-1, d).toLocaleDateString('fr-FR', {day:'numeric', month:'long', year:'numeric'});
  }
  // Tenter parsing direct (ex: "Sun Feb 22 2026...")
  const parsed = new Date(clean);
  if(!isNaN(parsed)) return parsed.toLocaleDateString('fr-FR', {day:'numeric', month:'long', year:'numeric'});
  return clean;
}


// =====================================================================
// CONFIG
// =====================================================================
/*
  front  = bouteilles rang√©e avant (grand cercle = CUL visible)
  back   = bouteilles rang√©e arri√®re (petit cercle = GOULOT visible, c√¥te √† c√¥te)
  double = 2 couches identiques sur le m√™me √©tage
  isMagnum = marqu√© Magnum dans formulaire/liste
  slots  = total emplacements
  Cave 1 : √©tage 1 en HAUT, √©tage 8 en BAS
*/
const CAVE_CONFIG = {
  1: {
    floors: [
      { id:1, front:6, back:6, double:true,  isMagnum:false, label:'√âtage 1',           slots:24 },
      { id:2, front:6, back:6, double:false, isMagnum:false, label:'√âtage 2',           slots:12 },
      { id:3, front:6, back:6, double:false, isMagnum:false, label:'√âtage 3',           slots:12 },
      { id:4, front:6, back:6, double:false, isMagnum:false, label:'√âtage 4',           slots:12 },
      { id:5, front:6, back:6, double:true,  isMagnum:false, label:'√âtage 5',           slots:24 },
      { id:6, front:6, back:6, double:true,  isMagnum:false, label:'√âtage 6',           slots:24 },
      { id:7, front:6, back:6, double:true,  isMagnum:false, label:'√âtage 7',           slots:24 },
      { id:8, front:6, back:6, double:false, isMagnum:true,  label:'√âtage 8 (Magnums)', slots:12 },
    ]
  },
  2: {
  floors: [
    { id:1, front:6, back:5, double:true, isMagnum:false, label:'√âtage 1', slots:22 },
    { id:2, front:6, back:5, double:true, isMagnum:false, label:'√âtage 2', slots:22 },
    { id:3, front:6, back:5, double:true, isMagnum:false, label:'√âtage 3', slots:22 },
    { id:4, front:6, back:5, double:true, isMagnum:false, label:'√âtage 4', slots:22 },
    { id:5, front:6, back:5, double:true, isMagnum:false, label:'√âtage 5', slots:22 },
  ]
}
};

// =====================================================================
// DATA
// =====================================================================
// =====================================================================
// CLOUDINARY CONFIG
// =====================================================================
const CLOUDINARY_CLOUD = 'dvrevescl';
const CLOUDINARY_PRESET = 'Degustation';
const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`;

// =====================================================================
// IMAGE STORE ‚Äî stockage persistant des URLs Cloudinary
// ind√©pendant de la sync Google Sheets
// cl√© : "wine_<id>" | "hist_<id>" | "deg_<id>"
// =====================================================================
const _imgStore = JSON.parse(localStorage.getItem('imageStore') || '{}');

function imgSave(key, url) {
  if(url) _imgStore[key] = url;
  else     delete _imgStore[key];
  localStorage.setItem('imageStore', JSON.stringify(_imgStore));
}
function imgGet(key) { return _imgStore[key] || ''; }

// Retourne l'URL d'image pour un vin : priorit√© imageStore > champ .image
function wineImg(w)    { return imgGet('wine_' + w.id)    || w.image    || ''; }
function histImg(h)    { return imgGet('hist_' + h.id)    || h.image    || ''; }
function degImg(d)     { return imgGet('deg_'  + d.id)    || d.image    || ''; }

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_GkA2thpGf_tCdgMtoVYt5-xANAztBu6Rmks9SE5-9yF8_jdbBu7iXbgS13_5iqH_6Q/exec';

// Chargement initial + d√©duplication imm√©diate du localStorage
// (prot√®ge contre les doublons accumul√©s par d'anciennes versions du code)
let wineData = (function() {
  try {
    const raw = JSON.parse(localStorage.getItem('caveData') || '[]');
    if (!Array.isArray(raw) || raw.length === 0) return [];
    const seenSlot = new Set(), seenId = new Set(), clean = [];
    for (const w of raw) {
      const sk = w.cave + '_' + w.floor + '_' + w.slot;
      const ik = w.id ? String(w.id).trim() : null;
      if (seenSlot.has(sk) || (ik && seenId.has(ik))) continue;
      seenSlot.add(sk); if (ik) seenId.add(ik);
      clean.push(w);
    }
    if (clean.length !== raw.length) {
      console.warn('[CAVE] localStorage: ' + raw.length + ' ‚Üí ' + clean.length + ' vins (doublons supprim√©s)');
      localStorage.setItem('caveData', JSON.stringify(clean));
    }
    return clean;
  } catch(e) { return []; }
})();
let currentCave = 1;
let addingToSlot = null;

const TYPE_LABELS   = { rouge:'Rouge', blanc:'Blanc', 'ros√©':'Ros√©', effervescent:'Effervescent', vdn_blanc:'VDN Blanc', vdn_rouge:'VDN Rouge', liquoreux:'Liquoreux' };
const FORMAT_LABELS = { '75cl':'75 cl','37.5cl':'37,5 cl','62cl':'62 cl','150cl':'Magnum 150 cl','300cl':'Double Magnum','autre':'Autre' };
const WINE_COLORS = {
  rouge:        { fill:'#8a1828', stroke:'#c04060', small:'#5a1020' },
  blanc:        { fill:'#a88018', stroke:'#e0c060', small:'#6a5010' },
  'ros√©':       { fill:'#b84068', stroke:'#e080a0', small:'#803050' },
  effervescent: { fill:'#1e4870', stroke:'#5090c0', small:'#102840' },
  vdn_blanc:    { fill:'#b8901a', stroke:'#f5d97a', small:'#7a6010' },
  vdn_rouge:    { fill:'#6a2010', stroke:'#b05030', small:'#3e1008' },
  liquoreux:    { fill:'#c06020', stroke:'#e89040', small:'#803810' },
  empty:        { fill:'#1a1014', stroke:'#4a3040', small:'#2a1a22' }
};

// ‚îÄ‚îÄ Indicateur de sync dans le header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSyncIndicator(state) {
  // state: 'saving' | 'ok' | 'error'
  let el = document.getElementById('sync-indicator');
  if (!el) {
    el = document.createElement('div');
    el.id = 'sync-indicator';
    el.style.cssText = 'font-size:0.7rem;letter-spacing:1px;transition:all 0.3s;padding:2px 8px;border-radius:10px;white-space:nowrap';
    const statsBar = document.querySelector('.stats-bar');
    if (statsBar) statsBar.appendChild(el);
  }
  if (state === 'saving') {
    el.textContent = '‚è≥ sync‚Ä¶';
    el.style.color = 'var(--text2)';
    el.style.background = 'transparent';
  } else if (state === 'ok') {
    el.textContent = '‚úì sauvegard√©';
    el.style.color = 'var(--gold)';
    el.style.background = 'rgba(201,168,76,0.1)';
    setTimeout(() => { if (el) el.textContent = ''; el.style.background = 'transparent'; }, 3000);
  } else if (state === 'error') {
    el.textContent = '‚ö† non sync';
    el.style.color = '#d44';
    el.style.background = 'rgba(200,60,60,0.1)';
  }
}

// ‚îÄ‚îÄ File d'attente pour les sauvegardes √©chou√©es ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _pendingSave = false;
let _saveDebounceTimer = null;
// Horodatage de la derni√®re modification locale ‚Äî pour d√©tecter les conflits avec le Sheet
let _localDataTs = parseInt(localStorage.getItem('_localDataTs') || '0');

// ‚îÄ‚îÄ saveData : persiste localement + d√©clenche sync Sheet apr√®s debounce ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveData() {
  // Horodater la modification locale
  _localDataTs = Date.now();
  localStorage.setItem('_localDataTs', String(_localDataTs));
  localStorage.setItem('caveData', JSON.stringify(wineData));
  updateHeader();
  // Debounce : n'envoyer qu'une seule fois apr√®s 1.5s d'inactivit√©
  clearTimeout(_saveDebounceTimer);
  _saveDebounceTimer = setTimeout(() => _doSyncToSheets(), 1500);
}

// ‚îÄ‚îÄ _doSyncToSheets : envoie l'√©tat complet de wineData vers Google Sheets ‚îÄ‚îÄ‚îÄ
function _doSyncToSheets() {
  setSyncIndicator('saving');
  _pendingSave = true;
  // Inclure l'horodatage pour que le Sheet sache quelle version est la plus r√©cente
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'save', data: wineData, clientTs: _localDataTs })
  })
  .then(r => {
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return r.text();
  })
  .then(() => {
    _pendingSave = false;
    setSyncIndicator('ok');
  })
  .catch(e => {
    console.warn('Sync Google Sheets √©chou√©e', e);
    _pendingSave = false;
    setSyncIndicator('error');
    showNotif('‚ö† Sauvegarde non synchronis√©e ‚Äî sera retent√©e √† la prochaine connexion', true);
    localStorage.setItem('_pendingSync', '1');
  });
}

// ‚îÄ‚îÄ Normaliser les noms de champs Sheet ‚Üí camelCase JS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Google Sheets peut renvoyer les colonnes en camelCase ou snake_case selon la version
// Cette fonction unifie les deux formes pour √©viter les champs manquants apr√®s rechargement
function _normalizeWineFields(w) {
  const n = Object.assign({}, w);
  // apogeeDebut / apogee_debut ‚Üí toujours apogeeDebut
  if(n.apogee_debut !== undefined && n.apogeeDebut === undefined) { n.apogeeDebut = n.apogee_debut; delete n.apogee_debut; }
  if(n.apogee_fin !== undefined && n.apogeeFin === undefined)     { n.apogeeFin   = n.apogee_fin;   delete n.apogee_fin;   }
  // dateAjout / date_ajout
  if(n.date_ajout !== undefined && n.dateAjout === undefined)     { n.dateAjout   = n.date_ajout;   delete n.date_ajout;   }
  // S'assurer que l'ID est toujours une string non vide
  if(n.id !== undefined) n.id = String(n.id).trim();
  return n;
}

// ‚îÄ‚îÄ loadFromSheets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CORRECTIF PRINCIPAL :
//   ‚Ä¢ D√©duplication DERNIER GAGNE sur les donn√©es du Sheet
//     ‚Üí si un slot/id appara√Æt plusieurs fois (doublons h√©rit√©s),
//       c'est la DERNI√àRE ligne qui est gard√©e (= position apr√®s d√©placement)
//   ‚Ä¢ Guard _loadInProgress : un seul appel actif √† la fois
//   ‚Ä¢ Guard _pendingSave/_saveDebounceTimer : client gagne si save en cours
let _loadInProgress = false;
function loadFromSheets() {
  if (_loadInProgress) return;
  _loadInProgress = true;
  const overlay = document.getElementById('sync-loading-overlay');
  if (overlay) overlay.classList.remove('hidden');
  showNotif('Synchronisation en cours‚Ä¶');
  const cbName = 'caveCallback_' + Date.now();
  const timeout = setTimeout(() => {
    _loadInProgress = false;
    if (overlay) overlay.classList.add('hidden');
    showNotif('Mode hors ligne ‚Äî donn√©es locales', true);
    delete window[cbName];
    const s = document.getElementById('jsonp-script');
    if (s) s.remove();
  }, 8000);
  window[cbName] = function(sheetData) {
    clearTimeout(timeout);
    _loadInProgress = false;
    if (overlay) overlay.classList.add('hidden');
    try {
      if (Array.isArray(sheetData) && sheetData.length > 0) {
        // Client gagne si une sauvegarde est en vol
        if (_pendingSave || _saveDebounceTimer) {
          showNotif('Donn√©es locales conserv√©es (sauvegarde en cours) ‚úì');
          loadHistoriqueFromSheets();
          return;
        }
        // Images et prix march√© locaux index√©s par ID
        const localData = JSON.parse(localStorage.getItem('caveData') || '[]');
        const localImgById = {}, localPm = {};
        localData.forEach(w => {
          if (!w.id) return;
          const id = String(w.id);
          localImgById[id] = imgGet('wine_' + id) || w.image || '';
          if (w.prix_marche || w.prix_marche_manuel)
            localPm[id] = {
              prix_marche: w.prix_marche||'', prix_marche_manuel: w.prix_marche_manuel||'',
              prix_marche_min: w.prix_marche_min||'', prix_marche_max: w.prix_marche_max||'',
              prix_marche_tendance: w.prix_marche_tendance||'', prix_marche_date: w.prix_marche_date||''
            };
        });
        // ‚îÄ‚îÄ D√âDUPLICATION DERNIER GAGNE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Pourquoi DERNIER ? Le Sheet peut contenir des doublons h√©rit√©s :
        //   ligne 5  = ancienne position AVANT d√©placement
        //   ligne 85 = nouvelle position APR√àS d√©placement (√©crite par _doSyncToSheets)
        // Le PREMIER vu = ancienne position ‚Üí vin semblerait revenir en arri√®re.
        // Le DERNIER vu = bonne position ‚Üí comportement attendu.
        const bySlot = new Map(); // "cave_floor_slot" ‚Üí entr√©e
        const byId   = new Map(); // id ‚Üí slotKey (pour lib√©rer l'ancien slot si id change)
        for (const raw of sheetData) {
          const w     = _normalizeWineFields(raw);
          const cave  = parseInt(w.cave)  || 1;
          const floor = parseInt(w.floor) || 1;
          const slot  = parseInt(w.slot)  || 1;
          const id    = String(w.id || '').trim();
          if (!w.nom) continue; // ignorer lignes vides
          const sk = cave + '_' + floor + '_' + slot;
          // Si cet id √©tait d√©j√† dans un autre slot, lib√©rer l'ancien slot
          if (id && byId.has(id)) bySlot.delete(byId.get(id));
          // Construire l'entr√©e fusionn√©e
          const img = (id ? imgGet('wine_' + id) : '') || w.image || (id ? localImgById[id] : '') || '';
          if (img && id) imgSave('wine_' + id, img);
          const pm = (id ? localPm[id] : null) || {};
          bySlot.set(sk, {
            ...w, cave, floor, slot,
            annee: parseInt(w.annee) || '', prix: parseFloat(w.prix) || '',
            note: w.note || '', image: img,
            _prixEstime: parseFloat(w.prix_marche || w._prixEstime || pm.prix_marche || '') || '',
            prix_marche: w.prix_marche||pm.prix_marche||'',
            prix_marche_manuel: w.prix_marche_manuel||pm.prix_marche_manuel||'',
            prix_marche_min: w.prix_marche_min||pm.prix_marche_min||'',
            prix_marche_max: w.prix_marche_max||pm.prix_marche_max||'',
            prix_marche_tendance: w.prix_marche_tendance||pm.prix_marche_tendance||'',
            prix_marche_date: w.prix_marche_date||pm.prix_marche_date||''
          });
          if (id) byId.set(id, sk);
        }
        wineData = Array.from(bySlot.values());
        if (wineData.length !== sheetData.length)
          console.warn('[CAVE] Sheet d√©dupliqu√©: ' + sheetData.length + ' ‚Üí ' + wineData.length + ' vins');
        _localDataTs = Date.now();
        localStorage.setItem('_localDataTs', String(_localDataTs));
        localStorage.setItem('caveData', JSON.stringify(wineData));
        updateHeader(); renderCave2D();
        showNotif('Cave synchronis√©e ‚Äî ' + wineData.length + ' vins ‚úì');
        loadHistoriqueFromSheets();
        setTimeout(() => estimerTousLesVinsAuto(), 2000);
      } else {
        showNotif('Sheet vide ‚Äî donn√©es locales conserv√©es');
      }
    } catch(e) {
      console.error('[CAVE] loadFromSheets:', e);
      showNotif('Erreur de donn√©es ‚Äî donn√©es locales conserv√©es', true);
    } finally {
      delete window[cbName];
      const s = document.getElementById('jsonp-script');
      if (s) s.remove();
    }
  };
  const script = document.createElement('script');
  script.id = 'jsonp-script';
  script.src = SCRIPT_URL + '?callback=' + cbName + '&t=' + Date.now();
  script.onerror = function() {
    clearTimeout(timeout); _loadInProgress = false;
    if (overlay) overlay.classList.add('hidden');
    showNotif('Mode hors ligne ‚Äî donn√©es locales', true);
    delete window[cbName]; this.remove();
  };
  const old = document.getElementById('jsonp-script');
  if (old) old.remove();
  document.head.appendChild(script);
}

function getWineAtSlot(cave, floor, slot) { return wineData.find(w => w.cave===parseInt(cave) && w.floor===parseInt(floor) && w.slot===parseInt(slot)); }

// ‚îÄ‚îÄ Drag & Drop ‚Äî singletons module-level ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// _drag, _onDragMove, _onDragUp sont d√©clar√©s ICI UNE SEULE FOIS.
// Ils ne doivent PAS √™tre red√©clar√©s √† l'int√©rieur de renderCave2D, car cette
// fonction est appel√©e apr√®s chaque d√©placement et recr√©erait de nouvelles
// r√©f√©rences, rendant removeEventListener inop√©rant ‚Üí accumulation de handlers
// ‚Üí plusieurs saveData() en parall√®le ‚Üí doublons / suppressions dans le Sheet.
let _drag = null;

function _onDragMove(e) {
  if(!_drag) return;
  _drag.ghost.style.left = e.clientX + 'px';
  _drag.ghost.style.top  = e.clientY + 'px';

  // Highlight de la cible sous la souris
  const svg = document.getElementById('caveSvg');
  if(!svg) return;
  svg.querySelectorAll('circle[data-cave]').forEach(el => {
    const isSrc = parseInt(el.dataset.cave) === _drag.cave &&
                  parseInt(el.dataset.floor) === _drag.floor &&
                  parseInt(el.dataset.slot)  === _drag.slot;
    if(!isSrc) {
      const rect = el.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top  + rect.height/2;
      const dist = Math.hypot(e.clientX - cx, e.clientY - cy);
      const r = rect.width / 2;
      if(dist < r + 8) {
        el.setAttribute('stroke', '#c9a84c');
        el.setAttribute('stroke-width', '3');
        el.style.filter = 'url(#softglow)';
        el.dataset.hovered = '1';
      } else if(el.dataset.hovered) {
        const w = getWineAtSlot(parseInt(el.dataset.cave), parseInt(el.dataset.floor), parseInt(el.dataset.slot));
        const c = w ? (WINE_COLORS[w.type] || WINE_COLORS.empty) : WINE_COLORS.empty;
        el.setAttribute('stroke', c.stroke);
        el.setAttribute('stroke-width', w ? '1.8' : '0.6');
        delete el.dataset.hovered;
      }
    }
  });
}

function _onDragUp(e) {
  if(!_drag) return;

  const svg = document.getElementById('caveSvg');
  let target = null;

  if(svg) {
    svg.querySelectorAll('circle[data-cave]').forEach(el => {
      const isSrc = parseInt(el.dataset.cave) === _drag.cave &&
                    parseInt(el.dataset.floor) === _drag.floor &&
                    parseInt(el.dataset.slot)  === _drag.slot;
      if(!isSrc) {
        const rect = el.getBoundingClientRect();
        const cx = rect.left + rect.width/2;
        const cy = rect.top  + rect.height/2;
        const dist = Math.hypot(e.clientX - cx, e.clientY - cy);
        if(dist < rect.width/2 + 8) {
          target = {
            cave:  parseInt(el.dataset.cave),
            floor: parseInt(el.dataset.floor),
            slot:  parseInt(el.dataset.slot)
          };
        }
      }
    });
  }

  // Effectuer le d√©placement
  if(target) {
    const srcWine = getWineAtSlot(_drag.cave, _drag.floor, _drag.slot);
    const dstWine = getWineAtSlot(target.cave, target.floor, target.slot);

    if(srcWine) {
      srcWine.cave  = target.cave;
      srcWine.floor = target.floor;
      srcWine.slot  = target.slot;

      if(dstWine) {
        dstWine.cave  = _drag.cave;
        dstWine.floor = _drag.floor;
        dstWine.slot  = _drag.slot;
        if(dstWine.id) {
          const _img = imgGet('wine_' + String(dstWine.id)) || dstWine.image || '';
          if(_img) imgSave('wine_' + String(dstWine.id), _img);
        }
      }

      if(srcWine.id) {
        const _img = imgGet('wine_' + String(srcWine.id)) || srcWine.image || '';
        if(_img) imgSave('wine_' + String(srcWine.id), _img);
      }

      saveData();

      const flash = document.createElement('div');
      flash.style.cssText = `
        position:fixed; left:${e.clientX-40}px; top:${e.clientY-20}px;
        background:rgba(201,168,76,0.9); color:#0e0a0b;
        border-radius:6px; padding:4px 10px; font-size:11px; font-weight:bold;
        pointer-events:none; z-index:9999; opacity:1;
        transition:opacity 0.5s;
      `;
      flash.textContent = dstWine ? '‚áÑ √âchang√©' : '‚úì D√©plac√©';
      document.body.appendChild(flash);
      setTimeout(() => { flash.style.opacity = '0'; setTimeout(() => flash.remove(), 500); }, 800);
    }
  }

  // Nettoyage
  _drag.ghost.remove();
  _drag.srcEl.removeAttribute('opacity');
  _drag.srcEl.style.cursor = '';
  _drag = null;

  renderCave2D();
}

// Enregistrer les handlers UNE SEULE FOIS sur document
document.addEventListener('mousemove', _onDragMove);
document.addEventListener('mouseup',   _onDragUp);
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function updateHeader() {
  const c1 = wineData.filter(w=>w.cave==1).length;
  const c2 = wineData.filter(w=>w.cave==2).length;
  document.getElementById('hdr-total').textContent = wineData.length;
  document.getElementById('hdr-c1').textContent = c1;
  document.getElementById('hdr-c2').textContent = c2;
  // Prix saisi en priorit√©, sinon estimation Groq
  const val = wineData.reduce((s,w)=>s+(parseFloat(w.prix)||parseFloat(w._prixEstime)||0),0);
  document.getElementById('hdr-val').textContent = Math.round(val).toLocaleString('fr-FR')+' ‚Ç¨';
  // ‚îÄ‚îÄ Alerte "√Ä boire bient√¥t / Apog√©e d√©pass√©e" ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const now = new Date().getFullYear();
  const abientot = wineData.filter(w => {
    if(!w.apogee_debut) return false;
    const debut = parseInt(w.apogee_debut);
    return debut > now && debut - now <= 2;
  }).length;
  const depasse = wineData.filter(w => {
    if(!w.apogee_fin) return false;
    return parseInt(w.apogee_fin) < now;
  }).length;
  let banner = document.getElementById('apogee-alert-banner');
  if(!banner) {
    banner = document.createElement('div');
    banner.id = 'apogee-alert-banner';
    banner.style.cssText = 'width:100%;background:linear-gradient(90deg,rgba(123,28,46,0.18),rgba(201,168,76,0.10));border-top:1px solid rgba(201,168,76,0.2);padding:4px 40px;font-size:0.75rem;display:flex;gap:16px;align-items:center;flex-wrap:wrap;cursor:pointer;transition:background 0.2s';
    banner.onclick = () => switchTab('apogee', document.querySelector('[data-tab="apogee"]'));
    const hdr = document.querySelector('header');
    if(hdr) hdr.after(banner);
  }
  if(abientot > 0 || depasse > 0) {
    banner.style.display = 'flex';
    banner.innerHTML = (abientot ? `<span>üü° <b style="color:var(--gold)">${abientot}</b> vin${abientot>1?'s':''} √† apog√©e dans ‚â§ 2 ans</span>` : '')
      + (depasse ? `<span style="color:var(--wine3)">üî¥ <b>${depasse}</b> vin${depasse>1?'s':''} d√©pass√©${depasse>1?'s':''}</span>` : '')
      + `<span style="color:var(--text3);font-size:0.68rem;margin-left:auto">‚Üí Voir l'onglet Apog√©e</span>`;
  } else {
    banner.style.display = 'none';
  }
}

// =====================================================================
// TABS
// =====================================================================
function switchTab(id, el, skipHistory) {
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>{
    t.classList.remove('active');
    t.setAttribute('aria-selected', 'false');
  });
  document.getElementById(id).classList.add('active');
  if(el) {
    el.classList.add('active');
    el.setAttribute('aria-selected', 'true');
  } else {
    // S√©lection robuste par data-tab (ne d√©pend plus du texte de l'attribut onclick)
    const match = document.querySelector('.tab[data-tab="'+id+'"]');
    if(match) { match.classList.add('active'); match.setAttribute('aria-selected','true'); }
  }
  if(id==='list')       renderList();
  if(id==='stats')      renderStats();
  if(id==='accords')    populateVinSelect();
  if(id==='apogee')     renderApogee('tous');
  if(id==='carte')      renderCarte();
  if(id==='historique') renderHistorique();
  if(id==='add')        updateEtageSelect();
  if(id==='view2d')     renderCave2D();
  // Gestion historique navigateur (prot√©g√© contre SecurityError sur file://)
  if(!skipHistory) {
    try { history.pushState({tab: id}, '', '#' + id); } catch(e) {}
  }
}

// G√©rer la touche Retour du navigateur
window.addEventListener('popstate', function(event) {
  // Fermer les modals ouverts en priorit√©
  const openModals = document.querySelectorAll('.modal-overlay.open');
  if(openModals.length > 0) {
    openModals.forEach(m => m.classList.remove('open'));
    return;
  }
  // Fermer le mobile bubble si ouvert
  if(document.getElementById('mobile-bubble')?.classList.contains('open')) {
    closeMobileBubble();
    return;
  }
  // Naviguer vers l'onglet correspondant
  const tabId = (event.state && event.state.tab) || 'view2d';
  switchTab(tabId, null, true);
});

// Initialiser l'√©tat d'historique au chargement (prot√©g√© contre SecurityError sur file://)
window.addEventListener('load', function() {
  try {
    const hash = window.location.hash.replace('#','');
    const validTabs = ['view2d','list','historique','carte','apogee','accords','stats','add'];
    const initialTab = validTabs.includes(hash) ? hash : 'view2d';
    history.replaceState({tab: initialTab}, '', '#' + initialTab);
  } catch(e) {}
});

function selectCave(n, btn) {
  currentCave = n;
  document.querySelectorAll('.cave-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderCave2D();
}

// =====================================================================
// 2D SVG CAVE RENDERER
// =====================================================================
/*
  DISPOSITION dans l'√©tage (vue de face) :

  Sur UNE COUCHE on place d'abord les bouteilles AVANT (grand cercle = cul)
  puis imm√©diatement √† leur droite les bouteilles ARRI√àRE (petit cercle = goulot),
  toutes au m√™me niveau Y.

  Exemple : front=6, back=6
  [ O  O  O  O  O  O ][ o  o  o  o  o  o ]
    1  2  3  4  5  6    7  8  9  10 11 12

  Pour un double √©tage : deux couches identiques sur deux rang√©es Y distinctes.

  Le LABEL de l'√©tage est affich√© sur le bord gauche.
  Cave 1 : √©tage 1 en haut (affich√© en premier), √©tage 8 en bas.
  Cave 2 : √©tage 1 en bas (affich√© en dernier).
*/

const R_BIG   = 18;   // rayon grand cercle (cul)
const R_SMALL = 9;    // rayon petit cercle (goulot)
const PAD_H   = 24;   // padding horizontal gauche/droite
const PAD_V   = 18;   // padding vertical haut/bas
const ROW_GAP = 10;   // espace vertical entre les 2 couches d'un double √©tage
const SHELF_H = 4;    // √©paisseur planche
const FLOOR_GAP = 18; // espace entre √©tages

/*
  INTERCALAGE dans une rang√©e :
  On alterne cul (grand) et goulot (petit) sur le m√™me axe Y.
  Pour front=6, back=6 : O o O o O o O o O o O o
  L'espacement horizontal est calcul√© pour que le bord de chaque cercle
  soit toujours s√©par√© du suivant d'un GAP constant.

  Slot encoding :
    - slots 1..front         = rang√©e avant  (grands cercles)
    - slots front+1..front+back = rang√©e arri√®re (petits cercles)
  On intercale visuellement mais on conserve l'encodage d'origine.
*/

function renderCave2D() {
  const svg    = document.getElementById('caveSvg');
  const floors = CAVE_CONFIG[currentCave].floors;
  const GAP    = 7; // espace bord-√†-bord entre deux cercles cons√©cutifs

  // ‚îÄ‚îÄ Pr√©-calcul : positions X de chaque cercle dans une couche ‚îÄ‚îÄ
  function layerPositions(front, back) {
    const seq = [];
    let f = 0, b = 0;
    while(f < front || b < back) {
      if(f < front)  { seq.push({isFront:true,  li:f});  f++; }
      if(b < back)   { seq.push({isFront:false, li:b});  b++; }
    }
    const positions = [];
    let x = 0;
    seq.forEach((s, i) => {
      const r = s.isFront ? R_BIG : R_SMALL;
      if(i === 0) x = r;
      else {
        const rPrev = seq[i-1].isFront ? R_BIG : R_SMALL;
        x += rPrev + GAP + r;
      }
      positions.push({cx: x, r, isFront: s.isFront, li: s.li});
    });
    return positions;
  }

  // ‚îÄ‚îÄ Largeur max ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let maxLayerW = 0;
  floors.forEach(f => {
    const pos = layerPositions(f.front, f.back);
    if(pos.length) {
      const last = pos[pos.length-1];
      const w = last.cx + last.r;
      if(w > maxLayerW) maxLayerW = w;
    }
  });

  const layerH    = R_BIG * 2;
  const floorH    = f => f.double
    ? layerH + ROW_GAP + layerH + SHELF_H + FLOOR_GAP
    : layerH + SHELF_H + FLOOR_GAP;

  const totalW = PAD_H + maxLayerW + PAD_H;
  const totalH = PAD_V + floors.reduce((s,f) => s + floorH(f), 0) + PAD_V;

  svg.setAttribute('viewBox', `0 0 ${totalW} ${totalH}`);
  svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
  const isMobile = window.innerWidth <= 768;
  if(isMobile) {
    svg.setAttribute('width', '100%');
    svg.setAttribute('height', 'auto');
    svg.style.maxWidth = '100%';
  } else {
    svg.setAttribute('width', totalW);
    svg.setAttribute('height', totalH);
    svg.style.maxWidth = '';
  }

  const W = totalW, H = totalH;

  let html = `
  <defs>
    <!-- Filtre lueur douce des bouteilles -->
    <filter id="softglow" x="-30%" y="-30%" width="160%" height="160%">
      <feGaussianBlur stdDeviation="2.2" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>

    <!-- Halo chaud ambiant (√©clairage cave bordeaux) -->
    <filter id="warmglow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="8" result="blur"/>
      <feColorMatrix type="matrix" values="0.9 0.1 0 0 0.02  0.1 0.5 0 0 0.01  0 0 0.4 0 0  0 0 0 0.22 0" in="blur" result="tinted"/>
      <feMerge><feMergeNode in="tinted"/></feMerge>
    </filter>

    <!-- Fond cave ‚Äî inox noir chaud (accord avec --bg: #0e0a0b) -->
    <linearGradient id="caveBg" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%"   stop-color="#0e0a0b"/>
      <stop offset="50%"  stop-color="#0a0708"/>
      <stop offset="100%" stop-color="#080506"/>
    </linearGradient>

    <!-- Gradient vitre (teinte chaude bordeaux tr√®s subtile) -->
    <linearGradient id="glassReflect" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0%"   stop-color="rgba(200,160,140,0.07)"/>
      <stop offset="20%"  stop-color="rgba(220,180,160,0.04)"/>
      <stop offset="50%"  stop-color="rgba(180,130,110,0.01)"/>
      <stop offset="80%"  stop-color="rgba(210,170,150,0.03)"/>
      <stop offset="100%" stop-color="rgba(200,160,140,0.06)"/>
    </linearGradient>

    <!-- Reflet vertical vitre (chaud) -->
    <linearGradient id="glassReflectV" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%"   stop-color="rgba(220,180,160,0.06)"/>
      <stop offset="40%"  stop-color="rgba(180,140,120,0.02)"/>
      <stop offset="100%" stop-color="rgba(140,100,80,0.03)"/>
    </linearGradient>

    <!-- Inox noir chaud bross√© (montants) -->
    <linearGradient id="inoxBlack" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0%"   stop-color="#100c0d"/>
      <stop offset="25%"  stop-color="#1e1a1b"/>
      <stop offset="50%"  stop-color="#262020"/>
      <stop offset="75%"  stop-color="#1e1a1b"/>
      <stop offset="100%" stop-color="#100c0d"/>
    </linearGradient>
    <!-- Inox noir chaud vertical (rails) -->
    <linearGradient id="inoxBlackV" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%"   stop-color="#201a1b"/>
      <stop offset="40%"  stop-color="#2c2426"/>
      <stop offset="100%" stop-color="#100c0e"/>
    </linearGradient>

    <!-- √âclairage LED chaud (ambre/cr√®me) -->
    <linearGradient id="ledLight" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0%"   stop-color="rgba(201,168,76,0)"/>
      <stop offset="20%"  stop-color="rgba(201,168,76,0.14)"/>
      <stop offset="50%"  stop-color="rgba(220,190,100,0.22)"/>
      <stop offset="80%"  stop-color="rgba(201,168,76,0.14)"/>
      <stop offset="100%" stop-color="rgba(201,168,76,0)"/>
    </linearGradient>

    <!-- Bois CLAIR verni (h√™tre/ch√™ne blond) -->
    <linearGradient id="woodShelf" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%"   stop-color="#c8a860"/>
      <stop offset="25%"  stop-color="#d4b870"/>
      <stop offset="60%"  stop-color="#b89448"/>
      <stop offset="100%" stop-color="#a07830"/>
    </linearGradient>
    <linearGradient id="woodShelfFront" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%"   stop-color="#a07830"/>
      <stop offset="100%" stop-color="#7a5818"/>
    </linearGradient>

    <!-- Lumi√®re ambiante chaude (bordeaux/or) -->
    <radialGradient id="ambientLight" cx="50%" cy="0%" r="80%">
      <stop offset="0%"   stop-color="rgba(120,40,30,0.08)"/>
      <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
    </radialGradient>

    <!-- Ombre planche -->
    <filter id="shelfShadow" x="-5%" y="0%" width="110%" height="300%">
      <feDropShadow dx="0" dy="3" stdDeviation="2.5" flood-color="rgba(0,0,0,0.8)"/>
    </filter>

    <!-- Reflet verni bois -->
    <linearGradient id="woodVarnish" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%"   stop-color="rgba(255,240,180,0.35)"/>
      <stop offset="40%"  stop-color="rgba(255,230,140,0.10)"/>
      <stop offset="100%" stop-color="rgba(200,160,80,0.05)"/>
    </linearGradient>

    <!-- Highlight drag cible -->
    <filter id="dropTarget" x="-20%" y="-20%" width="140%" height="140%">
      <feGaussianBlur stdDeviation="3" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
  </defs>

  <!-- ‚ïê‚ïê‚ïê FOND : INOX NOIR CHAUD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <rect width="${W}" height="${H}" fill="url(#caveBg)" rx="0"/>

  <!-- Micro-texture bross√©e (lignes tr√®s fines) -->
  ${Array.from({length: Math.floor(H/3)}, (_,i) =>
    i%2===0 ? `<line x1="0" y1="${i*3+1.5}" x2="${W}" y2="${i*3+1.5}"
      stroke="rgba(255,220,200,${i%10===0?'0.010':'0.004'})" stroke-width="0.4"/>` : ''
  ).join('')}

  <!-- Lumi√®re ambiante chaude -->
  <rect width="${W}" height="${H}" fill="url(#ambientLight)"/>

  <!-- Bande LED ambre plafond -->
  <rect x="${PAD_H-16}" y="${PAD_V-14}" width="${maxLayerW+32}" height="4"
    fill="url(#ledLight)" rx="2" opacity="0.9"/>
  <rect x="${PAD_H-16}" y="${PAD_V-11}" width="${maxLayerW+32}" height="10"
    fill="url(#ledLight)" opacity="0.22"/>

  <!-- ‚ïê‚ïê‚ïê AFFICHAGE TEMP√âRATURE (tons chauds) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <rect x="${W/2 - 26}" y="${PAD_V-19}" width="52" height="16"
    fill="#16100f" rx="3" stroke="#2e2028" stroke-width="1"/>
  <rect x="${W/2 - 25}" y="${PAD_V-18}" width="50" height="7"
    fill="rgba(201,168,76,0.05)" rx="2" style="pointer-events:none"/>
  <text x="${W/2}" y="${PAD_V-7}"
    text-anchor="middle" font-size="10" fill="rgba(201,168,76,0.85)"
    font-family="'Courier New', monospace" font-weight="bold"
    letter-spacing="1" style="pointer-events:none">12¬∞C</text>
  <text x="${W/2 - 19}" y="${PAD_V-7}"
    text-anchor="middle" font-size="8" fill="rgba(180,140,60,0.65)"
    style="pointer-events:none">üå°</text>

  <!-- ‚ïê‚ïê‚ïê STRUCTURE INOX NOIR CHAUD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <rect x="${PAD_H-22}" y="${PAD_V-18}" width="12" height="${H - PAD_V*2 + 30}"
    fill="url(#inoxBlack)" rx="2"/>
  <rect x="${PAD_H-22}" y="${PAD_V-18}" width="2" height="${H - PAD_V*2 + 30}"
    fill="rgba(201,168,76,0.08)" rx="1"/>
  <rect x="${PAD_H-11}" y="${PAD_V-18}" width="2" height="${H - PAD_V*2 + 30}"
    fill="rgba(0,0,0,0.4)" rx="1"/>

  <rect x="${PAD_H+maxLayerW+10}" y="${PAD_V-18}" width="12" height="${H - PAD_V*2 + 30}"
    fill="url(#inoxBlack)" rx="2"/>
  <rect x="${PAD_H+maxLayerW+19}" y="${PAD_V-18}" width="2" height="${H - PAD_V*2 + 30}"
    fill="rgba(100,80,60,0.18)" rx="1"/>
  <rect x="${PAD_H+maxLayerW+10}" y="${PAD_V-18}" width="2" height="${H - PAD_V*2 + 30}"
    fill="rgba(0,0,0,0.4)" rx="1"/>

  <!-- Rail haut -->
  <rect x="${PAD_H-24}" y="${PAD_V-22}" width="${maxLayerW+50}" height="8"
    fill="url(#inoxBlackV)" rx="2"/>
  <rect x="${PAD_H-24}" y="${PAD_V-22}" width="${maxLayerW+50}" height="2"
    fill="rgba(201,168,76,0.10)" rx="1"/>
  <rect x="${PAD_H-24}" y="${PAD_V-16}" width="${maxLayerW+50}" height="1"
    fill="rgba(0,0,0,0.5)"/>

  <!-- Rail bas -->
  <rect x="${PAD_H-24}" y="${H - PAD_V+14}" width="${maxLayerW+50}" height="8"
    fill="url(#inoxBlackV)" rx="2"/>
  <rect x="${PAD_H-24}" y="${H - PAD_V+20}" width="${maxLayerW+50}" height="1"
    fill="rgba(80,60,40,0.20)"/>

  <!-- Vis d√©coratives inox -->
  ${[
    [PAD_H-17, PAD_V-18], [PAD_H+maxLayerW+16, PAD_V-18],
    [PAD_H-17, H-PAD_V+18], [PAD_H+maxLayerW+16, H-PAD_V+18]
  ].map(([vx,vy]) => `
    <circle cx="${vx}" cy="${vy}" r="3" fill="#181214" stroke="#2e2428" stroke-width="0.8"/>
    <line x1="${vx-1.5}" y1="${vy}" x2="${vx+1.5}" y2="${vy}" stroke="rgba(201,168,76,0.30)" stroke-width="0.8"/>
    <line x1="${vx}" y1="${vy-1.5}" x2="${vx}" y2="${vy+1.5}" stroke="rgba(201,168,76,0.30)" stroke-width="0.8"/>
  `).join('')}
  `;

  // ‚ïê‚ïê‚ïê √âTAGES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let yTop = PAD_V;

  floors.forEach((floor, floorIdx) => {
    const layers = floor.double ? 2 : 1;
    const fH     = floorH(floor);
    const pos    = layerPositions(floor.front, floor.back);

    // Fond de l'√©tage (int√©rieur brun tr√®s sombre)
    html += `<rect x="${PAD_H-10}" y="${yTop-4}"
      width="${maxLayerW+20}" height="${fH - FLOOR_GAP + 4}"
      fill="rgba(10,6,7,0.97)" rx="1"/>`;

    // L√©g√®re lueur ambre en haut de chaque casier
    html += `<rect x="${PAD_H-8}" y="${yTop-4}"
      width="${maxLayerW+16}" height="${Math.min(14, fH/4)}"
      fill="rgba(120,60,20,0.04)" rx="1" style="pointer-events:none"/>`;

    for(let layer = 0; layer < layers; layer++) {
      // INVERSION : pour √©tage double, layer 0 = bas (calcul√© en dernier = plus bas Y)
      // layer 0 ‚Üí rang√©e du BAS  (yCenter plus grand)
      // layer 1 ‚Üí rang√©e du HAUT (yCenter plus petit)
      const displayLayer = floor.double ? (layers - 1 - layer) : layer;
      const yCenter    = yTop + displayLayer * (layerH + ROW_GAP) + R_BIG;
      const slotOffset = layer * (floor.front + floor.back);

      pos.forEach(p => {
        const slot  = slotOffset + (p.isFront ? p.li + 1 : floor.front + p.li + 1);
        const wine  = getWineAtSlot(currentCave, floor.id, slot);
        const col   = wine ? (WINE_COLORS[wine.type] || WINE_COLORS.empty) : WINE_COLORS.empty;
        const empty = !wine;
        const isMagnumBottle = !empty && (wine.format === '150cl' || wine.format === '300cl');
        const cx      = PAD_H + p.cx;
        const cy      = yCenter;
        const isFront = floor.double && layer === 1 ? !p.isFront : p.isFront;
        const r       = isFront ? R_BIG : R_SMALL;

        // Halo lumineux ambiant derri√®re bouteille pleine (effet r√©tro-√©clair√©)
        if(!empty && isFront) {
          html += `<circle cx="${cx}" cy="${cy}" r="${r*1.5}"
            fill="${col.fill}" opacity="0.07" filter="url(#warmglow)"
            style="pointer-events:none"/>`;
        }

        // Anneau Magnum couleur du type
        if(isMagnumBottle && isFront) {
          html += `<circle cx="${cx}" cy="${cy}" r="${r+3.5}"
            fill="none" stroke="${col.stroke}" stroke-width="2"
            opacity="0.9" style="pointer-events:none"
            filter="url(#softglow)"/>`;
        }

        // Cercle principal ‚Äî bouteille
        html += `<circle cx="${cx}" cy="${cy}" r="${r}"
          fill="${col.fill}" stroke="${col.stroke}"
          stroke-width="${empty ? 0.6 : (isFront ? 1.8 : 1.2)}"
          opacity="${empty ? 0.22 : 1}"
          ${(!empty) ? 'filter="url(#softglow)"' : ''}
          style="cursor:pointer"
          onclick="handleBottleClick(event,${currentCave},${floor.id},${slot})"
          data-cave="${currentCave}" data-floor="${floor.id}" data-slot="${slot}"/>`;

        if(isFront) {
          // Creux central
          html += `<circle cx="${cx}" cy="${cy}" r="${r*0.28}"
            fill="${empty ? '#040a0c' : col.small}"
            opacity="${empty ? 0.20 : 0.92}"
            style="pointer-events:none"/>`;

          if(!empty) {
            // Reflet principal (arc lumineux)
            html += `<path d="M ${cx-r*0.52} ${cy-r*0.42} A ${r*0.6} ${r*0.6} 0 0 1 ${cx+r*0.28} ${cy-r*0.68}"
              stroke="rgba(255,255,255,0.28)" stroke-width="2.5" fill="none" stroke-linecap="round"
              style="pointer-events:none"/>`;
            // Reflet bas chaud (reflet verre)
            html += `<path d="M ${cx-r*0.3} ${cy+r*0.45} A ${r*0.4} ${r*0.4} 0 0 0 ${cx+r*0.18} ${cy+r*0.62}"
              stroke="rgba(220,180,100,0.10)" stroke-width="1.2" fill="none" stroke-linecap="round"
              style="pointer-events:none"/>`;
          }

          // M Magnum
          if(isMagnumBottle) {
            html += `<text x="${cx}" y="${cy+r*0.55}" text-anchor="middle" font-size="${r*0.58}"
              fill="${col.stroke}" opacity="0.98" font-family="serif" font-weight="bold"
              style="pointer-events:none">M</text>`;
          }
        } else {
          // Reflet goulot (chaud)
          if(!empty) {
            html += `<circle cx="${cx-r*0.3}" cy="${cy-r*0.32}" r="${r*0.28}"
              fill="rgba(220,180,100,0.12)" style="pointer-events:none"/>`;
          }
        }
      });
    }

    // ‚îÄ‚îÄ CLAYETTE BOIS CLAIR VERNI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const shelfY = yTop + fH - FLOOR_GAP - SHELF_H;

    // Ombre port√©e
    html += `<rect x="${PAD_H-12}" y="${shelfY+2}" width="${maxLayerW+24}" height="${SHELF_H+5}"
      fill="rgba(0,0,0,0.6)" rx="1" filter="url(#shelfShadow)" style="pointer-events:none"/>`;

    // Corps principal bois clair
    html += `<rect x="${PAD_H-10}" y="${shelfY}" width="${maxLayerW+20}" height="${SHELF_H+3}"
      fill="url(#woodShelf)" rx="1"/>`;

    // Reflet verni (brillance)
    html += `<rect x="${PAD_H-10}" y="${shelfY}" width="${maxLayerW+20}" height="${SHELF_H+3}"
      fill="url(#woodVarnish)" rx="1" style="pointer-events:none"/>`;

    // Tranche avant (bois fonc√©)
    html += `<rect x="${PAD_H-10}" y="${shelfY+SHELF_H+2}" width="${maxLayerW+20}" height="3"
      fill="url(#woodShelfFront)" rx="1"/>`;

    // Filets de grain bois clair (horizontaux)
    for(let g = 0; g < 5; g++) {
      const gy = shelfY + 1.5 + g * ((SHELF_H+1) / 5);
      html += `<line x1="${PAD_H-8}" y1="${gy}" x2="${PAD_H+maxLayerW+8}" y2="${gy + (g%2===0?0.3:-0.3)}"
        stroke="rgba(160,120,50,0.30)" stroke-width="${g%2===0?'0.7':'0.4'}"
        style="pointer-events:none"/>`;
    }

    // N≈ìuds de bois d√©coratifs
    for(let k = 0; k < 3; k++) {
      const kx = PAD_H + maxLayerW * (0.18 + k * 0.32);
      html += `<ellipse cx="${kx}" cy="${shelfY + SHELF_H*0.5}" rx="${3.5}" ry="${1.5}"
        fill="none" stroke="rgba(140,100,40,0.22)" stroke-width="0.8"
        style="pointer-events:none"/>`;
    }

    // S√©parateur couche double (r√©glette inox chaud)
    if(floor.double) {
      const midY = yTop + layerH + ROW_GAP * 0.5;
      html += `<rect x="${PAD_H-6}" y="${midY-1}" width="${maxLayerW+12}" height="2"
        fill="#1e1818" rx="1" opacity="0.7" style="pointer-events:none"/>`;
      html += `<rect x="${PAD_H-6}" y="${midY-1}" width="${maxLayerW+12}" height="0.8"
        fill="rgba(201,168,76,0.10)" rx="1" style="pointer-events:none"/>`;
    }

    // Num√©ro d'√©tage
    html += `<text x="${PAD_H-16}" y="${yTop + (fH-FLOOR_GAP)*0.5 + 4}"
      text-anchor="middle" font-size="8" fill="rgba(160,120,80,0.45)"
      font-family="'Courier New', monospace" font-weight="bold"
      style="pointer-events:none">${floor.id}</text>`;

    yTop += fH;
  });

  // ‚ïê‚ïê‚ïê VITRE SUPERPOS√âE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  html += `<rect x="${PAD_H-22}" y="${PAD_V-18}" width="${maxLayerW+44}" height="${H - PAD_V*2 + 30}"
    fill="rgba(80,140,200,0.012)" stroke="none" style="pointer-events:none"/>`;

  html += `<rect x="${PAD_H-22}" y="${PAD_V-18}" width="${maxLayerW+44}" height="${H - PAD_V*2 + 30}"
    fill="url(#glassReflect)" style="pointer-events:none"/>`;

  html += `<rect x="${PAD_H-22}" y="${PAD_V-18}" width="${maxLayerW+44}" height="${H - PAD_V*2 + 30}"
    fill="url(#glassReflectV)" style="pointer-events:none"/>`;

  // Liserets bords vitre (chauds)
  html += `<rect x="${PAD_H-22}" y="${PAD_V-18}" width="2" height="${H - PAD_V*2 + 30}"
    fill="rgba(201,168,76,0.07)" style="pointer-events:none"/>`;
  html += `<rect x="${PAD_H+maxLayerW+20}" y="${PAD_V-18}" width="2" height="${H - PAD_V*2 + 30}"
    fill="rgba(160,120,80,0.05)" style="pointer-events:none"/>`;

  // Train√©es de condensation (chaudes)
  const condensLines = [0.06, 0.15, 0.27, 0.39, 0.52, 0.61, 0.72, 0.84, 0.91];
  condensLines.forEach((xRatio, i) => {
    const lx = PAD_H - 20 + xRatio * (maxLayerW + 42);
    const ly = PAD_V + 8 + (i % 5) * 16;
    const lh = 12 + (i % 4) * 10;
    html += `<line x1="${lx}" y1="${ly}" x2="${lx+(i%2===0?0.4:-0.4)}" y2="${ly+lh}"
      stroke="rgba(220,180,140,0.07)" stroke-width="${0.7+(i%3)*0.3}"
      stroke-linecap="round" style="pointer-events:none"/>`;
  });

  // Raies lumineuses obliques (reflet vitre chaud)
  html += `<line x1="${PAD_H + maxLayerW*0.28}" y1="${PAD_V-12}"
    x2="${PAD_H + maxLayerW*0.52}" y2="${H - PAD_V+10}"
    stroke="rgba(220,180,130,0.035)" stroke-width="26" style="pointer-events:none"/>`;
  html += `<line x1="${PAD_H + maxLayerW*0.66}" y1="${PAD_V-12}"
    x2="${PAD_H + maxLayerW*0.80}" y2="${H - PAD_V+10}"
    stroke="rgba(220,180,130,0.015)" stroke-width="11" style="pointer-events:none"/>`;

  svg.innerHTML = html;

  // ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // NOTE : _drag, _onDragMove, _onDragUp sont des singletons d√©clar√©s UNE SEULE FOIS
  // hors de renderCave2D (voir ci-dessous) pour √©viter l'accumulation de listeners
  // sur document √† chaque re-rendu. Ici on r√©attache uniquement les mousedown
  // (n√©cessaire car svg.innerHTML est recr√©√© √† chaque appel).
  svg.querySelectorAll('circle[data-cave]').forEach(el => {
    // Rendre draggable uniquement les emplacements occup√©s
    el.addEventListener('mousedown', (e) => {
      const cave  = parseInt(el.dataset.cave);
      const floor = parseInt(el.dataset.floor);
      const slot  = parseInt(el.dataset.slot);
      const wine  = getWineAtSlot(cave, floor, slot);
      if(!wine) return; // vide ‚Üí pas de drag
      e.preventDefault();
      e.stopPropagation();

      // Cr√©er un fant√¥me visuel qui suit la souris
      const ghost = document.createElement('div');
      ghost.id = 'drag-ghost';
      ghost.innerHTML = `<div style="
        background:${WINE_COLORS[wine.type]?.fill||'#4a2030'};
        border:2px solid ${WINE_COLORS[wine.type]?.stroke||'#c04060'};
        border-radius:50%; width:32px; height:32px;
        box-shadow:0 4px 16px rgba(0,0,0,0.7);
        display:flex; align-items:center; justify-content:center;
        font-size:9px; color:rgba(255,255,255,0.9); font-weight:bold;
        pointer-events:none; user-select:none;
      ">${wine.annee||'?'}</div>
      <div style="
        position:absolute; top:36px; left:50%; transform:translateX(-50%);
        background:rgba(14,10,11,0.92); border:1px solid rgba(201,168,76,0.4);
        border-radius:4px; padding:3px 7px; white-space:nowrap;
        font-size:10px; color:var(--gold3); pointer-events:none;
      ">${(wine.nom||'').substring(0,20)}</div>`;
      ghost.style.cssText = `
        position:fixed; pointer-events:none; z-index:9999;
        transform:translate(-50%,-50%);
        left:${e.clientX}px; top:${e.clientY}px;
      `;
      document.body.appendChild(ghost);

      // Att√©nuer la bouteille source
      el.setAttribute('opacity', '0.35');
      el.style.cursor = 'grabbing';

      _drag = { cave, floor, slot, wine, ghost, srcEl: el };
      document.getElementById('tooltip').style.display = 'none';
    });
  });

  // ‚îÄ‚îÄ Tooltip au survol ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  svg.querySelectorAll('circle[data-cave]').forEach(el => {
    el.addEventListener('mouseenter', (e) => {
      if(_drag) return; // pas de tooltip pendant drag
      const cave  = parseInt(el.dataset.cave);
      const floor = parseInt(el.dataset.floor);
      const slot  = parseInt(el.dataset.slot);
      const wine  = getWineAtSlot(cave, floor, slot);
      const tt    = document.getElementById('tooltip');
      const floorData = CAVE_CONFIG[cave].floors.find(f=>f.id===floor);
      if(wine) {
        document.getElementById('tt-name').innerHTML = wine.nom + (wine.annee ? ` <span style="color:var(--text2);font-size:0.82rem;font-weight:normal">${wine.annee}</span>` : '');
        document.getElementById('tt-info').innerHTML =
          `<span class="type-badge badge-${wine.type}" style="font-size:0.7rem">${TYPE_LABELS[wine.type]||wine.type}</span>
          ${wine.domaine ? `<br><i style="color:var(--cream)">${wine.domaine}</i>` : ''}
          <br>${wine.region||'‚Äî'}
          ${wine.prix ? `<br>${wine.prix} ‚Ç¨` : ''}
          ${wine.note ? `<br>${'‚òÖ'.repeat(parseInt(wine.note))}` : ''}
          <br><small style="color:#4a3840">√ât.${floor} ¬∑ #${slot}</small>`;
        const imgWrap = document.getElementById('tt-img-wrap');
        const imgEl   = document.getElementById('tt-img');
        const _mbImg = imgGet('wine_' + wine.id) || wine.image || '';
  if(_mbImg) { imgEl.src = _mbImg; imgWrap.style.display = 'block'; }
        else { imgWrap.style.display = 'none'; }
      } else {
        document.getElementById('tt-img-wrap').style.display = 'none';
        document.getElementById('tt-name').innerHTML = '<span class="tt-empty">Emplacement vide</span>';
        document.getElementById('tt-info').innerHTML =
          `${floorData?.label} ¬∑ #${slot}<br><small style="color:#5a4050">Cliquer pour ajouter</small>`;
      }
      tt.style.display = 'block';
      tt.style.left = (e.clientX + 16) + 'px';
      tt.style.top  = (e.clientY - 12) + 'px';
    });
    el.addEventListener('mousemove', (e) => {
      const tt = document.getElementById('tooltip');
      tt.style.left = (e.clientX + 16) + 'px';
      tt.style.top  = (e.clientY - 12) + 'px';
    });
    el.addEventListener('mouseleave', () => {
      document.getElementById('tooltip').style.display = 'none';
    });
  });
}

// =====================================================================
// SLOT MODAL
// =====================================================================
function openSlotModal(cave, floor, slot) {
  const wine      = getWineAtSlot(cave, floor, slot);
  const floorData = CAVE_CONFIG[cave].floors.find(f=>f.id===floor);
  document.getElementById('modal-title').textContent =
    `Cave ${cave} ¬∑ ${floorData?.label} ¬∑ Emplacement #${slot}`;
  const body = document.getElementById('modal-body');
  if(wine) {
    const stars  = '‚òÖ'.repeat(parseInt(wine.note)||0)+'‚òÜ'.repeat(5-(parseInt(wine.note)||0));
    const tLabel = TYPE_LABELS[wine.type] || wine.type;
    const fLabel = FORMAT_LABELS[wine.format] || (wine.format||'75 cl');
    const _wImg = imgGet('wine_' + wine.id) || wine.image || '';
    const imgHtml = _wImg ? `<div style="text-align:center;margin-bottom:18px">
        <img src="${_wImg}" alt="√âtiquette" id="etiquette-img" style="max-height:200px;max-width:100%;object-fit:contain;border-radius:4px;border:1px solid #3a2830;box-shadow:0 4px 20px rgba(0,0,0,0.7);cursor:pointer;transition:max-height 0.4s ease" onclick="this.style.maxHeight=this.style.maxHeight==='200px'||!this.style.maxHeight?'520px':'200px'" title="Cliquer pour agrandir">
        <div style="font-size:0.68rem;color:var(--text2);margin-top:5px;letter-spacing:1px">‚Üï CLIQUER POUR AGRANDIR</div>
      </div>` : '';
    // Sur mobile portrait, image au-dessus √† pleine largeur
    const isMobileDevice = window.matchMedia('(max-width: 768px) and (orientation: portrait)').matches;
    const imgHtmlMobile = _wImg ? `<div style="width:calc(100% + 28px);margin:-18px -14px 18px;background:var(--bg3);text-align:center;padding:16px 14px">
        <img src="${_wImg}" alt="√âtiquette" id="etiquette-img" style="max-height:220px;max-width:100%;object-fit:contain;border-radius:4px;border:1px solid #3a2830;box-shadow:0 4px 20px rgba(0,0,0,0.7);cursor:pointer;transition:max-height 0.4s ease" onclick="this.style.maxHeight=this.style.maxHeight==='220px'||!this.style.maxHeight?'440px':'220px'" title="Cliquer pour agrandir">
      </div>` : '';
    const imgHtmlFinal = isMobileDevice ? imgHtmlMobile : imgHtml;
    body.innerHTML = `
      ${imgHtmlFinal}
      <div style="display:flex;gap:20px;align-items:flex-start">
        <div style="flex:1">
          <div class="modal-info-panel">
            <div class="info-cell" style="grid-column:1/-1">
              <div class="lbl">Nom</div>
              <div class="val" style="font-size:1.15rem">${wine.nom}</div>
              ${wine.appellation?`<div style="font-size:0.85rem;color:var(--text2);font-style:italic;margin-top:2px">${wine.appellation}</div>`:''}
            </div>
            <div class="info-cell"><div class="lbl">Type</div><div class="val"><span class="type-badge badge-${wine.type}">${tLabel}</span></div></div>
            <div class="info-cell"><div class="lbl">Format</div><div class="val"><span class="format-badge">${fLabel}</span></div></div>
            <div class="info-cell"><div class="lbl">Mill√©sime</div><div class="val">${wine.annee||'‚Äî'}</div></div>
            <div class="info-cell">
              <div class="lbl">Prix</div>
              <div class="val">${wine.prix ? wine.prix+'‚Ç¨' : wine._prixEstime ? '~'+wine._prixEstime+'‚Ç¨' : '‚Äî'}</div>
            </div>
                        <div class="info-cell"><div class="lbl">Domaine</div><div class="val">${wine.domaine||'‚Äî'}</div></div>
            <div class="info-cell"><div class="lbl">R√©gion</div><div class="val">${wine.region||'‚Äî'}</div></div>
            <div class="info-cell"><div class="lbl">Note</div><div class="val rating-stars" style="font-size:1rem">${stars}</div></div>
          </div>
          ${wine.notes?`<div style="color:var(--text2);font-style:italic;margin-bottom:16px;line-height:1.6;font-size:0.95rem">"${wine.notes}"</div>`:''}
          ${wine.accords?`<div style="margin-bottom:14px"><div style="font-size:0.68rem;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Accords mets-vins</div><div style="color:var(--gold2);font-size:0.9rem">üçΩ ${wine.accords}</div></div>`:''}
          ${(wine.apogeeDebut||wine.apogeeFin)?`<div style="margin-bottom:14px"><div style="font-size:0.68rem;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Fen√™tre d'apog√©e</div><div style="font-size:0.95rem">${getApogeeLabel(wine)}</div></div>`:''}"
          <div id="price-estimate-box" style="display:none;margin-bottom:14px;padding:12px 16px;background:var(--bg3);border:1px solid rgba(201,168,76,0.3);border-radius:4px"></div>
          <div class="modal-actions">
            <button class="btn-outline" data-edit-id="${wine.id}" onclick="openEditModal(this.dataset.editId)">‚úè Modifier</button>
            <button class="btn-outline" data-mv-id="${wine.id}"   onclick="openDeplacerModal(this.dataset.mvId)">üì¶ D√©placer</button>
            <button class="btn-outline" data-dup-id="${wine.id}"  onclick="openDupliquerModal(this.dataset.dupId)">‚ßâ Dupliquer</button>
            <button class="btn-outline" data-wine-id="${wine.id}" onclick="estimerPrixMarche(this.dataset.wineId)" id="btn-estimer">üí∞ Estimer</button>
            <button class="btn-danger"  data-rm-id="${wine.id}"   onclick="removeWine(this.dataset.rmId)">üóë Retirer</button>
            <button class="btn-wine"    onclick="closeModal('modalSlot')">Fermer</button>
          </div>
        </div>
      </div>`;
  } else {
    body.innerHTML = `
      <div style="text-align:center;padding:20px 0;color:var(--text2);font-style:italic;margin-bottom:20px">
        Emplacement libre${floorData?.isMagnum?' ¬∑ R√©serv√© Magnums':''}
      </div>
      <div class="modal-actions">
        <button class="btn-wine" onclick="openAddToSlot(${cave},${floor},${slot})">‚ûï Placer un vin ici</button>
        <button class="btn-outline" onclick="closeModal('modalSlot')">Fermer</button>
      </div>`;
  }
  document.getElementById('modalSlot').classList.add('open');
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function openAddToSlot(cave, floor, slot) {
  closeModal('modalSlot');
  addingToSlot = {cave, floor, slot};
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===3));
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.getElementById('add').classList.add('active');
  document.getElementById('f-cave').value = cave;
  updateEtageSelect();
  document.getElementById('f-etage').value = floor;
  updateSlotSelect();
  document.getElementById('f-slot').value = slot;
  if(CAVE_CONFIG[cave].floors.find(f=>f.id==floor)?.isMagnum) {
    document.getElementById('f-format').value = '150cl';
  }
  showNotif(`Cave ${cave} ¬∑ √âtage ${floor} ¬∑ Emplacement #${slot}`);
}

function openEditModal(id) {
  const wine = wineData.find(w=>String(w.id)===String(id));
  if(!wine) return;
  closeModal('modalSlot');
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===3));
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.getElementById('add').classList.add('active');
  document.getElementById('f-nom').value         = wine.nom;
  document.getElementById('f-appellation').value = wine.appellation||'';
  document.getElementById('f-domaine').value     = wine.domaine||'';
  document.getElementById('f-region').value      = wine.region||'';
  document.getElementById('f-type').value        = wine.type;
  document.getElementById('f-format').value      = wine.format||'75cl';
  document.getElementById('f-annee').value       = wine.annee||'';
  document.getElementById('f-prix').value        = wine.prix||'';
  document.getElementById('f-note').value        = wine.note||'';
  document.getElementById('f-notes').value       = wine.notes||'';
  const accordsField = document.getElementById('f-accords'); if(accordsField) accordsField.value = wine.accords||'';
  const apDebut = document.getElementById('f-apogee-debut'); if(apDebut) apDebut.value = wine.apogeeDebut||'';
  const apFin   = document.getElementById('f-apogee-fin');   if(apFin)   apFin.value   = wine.apogeeFin||'';
  const imgField = document.getElementById('f-image'); if(imgField) imgField.value = imgGet('wine_' + wine.id) || wine.image||'';
  // Restore image preview if editing
  const _wImgEdit = imgGet('wine_' + wine.id) || wine.image || '';
  if(_wImgEdit) {
    const pw = document.getElementById('img-preview-wrap');
    const pi = document.getElementById('img-preview');
    if(pw && pi) { pi.src = _wImgEdit; pw.style.display = 'block'; }
  }
  document.getElementById('f-cave').value        = wine.cave;
  addingToSlot = {editing:String(id), cave:wine.cave, floor:wine.floor, slot:wine.slot};
  updateEtageSelect();
  document.getElementById('f-etage').value = wine.floor;
  updateSlotSelect();
  document.getElementById('f-slot').value  = wine.slot;
  showNotif('Mode √©dition ‚Äî modifiez puis validez');
}

function removeWine(id) {
  const wine = wineData.find(w=>String(w.id)===String(id));
  if(!wine) return;
  openHistoriqueModal(wine);
}

function openHistoriqueModal(wine) {
  const mo = document.getElementById('modalHistorique');
  document.getElementById('histo-wine-name').textContent = (wine.nom||'') + (wine.annee?' '+wine.annee:'');
  document.getElementById('histo-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('histo-note').value = wine.note || '';
  document.getElementById('histo-commentaire').value = '';
  document.getElementById('histo-occasion').value = '';
  mo._wine = wine;
  mo.classList.add('open');
}

function confirmRetirer(saveToHisto) {
  const mo = document.getElementById('modalHistorique');
  const wine = mo._wine;
  if(!wine) return;

  if(saveToHisto) {
    const entry = {
      id:           'h_' + Date.now(),
      source:       'cave',
      date:         document.getElementById('histo-date').value,
      nom:          wine.nom || '',
      appellation:  wine.appellation || '',
      domaine:      wine.domaine || '',
      region:       wine.region || '',
      annee:        wine.annee || '',
      type:         wine.type || '',
      note:         document.getElementById('histo-note').value,
      commentaire:  document.getElementById('histo-commentaire').value,
      occasion:     document.getElementById('histo-occasion').value,
      image:        imgGet('wine_' + wine.id) || wine.image || '',
      dateAjout:    new Date().toISOString().split('T')[0]
    };
    // Tout dans degustationData (plus de tableaux s√©par√©s)
    degustationData.unshift(entry);
    localStorage.setItem('degustationData', JSON.stringify(degustationData));
    if(entry.image) imgSave('hist_' + entry.id, entry.image);
    syncHistoriqueFromDeg();
    saveDegustationEntryToSheets(entry);
    showNotif('D√©gustation enregistr√©e ‚úì');
  }

  mo.classList.remove('open');
  wineData = wineData.filter(w=>String(w.id)!==String(wine.id));
  saveData();
  closeModal('modalSlot');
  renderCave2D();
  renderList();
  renderHistorique();
  if(!saveToHisto) showNotif('Vin retir√© ‚úì');
}

// =====================================================================
// DUPLICATION DE BOUTEILLE
// =====================================================================
let dupliquerWineId = null;

function openDupliquerModal(id) {
  const wine = wineData.find(w => String(w.id) === String(id));
  if(!wine) return;
  dupliquerWineId = id;
  document.getElementById('dup-wine-name').textContent = (wine.nom||'') + (wine.annee ? ' ¬∑ ' + wine.annee : '');
  document.getElementById('dup-warning').style.display = 'none';
  document.getElementById('dup-count').value = 1;
  renderDupSlots();
  document.getElementById('modalDupliquer').classList.add('open');
}

function renderDupSlots() {
  const count = parseInt(document.getElementById('dup-count').value) || 1;
  const wine = wineData.find(w => String(w.id) === String(dupliquerWineId));
  const container = document.getElementById('dup-slots-container');
  if(!container) return;

  let html = '';
  for(let i = 0; i < count; i++) {
    html += `
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:12px">
        <div style="font-size:0.72rem;color:var(--gold);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:12px">Copie ${i+1}</div>
        <div class="form-grid">
          <div class="form-row">
            <label>Cave</label>
            <select id="dup-cave-${i}" onchange="updateDupEtageN(${i})">
              <option value="1"${wine && wine.cave==1?' selected':''}>Cave 1</option>
              <option value="2"${wine && wine.cave==2?' selected':''}>Cave 2</option>
            </select>
          </div>
          <div class="form-row">
            <label>√âtage</label>
            <select id="dup-etage-${i}" onchange="updateDupSlotN(${i})"></select>
          </div>
          <div class="form-row form-full">
            <label>Emplacement</label>
            <select id="dup-slot-${i}"></select>
          </div>
        </div>
      </div>`;
  }
  container.innerHTML = html;

  // Initialiser les selects de chaque copie
  for(let i = 0; i < count; i++) {
    updateDupEtageN(i);
  }
}

function updateDupEtageN(idx) {
  const cave = parseInt(document.getElementById('dup-cave-' + idx).value) || 1;
  const sel = document.getElementById('dup-etage-' + idx);
  if(!sel) return;
  sel.innerHTML = '';
  CAVE_CONFIG[cave].floors.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f.id;
    opt.textContent = f.label + (f.isMagnum ? ' ¬∑ Magnums' : '');
    sel.appendChild(opt);
  });
  updateDupSlotN(idx);
}

function updateDupSlotN(idx) {
  const cave  = parseInt(document.getElementById('dup-cave-' + idx).value) || 1;
  const floor = parseInt(document.getElementById('dup-etage-' + idx).value) || 1;
  const floorData = CAVE_CONFIG[cave].floors.find(f => f.id === floor);
  const sel = document.getElementById('dup-slot-' + idx);
  if(!sel || !floorData) return;
  sel.innerHTML = '';

  // R√©cup√©rer les slots d√©j√† choisis par les autres copies
  const count = parseInt(document.getElementById('dup-count').value) || 1;
  const alreadyChosen = [];
  for(let i = 0; i < count; i++) {
    if(i === idx) continue;
    const c = parseInt(document.getElementById('dup-cave-' + i)?.value);
    const f = parseInt(document.getElementById('dup-etage-' + i)?.value);
    const s = parseInt(document.getElementById('dup-slot-' + i)?.value);
    if(c === cave && f === floor && s) alreadyChosen.push(s);
  }

  let freeCount = 0;
  for(let i = 1; i <= floorData.slots; i++) {
    if(getWineAtSlot(cave, floor, i)) continue;
    if(alreadyChosen.includes(i)) continue;
    freeCount++;
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = 'Empl. ' + i + ' ‚Äî libre';
    sel.appendChild(opt);
  }
  if(freeCount === 0) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = '‚Äî Aucun emplacement libre ‚Äî';
    sel.appendChild(opt);
  }
}

// Garder pour compatibilit√© (non utilis√©es mais peuvent √™tre appel√©es ailleurs)
function updateDupEtage() { updateDupEtageN(0); }
function updateDupSlot()  { updateDupSlotN(0); }
function updateDupWarning() {}

function confirmerDuplication() {
  const wine = wineData.find(w => String(w.id) === String(dupliquerWineId));
  if(!wine) return;
  const count = parseInt(document.getElementById('dup-count').value) || 1;
  const imageUrl = imgGet('wine_' + wine.id) || wine.image || '';
  let created = 0;
  const errors = [];

  for(let i = 0; i < count; i++) {
    const cave  = parseInt(document.getElementById('dup-cave-' + i)?.value);
    const floor = parseInt(document.getElementById('dup-etage-' + i)?.value);
    const slot  = parseInt(document.getElementById('dup-slot-' + i)?.value);

    if(!cave || !floor || !slot) { errors.push('Copie ' + (i+1) + ' : emplacement invalide'); continue; }
    if(getWineAtSlot(cave, floor, slot)) { errors.push('Copie ' + (i+1) + ' : emplacement d√©j√† occup√©'); continue; }

    // ID unique pour chaque copie
    const newId = Date.now().toString() + '_dup' + i + '_' + Math.random().toString(36).slice(2,6);
    const copy = {
      ...wine,
      id:        newId,
      cave,
      floor,
      slot,
      _prixEstime: wine._prixEstime || '',
      dateAjout: new Date().toISOString().split('T')[0]
    };
    wineData.push(copy);
    if(imageUrl) imgSave('wine_' + newId, imageUrl);
    created++;
  }

  if(created > 0) {
    saveData();
    closeModal('modalDupliquer');
    closeModal('modalSlot');
    renderCave2D();
    renderList();
    showNotif(created + ' copie' + (created > 1 ? 's' : '') + ' de "' + wine.nom + '" ajout√©e' + (created > 1 ? 's' : '') + ' ‚úì');
  }
  if(errors.length > 0) showNotif(errors.join(' ¬∑ '), true);
}

// =====================================================================
// FORM
// =====================================================================
function updateFormSelects() { updateEtageSelect(); }

function updateEtageSelect() {
  const cave = parseInt(document.getElementById('f-cave').value)||1;
  const sel  = document.getElementById('f-etage');
  sel.innerHTML = '';
  CAVE_CONFIG[cave].floors.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f.id;
    opt.textContent = f.label + (f.isMagnum?' ¬∑ Magnums':'');
    sel.appendChild(opt);
  });
  sel.onchange = updateSlotSelect;
  updateSlotSelect();
}

function updateSlotSelect() {
  const cave      = parseInt(document.getElementById('f-cave').value)||1;
  const floor     = parseInt(document.getElementById('f-etage').value)||1;
  const floorData = CAVE_CONFIG[cave].floors.find(f=>f.id===floor);
  if(!floorData) return;
  const sel = document.getElementById('f-slot');
  sel.innerHTML = '';
  for(let i=1; i<=floorData.slots; i++) {
    const taken     = getWineAtSlot(cave,floor,i);
    const editingId = addingToSlot?.editing;
    const isSelf    = editingId && String(taken?.id)===String(editingId);
    if(taken && !isSelf) continue;
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `Emplacement ${i}`;
    sel.appendChild(opt);
  }
  if(sel.options.length===0) {
    const opt = document.createElement('option');
    opt.value=''; opt.textContent='‚Äî √âtage complet ‚Äî';
    sel.appendChild(opt);
  }
}

function addWine() {
  const nom   = document.getElementById('f-nom').value.trim();
  const cave  = document.getElementById('f-cave').value;
  const floor = document.getElementById('f-etage').value;
  const slot  = document.getElementById('f-slot').value;
  if(!nom)  { showNotif('Le nom est requis', true); return; }
  if(!slot) { showNotif('Aucun emplacement disponible', true); return; }
  const editingId = addingToSlot?.editing;
  // Pr√©server les champs prix_marche et autres champs non pr√©sents dans le formulaire
  const existingWine = editingId ? wineData.find(w => String(w.id) === String(editingId)) : null;
  if(editingId) wineData = wineData.filter(w=>String(w.id)!==String(editingId));
  wineData.push({
    // Pr√©server tous les champs existants d'abord
    ...(existingWine || {}),
    id: editingId || Date.now().toString(),
    nom,
    appellation: document.getElementById('f-appellation').value.trim(),
    domaine:     document.getElementById('f-domaine').value.trim(),
    region:      document.getElementById('f-region').value.trim(),
    type:        document.getElementById('f-type').value,
    format:      document.getElementById('f-format').value,
    annee:       document.getElementById('f-annee').value,
    prix:        document.getElementById('f-prix').value,
    note:        document.getElementById('f-note').value,
    notes:       document.getElementById('f-notes').value.trim(),
    accords:     document.getElementById('f-accords') ? document.getElementById('f-accords').value.trim() : '',
    apogeeDebut: document.getElementById('f-apogee-debut') ? document.getElementById('f-apogee-debut').value : '',
    apogeeFin:   document.getElementById('f-apogee-fin')   ? document.getElementById('f-apogee-fin').value   : '',
    image:       document.getElementById('f-image') ? document.getElementById('f-image').value.trim() : '',
    cave:  parseInt(cave), floor: parseInt(floor), slot: parseInt(slot),
    dateAjout: existingWine?.dateAjout || new Date().toISOString().split('T')[0]
  });
  // Save image URL to imageStore indexed by wine id
  const _newWine = wineData[wineData.length - 1];
  if(_newWine && _newWine.image) imgSave('wine_' + _newWine.id, _newWine.image);
  saveData(); addingToSlot = null;
  ['f-nom','f-appellation','f-domaine','f-region','f-annee','f-prix','f-notes','f-image','f-accords','f-apogee-debut','f-apogee-fin'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=''});
  // Clear image preview
  const pw = document.getElementById('img-preview-wrap');
  const pi = document.getElementById('img-preview');
  if(pw) pw.style.display = 'none';
  if(pi) pi.src = '';
  document.getElementById('f-note').value='';
  document.getElementById('f-type').value='rouge';
  document.getElementById('f-format').value='75cl';
  renderCave2D();
  showNotif('Vin ajout√© avec succ√®s ‚úì');
}

// =====================================================================
// LIST
// =====================================================================
function renderList() {
  try {
  const q    = document.getElementById('searchInput').value.toLowerCase();
  const cave = document.getElementById('filterCave').value;
  const type = document.getElementById('filterType').value;
  const sort = document.getElementById('sortBy').value;
  let wines  = wineData.filter(w => {
    if(cave && w.cave!=cave) return false;
    if(type && w.type!==type) return false;
    if(q && !([w.nom,w.appellation,w.region,w.domaine].join(' ').toLowerCase().includes(q))) return false;
    return true;
  });
  wines.sort((a,b) => {
    if(sort==='annee')       return (b.annee||0)-(a.annee||0);
    if(sort==='prix')        return (b.prix||0)-(a.prix||0);
    if(sort==='type')        return a.type.localeCompare(b.type);
    if(sort==='appellation') return (a.appellation||'').localeCompare(b.appellation||'');
    if(sort==='region')      return (a.region||'').localeCompare(b.region||'');
    if(sort==='domaine')     return (a.domaine||'').localeCompare(b.domaine||'');
    return a.nom.localeCompare(b.nom);
  });
  const cont = document.getElementById('listContainer');
  if(wines.length===0) {
    cont.innerHTML=`<div class="empty-state">Aucun vin ¬∑ <a href="#" onclick="document.querySelectorAll('.tab')[3].click()" style="color:var(--gold);text-decoration:none">Ajouter</a></div>`;
    return;
  }
  // TABLE (desktop)
  let html=`<table class="wine-table"><thead><tr>
    <th>Nom</th><th>Appellation</th><th>Domaine / Producteur</th><th>Type</th><th>Format</th><th>Mill√©sime</th><th>R√©gion</th><th>Cave</th><th>Position</th><th>Prix</th><th></th>
  </tr></thead><tbody>`;
  wines.forEach(w => {
    const tLabel = TYPE_LABELS[w.type]||w.type;
    const fLabel = FORMAT_LABELS[w.format]||(w.format||'75 cl');
    html += `<tr onclick="openSlotModal(${w.cave},${w.floor},${w.slot})" title="Voir">
      <td><b style="color:var(--text)">${w.nom||'‚Äî'}</b></td>
      <td style="color:var(--text2);font-style:italic">${w.appellation||'‚Äî'}</td>
      <td style="color:var(--text2)">${w.domaine||'‚Äî'}</td>
      <td><span class="type-badge badge-${w.type}">${tLabel}</span></td>
      <td><span class="format-badge">${fLabel}</span></td>
      <td>${w.annee||'‚Äî'}</td>
      <td>${w.region||'‚Äî'}</td>
      <td>Cave ${w.cave}</td>
      <td style="white-space:nowrap">√ât.${w.floor} #${w.slot}</td>
      <td style="white-space:nowrap">
        ${w.prix ? `<span style="color:var(--cream)">${w.prix}‚Ç¨</span>`
          : w._prixEstime ? `<span style="color:var(--gold)">~${w._prixEstime}‚Ç¨</span>`
          : '<span style="color:var(--text3)">‚Äî</span>'}
      </td>
      <td><button class="btn-danger" style="padding:4px 9px;font-size:0.78rem;border-radius:50%;width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center" onclick="event.stopPropagation();removeWine('${w.id}')">‚úï</button></td>
    </tr>`;
  });
  html += '</tbody></table>';

  // CARTES (mobile)
  let cards = '<div class="wine-cards">';
  wines.forEach(w => {
    const tLabel = TYPE_LABELS[w.type]||w.type;
    const img = imgGet('wine_' + w.id) || w.image || '';
    const prixAff = w.prix ? w.prix+'‚Ç¨' : w._prixEstime ? '~'+w._prixEstime+'‚Ç¨' : '';
    const prixColor = w.prix ? 'var(--cream)' : 'var(--gold)';
    cards += `<div class="wine-card" onclick="openSlotModal(${w.cave},${w.floor},${w.slot})">
      <div class="wine-card-img">
        ${img ? `<img src="${img}" alt="${w.nom||'bouteille'} ${w.annee||''}">` : 'üç∑'}
      </div>
      <div class="wine-card-body">
        <div class="wine-card-name">${w.nom||'‚Äî'}</div>
        <div class="wine-card-sub">${[w.domaine, w.appellation].filter(Boolean).join(' ¬∑ ') || '‚Äî'}</div>
        <div class="wine-card-tags">
          <span class="type-badge badge-${w.type}">${tLabel}</span>
          ${w.annee ? `<span class="format-badge">${w.annee}</span>` : ''}
          <span style="font-size:0.72rem;color:var(--text3)">C${w.cave} ¬∑ √ât.${w.floor} #${w.slot}</span>
        </div>
      </div>
      ${prixAff ? `<div class="wine-card-price"><div class="price-val" style="color:${prixColor}">${prixAff}</div><div class="price-lbl">prix</div></div>` : ''}
    </div>`;
  });
  cards += '</div>';

  cont.innerHTML = html + cards;
  } catch(e) { console.warn('renderList error:', e); }
}

// =====================================================================
// STATS
// =====================================================================







let _isEstimating = false;

async function estimerTousLesVinsAuto() {
  // Throttle: ne pas relancer si d√©j√† en cours ou < 24h depuis la derni√®re estimation compl√®te
  if (_isEstimating) return;
  const lastEstim = parseInt(localStorage.getItem('_lastEstimation') || '0');
  if (Date.now() - lastEstim < 24 * 3600 * 1000) return;

  // N'estimer que les vins sans prix saisi manuellement
  const aEstimer = wineData.filter(w => !w.prix && !w._prixEstime);
  if(aEstimer.length === 0) return;

  _isEstimating = true;
  showNotif('üí∞ Estimation des prix en cours (' + aEstimer.length + ' vins)‚Ä¶');

  const BATCH = 15;
  let estim√©s = 0;

  for(let i = 0; i < aEstimer.length; i += BATCH) {
    const batch = aEstimer.slice(i, i + BATCH);
    const lignes = batch.map((w, idx) =>
      `${idx+1}. ${w.nom}|${w.domaine||''}|${w.appellation||''}|${w.annee||''}|${w.type||''}|${w.format||'75cl'}`
    ).join('\n');

    const prompt = `Tu es expert en vins. Pour chaque vin de cette liste (nom|domaine|appellation|mill√©sime|type|format), donne un prix de march√© moyen en euros (une seule valeur arrondie).

${lignes}

R√©ponds UNIQUEMENT avec un tableau JSON, un nombre par vin dans le m√™me ordre :
[45, 120, 28, ...]
Aucun texte autour. Juste le tableau.`;

    try {
      const resp = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'estimerPrix', prompt })
      });
      const data = await resp.json();
      const text = data.text || '';
      const jsonMatch = text.match(/\[[\s\S]*?\]/);
      if(!jsonMatch) continue;
      const prix = JSON.parse(jsonMatch[0]);

      batch.forEach((wine, idx) => {
        const p = parseFloat(prix[idx]);
        if(!p || p <= 0) return;
        const wIdx = wineData.findIndex(w => String(w.id) === String(wine.id));
        if(wIdx === -1) return;
        if(wineData[wIdx].prix) return; // Ne pas √©craser un prix saisi
        wineData[wIdx]._prixEstime = Math.round(p);
        estim√©s++;
      });

      saveData();
      renderList();
      renderStats();

    } catch(e) {
      console.warn('Batch estimation √©chou√©e', e);
    }

    if(i + BATCH < aEstimer.length) await new Promise(r => setTimeout(r, 800));
  }

  if(estim√©s > 0) showNotif('üí∞ ' + estim√©s + ' prix estim√©s ‚úì');
  _isEstimating = false;
  localStorage.setItem('_lastEstimation', String(Date.now()));
}

async function estimerValeurCave() {
  // Estimer tous les vins sans prix puis recalculer
  await estimerTousLesVinsAuto();
  // La valeur totale est d√©j√† affich√©e dans renderStats apr√®s saveData()
}

async function estimerPrixMarche(wineId) {
  const wine = wineData.find(w => String(w.id) === String(wineId));
  if(!wine) return;
  if(wine.prix) { showNotif('Prix saisi manuellement ‚Äî estimation ignor√©e', true); return; }

  const box = document.getElementById('price-estimate-box');
  const btn = document.getElementById('btn-estimer');
  if(!box || !btn) return;

  btn.disabled = true;
  btn.textContent = '‚è≥‚Ä¶';
  box.style.display = 'block';
  box.innerHTML = '<div style="color:var(--text2);font-style:italic;font-size:0.9rem">Estimation en cours‚Ä¶</div>';

  const prompt = `Tu es expert en vins. Donne le prix de march√© moyen actuel en euros (une seule valeur enti√®re arrondie) pour ce vin :
Nom: ${wine.nom||'‚Äî'} | Domaine: ${wine.domaine||'‚Äî'} | Appellation: ${wine.appellation||'‚Äî'} | Mill√©sime: ${wine.annee||'‚Äî'} | Type: ${wine.type||'‚Äî'} | Format: ${wine.format||'75cl'}
R√©ponds UNIQUEMENT avec un nombre entier. Ex: 45`;

  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'estimerPrix', prompt })
    });
    const data = await response.json();
    const text = (data.text || '').trim();
    const prix = parseInt(text.match(/\d+/)?.[0]);
    if(!prix || prix <= 0) throw new Error('Prix invalide');

    const wIdx = wineData.findIndex(w => String(w.id) === String(wineId));
    if(wIdx !== -1) {
      wineData[wIdx]._prixEstime = prix;
      saveData();
      renderList();
      renderStats();
    }

    box.innerHTML = `
      <div style="font-size:0.68rem;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">üí∞ Prix march√© estim√©</div>
      <div style="font-size:1.4rem;font-family:'Playfair Display',serif;color:var(--gold)">${prix} ‚Ç¨</div>
      ${wine.prix ? '' : '<div style="font-size:0.78rem;color:var(--text2);margin-top:4px">Saisissez un prix dans la fiche pour remplacer cette estimation</div>'}`;

    btn.textContent = 'üí∞ R√©-estimer';
    btn.disabled = false;

  } catch(err) {
    box.innerHTML = `<div style="color:#e57373;font-size:0.85rem">Estimation indisponible ‚Äî ${err.message}</div>`;
    btn.textContent = 'üí∞ Estimer';
    btn.disabled = false;
  }
}

function renderStats() {
  const total   = wineData.length;
  // valTotale = prix saisi EN PRIORIT√â, sinon estimation Groq
  const valTotale  = wineData.reduce((s,w)=>s+(parseFloat(w.prix)||parseFloat(w._prixEstime)||0),0);
  const nbEstimes  = wineData.filter(w => w._prixEstime && !w.prix).length;
  const nbAvecPrix = wineData.filter(w => w.prix).length;
  const nbAvecValeur = nbAvecPrix + nbEstimes;
  // Prix moyen bas√© sur tous les vins ayant une valeur (saisi ou estim√©)
  const avgPrix = nbAvecValeur ? Math.round(valTotale / nbAvecValeur) : 0;
  const types   = {}; wineData.forEach(w=>{ const t=w.type||'autre'; types[t]=(types[t]||0)+1; });
  const decades = {}; wineData.forEach(w=>{ if(w.annee){ const d=Math.floor(w.annee/10)*10; decades[d]=(decades[d]||0)+1; }});
  const regions = {}; wineData.forEach(w=>{ if(w.region){ regions[w.region]=(regions[w.region]||0)+1; }});
  const appells = {}; wineData.forEach(w=>{ if(w.appellation){ appells[w.appellation]=(appells[w.appellation]||0)+1; }});
  const cap1    = CAVE_CONFIG[1].floors.reduce((s,f)=>s+f.slots,0);
  const cap2    = CAVE_CONFIG[2].floors.reduce((s,f)=>s+f.slots,0);
  const occ1    = wineData.filter(w=>w.cave==1).length;
  const occ2    = wineData.filter(w=>w.cave==2).length;

  const winesAvecPrix = wineData.filter(w => parseFloat(w.prix) > 0);
  // Stat cards
  document.getElementById('statsGrid').innerHTML=`
    <div class="stat-card"><div class="s-val">${total}</div><div class="s-lbl">Bouteilles total</div></div>
    <div class="stat-card" style="cursor:pointer;border-color:rgba(201,168,76,0.3)" onclick="estimerValeurCave()">
      <div class="s-val" style="color:var(--green2)">${Math.round(valTotale).toLocaleString('fr-FR')} ‚Ç¨</div>
      <div class="s-lbl">Valeur estim√©e cave<br><span style="font-size:0.7rem;opacity:0.7">${nbAvecPrix} prix saisis ¬∑ ${nbEstimes} estim√©s Groq ¬∑ cliquer pour estimer les manquants</span></div>
    </div>
    <div class="stat-card"><div class="s-val">${avgPrix} ‚Ç¨</div><div class="s-lbl">Prix moyen / bouteille<br><span style="font-size:0.7rem;opacity:0.7">sur ${nbAvecValeur} vins avec valeur</span></div></div>
    <div class="stat-card"><div class="s-val">${occ1+occ2}/${cap1+cap2}</div><div class="s-lbl">Taux remplissage global</div></div>`;

  // Helper pour g√©n√©rer les barres
  function makeBarChart(elId, data, colorFn, limit=15) {
    const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]).slice(0,limit);
    const maxV = Math.max(1,...sorted.map(e=>e[1]));
    document.getElementById(elId).innerHTML = sorted.length
      ? sorted.map(([k,v])=>`
        <div class="bar-row">
          <div class="bar-label" title="${k}">${k.length>14?k.slice(0,13)+'‚Ä¶':k}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${v/maxV*100}%;${colorFn(k)}"></div></div>
          <div class="bar-count">${v}</div>
        </div>`).join('')
      : '<div style="color:var(--text2);font-style:italic;padding:10px">Aucune donn√©e</div>';
  }

  // Type
  const typeOrder = ['rouge','blanc','ros√©','effervescent','vdn_blanc','vdn_rouge','liquoreux'];
  const typeNames = {rouge:'Rouge',blanc:'Blanc','ros√©':'Ros√©',effervescent:'Effervescent',vdn_blanc:'VDN Blanc',vdn_rouge:'VDN Rouge',liquoreux:'Liquoreux'};
  const typeColors = {rouge:'background:linear-gradient(90deg,#5a1020,#9e2a3f)',blanc:'background:linear-gradient(90deg,#7a5a10,#c9a84c)','ros√©':'background:linear-gradient(90deg,#8a3050,#c06080)',effervescent:'background:linear-gradient(90deg,#204060,#5090c0)',vdn_blanc:'background:linear-gradient(90deg,#7a6010,#f5d97a)',vdn_rouge:'background:linear-gradient(90deg,#3e1008,#a04020)',liquoreux:'background:linear-gradient(90deg,#803810,#d07030)'};
  const maxT = Math.max(1,...Object.values(types));
  document.getElementById('chartType').innerHTML = typeOrder.map(t=>`
    <div class="bar-row">
      <div class="bar-label">${typeNames[t]||t}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${((types[t]||0)/maxT*100)}%;${typeColors[t]||'background:var(--wine)'}"></div></div>
      <div class="bar-count">${types[t]||0}</div>
    </div>`).join('');

  // Mill√©sime
  const decKeys = Object.keys(decades).sort();
  const maxD = Math.max(1,...Object.values(decades));
  document.getElementById('chartDecade').innerHTML = decKeys.length
    ? decKeys.map(d=>`
      <div class="bar-row">
        <div class="bar-label">${d}s</div>
        <div class="bar-track"><div class="bar-fill" style="width:${decades[d]/maxD*100}%;background:linear-gradient(90deg,#3a1828,#9e2a3f)"></div></div>
        <div class="bar-count">${decades[d]}</div>
      </div>`).join('')
    : '<div style="color:var(--text2);font-style:italic;padding:10px">Aucune ann√©e renseign√©e</div>';

  // R√©gion
  makeBarChart('chartRegion', regions, ()=>'background:linear-gradient(90deg,#1a3a2a,#2d7a4e)');

  // Appellation (top 15)
  makeBarChart('chartAppellation', appells, ()=>'background:linear-gradient(90deg,#2a1a3a,#6040a0)', 15);

  // Caves occupation
  document.getElementById('chartCaves').innerHTML = [
    {label:'Cave 1', occ:occ1, cap:cap1, color:'#9e2a3f'},
    {label:'Cave 2', occ:occ2, cap:cap2, color:'#c9a84c'}
  ].map(c=>{
    const pct = Math.round(c.occ/c.cap*100)||0;
    return `<div style="text-align:center;min-width:160px">
      <div style="position:relative;width:120px;height:120px;margin:0 auto">
        <svg viewBox="0 0 36 36" style="width:120px;height:120px;transform:rotate(-90deg)">
          <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--bg3)" stroke-width="3"/>
          <circle cx="18" cy="18" r="15.9" fill="none" stroke="${c.color}" stroke-width="3"
            stroke-dasharray="${pct} ${100-pct}" stroke-dashoffset="0" stroke-linecap="round"/>
        </svg>
        <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">
          <div style="font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--cream)">${pct}%</div>
          <div style="font-size:0.7rem;color:var(--text2)">${c.occ}/${c.cap}</div>
        </div>
      </div>
      <div style="margin-top:10px;color:var(--text2);font-size:0.85rem;letter-spacing:1px">${c.label}</div>
    </div>`;
  }).join('');
}

// =====================================================================
// NOTIF
// =====================================================================
// ‚îÄ‚îÄ Sanitisation ‚Äî √©chappe les caract√®res HTML dangereux ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sanitize(str) {
  if (str == null) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function showNotif(msg, error=false) {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.className = 'show'+(error?' error':'');
  setTimeout(()=>n.className='', 3000);
}


// =====================================================================
// PASSWORD
// =====================================================================
function migrateImagesToStore() {
  try {
    const cave = JSON.parse(localStorage.getItem('caveData') || '[]');
    cave.forEach(w => { if(w.image && w.id) imgSave('wine_' + w.id, w.image); });
    const deg = JSON.parse(localStorage.getItem('degustationData') || '[]');
    deg.forEach(d => { if(d.image && d.id) imgSave('deg_' + d.id, d.image); });
  } catch(e) {}
}

async function checkPwd() {
  const val = document.getElementById('pwd-input').value.trim();
  if(!val) return;

  // Hasher ce que l'utilisateur a tap√© avec SHA-256
  const encoder = new TextEncoder();
  const data = encoder.encode(val);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

  // R√©cup√©rer le hash stock√© dans le Google Sheet
  const cbName = 'configCallback_' + Date.now();
  const timeout = setTimeout(() => {
    delete window[cbName];
    const s = document.getElementById('config-script');
    if(s) s.remove();
    showLoginError();
  }, 8000);

  window[cbName] = function(config) {
    clearTimeout(timeout);
    delete window[cbName];
    const s = document.getElementById('config-script');
    if(s) s.remove();
    const storedHash = config.password_hash || '';
    if(hashHex === storedHash) {
      sessionStorage.setItem('cave_auth', '1');
      document.getElementById('pwd-screen').classList.add('hidden');
      migrateImagesToStore();
      loadFromSheets();
    } else {
      showLoginError();
    }
  };

  const script = document.createElement('script');
  script.id = 'config-script';
  script.src = SCRIPT_URL + '?action=getConfig&callback=' + cbName + '&t=' + Date.now();
  document.body.appendChild(script);
}

function showLoginError() {
  const inp = document.getElementById('pwd-input');
  inp.classList.add('error');
  document.getElementById('pwd-error').textContent = 'Mot de passe incorrect';
  setTimeout(() => { inp.classList.remove('error'); inp.value = ''; }, 800);
}

function initAuth() {
  if(sessionStorage.getItem('cave_auth') === '1') {
    document.getElementById('pwd-screen').classList.add('hidden');
  }
  // Sinon l'√©cran mot de passe reste visible
}

// =====================================================================
// INIT
// =====================================================================
window.addEventListener('load', () => {
  updateHeader();
  updateEtageSelect();
  renderCave2D();
  initAuth();
  if(sessionStorage.getItem('cave_auth') === '1') {
    loadFromSheets();
    // Retenter une sync √©chou√©e ‚Äî APR√àS que loadFromSheets soit termin√© (timeout interne = 8s)
    // D√©lai 10s pour √™tre s√ªr que le sheet est charg√© avant de r√©√©crire dessus
    if(localStorage.getItem('_pendingSync') === '1') {
      localStorage.removeItem('_pendingSync');
      setTimeout(() => {
        if (!_loadInProgress) { setSyncIndicator('saving'); _doSyncToSheets(); }
      }, 10000);
    }
  }
});

// =====================================================================
// VIVINO IMAGE SEARCH
// =====================================================================
// =====================================================================
// PHOTO UPLOAD ‚Äî CAVE FORM
// =====================================================================
async function handleImageFile(input) {
  const file = input.files && input.files[0];
  if(!file) return;
  if(!file.type.startsWith('image/')) { showNotif('Fichier non reconnu', true); return; }
  input.value = '';

  // Aper√ßu local imm√©diat pendant l'upload
  const pw = document.getElementById('img-preview-wrap');
  const pi = document.getElementById('img-preview');
  const reader = new FileReader();
  reader.onload = e => { if(pw && pi) { pi.src = e.target.result; pw.style.display = 'block'; } };
  reader.readAsDataURL(file);

  // Upload Cloudinary
  showNotif('üì§ Upload en cours‚Ä¶');
  try {
    const publicId = 'cave_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', CLOUDINARY_PRESET);
    fd.append('public_id', publicId);
    fd.append('asset_folder', 'cave_vins');
    const res  = await fetch(CLOUDINARY_URL, { method:'POST', body:fd });
    const data = await res.json();
    if(data.secure_url) {
      const imgField = document.getElementById('f-image');
      if(imgField) imgField.value = data.secure_url;
      if(pi) pi.src = data.secure_url;
      // Sauvegarder dans imageStore avec l'ID du vin en cours d'√©dition si disponible
      if(addingToSlot?.editing) imgSave('wine_' + addingToSlot.editing, data.secure_url);
      showNotif('Photo sauvegard√©e ‚úì');
    } else {
      throw new Error(data.error?.message || 'Erreur Cloudinary');
    }
  } catch(e) {
    showNotif('Erreur upload : ' + e.message, true);
  }
}

function onImageUrlChange(url) {
  const pw = document.getElementById('img-preview-wrap');
  const pi = document.getElementById('img-preview');
  if(!pw || !pi) return;
  if(url && url.startsWith('http')) {
    pi.src = url;
    pw.style.display = 'block';
    pi.onerror = () => { pw.style.display = 'none'; };
    pi.onload  = () => { pi.onerror = null; };
  } else if(!url) {
    pw.style.display = 'none';
    pi.src = '';
  }
}

function clearImage() {
  const imgField = document.getElementById('f-image');
  if(imgField) imgField.value = '';
  const pw = document.getElementById('img-preview-wrap');
  const pi = document.getElementById('img-preview');
  if(pw) pw.style.display = 'none';
  if(pi) pi.src = '';
}

// =====================================================================
// D√âGUSTATIONS HORS CAVE
// =====================================================================
let degustationData = (() => {
  const raw = JSON.parse(localStorage.getItem('degustationData') || '[]');
  // Nettoyage strict : une vraie d√©gustation a un id dg_/h_, ou un source valide, ET une date
  const clean = raw.filter(d => {
    if(!d.id || !d.nom) return false;
    // Rejeter structurellement les vins de cave
    if('cave' in d || 'floor' in d || 'slot' in d) return false;
    // Accepter uniquement si source valide OU id typ√© d√©gustation
    const validSource = d.source === 'cave' || d.source === 'hors_cave'
      || String(d.id).startsWith('h_') || String(d.id).startsWith('dg_');
    if(!validSource) return false;
    // Doit avoir une date de d√©gustation ou d'ajout
    if(!d.date && !d.dateAjout) return false;
    return true;
  });
  if(clean.length !== raw.length) {
    console.warn('degustationData : purge de', raw.length - clean.length, 'entr√©es parasites');
    localStorage.setItem('degustationData', JSON.stringify(clean));
  }
  return clean;
})();

function saveDegustationData() {
  // Normaliser les dates en YYYY-MM-DD avant sauvegarde
  degustationData = degustationData.map(d => ({
    ...d,
    date:      d.date      ? String(d.date).substring(0,10)      : '',
    dateAjout: d.dateAjout ? String(d.dateAjout).substring(0,10) : ''
  }));
  localStorage.setItem('degustationData', JSON.stringify(degustationData));
  syncHistoriqueFromDeg();
  // Sync vers Sheets : TOUT (cave + hors_cave) dans le sheet Degustation
  // On envoie uniquement les entr√©es qui ont un champ source valide
  const toSync = degustationData.filter(d => d.id && d.nom && (d.source === 'cave' || d.source === 'hors_cave'));
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'saveDegustation', data: toSync })
  }).catch(e => console.warn('Sync degustation √©chou√©e', e));
}

function saveDegustationEntryToSheets(entry) {
  // Envoi d'une seule entr√©e (pour compatibilit√© Apps Script ligne par ligne)
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'saveDegustationEntry', data: entry })
  }).catch(e => console.warn('Sync degustation entry √©chou√©e', e));
}

function openAddDegustation(editId) {
  const modal = document.getElementById('modalDegustation');
  const title = document.getElementById('deg-modal-title');
  // Set today's date default
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('deg-date').value = today;
  // Clear form
  ['deg-nom','deg-appellation','deg-domaine','deg-region','deg-annee','deg-prix','deg-commentaire','deg-occasion','deg-image'].forEach(id=>{
    const el = document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('deg-note').value = '';
  document.getElementById('deg-type').value = 'rouge';
  document.getElementById('deg-racheter').value = '';
  clearDegImage();

  if(editId) {
    const entry = degustationData.find(d=>d.id===editId);
    if(entry) {
      title.textContent = '‚úèÔ∏è Modifier la d√©gustation';
      modal._editId = editId;
      document.getElementById('deg-nom').value         = entry.nom||'';
      document.getElementById('deg-appellation').value = entry.appellation||'';
      document.getElementById('deg-domaine').value     = entry.domaine||'';
      document.getElementById('deg-region').value      = entry.region||'';
      document.getElementById('deg-annee').value       = entry.annee||'';
      document.getElementById('deg-prix').value        = entry.prix||'';
      document.getElementById('deg-type').value        = entry.type||'rouge';
      document.getElementById('deg-note').value        = entry.note||'';
      document.getElementById('deg-date').value        = entry.date||today;
      document.getElementById('deg-occasion').value    = entry.occasion||'';
      document.getElementById('deg-commentaire').value = entry.commentaire||'';
      document.getElementById('deg-racheter').value    = entry.racheter||'';
      document.getElementById('deg-image').value       = entry.image||'';
      if(entry.image) {
        const pw = document.getElementById('deg-img-preview-wrap');
        const pi = document.getElementById('deg-img-preview');
        if(pw && pi) { pi.src = entry.image; pw.style.display = 'block'; }
      }
    }
  } else {
    title.textContent = 'ü•Ç Nouvelle d√©gustation';
    modal._editId = null;
  }
  modal.classList.add('open');
}

function saveDegustation() {
  const nom = document.getElementById('deg-nom').value.trim();
  if(!nom) { showNotif('Le nom est requis', true); return; }
  const modal = document.getElementById('modalDegustation');
  const editId = modal._editId;
  const _degId = editId || 'dg_' + Date.now();
  const entry = {
    id:          _degId,
    source:      'hors_cave',
    nom,
    appellation: document.getElementById('deg-appellation').value.trim(),
    domaine:     document.getElementById('deg-domaine').value.trim(),
    region:      document.getElementById('deg-region').value.trim(),
    type:        document.getElementById('deg-type').value,
    annee:       document.getElementById('deg-annee').value,
    prix:        document.getElementById('deg-prix').value,
    note:        document.getElementById('deg-note').value,
    date:        document.getElementById('deg-date').value,
    occasion:    document.getElementById('deg-occasion').value.trim(),
    commentaire: document.getElementById('deg-commentaire').value.trim(),
    racheter:    document.getElementById('deg-racheter').value,
    image:       document.getElementById('deg-image').value,
    dateAjout:   new Date().toISOString().split('T')[0]
  };
  // Persist image URL in imageStore
  if(entry.image) imgSave('deg_' + _degId, entry.image);
  else imgSave('deg_' + _degId, '');
  if(editId) {
    degustationData = degustationData.map(d => d.id === editId ? entry : d);
  } else {
    degustationData.unshift(entry);
  }
  saveDegustationData();
  saveDegustationEntryToSheets(entry); // Sync entr√©e individuelle aussi
  closeModal('modalDegustation');
  renderDegustations();
  renderHistorique();
  showNotif(editId ? 'D√©gustation modifi√©e ‚úì' : 'D√©gustation enregistr√©e ‚úì');
}

function deleteDegustation(id) {
  if(!confirm('Supprimer cette d√©gustation ?')) return;
  degustationData = degustationData.filter(d => d.id !== id);
  saveDegustationData();
  renderDegustations();
  renderHistorique();
  showNotif('D√©gustation supprim√©e');
}

async function handleDegImageFile(input) {
  const file = input.files && input.files[0];
  if(!file) return;
  input.value = '';

  // Aper√ßu local imm√©diat
  const pw = document.getElementById('deg-img-preview-wrap');
  const pi = document.getElementById('deg-img-preview');
  const reader = new FileReader();
  reader.onload = e => { if(pw && pi) { pi.src = e.target.result; pw.style.display = 'block'; } };
  reader.readAsDataURL(file);

  // Upload Cloudinary
  showNotif('üì§ Upload en cours‚Ä¶');
  try {
    const publicId = 'deg_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', CLOUDINARY_PRESET);
    fd.append('public_id', publicId);
    fd.append('asset_folder', 'cave_vins');
    const res  = await fetch(CLOUDINARY_URL, { method:'POST', body:fd });
    const data = await res.json();
    if(data.secure_url) {
      document.getElementById('deg-image').value = data.secure_url;
      if(pi) pi.src = data.secure_url;
      showNotif('Photo sauvegard√©e ‚úì');
    } else {
      throw new Error(data.error?.message || 'Erreur Cloudinary');
    }
  } catch(e) {
    showNotif('Erreur upload : ' + e.message, true);
  }
}

function onDegImageUrlChange(url) {
  const pw = document.getElementById('deg-img-preview-wrap');
  const pi = document.getElementById('deg-img-preview');
  if(!pw || !pi) return;
  if(url && url.startsWith('http')) {
    pi.src = url; pw.style.display = 'block';
    pi.onerror = () => { pw.style.display = 'none'; };
  } else if(!url) {
    pw.style.display = 'none'; pi.src = '';
  }
}

function clearDegImage() {
  document.getElementById('deg-image').value = '';
  const pw = document.getElementById('deg-img-preview-wrap');
  const pi = document.getElementById('deg-img-preview');
  if(pw) pw.style.display = 'none';
  if(pi) pi.src = '';
}

// Appel√© depuis le bouton ‚úï sur l'image existante dans le modal deg
function clearDegImageAndNotify() {
  clearDegImage();
  showNotif('Image retir√©e ‚Äî enregistrez pour confirmer');
}

function renderDegustations() {
  // Onglet degustation supprim√© ‚Äî tout est dans renderHistorique()
  renderHistorique();
}

function searchVivino() {
  const nom     = (document.getElementById('f-nom')?.value     || '').trim();
  const domaine = (document.getElementById('f-domaine')?.value || '').trim();
  const annee   = (document.getElementById('f-annee')?.value   || '').trim();
  if(!nom && !domaine) { showNotif('Entrez le nom du vin ou le producteur', true); return; }
  const queryStr = [domaine, nom, annee].filter(Boolean).join(' ');
  const query = encodeURIComponent(queryStr);
  const vivinoUrl = 'https://www.vivino.com/search/wines?q=' + query;
  const resultsBox = document.getElementById('vivino-results');
  const gridEl     = document.getElementById('vivino-grid');
  resultsBox.style.display = 'block';
  gridEl.innerHTML = `<div style="color:var(--text2);font-size:0.88rem;line-height:2">
    <a href="${vivinoUrl}" target="_blank" rel="noopener" style="display:inline-block;margin-bottom:12px;padding:8px 18px;background:var(--wine);color:var(--cream);text-decoration:none;border-radius:2px;font-size:0.95rem;letter-spacing:1px">üçá Ouvrir Vivino ‚Äî ${queryStr}</a><br>
    <span style="color:var(--cream)">1.</span> Cliquez le lien ci-dessus<br>
    <span style="color:var(--cream)">2.</span> Cliquez sur le vin voulu sur Vivino<br>
    <span style="color:var(--cream)">3.</span> Clic droit sur l'√©tiquette ‚Üí <i>Copier l'adresse de l'image</i><br>
    <span style="color:var(--cream)">4.</span> Collez l'URL dans le champ ci-dessus
  </div>`;
}


// =====================================================================
// HISTORIQUE
// =====================================================================
let historiqueData = []; // alias calcul√© ‚Äî voir syncHistoriqueFromDeg()

function syncHistoriqueFromDeg() {
  historiqueData = degustationData.filter(d => d.source === 'cave' || (!d.source && d.id && String(d.id).startsWith('h_')));
}

// Initialiser l'alias au boot
syncHistoriqueFromDeg();

function saveHistoriqueToSheets(entry) {
  // Tout va dans le sheet Degustation maintenant
  saveDegustationEntryToSheets(entry);
}

function loadHistoriqueFromSheets() {
  // Redirige vers loadDegustationFromSheets ‚Äî tout est fusionn√© dans Degustation
  loadDegustationFromSheets();
}

function loadDegustationFromSheets() {
  const cbName = 'degCallback_' + Date.now();
  const timeout = setTimeout(() => { delete window[cbName]; }, 8000);
  window[cbName] = function(data) {
    clearTimeout(timeout);
    delete window[cbName];
    if(!Array.isArray(data) || data.length === 0) return;
    // V√©rifier que ce sont bien des d√©gustations (pas des vins de cave)
    const isDegustation = data[0] && !('cave' in data[0]) && !('floor' in data[0]) && !('slot' in data[0]);
    if(!isDegustation) {
      console.warn('loadDegustationFromSheets: donn√©es cave re√ßues, ignor√©es');
      return;
    }
    // Filtrer strictement : garder uniquement les vraies d√©gustations
    // Une vraie d√©gustation a obligatoirement source='cave' ou 'hors_cave'
    // ET au moins un champ de d√©gustation (date ou dateAjout)
    const validEntries = data.filter(d => {
      if(!d.id || !d.nom) return false;
      const validSource = d.source === 'cave' || d.source === 'hors_cave'
        || String(d.id).startsWith('h_') || String(d.id).startsWith('dg_');
      const hasDegDate = d.date || d.dateAjout;
      return validSource && hasDegDate;
    });

    if(validEntries.length === 0 && data.length > 0) {
      console.warn('loadDegustationFromSheets: aucune entr√©e valide parmi', data.length, '‚Äî sheet probablement pollu√©, ignor√©');
      return;
    }

    const localById = {};
    degustationData.forEach(d => { if(d.id) localById[d.id] = d; });
    degustationData = validEntries.map(d => {
      const source = d.source || (String(d.id).startsWith('h_') ? 'cave' : 'hors_cave');
      const imgKey = source === 'cave' ? ('hist_' + d.id) : ('deg_' + d.id);
      const img = imgGet(imgKey) || d.image || (localById[d.id]?.image) || '';
      if(img && d.id) imgSave(imgKey, img);
      return { ...d, source, image: img };
    });
    localStorage.setItem('degustationData', JSON.stringify(degustationData));
    syncHistoriqueFromDeg();
    renderHistorique();
    renderDegustations();
  };
  const script = document.createElement('script');
  script.src = SCRIPT_URL + '?sheet=Degustation&callback=' + cbName + '&t=' + Date.now();
  document.body.appendChild(script);
}

function renderHistorique() {
  const container = document.getElementById('histo-list');
  const empty     = document.getElementById('histo-empty');
  const count     = document.getElementById('histo-count');
  if(!container) return;

  const q       = (document.getElementById('histo-search')?.value || '').toLowerCase();
  const sourceF = document.getElementById('histo-filter-source')?.value || '';
  const typeF   = document.getElementById('histo-filter-type')?.value || '';

  // Tout vient de degustationData (source = 'cave' ou 'hors_cave')
  let allEntries = degustationData.map(d => ({...d, _source: d.source || (String(d.id).startsWith('h_') ? 'cave' : 'hors_cave')}));

  // Filtres
  allEntries = allEntries.filter(h => {
    if(sourceF && h._source !== sourceF) return false;
    if(typeF && h.type !== typeF) return false;
    if(q) {
      const text = [h.nom, h.domaine, h.appellation, h.region, h.occasion, h.commentaire].join(' ').toLowerCase();
      if(!text.includes(q)) return false;
    }
    return true;
  });

  // Tri par date d√©croissante
  allEntries.sort((a,b) => {
    const da = a.date || a.dateAjout || '';
    const db = b.date || b.dateAjout || '';
    return db > da ? 1 : -1;
  });

  if(!allEntries.length) {
    empty.style.display = 'block';
    container.innerHTML = '';
    count.textContent = '';
    return;
  }
  empty.style.display = 'none';
  count.textContent = allEntries.length + ' entr√©e' + (allEntries.length>1?'s':'');

  container.innerHTML = allEntries.map((h) => {
    const stars   = '‚òÖ'.repeat(parseInt(h.note)||0) + '‚òÜ'.repeat(5-(parseInt(h.note)||0));
    const _hImg = h._source === 'cave' ? (imgGet('hist_' + h.id) || h.image || '') : (imgGet('deg_' + h.id) || h.image || '');
    const imgHtml = _hImg
      ? `<img src="${_hImg}" alt="${h.nom||'bouteille'} ${h.annee||''}" style="width:50px;height:70px;object-fit:contain;border-radius:3px;flex-shrink:0;border:1px solid var(--border)">`
      : `<div style="width:50px;height:70px;background:var(--bg3);border-radius:3px;flex-shrink:0;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;color:var(--text2);font-size:1.4rem">üç∑</div>`;
    const isHorsCave = h._source === 'hors_cave';
    const sourceBadge = isHorsCave
      ? `<span style="font-size:0.67rem;color:var(--text2);border:1px solid rgba(201,168,76,0.3);border-radius:10px;padding:1px 7px;background:rgba(201,168,76,0.07);white-space:nowrap;margin-left:5px">hors cave</span>`
      : `<span style="font-size:0.67rem;color:var(--text2);border:1px solid rgba(80,80,80,0.3);border-radius:10px;padding:1px 7px;background:rgba(80,80,80,0.07);white-space:nowrap;margin-left:5px">cave</span>`;
    const editBtns = isHorsCave
      ? `<div style="display:flex;gap:6px;margin-top:6px;justify-content:flex-end">
           <button onclick="openAddDegustation('${h.id}')" style="padding:4px 9px;background:transparent;border:1px solid var(--border);color:var(--text2);font-family:'Cormorant Garamond',serif;font-size:0.78rem;cursor:pointer;border-radius:2px;transition:all 0.2s" class="btn-action-file">‚úèÔ∏è</button>
           <button onclick="deleteDegustation('${h.id}')" style="padding:4px 9px;background:transparent;border:1px solid var(--border);color:var(--text2);font-family:'Cormorant Garamond',serif;font-size:0.78rem;cursor:pointer;border-radius:2px;transition:all 0.2s" class="btn-action-del">üóë</button>
         </div>`
      : `<div style="display:flex;gap:6px;margin-top:6px;justify-content:flex-end">
           <button onclick="openEditHistorique('${h.id}')" style="padding:4px 9px;background:transparent;border:1px solid var(--border);color:var(--text2);font-family:'Cormorant Garamond',serif;font-size:0.78rem;cursor:pointer;border-radius:2px;transition:all 0.2s" class="btn-action-file">‚úèÔ∏è</button>
           <button onclick="deleteHistorique('${h.id}')" style="padding:4px 9px;background:transparent;border:1px solid var(--border);color:var(--text2);font-family:'Cormorant Garamond',serif;font-size:0.78rem;cursor:pointer;border-radius:2px;transition:all 0.2s" class="btn-action-del">üóë</button>
         </div>`;
    const borderCol = isHorsCave ? 'rgba(201,168,76,0.2)' : 'var(--border)';
    const bgCol     = isHorsCave ? 'rgba(201,168,76,0.025)' : 'var(--bg2)';
    return `<div style="display:flex;gap:16px;align-items:flex-start;padding:16px;background:${bgCol};border:1px solid ${borderCol};border-radius:4px;margin-bottom:10px">
      ${imgHtml}
      <div style="flex:1;min-width:0">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px">
          <div style="flex:1;min-width:0">
            <div style="font-family:'Playfair Display',serif;font-size:1.05rem;color:var(--cream);display:flex;align-items:baseline;flex-wrap:wrap;gap:4px">${h.nom||'‚Äî'}${h.annee?`<span style="color:var(--text2);font-size:0.9rem">${h.annee}</span>`:''}${sourceBadge}</div>
            <div style="font-size:0.82rem;color:var(--text2);margin-top:2px">${[h.domaine,h.appellation,h.region].filter(Boolean).join(' ¬∑ ')}</div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-size:0.75rem;color:var(--text2)">${formatDateFR(h.date||h.dateAjout)}</div>
            <div style="color:var(--gold);font-size:0.9rem;margin-top:2px">${stars}</div>
            ${editBtns}
          </div>
        </div>
        ${h.occasion?`<div style="margin-top:6px;font-size:0.8rem;color:var(--text2);font-style:italic">üìç ${h.occasion}</div>`:''}
        ${h.commentaire?`<div style="margin-top:6px;font-size:0.88rem;color:var(--text2);line-height:1.5;font-style:italic">"${h.commentaire}"</div>`:''}
      </div>
    </div>`;
  }).join('');
}


// =====================================================================
// √âDITION HISTORIQUE CAVE
// =====================================================================

function openEditHistorique(id) {
  const entry = degustationData.find(d => String(d.id) === String(id));
  if(!entry) return;
  const modal = document.getElementById('modalEditHistorique');
  modal._editId = id;
  document.getElementById('edit-histo-title').textContent = '‚úèÔ∏è ' + (entry.nom||'') + (entry.annee ? ' ' + entry.annee : '');
  document.getElementById('edit-histo-date').value        = entry.date || '';
  document.getElementById('edit-histo-note').value        = entry.note || '';
  document.getElementById('edit-histo-occasion').value    = entry.occasion || '';
  document.getElementById('edit-histo-commentaire').value = entry.commentaire || '';
  document.getElementById('edit-histo-image').value       = entry.image || '';
  const pw = document.getElementById('edit-histo-img-wrap');
  const pi = document.getElementById('edit-histo-img-preview');
  if(entry.image && pw && pi) { pi.src = entry.image; pw.style.display = 'block'; }
  else if(pw) pw.style.display = 'none';
  modal.classList.add('open');
}

function saveEditHistorique() {
  const modal = document.getElementById('modalEditHistorique');
  const id = modal._editId;
  if(!id) return;
  const idx = historiqueData.findIndex(h => String(h.id) === String(id));
  if(idx === -1) return;
  const _newImage = document.getElementById('edit-histo-image').value.trim();
  const degIdx = degustationData.findIndex(d => String(d.id) === String(id));
  if(degIdx !== -1) {
    degustationData[degIdx] = {
      ...degustationData[degIdx],
      date:        document.getElementById('edit-histo-date').value,
      note:        document.getElementById('edit-histo-note').value,
      occasion:    document.getElementById('edit-histo-occasion').value.trim(),
      commentaire: document.getElementById('edit-histo-commentaire').value.trim(),
      image:       _newImage
    };
    imgSave('hist_' + id, _newImage);
    saveDegustationData();
    saveDegustationEntryToSheets(degustationData[degIdx]);
  }
  closeModal('modalEditHistorique');
  renderHistorique();
  showNotif('D√©gustation mise √† jour ‚úì');
}

function deleteHistorique(id) {
  if(!confirm("Supprimer cette entr√©e de l'historique ?")) return;
  degustationData = degustationData.filter(d => String(d.id) !== String(id));
  saveDegustationData();
  renderHistorique();
  showNotif('Entr√©e supprim√©e');
}

// Handlers image pour le modal √©dition historique cave
async function handleHistoImageFile(input) {
  const file = input.files && input.files[0];
  if(!file) return;
  input.value = '';
  const pw = document.getElementById('edit-histo-img-wrap');
  const pi = document.getElementById('edit-histo-img-preview');
  const reader = new FileReader();
  reader.onload = e => { if(pw && pi) { pi.src = e.target.result; pw.style.display = 'block'; } };
  reader.readAsDataURL(file);
  showNotif('üì§ Upload en cours‚Ä¶');
  try {
    const publicId = 'histo_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', CLOUDINARY_PRESET);
    fd.append('public_id', publicId);
    fd.append('asset_folder', 'cave_vins');
    const res  = await fetch(CLOUDINARY_URL, { method:'POST', body:fd });
    const data = await res.json();
    if(data.secure_url) {
      document.getElementById('edit-histo-image').value = data.secure_url;
      if(pi) pi.src = data.secure_url;
      showNotif('Photo sauvegard√©e ‚úì');
    } else {
      throw new Error(data.error?.message || 'Erreur Cloudinary');
    }
  } catch(e) {
    showNotif('Erreur upload : ' + e.message, true);
  }
}

function onHistoImageUrlChange(url) {
  const pw = document.getElementById('edit-histo-img-wrap');
  const pi = document.getElementById('edit-histo-img-preview');
  if(!pw || !pi) return;
  if(url && url.startsWith('http')) {
    pi.src = url; pw.style.display = 'block';
    pi.onerror = () => { pw.style.display = 'none'; };
  } else if(!url) {
    pw.style.display = 'none'; pi.src = '';
  }
}

function clearHistoImage() {
  document.getElementById('edit-histo-image').value = '';
  const pw = document.getElementById('edit-histo-img-wrap');
  const pi = document.getElementById('edit-histo-img-preview');
  if(pw) pw.style.display = 'none';
  if(pi) pi.src = '';
}

// =====================================================================
// ACCORDS METS-VINS
// =====================================================================

// Accords automatiques par type de vin
const ACCORDS_AUTO = {

  // ============================================================
  // BOURGOGNE ROUGE - Pinot Noir
  // ============================================================
  "Gevrey-Chambertin": {
    plats: ["Becasse rotie au sang","Lievre a la royale","Chevreuil sauce poivrade","Carre d'agneau en croute d'herbes","Filet de boeuf Rossini","Pigeon roti aux truffes","Faisan aux ceps","Poularde demi-deuil","Ris de veau aux morilles noires","Epoisse affine a coeur","Ami du Chambertin","Langres au marc de Bourgogne"],
    mots: ["becasse","lievre","chevreuil","agneau","filet boeuf","pigeon","faisan","poularde","ris de veau","morilles","truffe","epoisse","ami chambertin","langres","gibier","volaille"]
  },
  "Chambolle-Musigny": {
    plats: ["Poularde de Bresse a la creme","Filet de sole au beurre blanc","Turbot roti aux asperges","Caille farcie aux raisins","Saint-Jacques a la vapeur","Veau en blanquette fine","Ris de veau poele aux girolles","Citeaux frais","Chaource cr√©meux"],
    mots: ["poularde","sole","turbot","asperges","caille","saint-jacques","veau","blanquette","girolles","citeaux","chaource","volaille","poisson","creme"]
  },
  "Vosne-Romanee": {
    plats: ["Becasse rotie entiere","Lievre a la royale version Cardinale","Chevreuil grand veneur","Filet de boeuf en croute sauce Perigueux","Turbot poche beurre noisette","Homard a la nage","Ris de veau aux truffes noires","Foie gras poele aux raisins","Epoisse tres affine","Ami du Chambertin"],
    mots: ["becasse","lievre","chevreuil","filet boeuf","truffe","homard","turbot","ris de veau","foie gras","epoisse","gibier","grand veneur"]
  },
  "Nuits-Saint-Georges": {
    plats: ["Carre d'agneau roti","Gigot de chevreuil","Pintade aux champignons","Coq au Chambertin","Andouillette de Chablis","Jambon persille de Bourgogne","Epoisse","Soumaintrain affine","Boeuf bourguignon traditionnel"],
    mots: ["agneau","chevreuil","pintade","coq au vin","andouillette","jambon persille","epoisse","soumaintrain","boeuf bourguignon","champignons"]
  },
  "Pommard": {
    plats: ["Gigot d'agneau de 7 heures","Daube de boeuf provencale","Canard aux olives","Cassoulet de Castelnaudary","Civet de sanglier","Lard fume aux lentilles du Puy","Epoisses","Munster affine","Maroilles"],
    mots: ["gigot agneau","daube boeuf","canard","cassoulet","sanglier","lentilles","epoisse","munster","maroilles","gibier","charcuterie"]
  },
  "Volnay": {
    plats: ["Carre de veau roti","Poularde pochee sauce supreme","Filet de turbot au beurre blanc","Rouget barbet grille","Ris de veau a la creme","Caille aux raisins de Corinthe","Brillat-Savarin","Chaource","Brie de Meaux affine"],
    mots: ["veau","poularde","turbot","rouget","ris de veau","caille","brillat savarin","chaource","brie","poisson","volaille"]
  },
  "Beaune": {
    plats: ["Coq au vin rouge de Bourgogne","Poulet roti et pommes dauphine","Lapin a la moutarde","Terrine de gibier","Jambon a l'os persille","Oeufs en meurette","Gateau de foies blonds","Epoisse jeune","Citeaux"],
    mots: ["coq au vin","poulet","lapin moutarde","terrine gibier","jambon persille","oeufs meurette","foies blonds","epoisse","citeaux"]
  },
  "Aloxe-Corton": {
    plats: ["Carre d'agneau roti au jus","Boeuf braise a la bourguignonne","Pintade aux morilles","Faisan en cocotte","Jambon braise au madere","Soumaintrain","Epoisse","Munster"],
    mots: ["agneau","boeuf braise","pintade","faisan","jambon braise","soumaintrain","epoisse","munster","gibier"]
  },
  "Marsannay": {
    plats: ["Saucisson chaud lyonnais","Andouillette grill√©e sauce moutarde","Lapin aux pruneaux","Poulet roti aux herbes","Jambon persille","Fromage de tete","Epoisses jeune","Citeaux"],
    mots: ["saucisson","andouillette","lapin pruneaux","poulet","jambon","fromage de tete","epoisse","citeaux"]
  },

  // ============================================================
  // BOURGOGNE BLANC - Chardonnay
  // ============================================================
  "Meursault": {
    plats: ["Homard bleu beurre blanc","Turbot sauce hollandaise","Saint-Jacques a la creme de corail","Sole meuniere beurre noisette","Ris de veau aux morilles a la creme","Poularde de Bresse a la creme","Feuillete d'escargots au beurre persille","Tarte fine aux asperges blanches","Comte vieux 18 mois","Beurre blanc nantais"],
    mots: ["homard","turbot","saint-jacques","sole","ris de veau","morilles","poularde","escargots","asperges","comte","creme","beurre blanc","crustaces"]
  },
  "Puligny-Montrachet": {
    plats: ["Homard a la nage","Turbot poche beurre blanc","Sole farcie aux langoustines","Saint-Jacques aux truffes blanches","Langoustines rotis beurre corail","Troncon de turbot a l'oseille","Bar sauvage en croute de sel","Blanc de volaille aux morilles","Feuillete de ris d'agneau"],
    mots: ["homard","turbot","sole","langoustines","saint-jacques","truffe blanche","bar","volaille","ris agneau","morilles","crustaces","poisson noble"]
  },
  "Chassagne-Montrachet": {
    plats: ["Coquille Saint-Jacques au beurre d'algues","Turbot braise aux champignons","Filet de bar beurre blanc","Sandre au beurre blanc","Poulet de Bresse roti a la creme","Feuillete de homard","Comte affine","Chaource","Poule au pot"],
    mots: ["saint-jacques","turbot","bar","sandre","poulet bresse","homard","comte","chaource","poule au pot","creme","beurre"]
  },
  "Chablis": {
    plats: ["Huitres de Marenne-Oleron","Huitres de Bretagne numero 3","Palourdes au naturel","Bulots mayonnaise","Crevettes grises","Langoustines pochees","Sole meuniere","Sole normande","Fruits de mer plateau","Andouillette de Chablis","Sandre sauce gribiche"],
    mots: ["huitres","palourdes","bulots","crevettes","langoustines","sole","fruits de mer","andouillette","sandre","coquillages","plateau mer"]
  },
  "Chablis Grand Cru": {
    plats: ["Huitres speciales de Claire","Homard breton","Langouste mayonnaise","Sole farcie aux truffes","Turbot au beurre blanc","Saint-Jacques au naturel","Caviar Oscietra","Foie gras de canard mi-cuit"],
    mots: ["huitres speciales","homard","langouste","sole truffee","turbot","saint-jacques","caviar","foie gras","crustaces nobles"]
  },
  "Macon-Villages": {
    plats: ["Grenouilles persillees","Quenelles de brochet sauce Nantua","Gateau de foies blonds","Terrine de brochet","Charcuterie lyonnaise","Saucisson brioch√©","Fromage blanc aux herbes","Epoisses jeune","Charolais frais"],
    mots: ["grenouilles","quenelles","brochet","foies blonds","charcuterie lyonnaise","saucisson brioche","fromage blanc","epoisse","charolais"]
  },
  "Pouilly-Fuisse": {
    plats: ["Grenouilles a la creme d'ail","Quenelles de brochet lyonnaises","Ecrevisses a la nage","Sandre au beurre blanc","Tarte aux morilles","Volaille de Bresse en cocotte","Comte jeune 8 mois","Beaufort d'alpage"],
    mots: ["grenouilles","quenelles","ecrevisses","sandre","morilles","volaille bresse","comte","beaufort","poisson riviere"]
  },
  "Saint-Veran": {
    plats: ["Poisson de riviere grille","Truite aux amandes","Charcuterie fine","Tarte aux legumes","Fromage de chevre frais","Maquee aux herbes","Beurre blanc"],
    mots: ["truite","poisson riviere","charcuterie fine","tarte legumes","chevre frais","herbes","beurre blanc"]
  },

  // ============================================================
  // JURA
  // ============================================================
  "Arbois": {
    plats: ["Poulet aux morilles et vin jaune du Jura","Carre de porc au Comt√©","Saucisse de Morteau en croute","Jambon du Jura chaud","Croute forestiere au Comt√©","Tarte aux morilles au vin jaune","Comte 18 mois","Morbier cr√©meux","Bleu de Gex"],
    mots: ["poulet morilles","vin jaune","morteau","jambon jura","croute comt√©","morilles","comte","morbier","bleu gex","porc","charcuterie jurassienne"]
  },
  "Arbois Vin Jaune": {
    plats: ["Poulet de Bresse aux morilles et vin jaune","Comt√© vieux 24 mois","Homard sauce corail au vin jaune","Ris de veau aux morilles et vin jaune","Foie gras chaud aux morilles","Becasse au vin jaune","Faisan aux morilles et creme de vin jaune","Langouste au vin jaune"],
    mots: ["poulet morilles","comte vieux","homard","ris de veau","foie gras","becasse","faisan","langouste","morilles","vin jaune"]
  },
  "Arbois Pupillin": {
    plats: ["Saucisse de Morteau lentilles","Jambon du Jura persille","Poulet roti au Jura","Fromage de tete","Morbier","Bleu de Gex","Raclette franc-comtoise"],
    mots: ["morteau","jambon jura","poulet","fromage tete","morbier","bleu gex","raclette","charcuterie"]
  },
  "Chateau-Chalon": {
    plats: ["Comt√© Grand Cru 30 mois minimum","Poulet de Bresse aux morilles sauce vin jaune","Homard au vin jaune","Ris de veau aux truffes et vin jaune","Becasse rotie au vin jaune","Foie gras mi-cuit aux figues et vin jaune","Langouste sauce corail","Turbot braise au vin jaune"],
    mots: ["comte grand cru","poulet morilles","homard","ris de veau truffes","becasse","foie gras","langouste","turbot","vin jaune","morilles"]
  },
  "L'Etoile": {
    plats: ["Quenelles de brochet sauce Nantua","Truite du Doubs aux amandes","Grenouilles a la creme","Feuillete aux morilles","Tarte aux asperges blanches","Comte 12 mois","Gruyere de Comt√©"],
    mots: ["quenelles","truite","grenouilles","morilles","asperges","comte","gruyere","poisson riviere"]
  },
  "Cotes du Jura": {
    plats: ["Saucisse de Montbeliard aux lentilles","Fondue comtoise au Comt√©","Gratin de macaronis au Comt√©","Poulet roti en cocotte","Lapin a la moutarde","Morbier chaud","Raclette du Jura","Bleu de Gex avec pain de noix"],
    mots: ["montbeliard","fondue","gratin comt√©","poulet","lapin moutarde","morbier","raclette","bleu gex","lentilles"]
  },
  "Macvin du Jura": {
    plats: ["Foie gras de canard mi-cuit","Terrine de foie gras aux abricots","Melon de Cavaillon","Roquefort sur pain brule","Tarte aux noix du P√©rigord","Desserts aux fruits rouges","Fraises au poivre"],
    mots: ["foie gras","melon","roquefort","tarte noix","desserts","fraises","aperitif","sucre"]
  },

  // ============================================================
  // PORTO / DOURO
  // ============================================================
  "Porto Ruby": {
    plats: ["Foie gras poele aux figues fraiches","Terrine de foie gras aux abricots","Stilton 18 mois sur pain de noix","Roquefort sur pain brule","Gateau au chocolat noir 72%","Fondant au chocolat coeur coulant","Tarte aux fruits rouges","Framboises au naturel","Creme brulee aux fruits rouges"],
    mots: ["foie gras","figues","stilton","roquefort","chocolat noir","fondant","tarte fruits rouges","framboises","creme brulee","fromage persille","sucre"]
  },
  "Porto Tawny": {
    plats: ["Tarte tatin aux pommes beurre sale","Mille-feuille caramel","Tarte aux noix du Perigord","Gateau de riz caramelise","Creme brulee a la vanille de Tahiti","Canele bordelais","Figues confites aux amandes","Stilton vieux","Fourme d'Ambert","Abricots secs aux amandes grillees"],
    mots: ["tarte tatin","mille feuille","caramel","tarte noix","gateau riz","creme brulee","canele","figues confites","stilton","fourme ambert","abricots"]
  },
  "Porto LBV": {
    plats: ["Gateau au chocolat noir intense 85%","Fondant au chocolat mi-cuit","Tarte au chocolat et fleur de sel","Roquefort vieux sur pain aux noix","Stilton sur crackers","Gateau basque a la cerise noire","Cerises a l'eau de vie","Pruneaux d'Agen au vieux Porto"],
    mots: ["chocolat noir intense","fondant","tarte chocolat","roquefort","stilton","gateau basque","cerises","pruneaux","fromage persille"]
  },
  "Porto Vintage": {
    plats: ["Stilton Grand Reserve","Roquefort Papillon vieux","Bleu de Termignon","Gateau au chocolat grand cru","Tarte sombrero chocolat-caramel","Figues fraiches au miel de thym","Grenade aux epices douces","Foie gras mi-cuit aux dattes"],
    mots: ["stilton grand reserve","roquefort vieux","bleu termignon","chocolat grand cru","figues miel","grenade","foie gras dattes","fromage persille vieux"]
  },
  "Douro": {
    plats: ["Bacalhau a bras traditionnel","Bacalhau a Gomes de Sa","Caldo verde au chourico","Leitao da Bairrada au four","Alheira de Mirandela grill√©e","Cozido a portuguesa","Bifanas au vin rouge","Posta de vitela transmontana","Queijo Serra da Estrela","Queijo Azeitao","Ameijoas a bulhao pato"],
    mots: ["bacalhau","morue","caldo verde","chourico","leitao","alheira","cozido","bifanas","vitela","queijo","ameijoas","cuisine portugaise","agneau","veau","saucisse"]
  },

  // ============================================================
  // ALSACE
  // ============================================================
  "Alsace Riesling": {
    plats: ["Choucroute garnie traditionnelle","Baeckeoffe a l'alsacienne","Tarte a l'oignon aux lardons","Foie gras d'oie au torchon","Sandre a la choucroute","Truite aux amandes","Quiche lorraine","Munster au cumin"],
    mots: ["choucroute","baeckeoffe","tarte oignon","foie gras oie","sandre","truite","quiche","munster","cuisine alsacienne"]
  },
  "Alsace Gewurztraminer": {
    plats: ["Foie gras d'oie au Gewurztraminer","Munster affine au cumin","Tarte aux mirabelles","Kougelhopf sale aux noix","Canard laque aux epices","Tajine de poulet aux citrons confits","Curry de crevettes a l'indienne","Poulet tikka masala"],
    mots: ["foie gras oie","munster","mirabelles","kougelhopf","canard laque","tajine","curry","tikka masala","epices","cuisine exotique"]
  },
  "Alsace Pinot Gris": {
    plats: ["Foie gras mi-cuit aux mirabelles","Chou farci a l'alsacienne","Presskopf","Baeckeoffe au porc","Quenelles de brochet","Volaille rotie aux mirabelles","Terrine de gibier","Munster"],
    mots: ["foie gras","mirabelles","chou farci","presskopf","baeckeoffe","quenelles","volaille","terrine gibier","munster"]
  },
  "Alsace Pinot Noir": {
    plats: ["Presskopf vinaigrette","Tarte flambee aux lardons","Coq au Riesling","Lapin aux pruneaux d'Alsace","Charcuterie alsacienne","Munster jeune","Carr√© de porc aux mirabelles"],
    mots: ["presskopf","tarte flambee","coq riesling","lapin pruneaux","charcuterie alsacienne","munster","porc mirabelles"]
  },
  "Cremant d'Alsace": {
    plats: ["Feuillete au fromage blanc","Tarte aux asperges","Terrine de saumon","Saumon fume d'Ecosse","Caviar de hareng","Aperitif alsacien","Munster jeune"],
    mots: ["feuillete","asperges","saumon fume","caviar hareng","aperitif","munster","bulle","petillant"]
  },

  // ============================================================
  // BORDEAUX
  // ============================================================
  "Pomerol": {
    plats: ["Agneau de Pauillac roti","Carre d'agneau aux herbes","Filet de boeuf sauce Perigueux","Cote de boeuf aux ceps","Canard aux cepes de Bordeaux","Foie gras poele aux raisins","Magret aux figues","Truffe noire du Perigord","Fromages a pate dure"],
    mots: ["agneau pauillac","carre agneau","filet boeuf","truffe noire","ceps","canard cepes","foie gras","magret figues","fromages"]
  },
  "Saint-Emilion": {
    plats: ["Entrecote bordelaise sauce au vin","Cote de boeuf aux cepes","Agneau de lait de Pauillac","Magret de canard aux figues","Foie gras poele","Canard confit aux ceps","Fromages du Perigord","Ossau-Iraty affine"],
    mots: ["entrecote","boeuf cepes","agneau pauillac","magret canard","foie gras","canard confit","fromages perigord","ossau iraty"]
  },
  "Medoc": {
    plats: ["Entrecote a la bordelaise","Gigot d'agneau roti","Carre d'agneau persillade","Cote de boeuf grille","Canard aux olives","Pintade aux cepes","Fromages a pate pressee"],
    mots: ["entrecote bordelaise","gigot agneau","carre agneau","cote boeuf","canard","pintade cepes","fromages presses"]
  },
  "Pauillac": {
    plats: ["Agneau de Pauillac en carre","Filet de boeuf en croute truffe","Becasse rotie sur canape","Cote de boeuf maturee","Chevreuil sauce grand veneur","Ris de veau aux truffes","Cantal vieux","Salers affine"],
    mots: ["agneau pauillac","filet boeuf truffe","becasse","cote boeuf maturee","chevreuil","ris de veau truffes","cantal vieux","salers"]
  },
  "Saint-Julien": {
    plats: ["Carre d'agneau en persillade","Filet de boeuf Wellington","Pintade aux cepes","Magret de canard aux myrtilles","Lievre a la royale","Fromages a pate pressee cuite"],
    mots: ["carre agneau","filet boeuf wellington","pintade cepes","magret myrtilles","lievre","fromages presses"]
  },
  "Margaux": {
    plats: ["Filet de boeuf en croute sauce truffe","Pigeon roti aux cepes","Carre d'agneau au jus","Sole meuniere beurre noisette","Caille aux raisins","Fromages fins a pate dure"],
    mots: ["filet boeuf truffe","pigeon cepes","carre agneau","sole","caille raisins","fromages fins"]
  },
  "Graves": {
    plats: ["Lamproie a la bordelaise","Entrecote bordelaise","Alose a l'oseille","Foie de veau a la bordelaise","Jambon de Bayonne","Fromages du Sud-Ouest"],
    mots: ["lamproie","entrecote","alose","foie veau","jambon bayonne","fromages sud ouest"]
  },
  "Pessac-Leognan": {
    plats: ["Turbot a la bordelaise","Sole sauce bordelaise","Homard en salade tiede","Saint-Jacques poelees","Foie gras de canard mi-cuit","Filet de bar au beurre blanc"],
    mots: ["turbot","sole","homard","saint-jacques","foie gras","bar","poisson noble","blanc bordeaux"]
  },
  "Sauternes": {
    plats: ["Foie gras d'oie au torchon","Foie gras de canard mi-cuit aux figues","Roquefort Papillon vieux","Stilton sur pain de noix","Tarte tatin aux pommes","Creme brulee a la cardamome","Abricots rotis au miel","Tarte aux peches blanches","Desserts aux fruits jaunes"],
    mots: ["foie gras oie","foie gras figues","roquefort","stilton","tarte tatin","creme brulee","abricots","peches","desserts fruits","sucre","liquoreux"]
  },
  "Barsac": {
    plats: ["Foie gras mi-cuit","Roquefort sur pain brule","Tarte aux fruits jaunes","Creme brulee vanille","Macarons aux fruits","Desserts legers"],
    mots: ["foie gras","roquefort","tarte fruits jaunes","creme brulee","macarons","desserts","liquoreux"]
  },

  // ============================================================
  // RHONE
  // ============================================================
  "Chateauneuf-du-Pape": {
    plats: ["Gigot d'agneau en croute d'herbes","Daube provencale au vin rouge","Carre d'agneau aux olives et thym","Sanglier aux baies de genievre","Perdrix aux ceps","Taureau de Camargue braise","Tapenade noire","Fromages de brebis des Alpilles","Banon a la feuille"],
    mots: ["gigot agneau","daube provencale","sanglier","perdrix","taureau camargue","ceps","olives","thym","fromage brebis","banon","herbes provence"]
  },
  "Cote-Rotie": {
    plats: ["Becasse rotie sur canape","Pigeon roti aux olives","Caille farcie aux herbes","Filet d'agneau en croute","Chevreuil sauce poivrade","Fromage de brebis","Pelardon des Cevennes"],
    mots: ["becasse","pigeon","caille","agneau","chevreuil","fromage brebis","pelardon","gibier","viognier"]
  },
  "Hermitage": {
    plats: ["Becasse au sang","Lievre en civet","Truffes noires du Tricastin","Cote de boeuf maturee","Canard aux olives","Fromages du Massif Central","Bleu des Causses"],
    mots: ["becasse","lievre","truffes","cote boeuf","canard olives","fromages massif central","bleu causses"]
  },
  "Hermitage blanc": {
    plats: ["Homard a la provencale","Turbot aux herbes","Saint-Jacques au safran","Loup en croute de sel","Brandade de morue","Tapenade verte","Fromage de chevre frais"],
    mots: ["homard","turbot","saint-jacques","safran","loup","brandade","tapenade verte","chevre frais"]
  },
  "Condrieu": {
    plats: ["Foie gras de canard mi-cuit aux abricots","Homard a la creme de safran","Saint-Jacques a la vanille","Quenelles de brochet sauce Nantua","Poularde de Bresse a la creme","Turbot poche beurre blanc","Fromage de chevre frais du Pilat"],
    mots: ["foie gras abricots","homard safran","saint-jacques vanille","quenelles","poularde","turbot","chevre frais","viognier","creme"]
  },
  "Gigondas": {
    plats: ["Carre d'agneau aux herbes de Provence","Daube provencale","Sanglier aux airelles","Perdrix aux cepes","Fromages de brebis Provence","Tapenade noire","Magret de canard aux figues"],
    mots: ["agneau herbes","daube","sanglier","perdrix cepes","fromage brebis","tapenade","magret figues"]
  },
  "Vacqueyras": {
    plats: ["Daube d'agneau aux olives noires","Pieds et paquets marseillais","Sanglier en rago√ªt","Perdreaux rotis","Fromages de Provence"],
    mots: ["daube agneau","pieds paquets","sanglier","perdreaux","fromages provence"]
  },
  "Crozes-Hermitage": {
    plats: ["Gratin dauphinois au Raclette","Poulet roti aux olives","Cotes d'agneau grillees","Charcuteries de l'Ardeche","Fromages de ch√®vre de la Drome"],
    mots: ["gratin dauphinois","poulet olives","agneau grille","charcuteries ardeche","chevre drome"]
  },
  "Saint-Joseph": {
    plats: ["Carre d'agneau grille","Saucisson de Lyon brioch√©","Quenelles sauce aurore","Gateau de foies blonds","Fromage de chevre du Pilat"],
    mots: ["agneau grille","saucisson brioch√©","quenelles","foies blonds","chevre pilat","charcuterie lyonnaise"]
  },
  "Tavel": {
    plats: ["Bouillabaisse de Marseille","Bourride de lotte","Tapenade et anchoiade","Salade nicoise authentique","Grillades de viandes","Daurade royale grill√©e","Brandade de morue nimoise"],
    mots: ["bouillabaisse","bourride","tapenade","anchoiade","salade nicoise","grillades","daurade","brandade","mediterraneen"]
  },
  "Muscat de Beaumes-de-Venise": {
    plats: ["Melon de Cavaillon au jambon cru","Fraises de Carpentras au sucre","Peches blanches au naturel","Tarte aux fruits d'ete","Macarons aux amandes","Nougat de Montelimar","Desserts aux abricots"],
    mots: ["melon","fraises","peches","tarte fruits","macarons","nougat","abricots","desserts","doux naturel"]
  },

  // ============================================================
  // LOIRE
  // ============================================================
  "Sancerre": {
    plats: ["Crottin de Chavignol chaud sur salade","Chevre frais aux herbes","Asperges vertes beurre blanc","Saumon en papillote au fenouil","Sandre au beurre blanc nantais","Truite en papillote","Grenouilles persillees","Terrine de poisson"],
    mots: ["crottin chavignol","chevre frais","asperges","saumon","sandre","truite","grenouilles","terrine poisson","beurre blanc"]
  },
  "Pouilly-Fume": {
    plats: ["Huitres fines de Bretagne","Saumon fume irlandais","Sandre au beurre blanc","Grenouilles a la creme d'ail","Crottin de Chavignol","Chevre sec de la Loire","Asperges blanches hollandaise"],
    mots: ["huitres","saumon fume","sandre","grenouilles","crottin","chevre sec","asperges"]
  },
  "Vouvray": {
    plats: ["Rillettes de Tours","Rillons de Touraine","Andouille de Vouvray","Terrine de foie gras","Tarte tatin tourangelle","Tarte aux pommes reinettes","Fromage de chevre de Touraine","Sainte-Maure de Touraine"],
    mots: ["rillettes","rillons","andouille","foie gras","tarte tatin","tarte pommes","chevre touraine","sainte maure"]
  },
  "Muscadet": {
    plats: ["Huitres de la Baie de Bourgneuf","Moules mariniere","Palourdes farcies","Crevettes roses","Langoustines pochees","Sandre au beurre blanc nantais","Sole normande","Plateau de fruits de mer"],
    mots: ["huitres","moules","palourdes","crevettes","langoustines","sandre","sole","plateau mer","fruits de mer","beurre blanc nantais"]
  },
  "Anjou": {
    plats: ["Broche de Loire au beurre blanc","Sandre a l'oseille","Carpe en matelote","Terrine de canard","Rillettes d'Anjou","Fromage de chevre de l'Anjou"],
    mots: ["brochet","sandre","carpe","terrine canard","rillettes","chevre anjou","poisson loire"]
  },
  "Bourgueil": {
    plats: ["Carre d'agneau roti","Rillettes de Tours","Rillons de Touraine","Tarte aux rillettes","Lapin aux pruneaux","Fromages de Touraine"],
    mots: ["agneau","rillettes","rillons","tarte rillettes","lapin pruneaux","fromages touraine","cabernet franc"]
  },
  "Chinon": {
    plats: ["Rillettes de Tours chaudes","Andouillette de Troyes grill√©e","Lapin aux pruneaux de Touraine","Sainte-Maure de Touraine","Crottin de Chavignol","Poulet grille aux herbes"],
    mots: ["rillettes","andouillette","lapin pruneaux","sainte maure","crottin","poulet herbes","touraine","cabernet franc"]
  },
  "Coteaux du Layon": {
    plats: ["Foie gras de canard mi-cuit au Layon","Tarte tatin tourangelle","Tarte aux prunes Reine-Claude","Creme brulee au Cointreau","Fromage blanc a la creme","Sainte-Maure affine","Peches blanches au naturel"],
    mots: ["foie gras","tarte tatin","prunes","creme brulee","fromage blanc","sainte maure","peches","liquoreux","sucre"]
  },

  // ============================================================
  // CHAMPAGNE
  // ============================================================
  "Champagne": {
    plats: ["Huitres speciales de Claire au Champagne","Caviar Oscietra sur blinis","Foie gras de canard mi-cuit","Homard en bellevue","Langoustines pochees au Court-bouillon","Turbot en sauce Champagne","Feuillete de saint-jacques aux truffes","Aperitif raffin√©"],
    mots: ["huitres","caviar","blinis","foie gras","homard","langoustines","turbot","saint-jacques truffes","aperitif","crustaces nobles"]
  },
  "Champagne Blanc de Blancs": {
    plats: ["Huitres fines de Bretagne","Caviar Beluga ou Oscietra","Saumon fume d'Ecosse","Langoustines a la mayonnaise","Saint-Jacques au naturel","Aperitif avec petits fours sales"],
    mots: ["huitres fines","caviar","saumon fume","langoustines","saint-jacques","aperitif","fours sales"]
  },
  "Champagne Blanc de Noirs": {
    plats: ["Jambon de Reims en gelee","Andouillette de Troyes","Rillettes champenoises","Brie de Meaux affine","Langres au Marc de Bourgogne","Chaource cr√©meux"],
    mots: ["jambon reims","andouillette troyes","rillettes champenoises","brie meaux","langres","chaource","charcuterie champagne"]
  },
  "Champagne Rose": {
    plats: ["Carpaccio de boeuf aux truffes","Saumon fume avec creme fraiche","Fraises des bois au Champagne","Macarons aux fruits rouges","Foie gras en terrine","Agneau roti jus court"],
    mots: ["carpaccio","saumon fume","fraises","macarons fruits rouges","foie gras","agneau roti"]
  },

  // ============================================================
  // LANGUEDOC-ROUSSILLON
  // ============================================================
  "Banyuls": {
    plats: ["Gateau au chocolat noir 70% minimum","Fondant mi-cuit au chocolat","Tarte au chocolat fleur de sel","Souffl√© au chocolat amer","Anchois de Collioure marines","Gateau catalan","Creme catalane","Figues fraiches au miel"],
    mots: ["chocolat noir","fondant","tarte chocolat","souffle chocolat","anchois collioure","gateau catalan","creme catalane","figues miel","sucre intense"]
  },
  "Rivesaltes": {
    plats: ["Foie gras de canard aux abricots","Desserts aux fruits secs","Gateau aux pruneaux","Creme brulee a l'orange","Nougat de Montpellier","Desserts catalanes","Formage persille"],
    mots: ["foie gras abricots","fruits secs","pruneaux","creme brulee orange","nougat","catalan","fromage persille"]
  },
  "Minervois": {
    plats: ["Cassoulet de Castelnaudary","Agneau de Lozere grille","Daube languedocienne","Sanglier aux olives","Fromages du Languedoc","Pelardon des Cevennes"],
    mots: ["cassoulet","agneau lozere","daube languedoc","sanglier olives","fromages languedoc","pelardon"]
  },
  "Corbi√®res": {
    plats: ["Daurade royale grill√©e au romarin","Bouillabaisse adapt√©e","Agneau grille aux herbes","Charcuterie du Languedoc","Fromages de brebis des Corbi√®res","Tapenade et anchoiade"],
    mots: ["daurade grille","bouillabaisse","agneau herbes","charcuterie languedoc","fromage brebis","tapenade","anchois"]
  },
  "Fitou": {
    plats: ["Sanglier en daube","Lievre aux olives","Agneau des garrigues aux herbes","Fromages cors√©s du Languedoc","Charcuteries catalanes"],
    mots: ["sanglier daube","li√®vre olives","agneau garrigues","fromages corses","charcuteries catalanes"]
  },

  // ============================================================
  // SUD-OUEST
  // ============================================================
  "Madiran": {
    plats: ["Magret de canard aux figues","Confit de canard aux ceps","Cassoulet gersois","Cote de boeuf maturee","Garbure bearnaise","Fromage de brebis Pyrenees","Ossau-Iraty affine 6 mois"],
    mots: ["magret canard","confit","cassoulet","cote boeuf","garbure","ossau iraty","fromage brebis pyrenees","tannat"]
  },
  "Cahors": {
    plats: ["Magret de canard au miel","Confit de canard aux sarladaises","Foie gras poele","Truffe noire du Perigord","Daube de boeuf querycoise","Fromages du Lot","Rocamadour affine"],
    mots: ["magret miel","confit canard","foie gras","truffe noire","daube boeuf","rocamadour","fromages lot","malbec"]
  },
  "Bergerac": {
    plats: ["Magret de canard aux pruneaux","Confit aux pommes sarladaises","Foie gras de canard","Noix du Perigord","Fromages de la Dordogne","Cab√©cou frais"],
    mots: ["magret pruneaux","confit canard","foie gras","noix perigord","fromages dordogne","cabecou"]
  },
  "Monbazillac": {
    plats: ["Foie gras d'oie au torchon","Foie gras mi-cuit aux raisins","Roquefort vieux","Gateau aux noix du Perigord","Tarte aux prunes","Creme brulee au foie gras","Melon au jambon de Bayonne"],
    mots: ["foie gras oie","foie gras raisins","roquefort vieux","gateau noix","tarte prunes","melon jambon","liquoreux perigord"]
  },
  "Jurancon": {
    plats: ["Jambon de Bayonne mi-sel","Foie gras de canard frais","Fromage de brebis des Pyrenees","Ossau-Iraty","Truite de montagne","Tarte aux pommes reinettes","Gateaux basques"],
    mots: ["jambon bayonne","foie gras frais","fromage brebis","ossau iraty","truite montagne","tarte pommes","gateau basque","Manseng"]
  },
  "Armagnac": {
    plats: ["Foie gras de canard","Pruneaux d'Agen a l'Armagnac","Tarte aux pruneaux","Creme brulee a l'Armagnac","Gateau a la broche"],
    mots: ["foie gras","pruneaux agen armagnac","tarte pruneaux","creme brulee armagnac","gateau broche"]
  },

  // ============================================================
  // PROVENCE
  // ============================================================
  "Bandol": {
    plats: ["Daube provencale au vin de Bandol","Gigot d'agneau de Sisteron en croute","Carre d'agneau aux herbes de Provence","Sanglier a la provencale","Perdrix aux olives","Fromages de brebis de Provence","Banon a la feuille"],
    mots: ["daube","gigot agneau sisteron","sanglier","perdrix olives","fromage brebis","banon","herbes provence","mourv√®dre"]
  },
  "Bandol Rose": {
    plats: ["Bouillabaisse de Marseille","Bourride de lotte","Salade nicoise authentique","Grillades de viandes","Tapenade et anchoiade","Fromages de chevre frais de Provence"],
    mots: ["bouillabaisse","bourride","salade nicoise","grillades","tapenade","anchoiade","chevre frais provence"]
  },
  "Cotes de Provence": {
    plats: ["Grillades de viandes au thym","Salade nicoise","Ratatouille aux herbes","Pissaladiere","Tapenade noire","Fromages de chevre des Alpilles","Fromage de brebis Provence"],
    mots: ["grillades thym","salade","ratatouille","pissaladiere","tapenade","chevre alpilles","brebis provence","herbes"]
  },
  "Cassis": {
    plats: ["Bouillabaisse royale de Marseille","Bourride de lotte","Loup grille au fenouil","Daurade royale en croute de sel","Soupe de poissons rouille","Brandade de morue de Nimes"],
    mots: ["bouillabaisse","bourride","loup fenouil","daurade","soupe poissons","brandade","poissons mediterraeens"]
  },

  // ============================================================
  // SAVOIE
  // ============================================================
  "Roussette de Savoie": {
    plats: ["Fondue savoyarde au Beaufort","Tartiflette au Reblochon","Raclette de Savoie","Gratin dauphinois","Diots de Savoie","Poisson du lac au beurre blanc","Feras du lac L√©man poel√©es"],
    mots: ["fondue beaufort","tartiflette","raclette","gratin dauphinois","diots","poisson lac","feras leman","fromages savoie"]
  },
  "Cremant de Savoie": {
    plats: ["Aperitif savoyard","Feuillete au Beaufort","Saumon fume","Truite fum√©e du lac","Tomates au chevre frais","Tartelettes fines aux asperges"],
    mots: ["aperitif","feuillete beaufort","saumon fume","truite fumee","chevre frais","asperges"]
  },
  "Vin de Savoie": {
    plats: ["Fondue savoyarde","Raclette","Tartiflette traditionnelle","Gratin de crozets au Beaufort","Diots au vin blanc","Saucisses fumees savoyardes","Beaufort d'alpage","Reblochon fermier"],
    mots: ["fondue","raclette","tartiflette","gratin crozets","diots","saucisses fumees","beaufort","reblochon"]
  },

  // ============================================================
  // Fallback g√©n√©rique
  // ============================================================
  "rouge": {
    plats: ["Carre d'agneau roti","Boeuf en sauce","Gibier a plumes","Fromages affines","Charcuterie fine"],
    mots: ["agneau","boeuf","gibier","fromage affine","charcuterie","viande rouge"]
  },
  "blanc": {
    plats: ["Poisson noble grille","Fruits de mer","Volaille a la creme","Fromage de chevre","Asperges"],
    mots: ["poisson","fruits de mer","volaille","chevre","asperges","crustaces"]
  },
  "rose": {
    plats: ["Grillades","Salade composee","Charcuterie","Cuisine provencale"],
    mots: ["grillades","salade","charcuterie","provencal","aperitif"]
  },
  "effervescent": {
    plats: ["Aperitif","Fruits de mer","Foie gras","Desserts legers"],
    mots: ["aperitif","huitres","foie gras","desserts"]
  },
  "vdn_blanc": {
    plats: ["Foie gras","Melon jambon","Tarte aux abricots","Cr√®me br√ªl√©e","Fromage bleu"],
    mots: ["foie gras","melon","abricots","creme brulee","fromage bleu","desserts","sucre"]
  },
  "vdn_rouge": {
    plats: ["Chocolat noir 70%","Fondant chocolat","Fromage persill√©","Tarte aux noix","Fruits rouges"],
    mots: ["chocolat","fondant","roquefort","noix","fruits rouges","desserts"]
  },
  "liquoreux": {
    plats: ["Foie gras d'oie","Roquefort","Tarte tatin","Cr√®me br√ªl√©e","Abricots poch√©s","Desserts fruit√©s"],
    mots: ["foie gras","roquefort","tarte tatin","creme brulee","abricots","peches","desserts","sucre"]
  }
};


function populateVinSelect() {
  const sel = document.getElementById('accord-vin-select');
  if(!sel) return;
  const current = sel.value;
  sel.innerHTML = '<option value="">‚Äî Choisir un vin ‚Äî</option>';
  [...wineData].sort((a,b)=>(a.nom||'').localeCompare(b.nom||'')).forEach(w => {
    const opt = document.createElement('option');
    opt.value = w.id;
    opt.textContent = (w.nom||'Sans nom') + (w.annee?' '+w.annee:'') + (w.domaine?' ‚Äî '+w.domaine:'');
    sel.appendChild(opt);
  });
  if(current) sel.value = current;
}

function getAccordsForWine(w) {
  // Chercher par appellation exacte d'abord, puis par nom, puis par type
  const appellation = (w.appellation || '').trim();
  const nom         = (w.nom || '').trim();
  // Essayer appellation exacte
  if(appellation && ACCORDS_AUTO[appellation]) return ACCORDS_AUTO[appellation];
  // Essayer matching partiel sur les cl√©s
  const keys = Object.keys(ACCORDS_AUTO);
  const matchKey = keys.find(k => 
    appellation.toLowerCase().includes(k.toLowerCase()) || 
    k.toLowerCase().includes(appellation.toLowerCase()) ||
    nom.toLowerCase().includes(k.toLowerCase())
  );
  if(matchKey) return ACCORDS_AUTO[matchKey];
  // Fallback par type
  return ACCORDS_AUTO[w.type] || ACCORDS_AUTO["rouge"];
}

function rechercherParPlat() {
  const query = document.getElementById('accord-plat-input').value.trim().toLowerCase();
  const results = document.getElementById('accord-plat-results');
  if(!query) { results.innerHTML = ''; return; }

  const matches = wineData.filter(w => {
    // Accord manuel saisi sur le vin
    if(w.accords && w.accords.toLowerCase().includes(query)) return true;
    // Accord par appellation ou type
    const auto = getAccordsForWine(w);
    if(auto && auto.mots.some(m => query.includes(m.toLowerCase()) || m.toLowerCase().includes(query))) return true;
    return false;
  });

  if(!matches.length) {
    results.innerHTML = '<div style="color:var(--text2);font-style:italic;padding:10px 0">Aucun vin trouv√© pour ce plat dans votre cave</div>';
    return;
  }

  results.innerHTML = '<div style="font-size:0.78rem;color:var(--text2);margin-bottom:10px;letter-spacing:1px">' + matches.length + ' VIN' + (matches.length>1?'S':'') + ' SUGG√âR√â' + (matches.length>1?'S':'') + '</div>' +
    matches.map(w => wineCardHtml(w)).join('');
}

function rechercherParVin(id) {
  const results = document.getElementById('accord-vin-results');
  if(!id) { results.innerHTML = ''; return; }
  const wine = wineData.find(w=>String(w.id)===String(id));
  if(!wine) return;

  const auto  = getAccordsForWine(wine);
  const plats = wine.accords
    ? [...new Set([...wine.accords.split(',').map(s=>s.trim()), ...auto.plats])]
    : auto.plats;

  const sourceLabel = (() => {
    const appellation = (wine.appellation||'').trim();
    if(appellation && ACCORDS_AUTO[appellation]) return appellation;
    const keys = Object.keys(ACCORDS_AUTO);
    const matchKey = keys.find(k => appellation.toLowerCase().includes(k.toLowerCase()) || k.toLowerCase().includes(appellation.toLowerCase()));
    if(matchKey) return matchKey;
    return wine.type || 'G√©n√©ral';
  })();

  results.innerHTML = `
    <div style="font-size:0.78rem;color:var(--text2);margin-bottom:6px;letter-spacing:1px">ACCORDS SUGG√âR√âS <span style="color:var(--gold);margin-left:6px">‚Äî ${sourceLabel}</span></div>
    <div style="display:flex;flex-wrap:wrap;gap:8px">
      ${plats.map(p=>`<span style="padding:5px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:20px;font-size:0.85rem;color:var(--cream)">üçΩ ${p}</span>`).join('')}
    </div>`;
}

function wineCardHtml(w) {
  const tLabel = {rouge:'Rouge',blanc:'Blanc','ros√©':'Ros√©',effervescent:'Effervescent',vdn_blanc:'VDN Blanc',vdn_rouge:'VDN Rouge',liquoreux:'Liquoreux'}[w.type] || w.type;
  return `<div style="display:flex;gap:12px;align-items:center;padding:10px;background:var(--bg3);border-radius:3px;margin-bottom:8px;border:1px solid var(--border)">
    ${(imgGet('wine_'+w.id)||w.image)?`<img src="${imgGet('wine_'+w.id)||w.image}" style="width:36px;height:50px;object-fit:contain;border-radius:2px;flex-shrink:0">`:'<div style="width:36px;height:50px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0">üç∑</div>'}
    <div style="flex:1;min-width:0">
      <div style="color:var(--cream);font-size:0.95rem">${w.nom||'‚Äî'}${w.annee?' <span style="color:var(--text2);font-size:0.8rem">'+w.annee+'</span>':''}</div>
      <div style="color:var(--text2);font-size:0.78rem;margin-top:2px">${[w.domaine,w.region].filter(Boolean).join(' ¬∑ ')}</div>
      ${w.accords?`<div style="color:var(--gold2);font-size:0.75rem;margin-top:3px">üçΩ ${w.accords}</div>`:''}
    </div>
    <span style="padding:2px 8px;border-radius:10px;font-size:0.7rem;background:var(--wine);color:var(--cream);flex-shrink:0">${tLabel}</span>
  </div>`;
}


// =====================================================================
// APOGEE
// =====================================================================

// Fen√™tres d'apog√©e automatiques par appellation (ann√©es apr√®s mill√©sime)
const APOGEE_AUTO = {
  // Bourgogne Grands Crus rouges
  "Gevrey-Chambertin":     { min: 8,  max: 25 },
  "Chambolle-Musigny":     { min: 6,  max: 20 },
  "Vosne-Romanee":         { min: 8,  max: 25 },
  "Nuits-Saint-Georges":   { min: 6,  max: 18 },
  "Pommard":               { min: 6,  max: 18 },
  "Volnay":                { min: 5,  max: 15 },
  "Beaune":                { min: 5,  max: 15 },
  "Aloxe-Corton":          { min: 6,  max: 18 },
  "Marsannay":             { min: 4,  max: 12 },
  // Bourgogne blancs
  "Meursault":             { min: 5,  max: 15 },
  "Puligny-Montrachet":    { min: 5,  max: 15 },
  "Chassagne-Montrachet":  { min: 5,  max: 15 },
  "Chablis Grand Cru":     { min: 5,  max: 20 },
  "Chablis Premier Cru":   { min: 4,  max: 12 },
  "Chablis":               { min: 3,  max: 8  },
  "Pouilly-Fuisse":        { min: 3,  max: 10 },
  "Macon-Villages":        { min: 2,  max: 6  },
  // Jura
  "Chateau-Chalon":        { min: 10, max: 40 },
  "Arbois Vin Jaune":      { min: 10, max: 40 },
  "Arbois":                { min: 4,  max: 15 },
  "Arbois Pupillin":       { min: 4,  max: 12 },
  "Cotes du Jura":         { min: 3,  max: 10 },
  "L'Etoile":              { min: 4,  max: 12 },
  "Macvin du Jura":        { min: 3,  max: 15 },
  // Porto / Douro
  "Porto Vintage":         { min: 15, max: 50 },
  "Porto LBV":             { min: 5,  max: 20 },
  "Porto Tawny":           { min: 0,  max: 5  },
  "Porto Ruby":            { min: 0,  max: 5  },
  "Douro":                 { min: 4,  max: 15 },
  // Bordeaux
  "Pomerol":               { min: 8,  max: 25 },
  "Saint-Emilion":         { min: 6,  max: 20 },
  "Pauillac":              { min: 10, max: 30 },
  "Saint-Julien":          { min: 8,  max: 25 },
  "Margaux":               { min: 8,  max: 25 },
  "Medoc":                 { min: 6,  max: 18 },
  "Graves":                { min: 5,  max: 15 },
  "Pessac-Leognan":        { min: 5,  max: 15 },
  "Sauternes":             { min: 8,  max: 30 },
  "Barsac":                { min: 6,  max: 25 },
  // Rh√¥ne
  "Chateauneuf-du-Pape":   { min: 6,  max: 20 },
  "Cote-Rotie":            { min: 6,  max: 20 },
  "Hermitage":             { min: 8,  max: 25 },
  "Hermitage blanc":       { min: 6,  max: 20 },
  "Condrieu":              { min: 2,  max: 6  },
  "Gigondas":              { min: 5,  max: 15 },
  "Vacqueyras":            { min: 4,  max: 12 },
  "Crozes-Hermitage":      { min: 4,  max: 12 },
  // Loire
  "Sancerre":              { min: 3,  max: 8  },
  "Pouilly-Fume":          { min: 3,  max: 8  },
  "Vouvray":               { min: 5,  max: 20 },
  "Coteaux du Layon":      { min: 8,  max: 25 },
  "Chinon":                { min: 4,  max: 12 },
  "Bourgueil":             { min: 4,  max: 12 },
  "Muscadet":              { min: 1,  max: 4  },
  // Champagne
  "Champagne":             { min: 5,  max: 15 },
  // Alsace
  "Alsace Riesling":       { min: 5,  max: 15 },
  "Alsace Gewurztraminer": { min: 4,  max: 12 },
  "Alsace Pinot Gris":     { min: 4,  max: 12 },
  // Languedoc
  "Banyuls":               { min: 5,  max: 20 },
  "Madiran":               { min: 6,  max: 18 },
  "Cahors":                { min: 5,  max: 15 },
  // Provence
  "Bandol":                { min: 5,  max: 15 },
  // Fallbacks par type
  "rouge":                 { min: 4,  max: 12 },
  "blanc":                 { min: 2,  max: 6  },
  "rose":                  { min: 1,  max: 3  },
  "effervescent":          { min: 2,  max: 8  },
  "vdn_blanc":             { min: 5,  max: 20 },
  "vdn_rouge":             { min: 8,  max: 30 },
  "liquoreux":             { min: 8,  max: 30 },
};

function getApogeeAuto(wine) {
  if(!wine.annee) return null;
  const annee = parseInt(wine.annee);
  if(!annee) return null;
  const appellation = (wine.appellation||'').trim();
  const keys = Object.keys(APOGEE_AUTO);
  // Chercher par appellation exacte puis partielle puis type
  let rule = APOGEE_AUTO[appellation];
  if(!rule) {
    const matchKey = keys.find(k => appellation.toLowerCase().includes(k.toLowerCase()) || k.toLowerCase().includes(appellation.toLowerCase()));
    if(matchKey) rule = APOGEE_AUTO[matchKey];
  }
  if(!rule) rule = APOGEE_AUTO[wine.type] || APOGEE_AUTO["rouge"];
  return { debut: annee + rule.min, fin: annee + rule.max };
}

function getApogeeWindows(wine) {
  // Priorit√© : manuel, sinon auto
  if(wine.apogeeDebut || wine.apogeeFin) {
    return {
      debut: parseInt(wine.apogeeDebut) || null,
      fin:   parseInt(wine.apogeeFin)   || null,
      source: "manuel"
    };
  }
  const auto = getApogeeAuto(wine);
  if(auto) return { ...auto, source: "auto" };
  return null;
}

function getApogeeStatut(wine) {
  const now = new Date().getFullYear();
  const ap  = getApogeeWindows(wine);
  if(!ap || (!ap.debut && !ap.fin)) return null;
  const debut = ap.debut || 0;
  const fin   = ap.fin   || 9999;
  if(now > fin)               return "depasse";
  if(now >= debut)            return "maintenant";
  if(debut - now <= 2)        return "bientot";
  return "jeune";
}

function getApogeeLabel(wine) {
  const ap = getApogeeWindows(wine);
  if(!ap) return "";
  const now    = new Date().getFullYear();
  const statut = getApogeeStatut(wine);
  const range  = ap.debut && ap.fin ? ap.debut + " ‚Äî " + ap.fin : (ap.debut ? "√† partir de " + ap.debut : "jusqu'en " + ap.fin);
  const badges = {
    depasse:    `<span style="color:#d44;font-size:0.85rem">üî¥ D√©pass√©</span>`,
    maintenant: `<span style="color:#3da066;font-size:0.85rem">üü¢ √Ä boire maintenant</span>`,
    bientot:    `<span style="color:#c9a84c;font-size:0.85rem">üü° Apog√©e dans ${ap.debut - now} an${ap.debut - now > 1 ? "s" : ""}</span>`,
    jeune:      `<span style="color:#5090c0;font-size:0.85rem">üîµ Trop jeune encore</span>`
  };
  const src = ap.source === "auto" ? `<span style="font-size:0.7rem;color:var(--text2);margin-left:6px">(estimation)</span>` : "";
  return `${badges[statut]||""} <span style="color:var(--gold2);margin-left:8px">${range}</span>${src}`;
}

let apogeeFiltre = "tous";

function filtreApogee(filtre) {
  apogeeFiltre = filtre;
  ["tous","maintenant","bientot","jeune","depasse"].forEach(f => {
    const btn = document.getElementById("btn-ap-" + f);
    if(btn) btn.classList.toggle("active", f === filtre);
  });
  renderApogee(filtre);
}

function renderApogee(filtre) {
  const container = document.getElementById("apogee-list");
  if(!container) return;
  const now = new Date().getFullYear();

  let wines = wineData.filter(w => {
    const ap = getApogeeWindows(w);
    if(filtre === "tous") return ap !== null || w.annee;
    const statut = getApogeeStatut(w);
    return statut === filtre;
  });

  // Trier : d√©pass√©s en premier, puis √† boire, puis bient√¥t, puis jeunes
  const order = { depasse: 0, maintenant: 1, bientot: 2, jeune: 3 };
  wines.sort((a, b) => {
    const sa = order[getApogeeStatut(a)] ?? 4;
    const sb = order[getApogeeStatut(b)] ?? 4;
    if(sa !== sb) return sa - sb;
    return (parseInt(a.annee)||0) - (parseInt(b.annee)||0);
  });

  if(!wines.length) {
    container.innerHTML = `<div style="text-align:center;padding:60px 0;color:var(--text2);font-style:italic">Aucun vin dans cette cat√©gorie</div>`;
    return;
  }

  const statLabels = {
    depasse:    { color: "#d44",    icon: "üî¥", label: "D√©pass√© ‚Äî √† boire rapidement" },
    maintenant: { color: "#3da066", icon: "üü¢", label: "√Ä boire maintenant" },
    bientot:    { color: "#c9a84c", icon: "üü°", label: "Apog√©e proche" },
    jeune:      { color: "#5090c0", icon: "üîµ", label: "Encore trop jeune" }
  };

  container.innerHTML = wines.map(w => {
    const ap     = getApogeeWindows(w);
    const statut = getApogeeStatut(w);
    const st     = statLabels[statut] || { color: "var(--text2)", icon: "‚ö™", label: "Inconnu" };
    const range  = ap ? (ap.debut && ap.fin ? ap.debut + " ‚Äî " + ap.fin : (ap.debut ? "√† partir de " + ap.debut : "jusqu'en " + ap.fin)) : "‚Äî";
    const src    = ap && ap.source === "auto" ? " (est.)" : "";
    const anneeRestante = ap && ap.debut ? ap.debut - now : null;

    return `<div style="display:flex;gap:14px;align-items:center;padding:14px 16px;background:var(--bg2);border:1px solid var(--border);border-left:3px solid ${st.color};border-radius:3px;margin-bottom:8px;cursor:pointer"
      onclick="openSlotModal(${w.cave},${w.floor},${w.slot})">
      ${(imgGet('wine_'+w.id)||w.image) ? `<img src="${imgGet('wine_'+w.id)||w.image}" style="width:40px;height:56px;object-fit:contain;border-radius:2px;flex-shrink:0">` : `<div style="width:40px;height:56px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0">üç∑</div>`}
      <div style="flex:1;min-width:0">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:6px">
          <div>
            <span style="color:var(--cream);font-size:1rem">${w.nom||"‚Äî"}</span>
            ${w.annee ? `<span style="color:var(--text2);font-size:0.85rem;margin-left:6px">${w.annee}</span>` : ""}
            <div style="color:var(--text2);font-size:0.78rem;margin-top:2px">${[w.domaine,w.appellation].filter(Boolean).join(" ¬∑ ")}</div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="color:${st.color};font-size:0.82rem">${st.icon} ${st.label}</div>
            <div style="color:var(--gold2);font-size:0.82rem;margin-top:2px">Apog√©e : ${range}${src}</div>
            ${statut === "bientot" && anneeRestante ? `<div style="color:var(--text2);font-size:0.75rem">Dans ${anneeRestante} an${anneeRestante>1?"s":""}</div>` : ""}
          </div>
        </div>
      </div>
    </div>`;
  }).join("");
}


// =====================================================================
// DEPLACEMENT DE BOUTEILLES
// =====================================================================
let deplacerWineId = null;

function openDeplacerModal(id) {
  deplacerWineId = id;
  const wine = wineData.find(w => String(w.id) === String(id));
  if(!wine) return;
  closeModal('modalSlot');
  document.getElementById('deplacer-wine-name').textContent = (wine.nom||'') + (wine.annee ? ' ' + wine.annee : '');
  // Pr√©-s√©lectionner la cave actuelle
  document.getElementById('dep-cave').value = wine.cave || 1;
  updateDepEtage(wine.floor);
  document.getElementById('modalDeplacer').classList.add('open');
}

function updateDepEtage(selectedFloor) {
  const cave    = parseInt(document.getElementById('dep-cave').value) || 1;
  const sel     = document.getElementById('dep-etage');
  sel.innerHTML = '';
  CAVE_CONFIG[cave].floors.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f.id;
    opt.textContent = f.label + (f.isMagnum ? ' ¬∑ Magnums' : '');
    sel.appendChild(opt);
  });
  if(selectedFloor) sel.value = selectedFloor;
  updateDepSlot();
}

function updateDepSlot() {
  const cave    = parseInt(document.getElementById('dep-cave').value) || 1;
  const floor   = parseInt(document.getElementById('dep-etage').value) || 1;
  const floorData = CAVE_CONFIG[cave].floors.find(f => f.id === floor);
  const sel     = document.getElementById('dep-slot');
  sel.innerHTML = '';
  if(!floorData) return;
  const wine = wineData.find(w => String(w.id) === String(deplacerWineId));
  for(let i = 1; i <= floorData.slots; i++) {
    const occupant = getWineAtSlot(cave, floor, i);
    // Exclure l'emplacement actuel du vin
    if(occupant && String(occupant.id) === String(deplacerWineId)) continue;
    const opt = document.createElement('option');
    opt.value = i;
    if(occupant) {
      opt.textContent = 'Empl. ' + i + ' ‚Äî ' + (occupant.nom||'?') + (occupant.annee?' '+occupant.annee:'') + ' (√©change)';
      opt.style.color = '#c9a84c';
    } else {
      opt.textContent = 'Empl. ' + i + ' ‚Äî Libre';
    }
    sel.appendChild(opt);
  }
  if(!sel.options.length) {
    const opt = document.createElement('option');
    opt.textContent = 'Aucun emplacement disponible';
    opt.disabled = true;
    sel.appendChild(opt);
  }
}

function confirmerDeplacement() {
  const wine = wineData.find(w => String(w.id) === String(deplacerWineId));
  if(!wine) return;
  const newCave  = parseInt(document.getElementById('dep-cave').value);
  const newFloor = parseInt(document.getElementById('dep-etage').value);
  const newSlot  = parseInt(document.getElementById('dep-slot').value);
  if(!newSlot) { showNotif('Choisissez un emplacement', true); return; }

  // Sauvegarder les positions avant d√©placement pour le log
  const oldPos = `Cave ${wine.cave} √ât.${wine.floor} #${wine.slot}`;

  // V√©rifier si emplacement occup√© ‚Üí √©change
  const occupant = getWineAtSlot(newCave, newFloor, newSlot);
  if(occupant && String(occupant.id) !== String(wine.id)) {
    // √âchange : mettre l'occupant √† l'ancienne place du vin d√©plac√©
    const oldCave = wine.cave, oldFloor = wine.floor, oldSlot = wine.slot;
    occupant.cave  = oldCave;
    occupant.floor = oldFloor;
    occupant.slot  = oldSlot;
    // R√©assurer que les images sont bien index√©es par ID (pas par slot) apr√®s l'√©change
    if(occupant.id) {
      const imgOcc = imgGet('wine_' + String(occupant.id)) || occupant.image || '';
      if(imgOcc) imgSave('wine_' + String(occupant.id), imgOcc);
    }
    showNotif('√âchange effectu√© : ' + (occupant.nom||'vin') + ' ‚Üî ' + (wine.nom||'vin') + ' ‚úì');
  } else {
    showNotif('Bouteille d√©plac√©e : ' + (wine.nom||'vin') + ' ' + oldPos + ' ‚Üí Cave ' + newCave + ' √ât.' + newFloor + ' #' + newSlot + ' ‚úì');
  }

  // D√©placer le vin
  wine.cave  = newCave;
  wine.floor = newFloor;
  wine.slot  = newSlot;

  // R√©assurer que l'image du vin d√©plac√© est bien index√©e par son ID
  if(wine.id) {
    const imgWine = imgGet('wine_' + String(wine.id)) || wine.image || '';
    if(imgWine) imgSave('wine_' + String(wine.id), imgWine);
  }

  saveData();
  closeModal('modalDeplacer');
  renderCave2D();
  renderList();
  deplacerWineId = null;
}


// =====================================================================
// RECHERCHE GLOBALE
// =====================================================================
function handleSearch(query) {
  const panel   = document.getElementById('search-panel');
  const overlay = document.getElementById('search-overlay');
  const clear   = document.getElementById('search-clear');
  const q = query.trim().toLowerCase();

  clear.style.display = q ? 'block' : 'none';

  if(!q) {
    panel.style.display   = 'none';
    overlay.style.display = 'none';
    return;
  }

  const results = wineData.filter(w => {
    return [w.nom, w.domaine, w.appellation, w.region, w.annee, w.type, w.notes, w.accords]
      .some(val => val && String(val).toLowerCase().includes(q));
  });

  overlay.style.display = 'block';

  if(!results.length) {
    panel.style.display = 'block';
    panel.innerHTML = `<div class="search-count">Aucun r√©sultat pour "${query}"</div>`;
    return;
  }

  const typeColors = {rouge:'#9e2a3f',blanc:'#c9a84c','ros√©':'#c06080',effervescent:'#5090c0',vdn_blanc:'#f5d97a',vdn_rouge:'#a04020',liquoreux:'#d07030'};

  panel.style.display = 'block';
  panel.innerHTML = `<div class="search-count">${results.length} r√©sultat${results.length>1?'s':''} pour "${sanitize(query)}"</div>` +
    results.map(w => {
      const color  = typeColors[w.type] || 'var(--text2)';
      const loc    = `Cave ${sanitize(w.cave)} ¬∑ √âtage ${sanitize(w.floor)} ¬∑ Empl. ${sanitize(w.slot)}`;
      const detail = [w.appellation, w.region].filter(Boolean).map(sanitize).join(' ¬∑ ');
      // Highlight matching text (highlight sanitizes internally via regex)
      const nom    = highlight(sanitize(w.nom||'‚Äî'), q);
      const dom    = w.domaine ? highlight(sanitize(w.domaine), q) : '';
      const imgSrc = sanitize(w.image);
      return `<div class="search-result-item" onclick="goToWine(${parseInt(w.cave)||1},${parseInt(w.floor)||1},${parseInt(w.slot)||1})">
        ${imgSrc ? `<img src="${imgSrc}" style="width:36px;height:50px;object-fit:contain;border-radius:2px;flex-shrink:0">` : `<div style="width:36px;height:50px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0">üç∑</div>`}
        <div style="flex:1;min-width:0">
          <div style="color:var(--cream);font-size:0.98rem">${nom}${w.annee?` <span style="color:var(--text2);font-size:0.82rem">${sanitize(w.annee)}</span>`:''}</div>
          ${dom ? `<div style="color:var(--text2);font-size:0.78rem;margin-top:1px">${dom}</div>` : ''}
          ${detail ? `<div style="color:var(--text2);font-size:0.78rem">${detail}</div>` : ''}
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div style="color:${color};font-size:0.75rem;text-transform:capitalize">${sanitize(w.type||'')}</div>
          <div style="color:var(--text2);font-size:0.72rem;margin-top:3px">${loc}</div>
        </div>
      </div>`;
    }).join('');
}

function highlight(text, query) {
  if(!text || !query) return text;
  // text est d√©j√† sanitis√© par l'appelant ‚Äî on applique uniquement le surlignage
  const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  return String(text).replace(new RegExp('(' + escaped + ')', 'gi'),
    '<mark style="background:var(--gold);color:#1a0a10;border-radius:2px;padding:0 2px">$1</mark>');
}

function clearSearch() {
  const input   = document.getElementById('global-search');
  const panel   = document.getElementById('search-panel');
  const overlay = document.getElementById('search-overlay');
  const clear   = document.getElementById('search-clear');
  if(input)   input.value = '';
  if(panel)   panel.style.display   = 'none';
  if(overlay) overlay.style.display = 'none';
  if(clear)   clear.style.display   = 'none';
}

function goToWine(cave, floor, slot) {
  clearSearch();
  // Switcher vers vue cave et ouvrir la fiche
  const tab = document.querySelector(".tab[onclick*=\"'view2d'\"]");
  switchTab('view2d', tab);
  // S√©lectionner la bonne cave si besoin
  if(cave !== currentCave) {
    const btn = document.querySelectorAll('.cave-btn')[cave-1];
    selectCave(cave, btn);
  }
  // Ouvrir la modal apr√®s un court d√©lai pour laisser le rendu se faire
  setTimeout(() => openSlotModal(cave, floor, slot), 150);
}


// =====================================================================
// BULLE MOBILE ‚Äî 1 tap = bulle, 2 taps = fiche compl√®te
// =====================================================================
let lastTapTime   = 0;
let lastTapTarget = null;
let mobileBubbleCave  = null;
let mobileBubbleFloor = null;
let mobileBubbleSlot  = null;

function isMobile() {
  // Uniquement bas√© sur la largeur ‚Äî pas sur ontouchstart (√©vite les faux positifs desktop tactile)
  return window.matchMedia('(max-width: 768px)').matches;
}

function handleBottleClick(e, cave, floor, slot) {
  // Masquer le tooltip dans tous les cas
  document.getElementById('tooltip').style.display = 'none';

  if(!isMobile()) {
    // Desktop : comportement normal
    openSlotModal(cave, floor, slot);
    return;
  }

  const now = Date.now();
  const sameTarget = (mobileBubbleCave === cave && mobileBubbleFloor === floor && mobileBubbleSlot === slot);

  if(sameTarget && now - lastTapTime < 400) {
    // Double tap sur la m√™me bouteille ‚Üí fiche compl√®te
    closeMobileBubble();
    openSlotModal(cave, floor, slot);
    lastTapTime = 0;
    return;
  }

  // 1er tap ‚Üí bulle rapide
  lastTapTime   = now;
  mobileBubbleCave  = cave;
  mobileBubbleFloor = floor;
  mobileBubbleSlot  = slot;
  showMobileBubble(cave, floor, slot);
}

function showMobileBubble(cave, floor, slot) {
  const wine      = getWineAtSlot(cave, floor, slot);
  const floorData = CAVE_CONFIG[cave].floors.find(f => f.id === floor);
  const bubble    = document.getElementById('mobile-bubble');
  const overlay   = document.getElementById('mobile-bubble-overlay');

  if(wine) {
    document.getElementById('mb-name').textContent = wine.nom || '‚Äî';
    const stars = wine.note ? '‚òÖ'.repeat(parseInt(wine.note)) + '‚òÜ'.repeat(5 - parseInt(wine.note)) : '';
    document.getElementById('mb-info').innerHTML = [
      wine.annee ? `<b>${wine.annee}</b>` : '',
      wine.domaine || '',
      wine.appellation || '',
      wine.region || '',
      wine.prix ? wine.prix + ' ‚Ç¨' : '',
      stars ? `<span style="color:var(--gold)">${stars}</span>` : '',
      `<span style="color:var(--text2);font-size:0.75rem">Cave ${cave} ¬∑ √ât.${floor} ¬∑ #${slot} ‚Äî double tap pour la fiche</span>`
    ].filter(Boolean).join('<br>');
    const imgWrap = document.getElementById('mb-img-wrap');
    const imgEl   = document.getElementById('mb-img');
    const _mbImg2 = imgGet('wine_' + wine.id) || wine.image || '';
    if(_mbImg2) { imgEl.src = _mbImg2; imgWrap.style.display = 'block'; }
    else           { imgWrap.style.display = 'none'; }
    document.getElementById('mb-btn-fiche').style.display = 'block';
  } else {
    document.getElementById('mb-name').textContent = 'Emplacement vide';
    document.getElementById('mb-info').innerHTML = `${floorData?.label} ¬∑ #${slot}<br><span style="color:var(--text2);font-size:0.75rem">Double tap pour ajouter un vin</span>`;
    document.getElementById('mb-img-wrap').style.display = 'none';
    document.getElementById('mb-btn-fiche').style.display = 'block';
  }

  overlay.style.display = 'block';
  bubble.style.display  = 'block';
  requestAnimationFrame(() => bubble.classList.add('open'));
}

function closeMobileBubble() {
  const bubble  = document.getElementById('mobile-bubble');
  const overlay = document.getElementById('mobile-bubble-overlay');
  bubble.classList.remove('open');
  overlay.style.display = 'none';
  setTimeout(() => { bubble.style.display = 'none'; }, 250);
  mobileBubbleCave = mobileBubbleFloor = mobileBubbleSlot = null;
  lastTapTime = 0;
}

// ‚îÄ‚îÄ Swipe-down pour fermer la mobile bubble ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  let _swipeStartY = 0;
  document.addEventListener('touchstart', function(e) {
    const bubble = document.getElementById('mobile-bubble');
    if(bubble && bubble.classList.contains('open')) {
      _swipeStartY = e.touches[0].clientY;
    }
  }, { passive: true });
  document.addEventListener('touchmove', function(e) {
    const bubble = document.getElementById('mobile-bubble');
    if(!bubble || !bubble.classList.contains('open')) return;
    const dy = e.touches[0].clientY - _swipeStartY;
    if(dy > 0) bubble.style.transform = `translateY(${dy}px)`;
  }, { passive: true });
  document.addEventListener('touchend', function(e) {
    const bubble = document.getElementById('mobile-bubble');
    if(!bubble || !bubble.classList.contains('open')) return;
    const dy = e.changedTouches[0].clientY - _swipeStartY;
    bubble.style.transform = '';
    if(dy > 80) closeMobileBubble();
  }, { passive: true });
})();

function mobileBubbleOpenFiche() {
  if(mobileBubbleCave !== null) {
    const c = mobileBubbleCave, f = mobileBubbleFloor, s = mobileBubbleSlot;
    // Fermer la bulle et bloquer tout nouveau tap pendant l'animation
    const bubble  = document.getElementById('mobile-bubble');
    const overlay = document.getElementById('mobile-bubble-overlay');
    bubble.classList.remove('open');
    overlay.style.display = 'none';
    mobileBubbleCave = mobileBubbleFloor = mobileBubbleSlot = null;
    lastTapTime = Date.now() + 2000; // bloquer les taps pendant 2s
    setTimeout(() => { bubble.style.display = 'none'; openSlotModal(c, f, s); }, 260);
  }
}


// =====================================================================

// =====================================================================
// CARTE DES VIGNOBLES ‚Äî Mapping r√©gions
// =====================================================================

const REGION_MAP = {
  // Alsace
  "alsace":"alsace","alsace grand cru":"alsace","riesling":"alsace","gewurztraminer":"alsace",
  "pinot gris":"alsace","cr√©mant d'alsace":"alsace","edelzwicker":"alsace","sylvaner":"alsace","pinot blanc":"alsace",
  // Bordeaux
  "bordeaux":"bordeaux","m√©doc":"bordeaux","haut-m√©doc":"bordeaux","medoc":"bordeaux",
  "pauillac":"bordeaux","saint-julien":"bordeaux","margaux":"bordeaux","saint-est√®phe":"bordeaux",
  "saint-√©milion":"bordeaux","saint emilion":"bordeaux","pomerol":"bordeaux",
  "fronsac":"bordeaux","canon-fronsac":"bordeaux","pessac-l√©ognan":"bordeaux",
  "graves":"bordeaux","sauternes":"bordeaux","barsac":"bordeaux","c√©rons":"bordeaux",
  "entre-deux-mers":"bordeaux","blaye":"bordeaux","bourg":"bordeaux","c√¥tes de bourg":"bordeaux",
  "moulis":"bordeaux","listrac":"bordeaux","lalande-de-pomerol":"bordeaux",
  // Bourgogne
  "bourgogne":"bourgogne","burgundy":"bourgogne","chablis":"bourgogne","petit chablis":"bourgogne",
  "c√¥te de nuits":"bourgogne","cote de nuits":"bourgogne","gevrey-chambertin":"bourgogne",
  "gevrey chambertin":"bourgogne","chambolle-musigny":"bourgogne","vosne-roman√©e":"bourgogne",
  "nuits-saint-georges":"bourgogne","morey-saint-denis":"bourgogne","marsannay":"bourgogne",
  "fixin":"bourgogne","vougeot":"bourgogne","flagey-echezeaux":"bourgogne",
  "c√¥te de beaune":"bourgogne","cote de beaune":"bourgogne","meursault":"bourgogne",
  "puligny-montrachet":"bourgogne","chassagne-montrachet":"bourgogne","pommard":"bourgogne",
  "volnay":"bourgogne","beaune":"bourgogne","corton":"bourgogne","aloxe-corton":"bourgogne",
  "savigny-l√®s-beaune":"bourgogne","chorey-les-beaune":"bourgogne","santenay":"bourgogne",
  "maranges":"bourgogne","saint-aubin":"bourgogne","ladoix":"bourgogne",
  "c√¥te chalonnaise":"bourgogne","mercurey":"bourgogne","givry":"bourgogne",
  "rully":"bourgogne","montagny":"bourgogne","bouzeron":"bourgogne",
  "m√¢connais":"bourgogne","macon":"bourgogne","m√¢con":"bourgogne","maconnais":"bourgogne",
  "pouilly-fuiss√©":"bourgogne","saint-v√©ran":"bourgogne","vir√©-cless√©":"bourgogne",
  "pouilly-vinzelles":"bourgogne","pouilly-loch√©":"bourgogne",
  // Champagne
  "champagne":"champagne","montagne de reims":"champagne","vall√©e de la marne":"champagne",
  "c√¥te des blancs":"champagne","cote des blancs":"champagne","aube":"champagne",
  "c√¥te des bar":"champagne","s√©zanne":"champagne","blanc de blancs":"champagne",
  "blanc de noirs":"champagne","cr√©mant":"champagne",
  // Beaujolais
  "beaujolais":"beaujolais","brouilly":"beaujolais","fleurie":"beaujolais","morgon":"beaujolais",
  "moulin-√†-vent":"beaujolais","chiroubles":"beaujolais","saint-amour":"beaujolais",
  "juli√©nas":"beaujolais","ch√©nas":"beaujolais","c√¥te de brouilly":"beaujolais",
  "r√©gni√©":"beaujolais","beaujolais-villages":"beaujolais","gamay":"beaujolais",
  // Val de Loire
  "loire":"val_de_loire","val de loire":"val_de_loire","muscadet":"val_de_loire",
  "pays nantais":"val_de_loire","gros plant":"val_de_loire",
  "anjou":"val_de_loire","saumur":"val_de_loire","saumur-champigny":"val_de_loire",
  "coteaux du layon":"val_de_loire","savenni√®res":"val_de_loire","bonnezeaux":"val_de_loire",
  "quarts-de-chaume":"val_de_loire","quarts de chaume":"val_de_loire",
  "touraine":"val_de_loire","chinon":"val_de_loire","bourgueil":"val_de_loire",
  "saint-nicolas-de-bourgueil":"val_de_loire","vouvray":"val_de_loire",
  "montlouis":"val_de_loire","montlouis-sur-loire":"val_de_loire","cheverny":"val_de_loire",
  "cr√©mant de loire":"val_de_loire","cr√©mant de la loire":"val_de_loire",
  "sancerre":"val_de_loire","pouilly-fum√©":"val_de_loire","menetou-salon":"val_de_loire",
  "quincy":"val_de_loire","reuilly":"val_de_loire","coteaux du giennois":"val_de_loire",
  "fiefs vend√©ens":"val_de_loire",
  // Corse
  "corse":"corse","corsica":"corse","patrimonio":"corse","ajaccio":"corse",
  "corse-calvi":"corse","corse-sart√®ne":"corse","corse-figari":"corse",
  "corse-porto-vecchio":"corse","muscat du cap corse":"corse",
  "nielluccio":"corse","sciaccarello":"corse",
  // Jura
  "jura":"jura","arbois":"jura","ch√¢teau-chalon":"jura","c√¥tes du jura":"jura",
  "l'√©toile":"jura","cr√©mant du jura":"jura","vin jaune":"jura","vin de paille":"jura",
  "savagnin":"jura","poulsard":"jura","trousseau":"jura",
  // Languedoc
  "languedoc":"languedoc","coteaux du languedoc":"languedoc","languedoc-roussillon":"languedoc",
  "pic saint-loup":"languedoc","pic saint loup":"languedoc",
  "faug√®res":"languedoc","faugeres":"languedoc",
  "saint-chinian":"languedoc","saint chinian":"languedoc",
  "minervois":"languedoc","minervois-la-livini√®re":"languedoc",
  "corbi√®res":"languedoc","corbieres":"languedoc","corbi√®res-boutenac":"languedoc",
  "fitou":"languedoc","la clape":"languedoc","terrasses du larzac":"languedoc",
  "p√©zenas":"languedoc","gr√®s de montpellier":"languedoc","clairette":"languedoc",
  "muscat de frontignan":"languedoc","muscat de lunel":"languedoc",
  "muscat de mireval":"languedoc","clairette du languedoc":"languedoc",
  "picpoul de pinet":"languedoc","limoux":"languedoc","blanquette de limoux":"languedoc",
  // Rh√¥ne Nord
  "c√¥te-r√¥tie":"rhone_nord","cote rotie":"rhone_nord","condrieu":"rhone_nord",
  "ch√¢teau-grillet":"rhone_nord","saint-joseph":"rhone_nord","crozes-hermitage":"rhone_nord",
  "hermitage":"rhone_nord","cornas":"rhone_nord","saint-p√©ray":"rhone_nord",
  "syrah":"rhone_nord","viognier":"rhone_nord","marsanne":"rhone_nord","roussanne":"rhone_nord",
  // Provence
  "provence":"provence","c√¥tes de provence":"provence","cotes de provence":"provence",
  "coteaux d'aix":"provence","coteaux d'aix-en-provence":"provence",
  "les baux-de-provence":"provence","les baux":"provence",
  "bandol":"provence","cassis":"provence","palette":"provence",
  "coteaux varois":"provence","bellet":"provence","pierrevert":"provence",
  "sainte-victoire":"provence",
  // Roussillon
  "roussillon":"roussillon","c√¥tes du roussillon":"roussillon","cotes du roussillon":"roussillon",
  "c√¥tes du roussillon villages":"roussillon","banyuls":"roussillon",
  "banyuls grand cru":"roussillon","collioure":"roussillon","maury":"roussillon",
  "rivesaltes":"roussillon","muscat de rivesaltes":"roussillon",
  // Rh√¥ne Sud
  "ch√¢teauneuf-du-pape":"rhone_sud","chateauneuf":"rhone_sud","chateauneuf-du-pape":"rhone_sud",
  "gigondas":"rhone_sud","vacqueyras":"rhone_sud","beaumes-de-venise":"rhone_sud",
  "rasteau":"rhone_sud","tavel":"rhone_sud","lirac":"rhone_sud",
  "ventoux":"rhone_sud","luberon":"rhone_sud","c√¥tes du rh√¥ne":"rhone_sud",
  "cotes du rhone":"rhone_sud","c√¥tes du rh√¥ne villages":"rhone_sud",
  "c√¥tes du vivarais":"rhone_sud","grenache":"rhone_sud","mourv√®dre":"rhone_sud",
  "rh√¥ne":"rhone_sud","rhone":"rhone_sud",
  // Savoie
  "savoie":"savoie","vin de savoie":"savoie","roussette de savoie":"savoie",
  "cr√©mant de savoie":"savoie","seyssel":"savoie","bugey":"savoie","cerdon":"savoie",
  "jacqu√®re":"savoie","altesse":"savoie","mondeuse":"savoie",
  "apremont":"savoie","abymes":"savoie","chignin":"savoie","cr√©py":"savoie","ripaille":"savoie",
  // Sud-Ouest
  "bergerac":"sud_ouest","p√©charmant":"sud_ouest","monbazillac":"sud_ouest",
  "saussignac":"sud_ouest","rosette":"sud_ouest",
  "cahors":"sud_ouest","malbec":"sud_ouest","c√¥t":"sud_ouest","auxerrois":"sud_ouest",
  "gaillac":"sud_ouest","gaillac premi√®res c√¥tes":"sud_ouest","fronton":"sud_ouest",
  "buzet":"sud_ouest","duras":"sud_ouest","marmandais":"sud_ouest","c√¥tes du marmandais":"sud_ouest",
  "madiran":"sud_ouest","pacherenc du vic-bilh":"sud_ouest","tannat":"sud_ouest",
  "juran√ßon":"sud_ouest","jurancon":"sud_ouest","iroul√©guy":"sud_ouest",
  "saint-mont":"sud_ouest","b√©arn":"sud_ouest","tursan":"sud_ouest",
  "manseng":"sud_ouest","len de l'el":"sud_ouest","fer servadou":"sud_ouest",
  "sud-ouest":"sud_ouest","sud ouest":"sud_ouest",
  // Espagne
  "espagne":"rioja","spain":"rioja",
  "rioja":"rioja","rioja alta":"rioja","rioja alavesa":"rioja","rioja oriental":"rioja",
  "ribera del duero":"ribera_del_duero","vega sicilia":"ribera_del_duero","pingus":"ribera_del_duero","pesquera":"ribera_del_duero",
  "priorat":"priorat","priorato":"priorat","montsant":"priorat","terra alta":"priorat",
  "jerez":"jerez","sherry":"jerez","x√©r√®s":"jerez","manzanilla":"jerez","fino":"jerez",
  "amontillado":"jerez","oloroso":"jerez","palo cortado":"jerez","pedro xim√©nez":"jerez",
  "pened√®s":"penedes","penedes":"penedes","cava":"penedes","corpinnat":"penedes",
  "r√≠as baixas":"rias_baixas","rias baixas":"rias_baixas","albari√±o":"rias_baixas",
  "rueda":"rueda","verdejo":"rueda",
  "toro":"toro","tinta de toro":"toro","zamora":"toro",
  "ribeira sacra":"galicia","ribeiro":"galicia","valdeorras":"galicia","monterrei":"galicia","godello":"galicia",
  "navarra":"aragon_navarra","campo de borja":"aragon_navarra","calatayud":"aragon_navarra","cari√±ena":"aragon_navarra","somontano":"aragon_navarra",
  "la mancha":"castilla_la_mancha","valdepe√±as":"castilla_la_mancha","manchuela":"castilla_la_mancha","almansa":"castilla_la_mancha",
  "bierzo":"bierzo","menc√≠a":"bierzo","mencia":"bierzo","cigales":"bierzo",
  "txakoli":"txakoli","txakoli de getaria":"txakoli","chacoli":"txakoli",
  "empord√†":"emporda","emporda":"emporda","costa brava wine":"emporda",
  // Portugal
  "porto":"douro_porto","port":"douro_porto","douro":"douro_porto","porto vintage":"douro_porto",
  "porto tawny":"douro_porto","porto ruby":"douro_porto","porto colheita":"douro_porto",
  "vinho verde":"vinho_verde","alvarinho":"vinho_verde","loureiro vinho":"vinho_verde",
  "d√£o":"dao_bairrada","dao":"dao_bairrada","bairrada":"dao_bairrada","baga":"dao_bairrada",
  "alentejo":"alentejo","borba":"alentejo","√©vora":"alentejo","reguengos":"alentejo",
  "set√∫bal":"setubal_lisboa","palmela":"setubal_lisboa","moscatel de set√∫bal":"setubal_lisboa","lisboa":"setubal_lisboa",
  "mad√®re":"madere","madeira":"madere","sercial":"madere","malmsey":"madere",
  "portugal":"douro_porto",
  // Italie
  "barolo":"piemonte","barbaresco":"piemonte","barbera":"piemonte","nebbiolo":"piemonte","gavi":"piemonte","pi√©mont":"piemonte","piemonte":"piemonte","moscato d'asti":"piemonte","asti":"piemonte","langhe":"piemonte","roero":"piemonte","dolcetto":"piemonte",
  "toscane":"toscane","toscana":"toscane","tuscany":"toscane","chianti":"toscane","brunello":"toscane","bolgheri":"toscane","sangiovese":"toscane","morellino":"toscane","vernaccia":"toscane","vino nobile":"toscane","rosso di montalcino":"toscane","maremma":"toscane",
  "v√©n√©tie":"veneto","veneto":"veneto","venetie":"veneto","amarone":"veneto","valpolicella":"veneto","soave":"veneto","prosecco":"veneto","bardolino":"veneto","recioto":"veneto",
  "frioul":"frioul","friuli":"frioul","collio":"frioul","friulano":"frioul","ribolla":"frioul",
  "trentin":"trentino_aa","trentino":"trentino_aa","alto adige":"trentino_aa","s√ºdtirol":"trentino_aa","lagrein":"trentino_aa","teroldego":"trentino_aa",
  "lombardie":"lombardie","lombardia":"lombardie","franciacorta":"lombardie","valtellina":"lombardie",
  "pi√©mont":"piemonte","italie":"piemonte","italy":"piemonte",
  "campanie":"campanie","campania":"campanie","taurasi":"campanie","aglianico":"campanie","fiano":"campanie","greco di tufo":"campanie","falanghina":"campanie",
  "sicile":"sicile","sicilia":"sicile","sicily":"sicile","nero d'avola":"sicile","etna":"sicile","marsala":"sicile",
  "sardaigne":"sardaigne","sardegna":"sardaigne","sardinia":"sardaigne","cannonau":"sardaigne","vermentino":"sardaigne",
  "pouilles":"pouilles","puglia":"pouilles","primitivo":"pouilles","negroamaro":"pouilles",
  "marches":"marches_ombrie","marche":"marches_ombrie","ombrie":"marches_ombrie","umbria":"marches_ombrie","sagrantino":"marches_ombrie","verdicchio":"marches_ombrie","orvieto":"marches_ombrie",
  "abruzzes":"abruzzo_molise","abruzzo":"abruzzo_molise","montepulciano d'abruzzo":"abruzzo_molise",
  "latium":"lazio","lazio":"lazio","frascati":"lazio","calabre":"lazio","calabria":"lazio","cir√≤":"lazio",
  // Allemagne
  "allemagne":"mosel","germany":"mosel",
  "moselle":"mosel","mosel":"mosel","saar":"saar","mittelrhein":"saar",
  "rheingau":"rheingau","r√ºdesheim":"rheingau","johannisberg":"rheingau",
  "rheinhessen":"rheinhessen","nierstein":"rheinhessen","oppenheim":"rheinhessen",
  "pfalz":"pfalz","palatinat":"pfalz","deidesheim":"pfalz",
  "bade":"bade","baden":"bade","kaiserstuhl":"bade","markgr√§flerland":"bade",
  "franconie":"franconie","franken":"franconie","w√ºrzburg":"franconie","silvaner":"franconie",
  "nahe":"nahe","bad kreuznach":"nahe",
  "wurtemberg":"wurtemberg","w√ºrttemberg":"wurtemberg","trollinger":"wurtemberg","lemberger":"wurtemberg",
  // Autriche
  "autriche":"wachau","austria":"wachau",
  "wachau":"wachau","smaragd":"wachau","gr√ºner veltliner":"wachau",
  "kamptal":"kamptal_kremstal","kremstal":"kamptal_kremstal","langenlois":"kamptal_kremstal",
  "burgenland":"burgenland","blaufr√§nkisch":"burgenland","zweigelt":"burgenland",
  "styrie":"styrie","steiermark":"styrie","s√ºdsteiermark":"styrie","schilcher":"styrie",
  "vienne":"wien_donauland","wien":"wien_donauland","wagram":"wien_donauland",
  // Gr√®ce
  "gr√®ce":"santorini","greece":"santorini",
  "santorini":"santorini","assyrtiko":"santorini","samos":"santorini",
  "nemea":"nemee","agiorgitiko":"nemee","p√©loponn√®se":"nemee",
  "naoussa":"naoussa_mak","xinomavro":"naoussa_mak","amyntaion":"naoussa_mak",
  "cr√®te":"crete","crete":"crete","kotsifali":"crete",
  // Hongrie
  "tokaj":"tokaj","tokaji":"tokaj","furmint":"tokaj","asz√∫":"tokaj","hongrie":"tokaj","hungary":"tokaj",
  "eger":"eger","egri bikav√©r":"eger",
  "vill√°ny":"villany","villany":"villany","szeksz√°rd":"villany",
  "soml√≥":"somlo","badacsony":"somlo","juhfark":"somlo",
  // Suisse
  "valais":"suisse_valais","fendant":"suisse_valais","d√¥le":"suisse_valais","petite arvine":"suisse_valais","suisse":"suisse_valais","switzerland":"suisse_valais",
  "vaud":"suisse_vaud","lavaux":"suisse_vaud","la c√¥te vaudoise":"suisse_vaud","chasselas":"suisse_vaud",
  // Autres
  "croatie":"croatie_dalm","croatia":"croatie_dalm","dingaƒç":"croatie_dalm","plavac mali":"croatie_dalm",
  "slov√©nie":"slovenie","slovenia":"slovenie","brda":"slovenie","rebula":"slovenie",
  "bulgarie":"bulgarie","bulgaria":"bulgarie","mavrud":"bulgarie","melnik":"bulgarie",
  "roumanie":"roumanie","romania":"roumanie","dealu mare":"roumanie","cotnari":"roumanie",
  "angleterre":"angleterre","england":"angleterre","english sparkling":"angleterre","sussex":"angleterre",
  "luxembourg":"luxembourg","moselle luxembourgeoise":"luxembourg",
};

const WINE_REGION_POLYGONS = {
  /* ===== FRANCE ===== */
  "alsace":{label:"Alsace",num:1,country:"France",color:"#d4c5a9",type:"blanc",
    appellations:["Alsace Grand Cru","Riesling","Gewurztraminer","Pinot Gris","Muscat d'Alsace","Cr√©mant d'Alsace","Pinot Blanc","Sylvaner","Edelzwicker"],
    cepages:"Riesling, Gewurztraminer, Pinot Gris, Pinot Noir, Muscat",
    geometry:{"type":"MultiPolygon","coordinates":[[[[7.33,48.95],[7.42,48.97],[7.52,48.88],[7.6,48.8],[7.68,48.65],[7.72,48.5],[7.76,48.32],[7.8,48.18],[7.78,47.95],[7.72,47.72],[7.6,47.6],[7.45,47.55],[7.35,47.58],[7.25,47.68],[7.18,47.85],[7.12,48.05],[7.08,48.22],[7.1,48.45],[7.12,48.62],[7.18,48.78],[7.25,48.88],[7.33,48.95]]]]}},

  "bordeaux":{label:"Bordeaux",num:2,country:"France",color:"#9988cc",type:"both",
    appellations:["M√©doc","Haut-M√©doc","Pauillac","Saint-Julien","Margaux","Saint-Est√®phe","Moulis","Listrac","Saint-√âmilion","Pomerol","Lalande-de-Pomerol","Graves","Pessac-L√©ognan","Sauternes","Barsac","Entre-deux-Mers","Blaye","Bourg","Fronsac","Canon-Fronsac"],
    cepages:"Cabernet Sauvignon, Merlot, Cabernet Franc, S√©millon, Sauvignon Blanc",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-1.25,45.62],[-1.05,45.72],[-0.88,45.68],[-0.72,45.55],[-0.68,45.32],[-0.72,45.12],[-0.82,44.98],[-0.95,44.92],[-1.08,44.95],[-1.18,45.08],[-1.22,45.3],[-1.25,45.62]]],[[[-0.38,45.05],[-0.12,45.1],[0.05,45.02],[0.12,44.88],[0.02,44.72],[-0.18,44.68],[-0.38,44.78],[-0.42,44.92],[-0.38,45.05]]],[[[-0.78,44.9],[-0.52,44.95],[-0.38,44.88],[-0.32,44.72],[-0.4,44.52],[-0.58,44.42],[-0.72,44.52],[-0.8,44.68],[-0.78,44.9]]],[[[-0.62,44.6],[-0.42,44.63],[-0.32,44.52],[-0.38,44.38],[-0.55,44.35],[-0.65,44.42],[-0.62,44.6]]],[[[-0.45,45.0],[-0.18,45.08],[0.08,44.98],[0.18,44.82],[0.05,44.58],[-0.15,44.5],[-0.35,44.6],[-0.42,44.78],[-0.45,45.0]]],[[[-0.68,45.32],[-0.45,45.38],[-0.32,45.28],[-0.28,45.08],[-0.38,44.92],[-0.58,44.88],[-0.68,45.02],[-0.68,45.32]]]]}},

  "bourgogne":{label:"Bourgogne",num:3,country:"France",color:"#e8c84a",type:"both",
    appellations:["Chablis","Chablis Grand Cru","C√¥te de Nuits","Gevrey-Chambertin","Chambolle-Musigny","Vosne-Roman√©e","Nuits-Saint-Georges","C√¥te de Beaune","Meursault","Puligny-Montrachet","Chassagne-Montrachet","Pommard","Volnay","Beaune","Corton","C√¥te Chalonnaise","Mercurey","Rully","Givry","M√¢connais","Pouilly-Fuiss√©","Saint-V√©ran","Vir√©-Cless√©"],
    cepages:"Pinot Noir, Chardonnay, Aligot√©, Gamay",
    geometry:{"type":"MultiPolygon","coordinates":[[[[3.52,47.72],[3.78,47.8],[4.02,47.72],[4.1,47.58],[3.95,47.45],[3.68,47.42],[3.48,47.55],[3.52,47.72]]],[[[4.82,47.42],[4.88,47.42],[4.98,47.38],[5.05,47.28],[5.08,47.15],[5.05,47.02],[4.95,46.95],[4.85,46.98],[4.78,47.08],[4.76,47.22],[4.78,47.32],[4.82,47.42]]],[[[4.76,47.05],[4.85,47.05],[4.95,46.98],[5.02,46.88],[5.0,46.72],[4.9,46.65],[4.78,46.68],[4.72,46.78],[4.72,46.92],[4.76,47.05]]],[[[4.65,46.68],[4.78,46.7],[4.88,46.6],[4.9,46.45],[4.8,46.32],[4.65,46.3],[4.55,46.4],[4.55,46.55],[4.65,46.68]]],[[[4.58,46.32],[4.78,46.35],[4.98,46.25],[5.08,46.08],[4.98,45.92],[4.75,45.85],[4.55,45.95],[4.48,46.12],[4.58,46.32]]]]}},

  "champagne":{label:"Champagne",num:4,country:"France",color:"#b03030",type:"effervescent",
    appellations:["Champagne","Montagne de Reims","Vall√©e de la Marne","C√¥te des Blancs","C√¥te des Bar","Blanc de Blancs","Blanc de Noirs","Cr√©mant d'Alsace"],
    cepages:"Pinot Noir, Chardonnay, Pinot Meunier",
    geometry:{"type":"MultiPolygon","coordinates":[[[[3.52,49.32],[3.75,49.38],[4.05,49.3],[4.15,49.15],[4.0,49.02],[3.68,49.0],[3.45,49.1],[3.52,49.32]]],[[[3.25,49.1],[3.68,49.15],[4.0,49.08],[4.12,48.98],[3.98,48.88],[3.65,48.85],[3.3,48.9],[3.25,49.1]]],[[[3.7,49.02],[3.95,49.0],[4.05,48.88],[4.0,48.72],[3.8,48.68],[3.65,48.75],[3.62,48.9],[3.7,49.02]]],[[[3.5,48.8],[3.72,48.82],[3.85,48.68],[3.75,48.55],[3.52,48.52],[3.38,48.62],[3.5,48.8]]],[[[4.05,48.32],[4.45,48.38],[4.7,48.22],[4.62,48.0],[4.28,47.92],[4.0,48.02],[4.05,48.32]]]]}},

  "beaujolais":{label:"Beaujolais",num:5,country:"France",color:"#2d8a4e",type:"rouge",
    appellations:["Moulin-√†-Vent","Fleurie","Morgon","Brouilly","C√¥te de Brouilly","Juli√©nas","Saint-Amour","Ch√©nas","Chiroubles","R√©gni√©","Beaujolais-Villages","Beaujolais"],
    cepages:"Gamay Noir",
    geometry:{"type":"MultiPolygon","coordinates":[[[[4.45,46.18],[4.68,46.22],[4.85,46.08],[4.92,45.9],[4.88,45.72],[4.75,45.58],[4.58,45.52],[4.42,45.6],[4.35,45.78],[4.35,45.98],[4.45,46.18]]]]}},

  "val_de_loire":{label:"Val de Loire",num:6,country:"France",color:"#88aa22",type:"both",
    appellations:["Muscadet","Muscadet-S√®vre et Maine","Anjou","Anjou-Villages","Saumur","Saumur-Champigny","Touraine","Chinon","Bourgueil","Saint-Nicolas-de-Bourgueil","Vouvray","Montlouis-sur-Loire","Savenni√®res","Coteaux du Layon","Bonnezeaux","Quarts de Chaume","Sancerre","Pouilly-Fum√©","Menetou-Salon","Reuilly","Quincy","Cr√©mant de Loire","Cheverny"],
    cepages:"Chenin Blanc, Sauvignon Blanc, Cabernet Franc, Melon de Bourgogne, Gamay",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-2.12,47.5],[-1.58,47.55],[-1.1,47.4],[-1.0,47.2],[-1.15,47.0],[-1.55,46.95],[-1.95,47.05],[-2.18,47.28],[-2.12,47.5]]],[[[-0.88,47.58],[-0.48,47.65],[-0.05,47.55],[0.08,47.42],[-0.02,47.25],[-0.22,47.12],[-0.55,47.08],[-0.88,47.22],[-0.88,47.58]]],[[[0.35,47.52],[0.82,47.62],[1.15,47.52],[1.3,47.38],[1.18,47.22],[0.82,47.12],[0.45,47.22],[0.3,47.38],[0.35,47.52]]],[[[2.5,47.5],[2.82,47.55],[3.08,47.45],[3.18,47.28],[3.05,47.1],[2.72,47.05],[2.45,47.15],[2.38,47.32],[2.5,47.5]]],[[[2.6,47.72],[2.85,47.78],[2.98,47.65],[2.88,47.52],[2.65,47.48],[2.5,47.58],[2.6,47.72]]]]}},

  "corse":{label:"Corse",num:7,country:"France",color:"#884488",type:"rouge",
    appellations:["Patrimonio","Ajaccio","Vin de Corse","Corse-Calvi","Corse-Sart√®ne","Corse-Figari","Corse-Porto-Vecchio","Muscat du Cap Corse"],
    cepages:"Nielluccio, Sciaccarello, Vermentino, Grenache",
    geometry:{"type":"MultiPolygon","coordinates":[[[[9.18,42.62],[9.38,42.72],[9.52,42.65],[9.48,42.5],[9.28,42.45],[9.12,42.55],[9.18,42.62]]],[[[8.62,42.0],[8.78,42.08],[8.92,41.98],[8.88,41.82],[8.68,41.78],[8.55,41.88],[8.62,42.0]]],[[[8.95,41.6],[9.18,41.68],[9.4,41.62],[9.58,41.5],[9.48,41.3],[9.25,41.22],[8.98,41.3],[8.85,41.45],[8.95,41.6]]],[[[9.42,42.48],[9.55,42.62],[9.65,42.5],[9.68,42.28],[9.58,42.1],[9.45,42.05],[9.35,42.15],[9.42,42.48]]]]}},

  "jura":{label:"Jura",num:8,country:"France",color:"#cc88cc",type:"both",
    appellations:["Arbois","Arbois-Pupillin","Ch√¢teau-Chalon","C√¥tes du Jura","L'√âtoile","Cr√©mant du Jura","Vin Jaune","Vin de Paille","Macvin du Jura"],
    cepages:"Savagnin, Chardonnay, Poulsard, Trousseau, Pinot Noir",
    geometry:{"type":"MultiPolygon","coordinates":[[[[5.38,47.2],[5.62,47.25],[5.82,47.15],[5.98,46.98],[5.92,46.72],[5.75,46.5],[5.52,46.42],[5.35,46.52],[5.28,46.72],[5.32,46.98],[5.38,47.2]]]]}},

  "languedoc":{label:"Languedoc",num:9,country:"France",color:"#ee44aa",type:"rouge",
    appellations:["Languedoc","Pic Saint-Loup","Faug√®res","Saint-Chinian","Minervois","Minervois-La Livini√®re","Corbi√®res","Corbi√®res-Boutenac","Fitou","La Clape","Terrasses du Larzac","P√©zenas","Gr√®s de Montpellier","Picpoul de Pinet","Blanquette de Limoux","Muscat de Frontignan","Muscat de Mireval"],
    cepages:"Grenache, Syrah, Mourv√®dre, Carignan, Cinsault, Clairette, Marsanne",
    geometry:{"type":"MultiPolygon","coordinates":[[[[3.48,43.98],[3.82,44.05],[4.05,43.92],[4.12,43.72],[3.92,43.55],[3.58,43.5],[3.35,43.58],[3.38,43.78],[3.48,43.98]]],[[[2.82,43.72],[3.15,43.8],[3.4,43.68],[3.45,43.48],[3.22,43.35],[2.88,43.3],[2.62,43.4],[2.7,43.6],[2.82,43.72]]],[[[2.3,43.58],[2.65,43.65],[2.88,43.52],[2.85,43.3],[2.55,43.18],[2.22,43.22],[2.05,43.38],[2.3,43.58]]],[[[2.68,43.1],[2.92,43.15],[3.08,43.0],[3.02,42.8],[2.78,42.72],[2.58,42.8],[2.62,43.0],[2.68,43.1]]],[[[3.62,43.5],[3.88,43.58],[4.05,43.45],[3.98,43.28],[3.75,43.22],[3.55,43.32],[3.62,43.5]]]]}},

  "rhone_nord":{label:"Rh√¥ne Septentrional",num:10,country:"France",color:"#22aa55",type:"rouge",
    appellations:["C√¥te-R√¥tie","Condrieu","Ch√¢teau-Grillet","Saint-Joseph","Crozes-Hermitage","Hermitage","Cornas","Saint-P√©ray"],
    cepages:"Syrah, Viognier, Marsanne, Roussanne",
    geometry:{"type":"MultiPolygon","coordinates":[[[[4.55,45.72],[4.68,45.75],[4.78,45.62],[4.75,45.48],[4.62,45.42],[4.5,45.48],[4.48,45.6],[4.55,45.72]]],[[[4.58,45.5],[4.72,45.55],[4.82,45.42],[4.88,45.22],[4.85,45.0],[4.72,44.92],[4.58,44.98],[4.52,45.15],[4.52,45.35],[4.58,45.5]]],[[[4.72,45.18],[4.95,45.28],[5.08,45.12],[5.02,44.95],[4.82,44.88],[4.65,44.95],[4.62,45.08],[4.72,45.18]]],[[[4.72,44.95],[4.88,44.98],[4.98,44.85],[4.92,44.72],[4.75,44.68],[4.62,44.75],[4.65,44.88],[4.72,44.95]]]]}},

  "provence":{label:"Provence",num:12,country:"France",color:"#aacc22",type:"ros√©",
    appellations:["C√¥tes de Provence","C√¥tes de Provence Sainte-Victoire","Coteaux d'Aix-en-Provence","Les Baux-de-Provence","Bandol","Cassis","Palette","Coteaux Varois en Provence","Bellet","Coteaux de Pierrevert"],
    cepages:"Grenache, Mourv√®dre, Cinsault, Syrah, Vermentino, Clairette, Ugni Blanc",
    geometry:{"type":"MultiPolygon","coordinates":[[[[4.8,43.82],[5.22,43.95],[5.52,43.82],[5.55,43.58],[5.28,43.38],[4.88,43.38],[4.68,43.52],[4.72,43.68],[4.8,43.82]]],[[[5.38,43.88],[5.85,44.0],[6.35,43.95],[6.88,43.8],[7.1,43.62],[7.02,43.35],[6.45,43.12],[5.88,43.05],[5.45,43.15],[5.25,43.35],[5.38,43.88]]]]}},

  "roussillon":{label:"Roussillon",num:13,country:"France",color:"#558822",type:"vdn_rouge",
    appellations:["C√¥tes du Roussillon","C√¥tes du Roussillon Villages","Banyuls","Banyuls Grand Cru","Collioure","Maury","Maury Sec","Rivesaltes","Muscat de Rivesaltes"],
    cepages:"Grenache Noir, Grenache Blanc, Grenache Gris, Carignan, Mourv√®dre, Macabeu",
    geometry:{"type":"MultiPolygon","coordinates":[[[[2.45,42.98],[2.82,43.05],[3.1,42.92],[3.15,42.65],[2.95,42.45],[2.62,42.38],[2.32,42.45],[2.18,42.68],[2.45,42.98]]],[[[2.92,42.58],[3.1,42.68],[3.25,42.55],[3.22,42.38],[3.0,42.32],[2.8,42.38],[2.82,42.5],[2.92,42.58]]]]}},

  "rhone_sud":{label:"Rh√¥ne M√©ridional",num:14,country:"France",color:"#44aaaa",type:"rouge",
    appellations:["Ch√¢teauneuf-du-Pape","Gigondas","Vacqueyras","Beaumes-de-Venise","Rasteau","Tavel","Lirac","Ventoux","Luberon","C√¥tes du Rh√¥ne Villages","C√¥tes du Vivarais","Grignan-les-Adh√©mar"],
    cepages:"Grenache, Syrah, Mourv√®dre, Cinsault, Clairette, Bourboulenc, Roussanne",
    geometry:{"type":"MultiPolygon","coordinates":[[[[4.58,44.28],[4.82,44.35],[5.0,44.22],[5.05,44.0],[4.88,43.88],[4.62,43.85],[4.45,43.98],[4.45,44.15],[4.58,44.28]]],[[[4.88,44.28],[5.08,44.38],[5.28,44.25],[5.32,44.05],[5.15,43.92],[4.92,43.88],[4.8,44.02],[4.8,44.18],[4.88,44.28]]],[[[4.78,44.45],[5.0,44.52],[5.18,44.38],[5.12,44.22],[4.9,44.18],[4.72,44.28],[4.78,44.45]]],[[[4.92,44.18],[5.25,44.28],[5.55,44.18],[5.62,43.95],[5.45,43.78],[5.12,43.72],[4.88,43.82],[4.78,44.02],[4.92,44.18]]]]}},

  "savoie":{label:"Savoie & Bugey",num:15,country:"France",color:"#aaaadd",type:"both",
    appellations:["Vin de Savoie","Roussette de Savoie","Cr√©mant de Savoie","Seyssel","Bugey","Bugey-Cerdon","Apremont","Abymes","Chignin","Chignin-Bergeron","Cr√©py","Ripaille"],
    cepages:"Jacqu√®re, Altesse/Roussette, Mondeuse, Chardonnay, Gamay, Chasselas",
    geometry:{"type":"MultiPolygon","coordinates":[[[[5.22,45.95],[5.5,46.05],[5.7,45.9],[5.65,45.68],[5.42,45.55],[5.2,45.62],[5.12,45.78],[5.22,45.95]]],[[[5.72,45.72],[5.98,45.82],[6.18,45.7],[6.22,45.5],[6.05,45.35],[5.82,45.3],[5.62,45.4],[5.58,45.58],[5.72,45.72]]],[[[6.08,45.6],[6.32,45.68],[6.52,45.55],[6.55,45.35],[6.38,45.2],[6.15,45.18],[5.98,45.3],[5.98,45.48],[6.08,45.6]]],[[[6.28,46.32],[6.45,46.4],[6.58,46.3],[6.52,46.15],[6.32,46.12],[6.18,46.22],[6.28,46.32]]]]}},

  "sud_ouest":{label:"Sud-Ouest",num:16,country:"France",color:"#ff2288",type:"rouge",
    appellations:["Bergerac","P√©charmant","Monbazillac","Cahors","Gaillac","Fronton","Buzet","Madiran","Pacherenc du Vic-Bilh","Juran√ßon","Iroul√©guy","Saint-Mont","Marcillac","Entraygues","Estaing","Tursan"],
    cepages:"Malbec/C√¥t, Cabernet Franc, Tannat, Gros et Petit Manseng, Len de l'El, Fer Servadou",
    geometry:{"type":"MultiPolygon","coordinates":[[[[0.22,45.05],[0.65,45.12],[0.98,44.98],[0.98,44.72],[0.68,44.58],[0.28,44.62],[0.1,44.78],[0.22,45.05]]],[[[0.98,44.72],[1.55,44.8],[1.9,44.62],[1.88,44.35],[1.52,44.22],[1.05,44.25],[0.82,44.42],[0.98,44.72]]],[[[1.55,44.0],[1.98,44.08],[2.15,43.92],[2.08,43.68],[1.72,43.6],[1.4,43.68],[1.28,43.85],[1.55,44.0]]],[[[0.12,44.52],[0.45,44.58],[0.68,44.45],[0.72,44.25],[0.48,44.12],[0.15,44.18],[-0.05,44.32],[0.12,44.52]]],[[[-0.48,43.85],[-0.12,43.92],[0.12,43.78],[0.12,43.55],[-0.15,43.42],[-0.48,43.48],[-0.6,43.62],[-0.48,43.85]]],[[[-0.68,43.32],[-0.28,43.38],[0.0,43.22],[0.0,43.02],[-0.28,42.92],[-0.62,42.98],[-0.72,43.15],[-0.68,43.32]]],[[[-1.28,43.22],[-0.98,43.28],[-0.8,43.12],[-0.82,42.98],[-1.05,42.92],[-1.28,43.02],[-1.28,43.22]]]]}},

  /* ===== ESPAGNE ===== */
  "rioja":{label:"Rioja",num:20,country:"Espagne",color:"#c8442a",type:"rouge",
    appellations:["Rioja Alta","Rioja Alavesa","Rioja Oriental","Crianza","Reserva","Gran Reserva","Rioja Blanco"],
    cepages:"Tempranillo, Garnacha, Mazuelo, Graciano, Viura, Malvas√≠a",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-3.08,42.62],[-2.72,42.75],[-2.28,42.72],[-1.92,42.62],[-1.82,42.38],[-2.05,42.18],[-2.55,42.12],[-3.0,42.28],[-3.08,42.62]]]]}},

  "ribera_del_duero":{label:"Ribera del Duero",num:21,country:"Espagne",color:"#aa2244",type:"rouge",
    appellations:["Ribera del Duero DO","Crianza","Reserva","Gran Reserva"],
    cepages:"Tempranillo/Tinto Fino, Garnacha, Cabernet Sauvignon, Merlot",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-4.18,41.88],[-3.55,41.98],[-2.92,41.92],[-2.72,41.62],[-3.05,41.32],[-3.72,41.28],[-4.18,41.45],[-4.25,41.68],[-4.18,41.88]]]]}},

  "priorat":{label:"Priorat",num:22,country:"Espagne",color:"#8b1a3a",type:"rouge",
    appellations:["DOCa Priorat","Montsant","Terra Alta","Conca de Barber√†"],
    cepages:"Garnacha, Cari√±ena/Mazuelo, Cabernet Sauvignon, Syrah, Merlot",
    geometry:{"type":"MultiPolygon","coordinates":[[[[ 0.62,41.32],[0.95,41.42],[1.15,41.28],[1.1,41.05],[0.85,40.98],[0.62,41.1],[0.62,41.32]]]]}},

  "jerez":{label:"Jerez / Sherry",num:23,country:"Espagne",color:"#d4a020",type:"blanc",
    appellations:["Fino","Manzanilla-Sanl√∫car de Barrameda","Amontillado","Oloroso","Palo Cortado","Pedro Xim√©nez","Cream","Jerez-X√©r√®s-Sherry"],
    cepages:"Palomino Fino, Pedro Xim√©nez, Moscatel",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-5.98,36.98],[-5.52,37.12],[-5.18,37.02],[-5.05,36.72],[-5.35,36.5],[-5.82,36.52],[-6.0,36.72],[-5.98,36.98]]]]}},

  "penedes":{label:"Pened√®s / Cava",num:24,country:"Espagne",color:"#c4a0e0",type:"effervescent",
    appellations:["Pened√®s DO","Cava DO","Corpinnat","Alt Pened√®s","Classic Pened√®s"],
    cepages:"Xarel¬∑lo, Macabeo/Viura, Parellada, Chardonnay, Pinot Noir",
    geometry:{"type":"MultiPolygon","coordinates":[[[[ 1.38,41.62],[1.82,41.75],[2.12,41.65],[2.18,41.38],[1.88,41.2],[1.48,41.18],[1.28,41.35],[1.38,41.62]]]]}},

  "rias_baixas":{label:"R√≠as Baixas",num:25,country:"Espagne",color:"#88bbcc",type:"blanc",
    appellations:["R√≠as Baixas DO","Val do Saln√©s","Condado do Tea","O Rosal","Soutomaior","Ribeira do Ulla"],
    cepages:"Albari√±o, Treixadura, Loureira, Ca√≠√±o",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-8.85,42.92],[-8.42,42.95],[-8.18,42.78],[-8.22,42.5],[-8.58,42.38],[-8.92,42.45],[-8.92,42.68],[-8.85,42.92]]]]}},

  "rueda":{label:"Rueda",num:26,country:"Espagne",color:"#a0cc55",type:"blanc",
    appellations:["Rueda DO","Rueda Superior Verdejo","Rueda Sauvignon","Rueda Espumoso"],
    cepages:"Verdejo, Viura/Macabeo, Sauvignon Blanc, Palomino",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-5.2,41.62],[-4.82,41.72],[-4.42,41.62],[-4.38,41.35],[-4.72,41.18],[-5.18,41.22],[-5.22,41.45],[-5.2,41.62]]]]}},

  "toro":{label:"Toro / Cigales",num:27,country:"Espagne",color:"#8a3a5a",type:"rouge",
    appellations:["Toro DO","Cigales DO","Zamora","Arribes DO"],
    cepages:"Tinta de Toro/Tempranillo, Garnacha, Malvas√≠a",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-5.95,41.7],[-5.48,41.8],[-5.22,41.68],[-5.22,41.42],[-5.58,41.28],[-5.95,41.38],[-5.98,41.55],[-5.95,41.7]]]]}},

  "galicia":{label:"Galice ‚Äî Ribeira Sacra",num:28,country:"Espagne",color:"#6699bb",type:"blanc",
    appellations:["Ribeiro DO","Ribeira Sacra DO","Valdeorras DO","Monterrei DO"],
    cepages:"Godello, Treixadura, Menc√≠a, Albari√±o",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-7.95,42.82],[-7.42,42.88],[-7.08,42.68],[-7.02,42.38],[-7.38,42.22],[-7.85,42.25],[-8.08,42.42],[-7.95,42.82]]]]}},

  "aragon_navarra":{label:"Aragon / Navarre",num:29,country:"Espagne",color:"#cc6633",type:"rouge",
    appellations:["Campo de Borja DO","Calatayud DO","Cari√±ena DO","Somontano DO","Navarra DO"],
    cepages:"Garnacha, Tempranillo, Cabernet Sauvignon, Syrah, Chardonnay",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-1.8,42.62],[-1.18,42.78],[-0.65,42.68],[-0.48,42.38],[-0.85,42.05],[-1.5,41.98],[-1.92,42.15],[-2.0,42.42],[-1.8,42.62]],[[-0.42,41.92],[0.15,42.0],[0.48,41.85],[0.45,41.6],[0.05,41.42],[-0.42,41.48],[-0.58,41.68],[-0.42,41.92]]]]}},

  "castilla_la_mancha":{label:"La Mancha / Castille",num:30,country:"Espagne",color:"#bb8833",type:"rouge",
    appellations:["La Mancha DO","Valdepe√±as DO","Manchuela DO","Almansa DO","Ucl√©s DO"],
    cepages:"Air√©n, Cencibel/Tempranillo, Garnacha, Bobal",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-3.78,39.88],[-2.98,40.08],[-2.28,39.98],[-1.72,39.62],[-1.62,39.0],[-2.18,38.48],[-3.12,38.32],[-3.92,38.55],[-4.28,39.12],[-4.05,39.58],[-3.78,39.88]]]]}},

  "bierzo":{label:"Bierzo / Le√≥n",num:31,country:"Espagne",color:"#7788aa",type:"rouge",
    appellations:["Bierzo DO","Cigales DO","Arlanza DO"],
    cepages:"Menc√≠a, Tempranillo, Garnacha",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-6.82,42.75],[-6.38,42.88],[-6.05,42.68],[-6.02,42.38],[-6.38,42.22],[-6.82,42.28],[-7.05,42.48],[-6.82,42.75]]]]}},

  "txakoli":{label:"Txakoli ‚Äî Pays Basque",num:32,country:"Espagne",color:"#88ccaa",type:"blanc",
    appellations:["Txakoli de Getaria DO","Txakoli de Bizkaia DO","Txakoli de √Ålava DO"],
    cepages:"Hondarrabi Zuri, Hondarrabi Beltza",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-2.28,43.42],[-1.92,43.52],[-1.72,43.38],[-1.88,43.22],[-2.22,43.22],[-2.32,43.32],[-2.28,43.42]]]]}},

  "emporda":{label:"Empord√† / Costa Brava",num:33,country:"Espagne",color:"#dd9944",type:"rouge",
    appellations:["Empord√† DO","Alt Empord√†","Baix Empord√†","Cava DO"],
    cepages:"Garnacha, Cari√±ena, Cabernet Sauvignon, Syrah, Macabeo",
    geometry:{"type":"MultiPolygon","coordinates":[[[[ 2.78,42.52],[3.22,42.52],[3.32,42.22],[2.98,42.05],[2.62,42.15],[2.62,42.38],[2.78,42.52]]]]}},

  /* ===== PORTUGAL ===== */
  "douro_porto":{label:"Douro / Porto",num:40,country:"Portugal",color:"#8b2252",type:"vdn_rouge",
    appellations:["Porto Vintage","Porto LBV","Porto Tawny","Porto Ruby","Porto Colheita","Douro DOC","Douro Superior"],
    cepages:"Touriga Nacional, Touriga Franca, Tinta Roriz, Tinta Barroca, Tinta C√£o",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-8.22,41.62],[-7.22,41.68],[-6.82,41.55],[-6.48,41.28],[-6.65,40.98],[-7.18,40.88],[-7.92,40.92],[-8.25,41.22],[-8.22,41.62]]]]}},

  "vinho_verde":{label:"Vinho Verde",num:41,country:"Portugal",color:"#55aa55",type:"blanc",
    appellations:["Vinho Verde DO","Alvarinho","Loureiro","Vinho Verde Espumante","Mon√ß√£o e Melga√ßo"],
    cepages:"Alvarinho, Loureiro, Arinto, Trajadura, Azal",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-8.92,42.22],[-8.28,42.22],[-7.85,42.15],[-7.78,41.82],[-8.1,41.62],[-8.62,41.62],[-8.98,41.72],[-8.92,42.22]]]]}},

  "dao_bairrada":{label:"D√£o / Bairrada",num:42,country:"Portugal",color:"#aa6622",type:"rouge",
    appellations:["D√£o DOC","Bairrada DOC","Encruzado","Baga","D√£o Branco"],
    cepages:"Touriga Nacional, Jaen/Menc√≠a, Baga, Encruzado, Bical",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-8.22,40.85],[-7.65,40.88],[-7.32,40.78],[-7.22,40.5],[-7.58,40.28],[-8.08,40.28],[-8.25,40.48],[-8.22,40.85]]]]}},

  "alentejo":{label:"Alentejo",num:43,country:"Portugal",color:"#cc8833",type:"rouge",
    appellations:["Alentejo DOC","Borba","√âvora","Reguengos","Vidigueira","Portalegre","Redondo"],
    cepages:"Aragonez/Tinta Roriz, Trincadeira, Alicante Bouschet, Ant√£o Vaz, Arinto",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-8.38,39.08],[-7.68,39.22],[-7.08,39.15],[-6.88,38.68],[-7.28,38.22],[-7.95,38.12],[-8.42,38.38],[-8.45,38.72],[-8.38,39.08]]]]}},

  "setubal_lisboa":{label:"Set√∫bal / Lisboa",num:44,country:"Portugal",color:"#aa4455",type:"rouge",
    appellations:["Palmela DOC","Set√∫bal DOC","Moscatel de Set√∫bal","Lisboa DOC","Alenquer","Bucelas"],
    cepages:"Castel√£o, Moscatel de Set√∫bal, Fern√£o Pires, Arinto",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-9.42,39.08],[-8.82,39.18],[-8.45,39.08],[-8.38,38.68],[-8.68,38.42],[-9.18,38.38],[-9.52,38.62],[-9.42,39.08]]]]}},

  "madere":{label:"Mad√®re",num:45,country:"Portugal",color:"#884400",type:"vdn_blanc",
    appellations:["Sercial","Verdelho","Bual","Malmsey/Malvasia","Terrantez","Rainwater"],
    cepages:"Sercial, Verdelho, Bual, Malmsey/Malvasia, Terrantez",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-17.32,32.82],[-16.98,32.94],[-16.65,32.88],[-16.58,32.7],[-16.78,32.58],[-17.12,32.55],[-17.35,32.68],[-17.32,32.82]]]]}},

  /* ===== ITALIE ===== */
  "piemonte":{label:"Pi√©mont",num:50,country:"Italie",color:"#c43a5a",type:"rouge",
    appellations:["Barolo DOCG","Barbaresco DOCG","Barbera d'Asti DOCG","Barbera d'Alba DOC","Dolcetto d'Alba DOC","Moscato d'Asti DOCG","Asti Spumante DOCG","Gavi DOCG","Roero DOCG","Nizza DOCG","Langhe DOC"],
    cepages:"Nebbiolo, Barbera, Dolcetto, Moscato Bianco, Cortese, Arneis",
    geometry:{"type":"MultiPolygon","coordinates":[[[[6.62,45.2],[7.65,45.45],[8.52,45.25],[8.65,44.8],[8.2,44.38],[7.38,44.2],[6.68,44.4],[6.48,44.82],[6.62,45.2]]]]}},

  "lombardie":{label:"Lombardie",num:51,country:"Italie",color:"#7755aa",type:"rouge",
    appellations:["Franciacorta DOCG","Lugana DOC","Valtellina Superiore DOCG","Sforzato di Valtellina DOCG","Oltrep√≤ Pavese DOCG"],
    cepages:"Nebbiolo/Chiavennasca, Pinot Noir, Chardonnay, Turbiana",
    geometry:{"type":"MultiPolygon","coordinates":[[[[8.55,46.35],[10.02,46.62],[10.22,46.08],[10.2,45.52],[9.22,45.3],[8.52,45.42],[8.22,45.72],[8.55,46.35]]]]}},

  "trentino_aa":{label:"Trentin-Haut-Adige",num:52,country:"Italie",color:"#6699cc",type:"rouge",
    appellations:["Trentino DOC","Alto Adige DOC","Santa Maddalena DOC","Lagrein DOC","Teroldego Rotaliano DOC","Trento DOC","Caldaro DOC"],
    cepages:"Teroldego, Lagrein, Schiava/Vernatsch, Pinot Noir, Gew√ºrztraminer, M√ºller-Thurgau",
    geometry:{"type":"MultiPolygon","coordinates":[[[[10.5,46.85],[11.65,47.12],[12.28,46.82],[12.25,46.4],[11.42,46.12],[10.55,46.35],[10.5,46.85]]]]}},

  "frioul":{label:"Frioul-V√©n√©tie Julienne",num:53,country:"Italie",color:"#4488bb",type:"blanc",
    appellations:["Collio DOC","Colli Orientali del Friuli DOCG","Friuli Isonzo DOC","Friuli Grave DOC","Ramandolo DOCG","Picolit DOCG"],
    cepages:"Pinot Grigio, Friulano/Tocai, Ribolla Gialla, Sauvignon Blanc, Refosco",
    geometry:{"type":"MultiPolygon","coordinates":[[[[12.3,46.52],[13.75,46.62],[13.95,45.95],[13.2,45.65],[12.45,45.7],[12.3,46.08],[12.3,46.52]]]]}},

  "veneto":{label:"V√©n√©tie",num:54,country:"Italie",color:"#5577cc",type:"rouge",
    appellations:["Amarone della Valpolicella DOCG","Valpolicella DOC","Valpolicella Ripasso DOC","Soave DOCG","Soave Classico DOC","Bardolino DOC","Prosecco Conegliano Valdobbiadene DOCG","Recioto della Valpolicella DOCG"],
    cepages:"Corvina, Molinara, Rondinella, Garganega, Glera, Pinot Grigio",
    geometry:{"type":"MultiPolygon","coordinates":[[[[10.25,46.05],[11.48,46.08],[12.3,45.92],[12.48,45.52],[12.32,45.12],[11.28,44.92],[10.38,45.12],[10.25,45.55],[10.25,46.05]]]]}},

  "toscane":{label:"Toscane",num:55,country:"Italie",color:"#8b3a2a",type:"rouge",
    appellations:["Chianti DOCG","Chianti Classico DOCG","Brunello di Montalcino DOCG","Vino Nobile di Montepulciano DOCG","Bolgheri DOC","Bolgheri Sassicaia DOC","Morellino di Scansano DOCG","Vernaccia di San Gimignano DOCG","Vin Santo del Chianti DOC","Rosso di Montalcino DOC"],
    cepages:"Sangiovese, Canaiolo, Colorino, Cabernet Sauvignon, Merlot, Trebbiano",
    geometry:{"type":"MultiPolygon","coordinates":[[[[9.78,44.5],[10.45,44.65],[11.28,44.45],[11.6,44.05],[11.72,43.38],[11.42,42.78],[10.68,42.6],[9.85,42.72],[9.42,43.2],[9.38,43.88],[9.78,44.5]]]]}},

  "marches_ombrie":{label:"Marches / Ombrie",num:56,country:"Italie",color:"#6688aa",type:"rouge",
    appellations:["Rosso Conero DOCG","Verdicchio dei Castelli di Jesi DOC","Verdicchio di Matelica DOC","Sagrantino di Montefalco DOCG","Orvieto DOC","Torgiano DOCG"],
    cepages:"Montepulciano, Verdicchio, Sagrantino, Sangiovese, Trebbiano Spoletino",
    geometry:{"type":"MultiPolygon","coordinates":[[[[11.72,43.75],[13.85,44.28],[14.42,43.45],[14.0,42.7],[12.88,42.4],[11.72,42.58],[11.58,43.2],[11.72,43.75]]]]}},

  "campanie":{label:"Campanie",num:57,country:"Italie",color:"#cc5533",type:"rouge",
    appellations:["Taurasi DOCG","Greco di Tufo DOCG","Fiano di Avellino DOCG","Lacryma Christi del Vesuvio DOC","Falerno del Massico DOC","Campi Flegrei DOC"],
    cepages:"Aglianico, Greco di Tufo, Fiano, Falanghina, Piedirosso",
    geometry:{"type":"MultiPolygon","coordinates":[[[[13.92,41.6],[15.18,41.72],[15.18,41.22],[14.95,40.62],[13.8,40.42],[13.3,40.8],[13.42,41.3],[13.92,41.6]]]]}},

  "pouilles":{label:"Pouilles (Puglia)",num:58,country:"Italie",color:"#dd4422",type:"rouge",
    appellations:["Primitivo di Manduria DOC","Primitivo di Manduria Dolce Naturale DOCG","Salice Salentino DOC","Castel del Monte DOCG","Locorotondo DOC"],
    cepages:"Primitivo/Zinfandel, Negroamaro, Malvasia Nera, Bombino Nero, Verdeca",
    geometry:{"type":"MultiPolygon","coordinates":[[[[15.2,41.68],[16.62,41.82],[17.68,41.32],[18.32,40.45],[17.95,39.6],[16.92,39.3],[15.48,39.95],[15.2,40.68],[15.2,41.68]]]]}},

  "sicile":{label:"Sicile",num:59,country:"Italie",color:"#dd7722",type:"rouge",
    appellations:["Nero d'Avola DOC","Etna DOC","Marsala DOC","Passito di Pantelleria DOC","Cerasuolo di Vittoria DOCG","Menfi DOC","Alcamo DOC"],
    cepages:"Nero d'Avola, Nerello Mascalese, Nerello Cappuccio, Catarratto, Grillo, Inzolia",
    geometry:{"type":"MultiPolygon","coordinates":[[[[12.32,37.88],[13.5,38.3],[14.65,38.15],[15.82,37.95],[15.5,37.28],[13.9,36.8],[12.45,36.72],[11.9,37.18],[12.32,37.88]]]]}},

  "sardaigne":{label:"Sardaigne",num:60,country:"Italie",color:"#bb6644",type:"rouge",
    appellations:["Cannonau di Sardegna DOC","Vermentino di Sardegna DOC","Vermentino di Gallura DOCG","Carignano del Sulcis DOC","Monica di Sardegna DOC"],
    cepages:"Cannonau/Grenache, Vermentino, Carignano/Carignan, Monica, Malvasia",
    geometry:{"type":"MultiPolygon","coordinates":[[[[8.18,41.05],[8.68,41.35],[9.5,41.15],[9.88,40.65],[9.68,39.88],[9.0,39.2],[8.4,38.9],[7.88,39.28],[7.82,40.05],[8.18,41.05]]]]}},

  "abruzzo_molise":{label:"Abruzzes / Molise",num:61,country:"Italie",color:"#cc6644",type:"rouge",
    appellations:["Montepulciano d'Abruzzo DOC","Trebbiano d'Abruzzo DOC","Cerasuolo d'Abruzzo DOC","Pecorino DOC","Biferno DOC"],
    cepages:"Montepulciano, Trebbiano d'Abruzzo, Pecorino, Passerina",
    geometry:{"type":"MultiPolygon","coordinates":[[[[13.48,42.88],[14.88,42.98],[15.18,42.05],[14.75,41.42],[13.88,41.38],[13.22,41.72],[13.38,42.38],[13.48,42.88]]]]}},

  "lazio":{label:"Latium / Calabre",num:62,country:"Italie",color:"#aa5533",type:"blanc",
    appellations:["Frascati DOC","Castelli Romani DOC","Est! Est!! Est!!! di Montefiascone DOC","Cir√≤ DOC","Greco di Bianco DOC"],
    cepages:"Malvasia, Trebbiano, Gaglioppo, Greco Bianco",
    geometry:{"type":"MultiPolygon","coordinates":[[[[11.88,42.65],[14.05,42.72],[14.18,41.42],[13.75,40.85],[12.58,40.78],[11.72,41.28],[11.88,42.65]]],[[[15.78,40.35],[16.68,40.45],[16.82,39.35],[16.12,38.42],[15.62,38.18],[15.48,38.72],[15.78,40.35]]]]}},

  /* ===== ALLEMAGNE ===== */
  "mosel":{label:"Moselle (Mosel)",num:70,country:"Allemagne",color:"#44bb88",type:"blanc",
    appellations:["Bernkasteler Doctor","Wehlener Sonnenuhr","Piesporter Goldtr√∂pfchen","Saar-Ruwer","Moseltor","Ober-Mosel"],
    cepages:"Riesling, M√ºller-Thurgau, Elbling, Auxerrois",
    geometry:{"type":"MultiPolygon","coordinates":[[[[6.1,50.48],[6.58,50.58],[6.95,50.48],[7.02,50.2],[6.78,49.92],[6.4,49.82],[6.05,49.95],[6.1,50.48]]]]}},

  "saar":{label:"Sarre / Mittelrhein",num:71,country:"Allemagne",color:"#44cc88",type:"blanc",
    appellations:["Ockfener Bockstein","Scharzhofberger","Wiltinger Braune Kupp","Bacharacher Hahn"],
    cepages:"Riesling",
    geometry:{"type":"MultiPolygon","coordinates":[[[[6.55,49.72],[6.85,49.78],[6.98,49.62],[6.85,49.42],[6.55,49.38],[6.38,49.52],[6.55,49.72]]],[[[7.52,50.35],[7.75,50.45],[7.88,50.32],[7.72,50.15],[7.48,50.12],[7.38,50.25],[7.52,50.35]]]]}},

  "rheingau":{label:"Rheingau",num:72,country:"Allemagne",color:"#88cc88",type:"blanc",
    appellations:["R√ºdesheimer Berg Schlossberg","Hochheimer Domdechaney","Johannisberger Klaus","Schloss Vollrads","Erbacher Marcobrunn"],
    cepages:"Riesling, Sp√§tburgunder/Pinot Noir",
    geometry:{"type":"MultiPolygon","coordinates":[[[[7.85,50.22],[8.32,50.25],[8.52,50.12],[8.42,50.02],[7.98,50.0],[7.78,50.08],[7.85,50.22]]]]}},

  "rheinhessen":{label:"Rheinhessen",num:73,country:"Allemagne",color:"#77bb55",type:"blanc",
    appellations:["Niersteiner Pettenthal","Oppenheimer Herrenberg","Wormser Liebfrauenstift","Dalsheimer Hubacker"],
    cepages:"Riesling, M√ºller-Thurgau, Dornfelder, Silvaner, Grauburgunder",
    geometry:{"type":"MultiPolygon","coordinates":[[[[7.82,49.98],[8.5,50.0],[8.62,49.72],[8.5,49.42],[8.05,49.42],[7.82,49.58],[7.82,49.8],[7.82,49.98]]]]}},

  "pfalz":{label:"Palatinat (Pfalz)",num:74,country:"Allemagne",color:"#55aa66",type:"blanc",
    appellations:["Deidesheimer Hohenmorgen","Forster Jesuitengarten","Wachenheimer Ger√ºmpel","Bad D√ºrkheimer Spielberg"],
    cepages:"Riesling, M√ºller-Thurgau, Dornfelder, Weissburgunder, Portugieser",
    geometry:{"type":"MultiPolygon","coordinates":[[[[7.68,49.4],[8.28,49.4],[8.42,49.22],[8.22,48.98],[7.8,48.92],[7.52,49.08],[7.58,49.28],[7.68,49.4]]]]}},

  "nahe":{label:"Nahe",num:75,country:"Allemagne",color:"#66bb66",type:"blanc",
    appellations:["Bad Kreuznacher Br√ºckes","Schlossb√∂ckelheimer Felsenberg","Roxheimer H√∂llenpfad"],
    cepages:"Riesling, M√ºller-Thurgau, Silvaner, Grauburgunder",
    geometry:{"type":"MultiPolygon","coordinates":[[[[7.4,49.95],[7.78,50.02],[7.8,49.85],[7.8,49.62],[7.58,49.52],[7.38,49.65],[7.38,49.82],[7.4,49.95]]]]}},

  "bade":{label:"Bade (Baden)",num:76,country:"Allemagne",color:"#33aa55",type:"rouge",
    appellations:["Kaiserst√ºhler Batzenberg","Markgr√§flerland","Ortenau Sp√§tburgunder","Breisgau","Tuniberg"],
    cepages:"Sp√§tburgunder/Pinot Noir, Grauburgunder, M√ºller-Thurgau, Gutedel/Chasselas",
    geometry:{"type":"MultiPolygon","coordinates":[[[[7.7,48.58],[8.1,48.65],[8.3,48.45],[8.38,48.1],[8.12,47.78],[7.8,47.72],[7.68,47.88],[7.68,48.22],[7.7,48.58]]]]}},

  "franconie":{label:"Franconie (Franken)",num:77,country:"Allemagne",color:"#88aa44",type:"blanc",
    appellations:["W√ºrzburger Stein","Iphofer Julius-Echter-Berg","Escherndorfer Lump","Volkacher Karth√§user"],
    cepages:"Silvaner, M√ºller-Thurgau, Bacchus, Riesling, Sp√§tburgunder",
    geometry:{"type":"MultiPolygon","coordinates":[[[[9.68,49.98],[10.32,50.15],[10.88,50.05],[11.05,49.75],[10.78,49.45],[10.15,49.35],[9.72,49.52],[9.68,49.98]]]]}},

  "wurtemberg":{label:"Wurtemberg",num:78,country:"Allemagne",color:"#99aa55",type:"rouge",
    appellations:["W√ºrttemberger Trollinger","Lemberger DOC","W√ºrttemberger Riesling","Stettener Brotwasser"],
    cepages:"Trollinger, Lemberger/Blaufr√§nkisch, Riesling, Schwarzriesling",
    geometry:{"type":"MultiPolygon","coordinates":[[[[8.95,49.55],[9.88,49.72],[10.18,49.45],[9.98,48.92],[9.42,48.75],[8.88,48.92],[8.78,49.25],[8.95,49.55]]]]}},

  /* ===== AUTRICHE ===== */
  "wachau":{label:"Wachau",num:80,country:"Autriche",color:"#88bbdd",type:"blanc",
    appellations:["Gr√ºner Veltliner Smaragd","Gr√ºner Veltliner Federspiel","Riesling Smaragd","Steinfeder","Loibener Riesling"],
    cepages:"Gr√ºner Veltliner, Riesling",
    geometry:{"type":"MultiPolygon","coordinates":[[[[14.98,48.45],[15.4,48.52],[15.45,48.4],[15.38,48.22],[15.18,48.18],[14.98,48.28],[14.98,48.45]]]]}},

  "kamptal_kremstal":{label:"Kamptal / Kremstal",num:81,country:"Autriche",color:"#66aacc",type:"blanc",
    appellations:["Kamptal DAC","Kremstal DAC","Langenlois","Krems-Stein","Z√∂bing","Gaisberg"],
    cepages:"Gr√ºner Veltliner, Riesling, Pinot Blanc",
    geometry:{"type":"MultiPolygon","coordinates":[[[[15.48,48.62],[16.1,48.7],[16.32,48.55],[16.15,48.32],[15.68,48.28],[15.48,48.42],[15.48,48.62]]]]}},

  "burgenland":{label:"Burgenland",num:82,country:"Autriche",color:"#cc8844",type:"rouge",
    appellations:["Blaufr√§nkisch DAC","Neusiedlersee DAC","Ruster Ausbruch DAC","Eisenwein","Leithaberg DAC"],
    cepages:"Blaufr√§nkisch, Zweigelt, Welschriesling, Chardonnay, Furmint",
    geometry:{"type":"MultiPolygon","coordinates":[[[[16.5,48.18],[16.95,48.12],[17.22,47.78],[17.05,47.42],[16.58,47.2],[16.05,47.35],[15.88,47.62],[16.25,48.02],[16.5,48.18]]]]}},

  "styrie":{label:"Styrie (Steiermark)",num:83,country:"Autriche",color:"#55aa44",type:"blanc",
    appellations:["S√ºdsteiermark DAC","Weststeiermark Schilcher DAC","Vulkanland Steiermark DAC"],
    cepages:"Sauvignon Blanc, Welschriesling, Weissburgunder, Schilcher/Blauer Wildbacher",
    geometry:{"type":"MultiPolygon","coordinates":[[[[14.58,47.48],[15.42,47.62],[16.02,47.35],[15.95,46.9],[15.25,46.68],[14.45,46.82],[14.18,47.18],[14.58,47.48]]]]}},

  "wien_donauland":{label:"Vienne / Donauland",num:84,country:"Autriche",color:"#aabbcc",type:"blanc",
    appellations:["Wiener Gemischter Satz DAC","Wagram DAC","Traisental DAC","Carnuntum DAC"],
    cepages:"Gr√ºner Veltliner, Riesling, Gemischter Satz, Roter Veltliner",
    geometry:{"type":"MultiPolygon","coordinates":[[[[15.55,48.35],[16.55,48.35],[16.6,48.12],[16.1,47.95],[15.72,48.05],[15.55,48.2],[15.55,48.35]]]]}},

  /* ===== GR√àCE ===== */
  "santorini":{label:"Santorin / Cyclades",num:90,country:"Gr√®ce",color:"#4499cc",type:"blanc",
    appellations:["Santorini PDO","Nykteri PDO","Vinsanto PDO","Muscat de Samos PDO","Rhodes PDO"],
    cepages:"Assyrtiko, Aidani, Athiri, Muscat Blanc √† Petits Grains",
    geometry:{"type":"MultiPolygon","coordinates":[[[[25.32,36.42],[25.58,36.54],[25.72,36.42],[25.55,36.28],[25.32,36.32],[25.32,36.42]]],[[[26.6,37.82],[26.9,37.94],[27.1,37.8],[26.9,37.64],[26.6,37.7],[26.6,37.82]]]]}},

  "nemee":{label:"N√©m√©e / P√©loponn√®se",num:91,country:"Gr√®ce",color:"#bb4455",type:"rouge",
    appellations:["Nemea PDO","Mantinia PDO","Patras PDO","Muscat de Patras PDO"],
    cepages:"Agiorgitiko, Moschofilero, Roditis, Mavrodaphne",
    geometry:{"type":"MultiPolygon","coordinates":[[[[21.98,37.88],[22.45,38.02],[22.9,37.9],[23.05,37.58],[22.72,37.28],[22.2,37.22],[21.88,37.42],[21.98,37.88]]]]}},

  "naoussa_mak":{label:"Mac√©doine ‚Äî Naoussa",num:92,country:"Gr√®ce",color:"#8844aa",type:"rouge",
    appellations:["Naoussa PDO","Amyntaion PDO","Goumenissa PDO","Drama","Kavala"],
    cepages:"Xinomavro, Negoska",
    geometry:{"type":"MultiPolygon","coordinates":[[[[21.35,40.88],[21.95,41.02],[22.38,40.88],[22.42,40.58],[22.05,40.3],[21.45,40.32],[21.18,40.55],[21.35,40.88]]]]}},

  "crete":{label:"Cr√®te",num:93,country:"Gr√®ce",color:"#cc6644",type:"rouge",
    appellations:["Archanes PDO","Dafnes PDO","Peza PDO","Sitia PDO"],
    cepages:"Kotsifali, Mandilari, Vilana, Thrapsathiri",
    geometry:{"type":"MultiPolygon","coordinates":[[[[23.52,35.52],[24.5,35.65],[25.55,35.6],[26.28,35.28],[25.82,34.92],[24.85,34.82],[23.98,34.95],[23.52,35.22],[23.52,35.52]]]]}},

  /* ===== HONGRIE ===== */
  "tokaj":{label:"Tokaj",num:100,country:"Hongrie",color:"#e8c850",type:"blanc",
    appellations:["Tokaji Asz√∫","Tokaji Szamorodni","Tokaji Furmint","Tokaji Essencia","Tokaji H√°rslevel≈±"],
    cepages:"Furmint, H√°rslevel≈±, S√°rga Muskot√°ly/Muscat",
    geometry:{"type":"MultiPolygon","coordinates":[[[[21.18,48.42],[21.58,48.55],[21.85,48.38],[21.78,48.1],[21.42,47.98],[21.1,48.1],[21.18,48.42]]]]}},

  "eger":{label:"Eger ‚Äî Egri Bikav√©r",num:101,country:"Hongrie",color:"#aa3344",type:"rouge",
    appellations:["Egri Bikav√©r PDO","Egri Csillag PDO","Egri Le√°nyka","Debr≈ëi H√°rslevel≈±"],
    cepages:"K√©kfrankos/Blaufr√§nkisch, Kadarka, Blauburger, Merlot",
    geometry:{"type":"MultiPolygon","coordinates":[[[[20.0,48.05],[20.45,48.15],[20.68,47.95],[20.62,47.7],[20.22,47.6],[19.9,47.75],[20.0,48.05]]]]}},

  "villany":{label:"Vill√°ny / Szeksz√°rd",num:102,country:"Hongrie",color:"#8b2244",type:"rouge",
    appellations:["Vill√°nyi Franc PDO","Vill√°nyi Merlot","Szeksz√°rdi Bikav√©r PDO","Szeksz√°rdi Kadarka"],
    cepages:"Cabernet Franc, Merlot, K√©kfrankos, Kadarka",
    geometry:{"type":"MultiPolygon","coordinates":[[[[17.88,45.9],[18.38,46.0],[18.62,45.78],[18.45,45.52],[18.05,45.4],[17.78,45.55],[17.88,45.9]]]]}},

  "somlo":{label:"Soml√≥ / Badacsony",num:103,country:"Hongrie",color:"#88aa55",type:"blanc",
    appellations:["Soml√≥i Juhfark PDO","Badacsonyi Sz√ºrkebar√°t PDO","Badacsonyi K√©knyel≈± PDO","Balaton-felvid√©ki Rizling"],
    cepages:"Juhfark, Furmint, Sz√ºrkebar√°t/Pinot Gris, K√©knyel≈±",
    geometry:{"type":"MultiPolygon","coordinates":[[[[17.15,46.98],[17.48,47.1],[17.68,46.95],[17.58,46.75],[17.25,46.68],[17.02,46.8],[17.15,46.98]]]]}},

  /* ===== SUISSE ===== */
  "suisse_valais":{label:"Valais",num:110,country:"Suisse",color:"#ccaa88",type:"rouge",
    appellations:["Fendant","Johannisberg","D√¥le","Cornalin","Humagne Rouge","Heida/Savagnin","Ermitage/Marsanne","Petite Arvine"],
    cepages:"Chasselas/Gutedel, Pinot Noir, Gamay, Cornalin, Syrah, Petite Arvine",
    geometry:{"type":"MultiPolygon","coordinates":[[[[6.98,46.38],[7.88,46.52],[8.48,46.25],[8.25,45.95],[7.18,45.95],[6.78,46.08],[6.98,46.38]]]]}},

  "suisse_vaud":{label:"Vaud / Gen√®ve",num:111,country:"Suisse",color:"#ccbb99",type:"blanc",
    appellations:["Lavaux AOC","Chablais AOC","La C√¥te AOC","Gen√®ve AOC","Mont-sur-Rolle","Aigle","Yvorne","Villeneuve"],
    cepages:"Chasselas/Gutedel, Pinot Noir, Gamay, Garanoir",
    geometry:{"type":"MultiPolygon","coordinates":[[[[6.12,46.45],[6.88,46.58],[7.0,46.42],[6.98,46.18],[6.55,46.05],[6.12,46.22],[6.12,46.45]]]]}},

  /* ===== AUTRES ===== */
  "croatie_dalm":{label:"Croatie ‚Äî Dalmatie",num:120,country:"Croatie",color:"#cc8855",type:"rouge",
    appellations:["Dingaƒç","Postup","Plavac Mali","Pro≈°ek","Grk","Po≈°ip","Zlatarica"],
    cepages:"Plavac Mali, Po≈°ip, Grk, Zlatarica, Mara≈°tina",
    geometry:{"type":"MultiPolygon","coordinates":[[[[14.42,45.28],[15.92,45.35],[16.88,45.12],[17.58,44.75],[17.88,44.28],[16.72,43.32],[15.88,43.05],[14.88,43.18],[14.42,43.72],[14.42,45.28]]]]}},

  "slovenie":{label:"Slov√©nie",num:121,country:"Slov√©nie",color:"#88bb77",type:"blanc",
    appellations:["Gori≈°ka Brda","Kras","Vipavska Dolina","≈†tajerska Slovenija","Prekmurje"],
    cepages:"Rebula/Ribolla Gialla, Malvazija, Pinot Gris, Welschriesling, ≈†ipon/Furmint",
    geometry:{"type":"MultiPolygon","coordinates":[[[[13.38,46.52],[15.18,46.88],[16.52,46.52],[16.55,46.12],[15.62,45.48],[14.12,45.38],[13.62,45.52],[13.38,46.0],[13.38,46.52]]]]}},

  "bulgarie":{label:"Bulgarie",num:130,country:"Bulgarie",color:"#aa6633",type:"rouge",
    appellations:["Melnik DO","Plovdiv","Thrace","Danube","Suhindol"],
    cepages:"Mavrud, Melnik, Rubin, Cabernet Sauvignon, Merlot, Dimyat",
    geometry:{"type":"MultiPolygon","coordinates":[[[[22.38,44.22],[26.62,44.28],[28.62,43.75],[28.62,41.88],[27.28,41.48],[25.28,41.32],[23.28,41.38],[22.32,42.05],[22.38,44.22]]]]}},

  "roumanie":{label:"Roumanie",num:131,country:"Roumanie",color:"#bb8844",type:"rouge",
    appellations:["Dealu Mare","Cotnari","Murfatlar","Reca»ô","DrƒÉgƒÉ»ôani","Odobe»ôti"],
    cepages:"FeteascƒÉ NeagrƒÉ, FeteascƒÉ AlbƒÉ, TƒÉm√¢ioasƒÉ Rom√¢neascƒÉ, Cabernet Sauvignon, Merlot",
    geometry:{"type":"MultiPolygon","coordinates":[[[[22.38,48.22],[29.62,48.22],[30.12,45.48],[29.62,43.72],[27.72,43.62],[25.28,43.78],[23.28,44.22],[22.38,44.98],[22.38,48.22]]]]}},

  "angleterre":{label:"Angleterre ‚Äî South East",num:140,country:"Angleterre",color:"#aabbaa",type:"effervescent",
    appellations:["English Sparkling Wine","Sussex","Kent","Surrey","Hampshire","Ridgeview","Nyetimber"],
    cepages:"Chardonnay, Pinot Noir, Pinot Meunier, Bacchus, Seyval Blanc",
    geometry:{"type":"MultiPolygon","coordinates":[[[[-1.78,51.12],[1.48,51.38],[1.72,51.12],[0.88,50.72],[-0.48,50.72],[-1.28,50.82],[-1.78,51.12]]]]}},

  "luxembourg":{label:"Luxembourg ‚Äî Moselle",num:141,country:"Luxembourg",color:"#ddcc88",type:"blanc",
    appellations:["Moselle Luxembourgeoise AOC","Wormeldange","Remich","Grevenmacher","Stadtbredimus"],
    cepages:"Riesling, Auxerrois, Pinot Gris, Pinot Blanc, Rivaner/M√ºller-Thurgau",
    geometry:{"type":"MultiPolygon","coordinates":[[[[6.12,49.62],[6.52,49.78],[6.52,49.42],[6.22,49.38],[6.05,49.48],[6.12,49.62]]]]}},
};

// =====================================================================
// LEAFLET MAP ENGINE
// =====================================================================

let leafletMap = null;
let leafletMarkers = {}; // key -> marker
let leafletMarkerCluster = null;
let carteSelectedRegion = null;

const TYPE_COLORS_CARTE = {
  rouge: '#e06878',
  blanc: '#e8c870',
  ros√©: '#e8a0b0',
  effervescent: '#90c8f0',
  vdn_blanc: '#f5d97a',
  vdn_rouge: '#d08060',
  liquoreux: '#f0a850',
};

function getRegionKey(w) {
  const r = (w.region || '').toLowerCase().trim();
  const a = (w.appellation || '').toLowerCase().trim();
  for(const [key, region] of Object.entries(WINE_REGION_POLYGONS)) {
    const label = (region.label || '').toLowerCase();
    const apps  = (region.appellations || []).map(x => x.toLowerCase());
    if(r && (label.includes(r) || r.includes(label.split('‚Äî')[0].trim()))) return key;
    if(a && apps.some(ap => ap.includes(a) || a.includes(ap.replace(' doc','').replace(' aoc','').replace(' aop','').replace(' docg','').trim()))) return key;
  }
  return null;
}

function renderCarte() {
  const container = document.getElementById('carte-leaflet');
  if(!container) return;
  // Lazy-load les librairies cartographiques si pas encore charg√©es
  if(!_mapLibsLoaded) {
    container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text2);font-family:\'Cormorant Garamond\',serif;flex-direction:column;gap:14px"><div class="sync-spinner"></div><div style="font-size:0.85rem;letter-spacing:1px">Chargement de la carte‚Ä¶</div></div>';
    loadMapLibs().then(() => renderCarte()).catch(() => { container.innerHTML = '<div style="color:var(--wine3);padding:20px">Erreur de chargement de la carte ‚Äî v√©rifiez votre connexion</div>'; });
    return;
  }

  // Init Leaflet une seule fois
  if(!leafletMap) {
    container.innerHTML = '';
    leafletMap = L.map('carte-leaflet', {
      center: [46.0, 10.0],
      zoom: 5,
      zoomControl: false,           // on le recr√©e en bas √† droite
      attributionControl: true
    });

    // Zoom en bas √† droite
    L.control.zoom({ position: 'topright' }).addTo(leafletMap);

    // Fond carte √©pur√© style "poster" ‚Äî CartoDB Voyager (libre, sans cl√©)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      maxZoom: 19,
      subdomains: 'abcd',
      attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors ¬© <a href="https://carto.com/">CARTO</a>'
    }).addTo(leafletMap);

    // ‚îÄ‚îÄ Fronti√®res terrestres entre pays viticoles (lignes inter-pays uniquement) ‚îÄ‚îÄ
    fetch('https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_0_boundary_lines_land.geojson')
      .then(r => r.ok ? r.json() : null)
      .catch(() => null)
      .then(data => {
        if(!data || !leafletMap) return;
        const WINE_COUNTRIES = new Set(['France','Spain','Italy','Germany','Portugal','Austria','Greece',
          'Hungary','Switzerland','Croatia','Slovenia','Bulgaria','Romania','Czech Republic',
          'Slovakia','Luxembourg','Georgia','Armenia','Moldova','Serbia','Montenegro',
          'Bosnia and Herzegovina','Albania','North Macedonia']);
        L.geoJSON(data, {
          // Garder uniquement les segments dont les deux c√¥t√©s sont des pays viticoles
          filter: f => {
            const a = f.properties.adm0_left  || f.properties.ADM0_LEFT  || '';
            const b = f.properties.adm0_right || f.properties.ADM0_RIGHT || '';
            return WINE_COUNTRIES.has(a) && WINE_COUNTRIES.has(b);
          },
          style: {
            color: '#7a3a1e',
            weight: 1.5,
            fillOpacity: 0,
            opacity: 0.55,
            dashArray: '4,3'
          }
        }).addTo(leafletMap);
      });

    // ‚îÄ‚îÄ WMTS INAO : tuiles parcellaires officielles ‚îÄ‚îÄ
    leafletMap._inaoVisible = true;
    const inaoTiles = L.tileLayer(
      'https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0' +
      '&LAYER=Aire-Parcellaire&STYLE=normal&TILEMATRIXSET=PM' +
      '&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image%2Fpng',
      { maxZoom: 19, opacity: 0.80, attribution: '¬© IGN/INAO' }
    );
    inaoTiles.addTo(leafletMap);
    leafletMap._inaoLayer = inaoTiles;

    // ‚îÄ‚îÄ Couche appellations embarqu√©e (affich√©e au clic r√©gion) ‚îÄ‚îÄ
    leafletMap._appelLayer = null;  // L.layerGroup courant
    leafletMap._appelRegion = null; // cl√© r√©gion active

    window.updateZoomHint = function updateZoomHint(regionLabel) {
      const hint = document.getElementById('carte-zoom-hint');
      if(!hint) return;
      if(regionLabel) {
        hint.innerHTML = `üèõÔ∏è <b style="color:#e8c870">${regionLabel}</b> ‚Äî appellations affich√©es ¬∑ zoomez pour les parcelles`;
        hint.style.color = 'rgba(220,200,120,0.9)';
      } else {
        hint.innerHTML = 'üåç Cliquez sur une r√©gion pour voir ses appellations';
        hint.style.color = 'rgba(200,200,200,0.65)';
      }
    }
    updateZoomHint(null);

    // Fix taille apr√®s affichage
    setTimeout(() => { if(leafletMap) leafletMap.invalidateSize(); }, 200);
  } else {
    // R√©initialiser les marqueurs existants
    Object.values(leafletMarkers).forEach(m => leafletMap.removeLayer(m));
    leafletMarkers = {};
    setTimeout(() => { if(leafletMap) leafletMap.invalidateSize(); }, 100);
  }

  // Regrouper les vins par r√©gion
  const regionData = {};
  wineData.forEach(w => {
    const key = getRegionKey(w);
    if(!key) return;
    if(!regionData[key]) regionData[key] = [];
    regionData[key].push(w);
  });

  // Cr√©er un marqueur par r√©gion
  // Positions personnalis√©es pour certaines r√©gions
  const MARKER_OVERRIDE = {
    'bourgogne':      { lat: 47.150, lng: 4.720 }, // √† gauche de la C√¥te de Nuits
    'beaujolais':     { lat: 46.100, lng: 4.580 },
    'cotes-du-rhone': { lat: 44.600, lng: 4.780 },
    'provence':       { lat: 43.480, lng: 5.900 },
    'languedoc':      { lat: 43.450, lng: 3.100 },
    'roussillon':     { lat: 42.680, lng: 2.780 },
    'sud_ouest':      { lat: 44.100, lng: 0.600 },
    'loire':          { lat: 47.380, lng: 0.200 },
  };

  Object.entries(WINE_REGION_POLYGONS).forEach(([key, region]) => {
    // Position : override si d√©fini, sinon centro√Øde calcul√©
    let lat, lng;
    if (MARKER_OVERRIDE[key]) {
      lat = MARKER_OVERRIDE[key].lat;
      lng = MARKER_OVERRIDE[key].lng;
    } else {
      try {
        const geom = region.geometry || { type:'Polygon', coordinates:[region.coords] };
        const coords = geom.type === 'MultiPolygon' ? geom.coordinates[0][0] : geom.coordinates[0];
        const sumLng = coords.reduce((s,c) => s+c[0], 0);
        const sumLat = coords.reduce((s,c) => s+c[1], 0);
        lng = sumLng / coords.length;
        lat = sumLat / coords.length;
      } catch(e) { return; }
    }

    const wines = regionData[key] || [];
    const hasWines = wines.length > 0;

    // Couleur dominante
    const typeCount = {};
    wines.forEach(w => { typeCount[w.type] = (typeCount[w.type]||0)+1; });
    const domType = Object.entries(typeCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'rouge';
    const radius = hasWines ? Math.max(10, Math.min(22, 10 + wines.length * 0.8)) : 7;

    const icon = L.divIcon({
      className: '',
      html: `<div style="
        width:${radius*2}px;height:${radius*2}px;
        border-radius:50%;
        background:${hasWines ? 'rgba(110,40,180,0.45)' : 'rgba(110,40,180,0.15)'};
        border:2px solid ${hasWines ? 'rgba(160,80,220,0.80)' : 'rgba(130,60,200,0.35)'};
        box-shadow:0 2px 10px rgba(80,20,140,0.40);
        display:flex;align-items:center;justify-content:center;
        font-size:${radius > 12 ? '11' : '9'}px;
        font-weight:bold;color:rgba(255,255,255,0.95);
        cursor:pointer;
        transition:transform 0.15s ease, background 0.2s ease;
      ">${hasWines ? wines.length : ''}</div>`,
      iconSize: [radius*2, radius*2],
      iconAnchor: [radius, radius],
      popupAnchor: [0, -radius]
    });

    const marker = L.marker([lat, lng], { icon, zIndexOffset: hasWines ? 1000 : 0 });

    // Popup au clic
    marker.on('click', (e) => { L.DomEvent.stopPropagation(e); selectCarteRegion(key, region.label); });

    // Tooltip : c√©pages + appellations phares + vins en cave
    const appellationsPhares = {
      'bourgogne':      'Gevrey-Chambertin ¬∑ Chambolle-Musigny ¬∑ Vosne-Roman√©e ¬∑ Meursault ¬∑ Puligny-Montrachet ¬∑ Chablis ¬∑ Pouilly-Fuiss√©',
      'bordeaux':       'Pauillac ¬∑ Saint-√âmilion ¬∑ Margaux ¬∑ Saint-Julien ¬∑ Pomerol ¬∑ Pessac-L√©ognan ¬∑ Sauternes',
      'champagne':      'Montagne de Reims ¬∑ C√¥te des Blancs ¬∑ Vall√©e de la Marne ¬∑ C√¥te des Bar',
      'cotes-du-rhone': 'C√¥te-R√¥tie ¬∑ Hermitage ¬∑ Ch√¢teauneuf-du-Pape ¬∑ Condrieu ¬∑ Gigondas ¬∑ Tavel',
      'alsace':         'Riesling Grand Cru ¬∑ Gewurztraminer ¬∑ Pinot Gris ¬∑ Muscat ¬∑ Rangen ¬∑ Schlossberg',
      'loire':          'Sancerre ¬∑ Pouilly-Fum√© ¬∑ Chinon ¬∑ Vouvray ¬∑ Muscadet ¬∑ Bonnezeaux ¬∑ Quarts-de-Chaume',
      'languedoc':      'Pic Saint-Loup ¬∑ Faug√®res ¬∑ Saint-Chinian ¬∑ Minervois ¬∑ Corbi√®res ¬∑ La Clape',
      'roussillon':     'Banyuls ¬∑ Maury ¬∑ Collioure ¬∑ C√¥tes du Roussillon Villages ¬∑ Rivesaltes',
      'provence':       'Bandol ¬∑ Cassis ¬∑ C√¥tes de Provence ¬∑ Les Baux-de-Provence ¬∑ Bellet',
      'sud-ouest':      'Cahors ¬∑ Juran√ßon ¬∑ Madiran ¬∑ Bergerac ¬∑ Iroul√©guy ¬∑ Gaillac',
      'beaujolais':     'Moulin-√†-Vent ¬∑ Morgon ¬∑ Fleurie ¬∑ Juli√©nas ¬∑ Brouilly ¬∑ C√¥te de Brouilly',
      'jura':           'Arbois ¬∑ Ch√¢teau-Chalon ¬∑ L\'√âtoile ¬∑ C√¥tes du Jura',
      'savoie':         'Apremont ¬∑ Chignin-Bergeron ¬∑ Roussette de Savoie ¬∑ Seyssel ¬∑ Cr√©py',
      'corse':          'Patrimonio ¬∑ Ajaccio ¬∑ Muscat du Cap Corse ¬∑ Vin de Corse',
    };
    const phares = appellationsPhares[key] || (region.appellations || []).slice(0,6).join(' ¬∑ ');
    const wineInfo = hasWines
      ? `<div style="color:#e8c870;font-weight:600;margin-top:6px;font-size:0.78rem;border-top:1px solid rgba(201,168,76,0.2);padding-top:5px">üç∑ ${wines.length} bouteille${wines.length>1?'s':''} en cave</div>`
      : '';

    marker.bindTooltip(`
      <div style="font-family:'Playfair Display',serif;min-width:200px;max-width:270px">
        <div style="color:#c9a84c;font-size:0.95rem;font-weight:700;margin-bottom:4px;padding-bottom:4px;border-bottom:1px solid rgba(201,168,76,0.25)">${region.label}</div>
        ${region.cepages ? (() => {
          // Utilise les listes globales CEPAGES_BLANCS_LIST / CEPAGES_ROUGES_LIST (d√©finies une seule fois)
          const lst = region.cepages.split(',').map(s=>s.trim());
          const r=[], b=[], a=[];
          lst.forEach(c=>{const k=c.toLowerCase().trim();if(CEPAGES_ROUGES_LIST.some(x=>k===x||k.startsWith(x)||k.includes(x)))r.push(c);else if(CEPAGES_BLANCS_LIST.some(x=>k===x||k.startsWith(x)||k.includes(x)))b.push(c);else a.push(c);});
          let h='<div style="font-size:0.72rem;margin-bottom:6px">';
          if(r.length)h+=`<span style="color:#c87080">üç∑ ${r.join(', ')}</span>`;
          if(r.length&&b.length)h+=' <span style="color:#555">¬∑</span> ';
          if(b.length)h+=`<span style="color:#b8a050">ü•Ç ${b.join(', ')}</span>`;
          if(a.length)h+=`<span style="color:#908070"> ¬∑ ${a.join(', ')}</span>`;
          return h+'</div>';
        })() : ''}
        ${phares ? `<div style="color:#d4c4b0;font-size:0.70rem;line-height:1.65">${phares.split(' ¬∑ ').map(a=>`<span style="display:inline-block;background:rgba(180,140,80,0.15);border-radius:2px;padding:0 3px;margin:1px 2px 1px 0">${a}</span>`).join('')}</div>` : ''}
        ${wineInfo}
      </div>
    `, {
      direction: 'top',
      className: 'leaflet-wine-tooltip',
      offset: [0, -radius - 4]
    });

    marker.addTo(leafletMap);
    leafletMarkers[key] = marker;
  });

  renderCarteLegend();
  // Clic sur le fond de la carte (hors marqueur) ‚Üí effacer les appellations
  leafletMap.on('click', function(e) {
    // Only clear if the click was not on a marker (markers stop propagation)
    if (leafletMap._appelLayer) {
      leafletMap.removeLayer(leafletMap._appelLayer);
      leafletMap._appelLayer = null;
      leafletMap._appelRegion = null;
    }
    carteSelectedRegion = null;
    document.getElementById('carte-region-title').textContent = 'Cliquez sur un point pour voir les vins';
    document.getElementById('carte-region-list').innerHTML = '';
    updateZoomHint(null);
    refreshCarteMarkers();
  });
  // Les appellations n'apparaissent qu'au clic sur une r√©gion
}

// ‚îÄ‚îÄ Calcule le centro√Øde d'un polygone GeoJSON (coordonn√©es [lng,lat]) ‚îÄ‚îÄ
function geoCentroid(geometry) {
  let coords = [];
  if (geometry.type === 'Polygon') {
    coords = geometry.coordinates[0];
  } else if (geometry.type === 'MultiPolygon') {
    let best = [];
    geometry.coordinates.forEach(poly => { if (poly[0].length > best.length) best = poly[0]; });
    coords = best;
  }
  if (!coords.length) return null;
  return [coords.reduce((s,c)=>s+c[1],0)/coords.length, coords.reduce((s,c)=>s+c[0],0)/coords.length];
}

// ‚îÄ‚îÄ Ajoute un label+point sur la carte √† partir d'un centro√Øde r√©el ‚îÄ‚îÄ
// ‚îÄ‚îÄ Label+point selon le type : 'zone' | 'aoc' | 'cru' ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// zone = grande aire g√©ographique (nom en majuscules, sans point)
// aoc  = appellation AOC/AOP officielle INAO (point bordeaux)
// cru  = Grand Cru / cru class√©, AOC distincte √† part enti√®re (point violet, italique)
function addAppelLabel(group, lat, lng, nom, type) {
  const S = {
    zone: { dot:false, r:0,   stroke:'',        fill:'',        txtColor:'#4a8c5c', bg:'rgba(0,0,0,0.0)',    size:'0.60rem', weight:'800', italic:false, upper:true  },
    aoc:  { dot:true,  r:5,   stroke:'#6b1020', fill:'#9b2030', txtColor:'#3a7a4e', bg:'rgba(0,0,0,0.0)',    size:'0.65rem', weight:'700', italic:false, upper:false },
    cru:  { dot:true,  r:3.5, stroke:'#3a0868', fill:'#6a18b0', txtColor:'#5a9a6e', bg:'rgba(0,0,0,0.0)',    size:'0.60rem', weight:'600', italic:true,  upper:false },
  }[type] || { dot:true, r:4, stroke:'#6b1020', fill:'#9b2030', txtColor:'#3a7a4e', bg:'rgba(0,0,0,0.0)', size:'0.62rem', weight:'600', italic:false, upper:false };

  if (S.dot) {
    const dot = L.circleMarker([lat, lng], {
      radius: S.r, color: S.stroke, fillColor: S.fill,
      fillOpacity: 0.88, weight: 1.5, opacity: 1
    });
    const badge = type === 'cru' ? ' <span style="color:#9b60d0;font-size:0.62rem">‚òÖ Cru</span>'
                : type === 'aoc' ? ' <span style="color:#c08050;font-size:0.62rem">AOC</span>' : '';
    dot.bindTooltip(
      `<span style="font-family:'Playfair Display',serif;font-size:0.85rem;color:#c9a84c;font-weight:700">${nom}</span>${badge}`,
      { direction:'top', className:'leaflet-wine-tooltip' }
    );
    group.addLayer(dot);
  }

  const lbl = L.marker([lat, lng], {
    icon: L.divIcon({
      className: 'appel-label-icon',
      html: `<div style="
        font-family:'Playfair Display',serif;
        font-size:${S.size};font-weight:${S.weight};
        color:${S.txtColor};
        padding:1px 4px;
        white-space:nowrap;pointer-events:none;
        transform:translate(${S.dot ? '7px' : '-50%'},-50%);
        text-shadow:0 1px 3px rgba(255,255,255,0.85),0 0 6px rgba(255,255,255,0.6);
        ${S.upper ? 'text-transform:uppercase;letter-spacing:0.7px;' : ''}
        ${S.italic ? 'font-style:italic;' : ''}
      ">${nom}</div>`,
      iconSize:[0,0], iconAnchor:[0,0]
    }),
    interactive: false,
    zIndexOffset: type === 'zone' ? -300 : type === 'cru' ? -200 : -100
  });
  group.addLayer(lbl);
}

// ‚îÄ‚îÄ Requ√™te WFS IGN INAO ‚Äî centro√Ødes r√©els des appellations ‚îÄ‚îÄ
async function fetchInaoFeatures(bbox) {
  const [minLat,minLng] = bbox[0], [maxLat,maxLng] = bbox[1];
  const url = `https://data.geopf.fr/wfs/ows?SERVICE=WFS&VERSION=2.0.0&REQUEST=GetFeature`
    +`&TYPENAMES=AOC-VITICOLES:aire_parcellaire`
    +`&OUTPUTFORMAT=application/json&SRSNAME=CRS:84&COUNT=500`
    +`&BBOX=${minLng},${minLat},${maxLng},${maxLat},CRS:84`;
  try {
    const resp = await fetch(url);
    if (!resp.ok) return null;
    return await resp.json();
  } catch(e) { return null; }
}

// ‚îÄ‚îÄ Couche permanente : labels sur centro√Ødes embarqu√©s ‚îÄ‚îÄ
function renderAppellationsLayer() {
  if (!leafletMap) return;
  if (leafletMap._allAppelLayer) { leafletMap.removeLayer(leafletMap._allAppelLayer); }
  const group = L.layerGroup();

  Object.values(APPELLATIONS).forEach(apps => {
    apps.forEach(app => {
      if (app.lat == null || app.lng == null) return;
      addAppelLabel(group, app.lat, app.lng, app.nom, app.type || 'aoc');
    });
  });

  group.addTo(leafletMap);
  leafletMap._allAppelLayer = group;
}

function resetToEurope() {
  if(!leafletMap) return;
  leafletMap.setView([46.0, 10.0], 5, {animate: true, duration: 0.6});
}

function toggleInaoLayer() {
  if(!leafletMap) return;
  const btn = document.getElementById('btn-inao-toggle');
  leafletMap._inaoVisible = !leafletMap._inaoVisible;
  const on = leafletMap._inaoVisible;

  // Tuiles WMTS parcellaires
  if(leafletMap._inaoLayer) {
    if(on) leafletMap.addLayer(leafletMap._inaoLayer);
    else   leafletMap.removeLayer(leafletMap._inaoLayer);
  }

  // Couche appellations
  if(leafletMap._appelLayer) {
    if(on) leafletMap.addLayer(leafletMap._appelLayer);
    else   leafletMap.removeLayer(leafletMap._appelLayer);
  }

  if(btn) {
    btn.style.background   = on ? '#1a2e1a'  : 'var(--bg3)';
    btn.style.borderColor  = on ? '#4a8a4a'  : '#3a2830';
    btn.style.color        = on ? '#7aba7a'  : 'var(--text2)';
  }

  // Met √† jour le hint
  const hint = document.getElementById('carte-zoom-hint');
  if(hint) {
    hint.textContent = on
      ? (leafletMap.getZoom() >= 10 ? 'üèõÔ∏è D√©limitations INAO actives' : 'üîç Zoomez (zoom 10+) pour les parcelles AOC')
      : 'Couche AOC d√©sactiv√©e';
  }
}

function carteZoomIn() {
  if(!leafletMap) return;
  leafletMap.zoomIn();
}
function carteZoomOut() {
  if(!leafletMap) return;
  leafletMap.zoomOut();
}
function carteReset() {
  resetToEurope();
  carteSelectedRegion = null;
  // Effacer les appellations affich√©es
  if (leafletMap?._appelLayer) {
    leafletMap.removeLayer(leafletMap._appelLayer);
    leafletMap._appelLayer = null;
  }
  updateZoomHint(null);
  refreshCarteMarkers();
}

const PAYS_ZOOM = {
  'France':    { center:[46.5,  2.3],  zoom:6 },
  'Espagne':   { center:[40.2, -3.5],  zoom:6 },
  'Portugal':  { center:[39.5, -8.1],  zoom:7 },
  'Italie':    { center:[43.0, 12.5],  zoom:6 },
  'Allemagne': { center:[49.5,  9.5],  zoom:6 },
  'Autriche':  { center:[47.5, 15.8],  zoom:7 },
  'Gr√®ce':     { center:[37.8, 22.5],  zoom:7 },
  'Hongrie':   { center:[47.5, 19.5],  zoom:7 },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPELLATIONS ‚Äî centro√Ødes pr√©cis embarqu√©s
// type:'zone'   = grande zone g√©ographique (pas une AOC en soi : C√¥te de Nuits, M√©doc‚Ä¶)
// type:'aoc'    = appellation AOC/AOP officielle reconnue par l'INAO
// type:'cru'    = Grand Cru ou 1er Cru, lui-m√™me AOC distincte (Chambertin, Musigny‚Ä¶)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const APPELLATIONS = {

  // ‚îÄ‚îÄ‚îÄ BOURGOGNE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'bourgogne': [
    // Zones g√©ographiques (pas des AOC seules)
    { nom:'Chablis',                   type:'zone', lat:47.814, lng:3.796 },
    { nom:'C√¥te de Nuits',             type:'zone', lat:47.190, lng:4.970 },
    { nom:'C√¥te de Beaune',            type:'zone', lat:47.000, lng:4.830 },
    { nom:'C√¥te Chalonnaise',          type:'zone', lat:46.750, lng:4.720 },
    { nom:'M√¢connais',                 type:'zone', lat:46.380, lng:4.730 },
    // AOC officielles ‚Äî Chablisien
    { nom:'Petit Chablis',             type:'aoc',  lat:47.830, lng:3.760 },
    { nom:'Chablis AOC',               type:'aoc',  lat:47.814, lng:3.800 },
    { nom:'Chablis 1er Cru',           type:'aoc',  lat:47.812, lng:3.812 },
    { nom:'Chablis Grand Cru',         type:'aoc',  lat:47.820, lng:3.823 },
    { nom:'Irancy',                    type:'aoc',  lat:47.758, lng:3.660 },
    { nom:'Saint-Bris',                type:'aoc',  lat:47.742, lng:3.614 },
    { nom:'Bourgogne C√¥te d\'Auxerre', type:'aoc',  lat:47.798, lng:3.572 },
    // AOC ‚Äî C√¥te de Nuits
    { nom:'Marsannay',                 type:'aoc',  lat:47.280, lng:4.996 },
    { nom:'Fixin',                     type:'aoc',  lat:47.262, lng:4.980 },
    { nom:'Gevrey-Chambertin',         type:'aoc',  lat:47.228, lng:4.971 },
    { nom:'Morey-Saint-Denis',         type:'aoc',  lat:47.188, lng:4.964 },
    { nom:'Chambolle-Musigny',         type:'aoc',  lat:47.168, lng:4.964 },
    { nom:'Vougeot',                   type:'aoc',  lat:47.162, lng:4.963 },
    { nom:'Vosne-Roman√©e',             type:'aoc',  lat:47.149, lng:4.960 },
    { nom:'Nuits-Saint-Georges',       type:'aoc',  lat:47.113, lng:4.953 },
    { nom:'C√¥te de Nuits-Villages',    type:'aoc',  lat:47.090, lng:4.945 },
    // Grands Crus C√¥te de Nuits (AOC √† part enti√®re)
    { nom:'Chambertin',                type:'cru',  lat:47.219, lng:4.970 },
    { nom:'Chambertin-Clos de B√®ze',   type:'cru',  lat:47.222, lng:4.971 },
    { nom:'Musigny',                   type:'cru',  lat:47.163, lng:4.966 },
    { nom:'Bonnes-Mares',              type:'cru',  lat:47.175, lng:4.966 },
    { nom:'Clos de Vougeot',           type:'cru',  lat:47.159, lng:4.965 },
    { nom:'√âch√©zeaux',                 type:'cru',  lat:47.152, lng:4.964 },
    { nom:'Grands √âch√©zeaux',          type:'cru',  lat:47.155, lng:4.965 },
    { nom:'Roman√©e-Conti',             type:'cru',  lat:47.145, lng:4.962 },
    { nom:'La T√¢che',                  type:'cru',  lat:47.143, lng:4.961 },
    { nom:'Richebourg',                type:'cru',  lat:47.147, lng:4.963 },
    // AOC ‚Äî C√¥te de Beaune
    { nom:'Aloxe-Corton',              type:'aoc',  lat:47.064, lng:4.847 },
    { nom:'Pernand-Vergelesses',       type:'aoc',  lat:47.072, lng:4.835 },
    { nom:'Savigny-l√®s-Beaune',        type:'aoc',  lat:47.055, lng:4.823 },
    { nom:'Chorey-l√®s-Beaune',         type:'aoc',  lat:47.042, lng:4.862 },
    { nom:'Beaune',                    type:'aoc',  lat:47.023, lng:4.840 },
    { nom:'Pommard',                   type:'aoc',  lat:46.990, lng:4.797 },
    { nom:'Volnay',                    type:'aoc',  lat:46.975, lng:4.792 },
    { nom:'Month√©lie',                 type:'aoc',  lat:46.968, lng:4.783 },
    { nom:'Auxey-Duresses',            type:'aoc',  lat:46.962, lng:4.771 },
    { nom:'Saint-Romain',              type:'aoc',  lat:46.952, lng:4.754 },
    { nom:'Meursault',                 type:'aoc',  lat:46.974, lng:4.769 },
    { nom:'Puligny-Montrachet',        type:'aoc',  lat:46.951, lng:4.762 },
    { nom:'Chassagne-Montrachet',      type:'aoc',  lat:46.940, lng:4.758 },
    { nom:'Santenay',                  type:'aoc',  lat:46.912, lng:4.720 },
    { nom:'Maranges',                  type:'aoc',  lat:46.896, lng:4.698 },
    { nom:'C√¥te de Beaune-Villages',   type:'aoc',  lat:47.020, lng:4.840 },
    // Grands Crus C√¥te de Beaune
    { nom:'Corton',                    type:'cru',  lat:47.063, lng:4.850 },
    { nom:'Corton-Charlemagne',        type:'cru',  lat:47.066, lng:4.843 },
    { nom:'Montrachet',                type:'cru',  lat:46.947, lng:4.761 },
    { nom:'B√¢tard-Montrachet',         type:'cru',  lat:46.945, lng:4.759 },
    { nom:'Chevalier-Montrachet',      type:'cru',  lat:46.949, lng:4.762 },
    // AOC ‚Äî C√¥te Chalonnaise
    { nom:'Bouzeron',                  type:'aoc',  lat:46.884, lng:4.745 },
    { nom:'Rully',                     type:'aoc',  lat:46.868, lng:4.742 },
    { nom:'Mercurey',                  type:'aoc',  lat:46.839, lng:4.726 },
    { nom:'Givry',                     type:'aoc',  lat:46.783, lng:4.748 },
    { nom:'Montagny',                  type:'aoc',  lat:46.672, lng:4.742 },
    // AOC ‚Äî M√¢connais
    { nom:'M√¢con-Villages',            type:'aoc',  lat:46.348, lng:4.840 },
    { nom:'Vir√©-Cless√©',               type:'aoc',  lat:46.428, lng:4.760 },
    { nom:'Pouilly-Fuiss√©',            type:'aoc',  lat:46.288, lng:4.759 },
    { nom:'Pouilly-Loch√©',             type:'aoc',  lat:46.282, lng:4.773 },
    { nom:'Pouilly-Vinzelles',         type:'aoc',  lat:46.278, lng:4.770 },
    { nom:'Saint-V√©ran',               type:'aoc',  lat:46.264, lng:4.750 },
  ],

  // ‚îÄ‚îÄ‚îÄ BORDEAUX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'bordeaux': [
    // Zones
    { nom:'M√©doc',                     type:'zone', lat:45.350, lng:-0.920 },
    { nom:'Rive droite',               type:'zone', lat:44.940, lng:-0.180 },
    { nom:'Graves & Sauternes',        type:'zone', lat:44.550, lng:-0.390 },
    // AOC ‚Äî M√©doc
    { nom:'M√©doc AOC',                 type:'aoc',  lat:45.520, lng:-1.010 },
    { nom:'Haut-M√©doc',                type:'aoc',  lat:45.120, lng:-0.780 },
    { nom:'Saint-Est√®phe',             type:'aoc',  lat:45.363, lng:-0.765 },
    { nom:'Pauillac',                  type:'aoc',  lat:45.197, lng:-0.746 },
    { nom:'Saint-Julien',              type:'aoc',  lat:45.157, lng:-0.760 },
    { nom:'Listrac-M√©doc',             type:'aoc',  lat:45.073, lng:-0.821 },
    { nom:'Moulis-en-M√©doc',           type:'aoc',  lat:45.053, lng:-0.798 },
    { nom:'Margaux',                   type:'aoc',  lat:45.040, lng:-0.740 },
    // AOC ‚Äî Graves
    { nom:'Pessac-L√©ognan',            type:'aoc',  lat:44.760, lng:-0.586 },
    { nom:'Graves',                    type:'aoc',  lat:44.540, lng:-0.420 },
    { nom:'Graves Sup√©rieures',        type:'aoc',  lat:44.530, lng:-0.350 },
    { nom:'Sauternes',                 type:'aoc',  lat:44.548, lng:-0.340 },
    { nom:'Barsac',                    type:'aoc',  lat:44.574, lng:-0.330 },
    { nom:'C√©rons',                    type:'aoc',  lat:44.620, lng:-0.321 },
    { nom:'Loupiac',                   type:'aoc',  lat:44.625, lng:-0.278 },
    { nom:'Sainte-Croix-du-Mont',      type:'aoc',  lat:44.618, lng:-0.275 },
    // AOC ‚Äî Rive droite
    { nom:'Saint-√âmilion',             type:'aoc',  lat:44.893, lng:-0.150 },
    { nom:'Saint-√âmilion Grand Cru',   type:'aoc',  lat:44.896, lng:-0.153 },
    { nom:'Pomerol',                   type:'aoc',  lat:44.924, lng:-0.188 },
    { nom:'Lalande-de-Pomerol',        type:'aoc',  lat:44.942, lng:-0.188 },
    { nom:'Fronsac',                   type:'aoc',  lat:44.974, lng:-0.249 },
    { nom:'Canon-Fronsac',             type:'aoc',  lat:44.966, lng:-0.256 },
    { nom:'Castillon-C√¥tes de Bordeaux',type:'aoc', lat:44.859, lng:-0.063 },
    { nom:'Francs-C√¥tes de Bordeaux',  type:'aoc',  lat:44.877, lng:-0.021 },
    // AOC ‚Äî Entre-deux-Mers & divers
    { nom:'Entre-deux-Mers',           type:'aoc',  lat:44.710, lng:-0.200 },
    { nom:'Blaye-C√¥tes de Bordeaux',   type:'aoc',  lat:45.127, lng:-0.654 },
    { nom:'Bourg',                     type:'aoc',  lat:45.047, lng:-0.562 },
    { nom:'Sainte-Foy-Bordeaux',       type:'aoc',  lat:44.834, lng: 0.219 },
  ],

  // ‚îÄ‚îÄ‚îÄ CHAMPAGNE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'champagne': [
    // Zones viticoles
    { nom:'Montagne de Reims',         type:'zone', lat:49.175, lng:4.005 },
    { nom:'Vall√©e de la Marne',        type:'zone', lat:49.048, lng:3.700 },
    { nom:'C√¥te des Blancs',           type:'zone', lat:48.905, lng:3.995 },
    { nom:'C√¥te de S√©zanne',           type:'zone', lat:48.660, lng:3.740 },
    { nom:'C√¥te des Bar',              type:'zone', lat:48.140, lng:4.490 },
    // AOC (une seule : Champagne, d√©clin√©e par villages ‚Äî crus class√©s)
    { nom:'Champagne AOC',             type:'aoc',  lat:49.050, lng:3.950 },
    { nom:'Coteaux Champenois',        type:'aoc',  lat:49.100, lng:3.980 },
    { nom:'Ros√© des Riceys',           type:'aoc',  lat:47.999, lng:4.371 },
    // Crus (villages class√©s Grand Cru ‚Äî terroirs reconnus)
    { nom:'Mailly-Champagne',          type:'cru',  lat:49.215, lng:4.068 },
    { nom:'Verzenay',                  type:'cru',  lat:49.187, lng:4.141 },
    { nom:'Verzy',                     type:'cru',  lat:49.166, lng:4.155 },
    { nom:'Bouzy',                     type:'cru',  lat:49.148, lng:4.209 },
    { nom:'Ambonnay',                  type:'cru',  lat:49.143, lng:4.228 },
    { nom:'A√ø-Champagne',              type:'cru',  lat:49.058, lng:3.993 },
    { nom:'Hautvillers',               type:'cru',  lat:49.075, lng:3.938 },
    { nom:'Cramant',                   type:'cru',  lat:48.967, lng:3.993 },
    { nom:'Avize',                     type:'cru',  lat:48.975, lng:4.002 },
    { nom:'Oger',                      type:'cru',  lat:48.953, lng:4.016 },
    { nom:'Le Mesnil-sur-Oger',        type:'cru',  lat:48.933, lng:4.020 },
  ],

  // ‚îÄ‚îÄ‚îÄ VALL√âE DU RH√îNE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // ‚îÄ‚îÄ‚îÄ RH√îNE SEPTENTRIONAL (Nord) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'rhone_nord': [
    { nom:'Rh√¥ne Septentrional',         type:'zone', lat:45.200, lng:4.820 },
    // AOC propres au Nord
    { nom:'C√¥te-R√¥tie',                  type:'aoc',  lat:45.470, lng:4.796 },
    { nom:'Condrieu',                    type:'aoc',  lat:45.382, lng:4.776 },
    { nom:'Ch√¢teau-Grillet',             type:'cru',  lat:45.368, lng:4.769 },
    { nom:'Saint-Joseph',                type:'aoc',  lat:45.100, lng:4.837 },
    { nom:'Crozes-Hermitage',            type:'aoc',  lat:45.090, lng:4.897 },
    { nom:'Hermitage',                   type:'cru',  lat:45.075, lng:4.836 },
    { nom:'Cornas',                      type:'aoc',  lat:44.912, lng:4.840 },
    { nom:'Saint-P√©ray',                 type:'aoc',  lat:44.896, lng:4.846 },
    // AOC p√©riph√©riques Nord (Dr√¥me)
    { nom:'Clairette de Die',            type:'aoc',  lat:44.750, lng:5.370 },
    { nom:'Cr√©mant de Die',              type:'aoc',  lat:44.745, lng:5.368 },
    { nom:'Coteaux de Die',              type:'aoc',  lat:44.752, lng:5.375 },
    { nom:'Ch√¢tillon-en-Diois',          type:'aoc',  lat:44.695, lng:5.480 },
    { nom:'C√¥tes du Vivarais',           type:'aoc',  lat:44.510, lng:4.386 },
  ],

  // ‚îÄ‚îÄ‚îÄ RH√îNE M√âRIDIONAL (Sud) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'rhone_sud': [
    { nom:'Rh√¥ne M√©ridional',            type:'zone', lat:44.100, lng:4.900 },
    // Grands crus du Sud
    { nom:'Ch√¢teauneuf-du-Pape',         type:'cru',  lat:44.057, lng:4.833 },
    { nom:'Gigondas',                    type:'cru',  lat:44.172, lng:5.022 },
    { nom:'Vacqueyras',                  type:'cru',  lat:44.117, lng:5.000 },
    { nom:'Rasteau',                     type:'cru',  lat:44.193, lng:4.958 },
    { nom:'Cairanne',                    type:'cru',  lat:44.226, lng:4.956 },
    { nom:'Vinsobres',                   type:'cru',  lat:44.334, lng:5.025 },
    // AOC du Sud
    { nom:'Beaumes-de-Venise',           type:'aoc',  lat:44.123, lng:5.028 },
    { nom:'Muscat de Beaumes-de-Venise', type:'aoc',  lat:44.118, lng:5.032 },
    { nom:'Tavel',                       type:'aoc',  lat:44.009, lng:4.677 },
    { nom:'Lirac',                       type:'aoc',  lat:44.041, lng:4.693 },
    { nom:'Grignan-les-Adh√©mar',         type:'aoc',  lat:44.420, lng:4.905 },
    { nom:'Ventoux',                     type:'aoc',  lat:44.136, lng:5.160 },
    { nom:'Luberon',                     type:'aoc',  lat:43.830, lng:5.380 },
    { nom:'Costi√®res de N√Æmes',          type:'aoc',  lat:43.722, lng:4.428 },
    { nom:"Duch√© d'Uz√®s",               type:'aoc',  lat:43.998, lng:4.420 },
    // C√¥tes du Rh√¥ne Villages avec d√©nomination g√©ographique
    { nom:'Roaix',                       type:'aoc',  lat:44.225, lng:4.975 },
    { nom:'S√©guret',                     type:'aoc',  lat:44.220, lng:5.005 },
    { nom:'Sablet',                      type:'aoc',  lat:44.198, lng:5.005 },
    { nom:'Chusclan',                    type:'aoc',  lat:44.108, lng:4.605 },
    { nom:'Laudun',                      type:'aoc',  lat:44.093, lng:4.672 },
    { nom:'Saint-Gervais',               type:'aoc',  lat:44.140, lng:4.623 },
    { nom:'Visan',                       type:'aoc',  lat:44.308, lng:5.002 },
    { nom:"Massif d'Uchaux",            type:'aoc',  lat:44.175, lng:4.748 },
    { nom:'Plan de Dieu',                type:'aoc',  lat:44.220, lng:4.938 },
    { nom:'Puym√©ras',                    type:'aoc',  lat:44.306, lng:5.058 },
    { nom:'Rousset-les-Vignes',          type:'aoc',  lat:44.390, lng:5.058 },
    { nom:'Saint-Pantal√©on-les-Vignes',  type:'aoc',  lat:44.395, lng:5.066 },
    { nom:'Valr√©as',                     type:'aoc',  lat:44.384, lng:4.992 },
    // AOC g√©n√©riques
    { nom:'C√¥tes du Rh√¥ne Villages',     type:'aoc',  lat:44.300, lng:4.870 },
    { nom:'C√¥tes du Rh√¥ne',              type:'aoc',  lat:44.100, lng:4.700 },
  ],

  // ‚îÄ‚îÄ‚îÄ ALSACE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'alsace': [
    // AOC principales
    { nom:'Alsace AOC',                type:'aoc',  lat:48.200, lng:7.440 },
    { nom:"Cr√©mant d'Alsace",          type:'aoc',  lat:48.100, lng:7.390 },
    // Grands Crus (51 AOC distinctes ‚Äî chacun est une AOC √† part enti√®re)
    { nom:'Rangen',                    type:'cru',  lat:47.806, lng:7.219 },
    { nom:'Zinnkoepfl√©',               type:'cru',  lat:47.886, lng:7.249 },
    { nom:'Pfingstberg',               type:'cru',  lat:47.856, lng:7.277 },
    { nom:'Goldert',                   type:'cru',  lat:47.922, lng:7.285 },
    { nom:'Hengst',                    type:'cru',  lat:47.947, lng:7.304 },
    { nom:'Kessler',                   type:'cru',  lat:47.887, lng:7.258 },
    { nom:'Kitterl√©',                  type:'cru',  lat:47.885, lng:7.263 },
    { nom:'Saering',                   type:'cru',  lat:47.891, lng:7.261 },
    { nom:'Spiegel',                   type:'cru',  lat:47.899, lng:7.265 },
    { nom:'Brand',                     type:'cru',  lat:47.985, lng:7.293 },
    { nom:'Sommerberg',                type:'cru',  lat:48.090, lng:7.340 },
    { nom:'Schlossberg',               type:'cru',  lat:48.111, lng:7.310 },
    { nom:'Furstentum',                type:'cru',  lat:48.125, lng:7.322 },
    { nom:'Mambourg',                  type:'cru',  lat:48.145, lng:7.349 },
    { nom:'Marckrain',                 type:'cru',  lat:48.143, lng:7.358 },
    { nom:'Altenberg de Bergheim',     type:'cru',  lat:48.200, lng:7.378 },
    { nom:'Praelatenberg',             type:'cru',  lat:48.254, lng:7.394 },
    { nom:'Kastelberg',                type:'cru',  lat:48.373, lng:7.421 },
    { nom:'Wiebelsberg',               type:'cru',  lat:48.377, lng:7.426 },
    { nom:'Moenchberg',                type:'cru',  lat:48.393, lng:7.439 },
    { nom:'Muenchberg',                type:'cru',  lat:48.504, lng:7.492 },
    { nom:'Zotzenberg',                type:'cru',  lat:48.572, lng:7.551 },
    { nom:'Steinklotz',                type:'cru',  lat:48.690, lng:7.574 },
  ],

  // ‚îÄ‚îÄ‚îÄ VALL√âE DE LA LOIRE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'loire': [
    // Zones
    { nom:'Pays Nantais',              type:'zone', lat:47.200, lng:-1.550 },
    { nom:'Anjou-Saumur',              type:'zone', lat:47.320, lng:-0.450 },
    { nom:'Touraine',                  type:'zone', lat:47.350, lng: 0.700 },
    { nom:'Centre-Loire',              type:'zone', lat:47.350, lng: 2.850 },
    // AOC ‚Äî Pays Nantais
    { nom:'Muscadet',                  type:'aoc',  lat:47.171, lng:-1.350 },
    { nom:'Muscadet-S√®vre et Maine',   type:'aoc',  lat:47.153, lng:-1.368 },
    { nom:'Muscadet-Coteaux de la Loire',type:'aoc',lat:47.340, lng:-1.165 },
    { nom:'Muscadet-C√¥tes de Grandlieu',type:'aoc', lat:47.062, lng:-1.696 },
    { nom:'Gros Plant du Pays Nantais',type:'aoc',  lat:47.150, lng:-1.550 },
    { nom:'Fiefs Vend√©ens',            type:'aoc',  lat:46.618, lng:-1.432 },
    // AOC ‚Äî Anjou-Saumur
    { nom:'Anjou',                     type:'aoc',  lat:47.387, lng:-0.497 },
    { nom:'Anjou-Villages',            type:'aoc',  lat:47.386, lng:-0.568 },
    { nom:'Anjou-Villages Brissac',    type:'aoc',  lat:47.350, lng:-0.470 },
    { nom:'Savenni√®res',               type:'aoc',  lat:47.380, lng:-0.707 },
    { nom:'Savenni√®res-Roche aux Moines',type:'cru',lat:47.379, lng:-0.715 },
    { nom:'Savenni√®res-Coul√©e de Serrant',type:'cru',lat:47.381,lng:-0.720 },
    { nom:'Coteaux du Layon',          type:'aoc',  lat:47.265, lng:-0.630 },
    { nom:'Coteaux de l\'Aubance',     type:'aoc',  lat:47.340, lng:-0.520 },
    { nom:'Bonnezeaux',                type:'aoc',  lat:47.249, lng:-0.558 },
    { nom:'Quarts-de-Chaume',          type:'aoc',  lat:47.264, lng:-0.583 },
    { nom:'Saumur',                    type:'aoc',  lat:47.261, lng:-0.074 },
    { nom:'Saumur-Champigny',          type:'aoc',  lat:47.212, lng:-0.049 },
    { nom:'Saumur Mousseux',           type:'aoc',  lat:47.255, lng:-0.082 },
    { nom:'Cr√©mant de Loire',          type:'aoc',  lat:47.300, lng:-0.100 },
    // AOC ‚Äî Touraine
    { nom:'Touraine AOC',              type:'aoc',  lat:47.380, lng: 0.690 },
    { nom:'Chinon',                    type:'aoc',  lat:47.165, lng: 0.240 },
    { nom:'Bourgueil',                 type:'aoc',  lat:47.282, lng: 0.166 },
    { nom:'Saint-Nicolas-de-Bourgueil',type:'aoc',  lat:47.280, lng: 0.122 },
    { nom:'Vouvray',                   type:'aoc',  lat:47.408, lng: 0.803 },
    { nom:'Montlouis-sur-Loire',       type:'aoc',  lat:47.387, lng: 0.860 },
    { nom:'Cheverny',                  type:'aoc',  lat:47.500, lng: 1.455 },
    { nom:'Cour-Cheverny',             type:'aoc',  lat:47.510, lng: 1.460 },
    { nom:'Valen√ßay',                  type:'aoc',  lat:47.161, lng: 1.565 },
    { nom:'Touraine-Amboise',          type:'aoc',  lat:47.413, lng: 1.003 },
    { nom:'Touraine-Azay-le-Rideau',   type:'aoc',  lat:47.258, lng: 0.466 },
    { nom:'Touraine-Mesland',          type:'aoc',  lat:47.502, lng: 1.192 },
    // AOC ‚Äî Centre-Loire
    { nom:'Sancerre',                  type:'aoc',  lat:47.327, lng: 2.839 },
    { nom:'Pouilly-Fum√©',              type:'aoc',  lat:47.300, lng: 2.954 },
    { nom:'Pouilly-sur-Loire',         type:'aoc',  lat:47.291, lng: 2.954 },
    { nom:'Menetou-Salon',             type:'aoc',  lat:47.239, lng: 2.489 },
    { nom:'Quincy',                    type:'aoc',  lat:47.108, lng: 2.041 },
    { nom:'Reuilly',                   type:'aoc',  lat:47.081, lng: 1.979 },
    { nom:'Ch√¢teaumeillant',           type:'aoc',  lat:46.561, lng: 2.196 },
    { nom:'Coteaux du Giennois',       type:'aoc',  lat:47.660, lng: 2.630 },
    { nom:'Orl√©ans',                   type:'aoc',  lat:47.892, lng: 1.908 },
    { nom:'Orl√©ans-Cl√©ry',             type:'aoc',  lat:47.820, lng: 1.767 },
  ],

  // ‚îÄ‚îÄ‚îÄ LANGUEDOC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'languedoc': [
    // Zone g√©n√©rique
    { nom:'Languedoc AOC',             type:'aoc',  lat:43.500, lng: 3.250 },
    // AOC sp√©cifiques
    { nom:'Picpoul de Pinet',          type:'aoc',  lat:43.437, lng: 3.549 },
    { nom:'Faug√®res',                  type:'aoc',  lat:43.520, lng: 3.272 },
    { nom:'Saint-Chinian',             type:'aoc',  lat:43.464, lng: 2.952 },
    { nom:'Minervois',                 type:'aoc',  lat:43.358, lng: 2.720 },
    { nom:'Minervois-La Livini√®re',    type:'aoc',  lat:43.363, lng: 2.685 },
    { nom:'Corbi√®res',                 type:'aoc',  lat:43.019, lng: 2.680 },
    { nom:'Corbi√®res-Boutenac',        type:'aoc',  lat:43.094, lng: 2.758 },
    { nom:'Fitou',                     type:'aoc',  lat:42.895, lng: 2.952 },
    { nom:'Blanquette de Limoux',      type:'aoc',  lat:43.052, lng: 2.165 },
    { nom:'Cr√©mant de Limoux',         type:'aoc',  lat:43.062, lng: 2.165 },
    { nom:'Limoux',                    type:'aoc',  lat:43.052, lng: 2.168 },
    { nom:'Clairette du Languedoc',    type:'aoc',  lat:43.561, lng: 3.385 },
    { nom:'Clairette de Bellegarde',   type:'aoc',  lat:43.762, lng: 4.532 },
    // D√©nominations g√©ographiques du Languedoc AOC
    { nom:'Terrasses du Larzac',       type:'cru',  lat:43.665, lng: 3.345 },
    { nom:'Pic Saint-Loup',            type:'cru',  lat:43.746, lng: 3.759 },
    { nom:'La Clape',                  type:'cru',  lat:43.172, lng: 3.128 },
    { nom:'Gr√®s de Montpellier',       type:'cru',  lat:43.590, lng: 3.780 },
    { nom:'P√©zenas',                   type:'cru',  lat:43.461, lng: 3.427 },
    { nom:'Montpeyroux',               type:'cru',  lat:43.687, lng: 3.456 },
    { nom:'Saint-Saturnin',            type:'cru',  lat:43.693, lng: 3.483 },
    { nom:'Saint-Georges-d\'Orques',   type:'cru',  lat:43.573, lng: 3.778 },
    { nom:'Cabri√®res',                 type:'cru',  lat:43.573, lng: 3.382 },
    { nom:'Quatourze',                 type:'cru',  lat:43.198, lng: 2.942 },
  ],

  // ‚îÄ‚îÄ‚îÄ ROUSSILLON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'roussillon': [
    // AOC
    { nom:'C√¥tes du Roussillon',       type:'aoc',  lat:42.690, lng: 2.780 },
    { nom:'C√¥tes du Roussillon Villages',type:'aoc',lat:42.760, lng: 2.760 },
    { nom:'Maury',                     type:'aoc',  lat:42.810, lng: 2.648 },
    { nom:'Maury Sec',                 type:'aoc',  lat:42.813, lng: 2.650 },
    { nom:'Collioure',                 type:'aoc',  lat:42.524, lng: 3.083 },
    { nom:'Banyuls',                   type:'aoc',  lat:42.489, lng: 3.127 },
    { nom:'Banyuls Grand Cru',         type:'aoc',  lat:42.487, lng: 3.130 },
    { nom:'Rivesaltes',                type:'aoc',  lat:42.771, lng: 2.878 },
    { nom:'Muscat de Rivesaltes',      type:'aoc',  lat:42.775, lng: 2.880 },
    // D√©nominations Villages
    { nom:'Lesquerde',                 type:'cru',  lat:42.780, lng: 2.673 },
    { nom:'Tautavel',                  type:'cru',  lat:42.820, lng: 2.769 },
    { nom:'Caramany',                  type:'cru',  lat:42.751, lng: 2.624 },
    { nom:'Latour-de-France',          type:'cru',  lat:42.758, lng: 2.706 },
  ],

  // ‚îÄ‚îÄ‚îÄ PROVENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'provence': [
    // AOC
    { nom:'C√¥tes de Provence',         type:'aoc',  lat:43.450, lng: 6.150 },
    { nom:'Coteaux d\'Aix-en-Provence',type:'aoc',  lat:43.527, lng: 5.441 },
    { nom:'Coteaux Varois en Provence',type:'aoc',  lat:43.440, lng: 5.990 },
    { nom:'Bandol',                    type:'aoc',  lat:43.130, lng: 5.755 },
    { nom:'Cassis',                    type:'aoc',  lat:43.214, lng: 5.548 },
    { nom:'Bellet',                    type:'aoc',  lat:43.747, lng: 7.189 },
    { nom:'Palette',                   type:'aoc',  lat:43.520, lng: 5.474 },
    { nom:'Pierrevert',                type:'aoc',  lat:43.807, lng: 5.897 },
    { nom:'Les Baux-de-Provence',      type:'aoc',  lat:43.742, lng: 4.797 },
    // D√©nominations C√¥tes de Provence
    { nom:'C√¥tes de Provence Sainte-Victoire',type:'cru',lat:43.530,lng:5.620 },
    { nom:'C√¥tes de Provence Fr√©jus',  type:'cru',  lat:43.437, lng: 6.733 },
    { nom:'C√¥tes de Provence La Londe',type:'cru',  lat:43.143, lng: 6.239 },
    { nom:'C√¥tes de Provence Pierrefeu',type:'cru', lat:43.250, lng: 6.145 },
  ],

  // ‚îÄ‚îÄ‚îÄ SUD-OUEST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'sud-ouest': [
    // ‚îÄ‚îÄ Zone ‚îÄ‚îÄ
    { nom:'Sud-Ouest',                 type:'zone', lat:44.100, lng: 0.600 },
    // ‚îÄ‚îÄ P√©rigord / Bergerac ‚îÄ‚îÄ
    { nom:'Bergerac',                  type:'aoc',  lat:44.855, lng: 0.487 },
    { nom:'C√¥tes de Bergerac',         type:'aoc',  lat:44.830, lng: 0.420 },
    { nom:'P√©charmant',                type:'aoc',  lat:44.876, lng: 0.555 },
    { nom:'Monbazillac',               type:'aoc',  lat:44.773, lng: 0.521 },
    { nom:'Saussignac',                type:'aoc',  lat:44.793, lng: 0.361 },
    { nom:'Rosette',                   type:'aoc',  lat:44.872, lng: 0.471 },
    { nom:'Montravel',                 type:'aoc',  lat:44.841, lng: 0.204 },
    { nom:'Haut-Montravel',            type:'aoc',  lat:44.845, lng: 0.196 },
    { nom:'C√¥tes de Montravel',        type:'aoc',  lat:44.840, lng: 0.200 },
    // ‚îÄ‚îÄ Vall√©e du Lot ‚îÄ‚îÄ
    { nom:'Cahors',                    type:'aoc',  lat:44.449, lng: 1.441 },
    { nom:'Entraygues-Le Fel',         type:'aoc',  lat:44.638, lng: 2.568 },
    { nom:'Estaing',                   type:'aoc',  lat:44.578, lng: 2.679 },
    { nom:'Marcillac',                 type:'aoc',  lat:44.457, lng: 2.448 },
    { nom:'C√¥tes du Marmandais',       type:'aoc',  lat:44.505, lng: 0.160 },
    { nom:'Buzet',                     type:'aoc',  lat:44.262, lng: 0.302 },
    { nom:'C√¥tes de Duras',            type:'aoc',  lat:44.670, lng: 0.178 },
    // ‚îÄ‚îÄ Garonne / Tarn ‚îÄ‚îÄ
    { nom:'Fronton',                   type:'aoc',  lat:43.861, lng: 1.386 },
    { nom:'Gaillac',                   type:'aoc',  lat:43.901, lng: 1.893 },
    { nom:'Gaillac Premi√®res C√¥tes',   type:'aoc',  lat:43.870, lng: 1.850 },
    { nom:'Saint-Sardos',              type:'aoc',  lat:44.001, lng: 0.851 },
    { nom:'Brulhois',                  type:'aoc',  lat:44.065, lng: 0.752 },
    // ‚îÄ‚îÄ Pyr√©n√©es / B√©arn ‚îÄ‚îÄ
    { nom:'Madiran',                   type:'aoc',  lat:43.569, lng:-0.086 },
    { nom:'Pacherenc du Vic-Bilh',     type:'aoc',  lat:43.574, lng:-0.090 },
    { nom:'Saint-Mont',                type:'aoc',  lat:43.630, lng:-0.165 },
    { nom:'Tursan',                    type:'aoc',  lat:43.718, lng:-0.527 },
    { nom:'B√©arn',                     type:'aoc',  lat:43.380, lng:-0.605 },
    { nom:'Juran√ßon',                  type:'aoc',  lat:43.315, lng:-0.292 },
    { nom:'Juran√ßon Sec',              type:'aoc',  lat:43.312, lng:-0.297 },
    // ‚îÄ‚îÄ Pays Basque ‚îÄ‚îÄ
    { nom:'Iroul√©guy',                 type:'aoc',  lat:43.234, lng:-1.281 },
  ],

  // ‚îÄ‚îÄ‚îÄ BEAUJOLAIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'beaujolais': [
    // AOC g√©n√©riques
    { nom:'Beaujolais',                type:'aoc',  lat:46.068, lng: 4.678 },
    { nom:'Beaujolais-Villages',       type:'aoc',  lat:46.148, lng: 4.633 },
    // Crus du Beaujolais (10 AOC distinctes)
    { nom:'Saint-Amour',               type:'cru',  lat:46.306, lng: 4.700 },
    { nom:'Juli√©nas',                  type:'cru',  lat:46.254, lng: 4.698 },
    { nom:'Ch√©nas',                    type:'cru',  lat:46.196, lng: 4.707 },
    { nom:'Moulin-√†-Vent',             type:'cru',  lat:46.155, lng: 4.716 },
    { nom:'Fleurie',                   type:'cru',  lat:46.192, lng: 4.698 },
    { nom:'Chiroubles',                type:'cru',  lat:46.167, lng: 4.669 },
    { nom:'Morgon',                    type:'cru',  lat:46.116, lng: 4.685 },
    { nom:'R√©gni√©',                    type:'cru',  lat:46.131, lng: 4.659 },
    { nom:'C√¥te de Brouilly',          type:'cru',  lat:46.100, lng: 4.654 },
    { nom:'Brouilly',                  type:'cru',  lat:46.088, lng: 4.661 },
  ],

  // ‚îÄ‚îÄ‚îÄ JURA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'jura': [
    // AOC
    { nom:'Arbois',                    type:'aoc',  lat:46.903, lng: 5.775 },
    { nom:'Arbois Pupillin',           type:'aoc',  lat:46.888, lng: 5.785 },
    // AOC √† part enti√®re
    { nom:'Ch√¢teau-Chalon',            type:'aoc',  lat:46.762, lng: 5.629 },
    { nom:"L'√âtoile",                  type:'aoc',  lat:46.724, lng: 5.582 },
  ],

  // ‚îÄ‚îÄ‚îÄ SAVOIE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'savoie': [
    // AOC
    { nom:'Vin de Savoie',             type:'aoc',  lat:45.688, lng: 5.934 },
    { nom:'Roussette de Savoie',       type:'aoc',  lat:45.743, lng: 5.882 },
    { nom:'Seyssel',                   type:'aoc',  lat:45.949, lng: 5.836 },
    { nom:'Cr√©py',                     type:'aoc',  lat:46.310, lng: 6.332 },
    { nom:'Bugey',                     type:'aoc',  lat:45.880, lng: 5.450 },
    { nom:'Roussette du Bugey',        type:'aoc',  lat:45.870, lng: 5.410 },
    { nom:'Cerdon',                    type:'aoc',  lat:46.063, lng: 5.479 },
    // Crus (d√©nominations Vin de Savoie)
    { nom:'Apremont',                  type:'cru',  lat:45.526, lng: 5.988 },
    { nom:'Abymes',                    type:'cru',  lat:45.512, lng: 6.002 },
    { nom:'Chignin',                   type:'cru',  lat:45.544, lng: 5.980 },
    { nom:'Chignin-Bergeron',          type:'cru',  lat:45.540, lng: 5.982 },
    { nom:'Ripaille',                  type:'cru',  lat:46.363, lng: 6.418 },
    { nom:'Marignan',                  type:'cru',  lat:46.355, lng: 6.390 },
  ],

  // ‚îÄ‚îÄ‚îÄ CORSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  'corse': [
    // AOC
    { nom:'Vin de Corse',              type:'aoc',  lat:42.050, lng: 9.100 },
    { nom:'Patrimonio',                type:'aoc',  lat:42.700, lng: 9.369 },
    { nom:'Ajaccio',                   type:'aoc',  lat:41.950, lng: 8.758 },
    { nom:'Muscat du Cap Corse',       type:'aoc',  lat:42.980, lng: 9.420 },
    // D√©nominations Vin de Corse
    { nom:'Corse Calvi',               type:'cru',  lat:42.570, lng: 8.760 },
    { nom:'Corse Sart√®ne',             type:'cru',  lat:41.623, lng: 8.974 },
    { nom:'Corse Figari',              type:'cru',  lat:41.504, lng: 9.148 },
    { nom:'Corse Porto-Vecchio',       type:'cru',  lat:41.594, lng: 9.279 },
    { nom:'Corse Coteaux du Cap Corse',type:'cru',  lat:43.007, lng: 9.420 },
  ],
};

// Fonction pour afficher les appellations d'une r√©gion sur la carte ‚Äî centro√Ødes r√©els WFS
function showAppellations(regionKey, niveauMax) {
  if (!leafletMap) return;
  if (leafletMap._appelLayer) {
    leafletMap.removeLayer(leafletMap._appelLayer);
    leafletMap._appelLayer = null;
  }
  if (!regionKey) return;

  // Mapping cl√©s WINE_REGION_POLYGONS ‚Üí cl√©s APPELLATIONS
  const KEY_MAP = {
    'val_de_loire': 'loire',
    'sud_ouest':    'sud-ouest',
  };
  const appelKey = KEY_MAP[regionKey] || regionKey;
  const apps = APPELLATIONS[appelKey];
  if (!apps || !apps.length) return;

  leafletMap._appelRegion = regionKey;
  const group = L.layerGroup();

  apps.forEach(app => {
    if (app.lat == null || app.lng == null) return;
    addAppelLabel(group, app.lat, app.lng, app.nom, app.type || 'aoc');
  });

  group.addTo(leafletMap);
  leafletMap._appelLayer = group;

  const hint = document.getElementById('carte-zoom-hint');
  if (hint) {
    const region = WINE_REGION_POLYGONS[regionKey];
    const nAoc = apps.filter(a => a.type === 'aoc').length;
    const nCru = apps.filter(a => a.type === 'cru').length;
    hint.innerHTML = `üèõÔ∏è <b style="color:#e8c870">${region?.label||regionKey}</b>`
      + ` ‚Äî <span style="color:#c08050">${nAoc} AOC</span>`
      + (nCru ? ` ¬∑ <span style="color:#9b60d0">${nCru} cru${nCru>1?'s':''}</span>` : '');
    hint.style.color = 'rgba(220,200,120,0.9)';
  }
}

const REGION_BBOX = {
  // France
  'alsace':         [[47.45, 7.08], [48.97, 7.80]],
  'bordeaux':       [[44.30,-1.28], [45.78, 0.22]],
  'bourgogne':      [[45.85, 3.48], [47.82, 5.10]],
  'champagne':      [[48.40, 3.30], [49.40, 4.85]],
  'rhone_nord':     [[44.80, 4.60], [45.60, 5.50]],
  'rhone_sud':      [[43.60, 4.35], [44.55, 5.45]],
  'val_de_loire':   [[46.80,-2.30], [48.10, 3.10]],
  'languedoc':      [[42.90, 2.40], [43.90, 4.50]],
  'roussillon':     [[42.40, 2.45], [42.90, 3.15]],
  'provence':       [[43.10, 5.00], [43.90, 6.80]],
  'jura':           [[46.50, 5.40], [47.00, 5.90]],
  'savoie':         [[45.40, 5.80], [46.00, 6.80]],
  'sud_ouest':      [[43.20,-0.80], [44.70, 2.00]],
  'corse':          [[41.35, 8.55], [43.00, 9.55]],
  // Espagne
  'rioja':          [[42.20,-2.80], [42.70,-1.95]],
  'ribera-del-duero':[[41.25,-4.00],[41.80,-2.80]],
  'priorat':        [[41.05, 0.70], [41.30, 1.00]],
  'rias-baixas':    [[42.05,-8.90], [42.60,-8.20]],
  'penedes':        [[41.15, 1.30], [41.60, 1.90]],
  'jerez':          [[36.65,-6.20], [36.95,-5.85]],
  // Italie
  'barolo-barbaresco':[[44.55, 7.85],[44.80, 8.15]],
  'chianti':        [[43.30,11.10], [43.90,11.80]],
  'toscane':        [[42.60,10.50], [44.20,12.40]],
  'valpolicella':   [[45.40,10.80], [45.75,11.20]],
  'piemonte':       [[44.35, 7.40], [45.05, 8.90]],
  'sicile':         [[36.65,12.35], [38.20,15.60]],
  // Allemagne
  'moselle':        [[49.65, 6.55], [50.40, 7.40]],
  'rheingau':       [[49.95, 7.80], [50.15, 8.45]],
  'pfalz':          [[49.10, 7.75], [49.65, 8.35]],
  // Portugal
  'douro':          [[41.00,-7.75], [41.50,-6.90]],
  'alentejo':       [[37.50,-8.20], [38.80,-6.80]],
  'vinho-verde':    [[41.30,-8.75], [42.20,-7.80]],
  // Autriche
  'wachau':         [[48.25,15.35], [48.45,15.65]],
  'burgenland':     [[47.20,16.40], [47.95,16.95]],
  // Gr√®ce
  'santorini':      [[36.33,25.35], [36.48,25.48]],
  'naoussa':        [[40.55,22.00], [40.75,22.20]],
  // Hongrie
  'tokaj':          [[48.10,21.30], [48.45,21.80]],
};

function carteZoomPays(pays) {
  if(!leafletMap) { renderCarte(); setTimeout(() => carteZoomPays(pays), 400); return; }
  const cfg = PAYS_ZOOM[pays];
  if(!cfg) return;
  leafletMap.setView(cfg.center, cfg.zoom, {animate: true, duration: 0.7});
}

// Zoom sur une r√©gion viticole pr√©cise (appel√© depuis marker click)
function zoomRegion(key) {
  if(!leafletMap) return;
  const bbox = REGION_BBOX[key];
  if(bbox) {
    leafletMap.fitBounds(bbox, { animate: true, duration: 0.7, padding: [20, 20] });
  } else {
    // Fallback : centro√Øde de la g√©om√©trie
    const region = WINE_REGION_POLYGONS[key];
    if(!region) return;
    try {
      const geom   = region.geometry || { type:'Polygon', coordinates:[region.coords] };
      const coords = geom.type === 'MultiPolygon' ? geom.coordinates.flat(2) : geom.coordinates[0];
      const lats   = coords.map(c => c[1]), lngs = coords.map(c => c[0]);
      leafletMap.fitBounds(
        [[Math.min(...lats), Math.min(...lngs)], [Math.max(...lats), Math.max(...lngs)]],
        { animate: true, duration: 0.7, padding: [20, 20] }
      );
    } catch(e) {}
  }
}

function renderCarteLegend() {
  // L√©gende masqu√©e
  document.getElementById('carte-legend').innerHTML = '';
}


// ‚îÄ‚îÄ Listes de c√©pages pour la classification rouge/blanc ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CEPAGES_BLANCS_LIST = ['chardonnay','sauvignon blanc','sauvignon','s√©millon','semillon',
  'riesling','gewurztraminer','gew√ºrztraminer','pinot gris','pinot blanc','aligot√©','aligote',
  'muscat','viognier','marsanne','roussanne','clairette','bourboulenc','ugni blanc','ugni',
  'rolle','vermentino','grenache blanc','macabeu','macabeo','viura','malvasia','malvas√≠a',
  'palomino','palomino fino','pedro xim√©nez','pedro ximenez','moscatel','albari√±o','albarino',
  'treixadura','loureira','verdejo','godello','arinto','alvarinho','loureiro','trajadura','azal',
  'encruzado','bical','ant√£o vaz','antao vaz','fern√£o pires','fernao pires','sercial','verdelho',
  'bual','malmsey','terrantez','cortese','arneis','turbiana','garganega','glera','pinot grigio',
  'friulano','tocai','ribolla gialla','m√ºller-thurgau','muller-thurgau','savagnin','jacqu√®re',
  'jacquere','altesse','roussette','chasselas','gros manseng','petit manseng','melon de bourgogne',
  'chenin blanc','chenin','hondarrabi zuri','xarel¬∑lo','xarello','parellada','furmint',
  'h√°rslevel≈±','harslevel√º','harslevelu','assyrtiko','moschofilero'];
const CEPAGES_ROUGES_LIST = ['cabernet sauvignon','merlot','cabernet franc','pinot noir','syrah',
  'grenache','mourv√®dre','mourvedre','carignan','cinsault','gamay','gamay noir','malbec','c√¥t','cot',
  'tannat','fer servadou','tempranillo','garnacha','mazuelo','graciano','menc√≠a','mencia',
  'tinto fino','cari√±ena','carinena','touriga nacional','touriga franca','tinta roriz',
  'tinta barroca','tinta c√£o','tinta cao','aragonez','trincadeira','alicante bouschet',
  'castel√£o','castelao','nebbiolo','barbera','dolcetto','corvina','molinara','rondinella',
  'sangiovese','primitivo','aglianico','teroldego','lagrein','schiava','vernatsch','refosco',
  'nielluccio','sciaccarello','poulsard','trousseau','mondeuse','hondarrabi beltza',
  'blaufr√§nkisch','zweigelt','pinot meunier','mavrud','tempranillo/tinto fino','xinomavro','agiorgitiko'];

// Classe un c√©page : retourne 'rouge', 'blanc', ou 'autre'
function classifyCepage(c) {
  const k = c.toLowerCase().trim();
  if (CEPAGES_ROUGES_LIST.some(r => k === r || k.startsWith(r) || k.includes(r))) return 'rouge';
  if (CEPAGES_BLANCS_LIST.some(b => k === b || k.startsWith(b) || k.includes(b))) return 'blanc';
  return 'autre';
}

// Construit le HTML des c√©pages s√©par√©s rouge/blanc pour un affichage donn√©
function buildCepagesHtml(cepagesStr, style) {
  // style: 'hint' = compact inline, 'panel' = affich√© dans le panneau r√©gion
  if (!cepagesStr) return '';
  const rawList = cepagesStr.split(',').map(s => s.trim());
  const rouges = [], blancs = [], autres = [];
  rawList.forEach(c => {
    const cat = classifyCepage(c);
    if (cat === 'rouge') rouges.push(c);
    else if (cat === 'blanc') blancs.push(c);
    else autres.push(c);
  });
  if (style === 'hint') {
    if (!rouges.length && !blancs.length) return ` ‚Äî <span style="color:#a09080;font-style:italic">üçá ${cepagesStr}</span>`;
    let h = ' ‚Äî <span style="font-style:italic;font-size:0.88em">';
    if (rouges.length) h += `<span style="color:#c87080">üç∑ ${rouges.join(', ')}</span>`;
    if (rouges.length && blancs.length) h += ' ¬∑ ';
    if (blancs.length) h += `<span style="color:#b8a050">ü•Ç ${blancs.join(', ')}</span>`;
    if (autres.length) h += `<span style="color:#908070"> ¬∑ ${autres.join(', ')}</span>`;
    return h + '</span>';
  } else {
    // panneau : affichage structur√©, plus lisible
    let h = '<div style="margin-bottom:14px;padding:10px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:4px">';
    h += '<div style="font-size:0.65rem;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px">C√©pages</div>';
    if (rouges.length) {
      h += `<div style="margin-bottom:6px"><span style="font-size:0.7rem;color:#c87080;letter-spacing:1px;text-transform:uppercase;margin-right:8px">üç∑ Rouges</span>`;
      h += `<span style="color:var(--text);font-size:0.88rem">${rouges.join(', ')}</span></div>`;
    }
    if (blancs.length) {
      h += `<div style="margin-bottom:${autres.length?'6px':'0'}"><span style="font-size:0.7rem;color:#b8a050;letter-spacing:1px;text-transform:uppercase;margin-right:8px">ü•Ç Blancs</span>`;
      h += `<span style="color:var(--text);font-size:0.88rem">${blancs.join(', ')}</span></div>`;
    }
    if (autres.length) {
      h += `<div><span style="font-size:0.7rem;color:#908070;letter-spacing:1px;text-transform:uppercase;margin-right:8px">üçá Autres</span>`;
      h += `<span style="color:var(--text);font-size:0.88rem">${autres.join(', ')}</span></div>`;
    }
    if (!rouges.length && !blancs.length && !autres.length) {
      h += `<span style="color:var(--text2);font-style:italic">${cepagesStr}</span>`;
    }
    return h + '</div>';
  }
}

function selectCarteRegion(key, label) {
  carteSelectedRegion = key;
  const wines = wineData.filter(w => getRegionKey(w) === key);
  const region = WINE_REGION_POLYGONS[key];
  const _appelKeyMap = {'val_de_loire':'loire','sud_ouest':'sud-ouest'};
  const allApps = APPELLATIONS[_appelKeyMap[key] || key] || [];
  const nbAoc = allApps.filter(a=>a.type==='aoc').length;
  const nbCru  = allApps.filter(a=>a.type==='cru').length;
  const nbApp  = region?.appellations ? region.appellations.length : nbAoc;

  document.getElementById('carte-region-title').textContent = `${label} ‚Äî ${wines.length} bouteille${wines.length!==1?'s':''}`;

  // Zoom pr√©cis sur la bbox de la r√©gion
  zoomRegion(key);

  // Effacer les appellations pr√©c√©dentes puis afficher celles de cette r√©gion
  showAppellations(key, 2);

  // Mettre √† jour le hint avec infos r√©gion (compact)
  const hint = document.getElementById('carte-zoom-hint');
  if (hint) {
    hint.innerHTML = `üèõÔ∏è <b style="color:#e8c870">${label}</b>`
      + buildCepagesHtml(region?.cepages, 'hint')
      + (nbAoc ? ` ‚Äî <span style="color:#c08050">${nbAoc} AOC</span>` : '')
      + (nbCru  ? ` ¬∑ <span style="color:#9b60d0">${nbCru} cru${nbCru>1?'s':''}</span>` : '');
    hint.style.color = 'rgba(220,200,120,0.9)';
  }

  if(!wines.length) {
    document.getElementById('carte-region-list').innerHTML = '<div style="color:var(--text2);font-style:italic">Aucun vin de cette r√©gion</div>';
    refreshCarteMarkers(); return;
  }

  const byApp = {};
  wines.forEach(w => {
    const app = w.appellation || 'Sans appellation';
    if(!byApp[app]) byApp[app] = [];
    byApp[app].push(w);
  });

  document.getElementById('carte-region-list').innerHTML =
    Object.entries(byApp)
    .sort((a,b) => b[1].length - a[1].length)
    .map(([app, ws]) => `
      <div style="margin-bottom:14px">
        <div style="font-size:0.75rem;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">${app} <span style="color:var(--gold)">(${ws.length})</span></div>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          ${ws.map(w => `
            <div onclick="openSlotModal(${w.cave},${w.floor},${w.slot})"
              style="display:flex;gap:8px;align-items:center;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:3px;cursor:pointer;min-width:180px;flex:1;max-width:260px">
              ${w.image?`<img src="${w.image}" alt="${w.nom||'vin'}" style="width:28px;height:40px;object-fit:contain;border-radius:2px;flex-shrink:0">`:`<span style="font-size:1rem;flex-shrink:0">üç∑</span>`}
              <div style="min-width:0">
                <div style="color:var(--text);font-size:0.88rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${w.nom||'‚Äî'}</div>
                <div style="color:var(--text2);font-size:0.75rem">${w.annee||''} ${w.domaine?'¬∑ '+w.domaine:''}</div>
              </div>
            </div>`).join('')}
        </div>
      </div>`).join('');

  refreshCarteMarkers();
}

function refreshCarteMarkers() {
  // Mettre en surbrillance le marqueur s√©lectionn√©
  Object.entries(leafletMarkers).forEach(([key, marker]) => {
    const isSel = key === carteSelectedRegion;
    const wines = wineData.filter(w => getRegionKey(w) === key);
    const typeCount = {};
    wines.forEach(w => { typeCount[w.type] = (typeCount[w.type]||0)+1; });
    const domType = Object.entries(typeCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'rouge';
    const radius = wines.length > 0 ? Math.max(10, Math.min(22, 10 + wines.length * 0.8)) : 7;
    const r = isSel ? radius + 4 : radius;
    const newIcon = L.divIcon({
      className: '',
      html: `<div style="
        width:${r*2}px;height:${r*2}px;
        border-radius:50%;
        background:${isSel ? 'rgba(160,80,240,0.70)' : wines.length > 0 ? 'rgba(110,40,180,0.45)' : 'rgba(110,40,180,0.15)'};
        border:${isSel ? '3px solid rgba(220,180,255,0.95)' : wines.length > 0 ? '2px solid rgba(160,80,220,0.80)' : '2px solid rgba(130,60,200,0.35)'};
        box-shadow:${isSel ? '0 0 14px rgba(160,80,240,0.70)' : '0 2px 10px rgba(80,20,140,0.40)'};
        display:flex;align-items:center;justify-content:center;
        font-size:${r > 12 ? '11' : '9'}px;
        font-weight:bold;color:rgba(255,255,255,0.95);
        cursor:pointer;
      ">${wines.length > 0 ? wines.length : ''}</div>`,
      iconSize: [r*2, r*2],
      iconAnchor: [r, r],
      popupAnchor: [0, -r]
    });
    marker.setIcon(newIcon);
  });
}

function updateCartePoints() {
  // Refresh marqueurs
  refreshCarteMarkers();
  // WMTS+WFS : pas de mise √† jour de style n√©cessaire
}

</script>
<div id="mobile-bubble">
  <div class="mb-handle"></div>
  <div id="mb-img-wrap" style="display:none;margin:-16px -20px 14px;background:var(--bg3);text-align:center;padding:12px 20px;border-bottom:1px solid var(--border)">
    <img id="mb-img" src="" style="max-height:180px;max-width:100%;object-fit:contain;border-radius:3px;">
  </div>
  <div class="mb-name" id="mb-name"></div>
  <div class="mb-info" id="mb-info"></div>
  <div class="mb-actions">
    <button class="btn-wine" id="mb-btn-fiche" onclick="mobileBubbleOpenFiche()">üìã Fiche compl√®te</button>
    <button class="btn-outline" onclick="closeMobileBubble()">Fermer</button>
  </div>
</div>
<div id="mobile-bubble-overlay" style="display:none;position:fixed;inset:0;z-index:299;background:rgba(0,0,0,0.3)" onclick="closeMobileBubble()"></div>
</body>
</html>
