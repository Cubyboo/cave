<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üç∑  Cave √† Vin MMM</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #18100f;
    --bg2: #221518;
    --bg3: #2c1c20;
    --wine: #7b1c2e;
    --wine2: #9e2a3f;
    --wine3: #c4364f;
    --gold: #c9a84c;
    --gold2: #e8c870;
    --cream: #f5ede0;
    --text: #e8ddd0;
    --text2: #b0a090;
    --green: #2d7a4e;
    --green2: #3da066;
    --border: #3a2830;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Cormorant Garamond', serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* HEADER */
  header {
    background: linear-gradient(180deg, #000 0%, var(--bg) 100%);
    border-bottom: 1px solid var(--border);
    padding: 18px 40px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
    backdrop-filter: blur(10px);
  }
  .logo { font-family: 'Playfair Display', serif; font-size: 1.7rem; color: var(--gold); letter-spacing: 2px; }
  .logo span { color: var(--cream); font-style: italic; }
  .stats-bar { display: flex; gap: 28px; font-size: 0.85rem; color: var(--text2); letter-spacing: 1px; }
  .stats-bar b { color: var(--gold); font-size: 1.05rem; }
  .search-input { flex:1; max-width:480px; padding:8px 14px 8px 36px; background:var(--bg3); border:1px solid var(--border); color:var(--text); font-family:'Cormorant Garamond',serif; font-size:1rem; border-radius:2px; outline:none; transition: border-color 0.2s; }
  .search-input:focus { border-color:var(--gold); }
  .search-wrap { position:relative; flex:1; max-width:480px; }
  .search-icon { position:absolute; left:10px; top:50%; transform:translateY(-50%); color:var(--text2); font-size:0.95rem; pointer-events:none; }
  .search-clear { position:absolute; right:10px; top:50%; transform:translateY(-50%); color:var(--text2); cursor:pointer; font-size:0.9rem; display:none; }
  .search-results-overlay { position:fixed; top:0; left:0; right:0; bottom:0; z-index:200; display:none; }
  .search-results-panel { position:fixed; top:120px; left:40px; right:40px; max-width:640px; margin:0 auto; background:var(--bg2); border:1px solid var(--border); border-radius:4px; z-index:201; max-height:70vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.5); }
  .search-result-item { display:flex; gap:12px; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border); cursor:pointer; transition:background 0.15s; }
  .search-result-item:hover { background:var(--bg3); }
  .search-result-item:last-child { border-bottom:none; }
  .search-count { font-size:0.78rem; color:var(--text2); letter-spacing:1px; padding:8px 16px; border-bottom:1px solid var(--border); }

  /* TABS */
  .tabs { display: flex; border-bottom: 1px solid var(--border); padding: 0 40px; background: var(--bg2); }
  .tab {
    padding: 13px 26px; cursor: pointer; color: var(--text2);
    font-size: 0.88rem; letter-spacing: 2px; text-transform: uppercase;
    border-bottom: 2px solid transparent; transition: all 0.3s;
  }
  .tab:hover { color: var(--cream); }
  .tab.active { color: var(--gold); border-bottom-color: var(--gold); }

  .content { display: none; padding: 28px 40px; }
  .content.active { display: block; }

  /* ===================== 2D CAVE VIEW ===================== */
  .cave-selector {
    display: flex; gap: 14px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;
  }
  .cave-btn {
    padding: 9px 22px; border: 1px solid var(--border);
    background: transparent; color: var(--text2); cursor: pointer;
    font-family: 'Cormorant Garamond', serif; font-size: 1rem; letter-spacing: 1px;
    transition: all 0.3s; border-radius: 2px;
  }
  .cave-btn.active, .cave-btn:hover { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.07); }

  .cave-legend {
    margin-left: auto; display: flex; gap: 18px;
    font-size: 0.78rem; color: var(--text2); align-items: center; flex-wrap: wrap;
  }
  .legend-item { display: flex; align-items: center; gap: 6px; }
  .legend-big  { width: 18px; height: 18px; border-radius: 50%; border: 1.5px solid rgba(255,255,255,0.15); }
  .legend-small{ width: 9px;  height: 9px;  border-radius: 50%; border: 1px solid rgba(255,255,255,0.15); }

  /* Cave wrapper */
  .cave-2d-wrap {
    background: #080406;
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow-x: auto;
    overflow-y: auto;
    padding: 20px;
    position: relative;
    display: flex;
    justify-content: center;
  }

  /* Tooltip */
  /* Bulle mobile tap */
  #mobile-bubble {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: var(--bg2);
    border-top: 1px solid var(--border);
    border-radius: 12px 12px 0 0;
    padding: 16px 20px 24px;
    z-index: 300;
    display: none;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
    transform: translateY(100%);
    transition: transform 0.25s ease;
  }
  #mobile-bubble.open {
    display: block;
    transform: translateY(0);
  }
  #mobile-bubble .mb-handle {
    width: 36px; height: 4px; background: var(--border);
    border-radius: 2px; margin: 0 auto 14px;
  }
  #mobile-bubble .mb-name {
    font-family: 'Playfair Display', serif;
    color: var(--gold); font-size: 1.1rem; margin-bottom: 4px;
  }
  #mobile-bubble .mb-info { color: var(--text2); font-size: 0.85rem; line-height: 1.7; }
  #mobile-bubble .mb-actions { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
  #mobile-bubble .mb-actions button { flex: 1; min-width: 100px; }
  #tooltip {
    position: fixed;
    background: rgba(8,4,6,0.97);
    border: 1px solid var(--gold);
    padding: 12px 16px; border-radius: 3px;
    font-size: 0.84rem; pointer-events: none;
    display: none; z-index: 999; max-width: 280px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.9);
  }
  #tooltip .tt-name { font-family: 'Playfair Display', serif; color: var(--gold); margin-bottom: 4px; font-size: 0.95rem; }
  #tooltip .tt-info { color: var(--text2); line-height: 1.65; font-size: 0.79rem; }
  #tooltip .tt-empty { color: #665858; font-style: italic; }

  /* Modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.88); z-index: 200; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--bg2); border: 1px solid var(--border); padding: 32px; width: 760px; max-width: 96vw; border-radius: 4px; position: relative; max-height: 90vh; overflow-y: auto; }
  .modal h2 { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.35rem; margin-bottom: 18px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
  .modal-close { position: absolute; top: 14px; right: 16px; background: none; border: none; color: var(--text2); font-size: 1.4rem; cursor: pointer; }
  .form-row { margin-bottom: 13px; }
  .form-row label { display: block; font-size: 0.78rem; color: var(--text2); letter-spacing: 1px; margin-bottom: 4px; text-transform: uppercase; }
  .form-row input, .form-row select, .form-row textarea {
    width: 100%; padding: 9px 12px; background: var(--bg3); border: 1px solid var(--border);
    color: var(--text); font-family: 'Cormorant Garamond', serif; font-size: 1rem;
    border-radius: 2px; outline: none; transition: border-color 0.2s;
  }
  .form-row input:focus, .form-row select:focus { border-color: var(--gold); }
  .form-row select option { background: var(--bg3); }
  .btn-wine { padding: 10px 26px; background: var(--wine); border: none; color: var(--cream); font-family: 'Cormorant Garamond', serif; font-size: 1rem; letter-spacing: 1px; cursor: pointer; border-radius: 2px; transition: background 0.2s; }
  .btn-wine:hover { background: var(--wine2); }
  .btn-outline { padding: 10px 18px; background: transparent; border: 1px solid var(--border); color: var(--text2); font-family: 'Cormorant Garamond', serif; font-size: 1rem; cursor: pointer; border-radius: 2px; transition: all 0.2s; }
  .btn-outline:hover { border-color: var(--wine3); color: var(--wine3); }
  .btn-danger { padding: 10px 18px; background: transparent; border: 1px solid #6b1a1a; color: #d44; font-family: 'Cormorant Garamond', serif; font-size: 1rem; cursor: pointer; border-radius: 2px; transition: all 0.2s; }
  .btn-danger:hover { background: #6b1a1a33; }
  .modal-info-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 18px; }
  .info-cell { background: var(--bg3); padding: 9px 13px; border-radius: 2px; }
  .info-cell .lbl { font-size: 0.68rem; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
  .info-cell .val { font-size: 1.02rem; color: var(--cream); margin-top: 2px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 18px; flex-wrap: wrap; }

  /* LIST VIEW */
  .filter-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
  .filter-bar input, .filter-bar select { padding: 8px 14px; background: var(--bg2); border: 1px solid var(--border); color: var(--text); font-family: 'Cormorant Garamond', serif; font-size: 0.95rem; border-radius: 2px; outline: none; transition: border-color 0.2s; }
  .filter-bar input:focus, .filter-bar select:focus { border-color: var(--gold); }
  .filter-bar input { width: 220px; }
  .wine-table { width: 100%; border-collapse: collapse; font-size: 0.94rem; }
  .wine-table th { text-align: left; padding: 9px 13px; border-bottom: 1px solid var(--border); color: var(--text2); font-weight: 400; letter-spacing: 1px; text-transform: uppercase; font-size: 0.73rem; white-space: nowrap; }
  .wine-table td { padding: 10px 13px; border-bottom: 1px solid rgba(58,40,48,0.4); }
  .wine-table tr:hover td { background: rgba(201,168,76,0.04); cursor: pointer; }
  .type-badge { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap; }
  .badge-rouge       { background: rgba(123,28,46,0.3);   color: #e06070; border: 1px solid #7b1c2e; }
  .badge-blanc       { background: rgba(201,168,76,0.15); color: #e8c870; border: 1px solid #9a7e30; }
  .badge-ros√©        { background: rgba(200,100,120,0.2); color: #e8a0b0; border: 1px solid #a05060; }
  .badge-effervescent{ background: rgba(180,210,240,0.15);color: #a8d8f0; border: 1px solid #5080a0; }
  .badge-vdn         { background: rgba(160,80,200,0.2);  color: #d0a0f0; border: 1px solid #804090; }
  .badge-magnum      { background: rgba(80,50,100,0.3);   color: #c0a0e8; border: 1px solid #6040a0; }
  .format-badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 0.67rem; letter-spacing: 0.5px; text-transform: uppercase; background: rgba(201,168,76,0.09); color: var(--text2); border: 1px solid #3a2830; margin-left: 4px; }
  .rating-stars { color: var(--gold); letter-spacing: -1px; }
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text2); font-size: 1.1rem; font-style: italic; }

  /* STATS VIEW */
  .stats-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 28px; }
  .stat-card { background: var(--bg2); border: 1px solid var(--border); padding: 20px 22px; border-radius: 3px; position: relative; overflow: hidden; }
  .stat-card::before { content:''; position: absolute; left:0; top:0; bottom:0; width:3px; background: var(--gold); }
  .stat-card .s-val { font-family: 'Playfair Display', serif; font-size: 2.1rem; color: var(--gold); line-height: 1; }
  .stat-card .s-lbl { font-size: 0.78rem; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; margin-top: 6px; }
  .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .chart-card { background: var(--bg2); border: 1px solid var(--border); padding: 20px; border-radius: 3px; }
  .chart-card h3 { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--gold2); margin-bottom: 16px; font-weight: 400; letter-spacing: 1px; }
  .bar-chart { display: flex; flex-direction: column; gap: 8px; }
  .bar-row { display: flex; align-items: center; gap: 10px; }
  .bar-label { width: 96px; font-size: 0.79rem; color: var(--text2); text-align: right; flex-shrink: 0; }
  .bar-track { flex: 1; height: 17px; background: var(--bg3); border-radius: 2px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 2px; transition: width 0.9s ease; }
  .bar-fill-rouge        { background: linear-gradient(90deg,#5a1020,#9e2a3f); }
  .bar-fill-blanc        { background: linear-gradient(90deg,#7a5a10,#c9a84c); }
  .bar-fill-ros√©         { background: linear-gradient(90deg,#8a3050,#c06080); }
  .bar-fill-effervescent { background: linear-gradient(90deg,#204060,#5090c0); }
  .bar-fill-vdn          { background: linear-gradient(90deg,#502080,#9040c0); }
  .bar-fill-magnum       { background: linear-gradient(90deg,#4a2870,#9060c0); }
  .bar-count { width: 28px; font-size: 0.79rem; color: var(--text2); text-align: right; }

  /* ADD VIEW */
  .add-wine-form { background: var(--bg2); border: 1px solid var(--border); padding: 32px; border-radius: 4px; max-width: 600px; }
  .add-wine-form h2 { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.5rem; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .form-full { grid-column: 1/-1; }

  /* Notifications */
  #notif { position: fixed; top: 76px; right: 20px; background: var(--bg2); border: 1px solid var(--green2); color: var(--green2); padding: 12px 20px; border-radius: 3px; font-size: 0.9rem; z-index: 500; transform: translateX(130%); opacity: 0; visibility: hidden; transition: transform 0.3s, opacity 0.3s; }
  #notif.show { transform: translateX(0); opacity: 1; visibility: visible; }
  #notif.error { border-color: var(--wine3); color: var(--wine3); }

  /* PASSWORD SCREEN */
  #pwd-screen {
    position: fixed; inset: 0; background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999; flex-direction: column; gap: 20px;
  }
  #pwd-screen.hidden { display: none; }
  .pwd-box {
    background: var(--bg2); border: 1px solid var(--border);
    padding: 40px 48px; border-radius: 4px; text-align: center;
    box-shadow: 0 8px 40px rgba(0,0,0,0.8);
  }
  .pwd-box h1 { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 2rem; margin-bottom: 6px; }
  .pwd-box p  { color: var(--text2); font-size: 0.9rem; margin-bottom: 24px; letter-spacing: 1px; }
  .pwd-input {
    width: 100%; padding: 12px 16px; background: var(--bg3);
    border: 1px solid var(--border); color: var(--text);
    font-family: 'Cormorant Garamond', serif; font-size: 1.1rem;
    border-radius: 2px; outline: none; text-align: center;
    letter-spacing: 3px; margin-bottom: 14px;
    transition: border-color 0.2s;
  }
  .pwd-input:focus { border-color: var(--gold); }
  .pwd-input.error { border-color: var(--wine3); animation: shake 0.3s; }
  .pwd-btn {
    width: 100%; padding: 12px; background: var(--wine);
    border: none; color: var(--cream); font-family: 'Cormorant Garamond', serif;
    font-size: 1rem; letter-spacing: 2px; cursor: pointer;
    border-radius: 2px; transition: background 0.2s;
  }
  .pwd-btn:hover { background: var(--wine2); }
  .pwd-error { color: var(--wine3); font-size: 0.85rem; margin-top: 10px; min-height: 18px; }
  @keyframes shake {
    0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)}
  }


  /* ============================================================
     RESPONSIVE MOBILE
     ============================================================ */
  @media (max-width: 768px) {
    header {
      padding: 12px 16px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .logo { font-size: 1.2rem; }
    .stats-bar {
      gap: 10px;
      font-size: 0.75rem;
      flex-wrap: wrap;
    }
    .tabs {
      padding: 0 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      flex-wrap: nowrap;
      align-items: center;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab {
      font-size: 0.78rem;
      padding: 10px 10px;
      white-space: nowrap;
      letter-spacing: 0;
    }
    .search-wrap { max-width: 140px; margin: 4px 6px !important; }
    .search-input { font-size: 0.85rem; padding: 6px 10px 6px 28px; }
    .search-results-panel { left: 10px; right: 10px; top: 100px; }

    .content { padding: 16px 14px; }

    /* Cave 2D ‚Äî scroll horizontal */
    #caveSvg { display: block; max-width: 100%; overflow: visible; }
    .cave-selector {
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px 14px;
    }
    .cave-legend {
      flex-wrap: wrap;
      gap: 6px;
    }
    #cave-svg-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border: 1px solid var(--border);
      border-radius: 3px;
      background: var(--bg2);
    }

    /* Stats */
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .charts-row { grid-template-columns: 1fr; }

    /* Formulaires */
    .form-grid { grid-template-columns: 1fr; }
    .form-full { grid-column: 1; }

    /* Modal */
    .modal {
      width: 96vw;
      max-width: 96vw;
      padding: 18px 14px;
      margin: 10px auto;
    }
    .modal-info-panel { grid-template-columns: 1fr 1fr; gap: 8px; }
    .modal-actions { flex-wrap: wrap; gap: 8px; }
    .modal-actions button { flex: 1; min-width: 120px; font-size: 0.88rem; padding: 9px 10px; }

    /* Historique */
    .bar-label { width: 70px; font-size: 0.72rem; }

    /* Liste */
    table { font-size: 0.82rem; }
    th, td { padding: 8px 6px; }
  }

  @media (max-width: 480px) {
    .logo { font-size: 1rem; }
    .stats-bar { display: none; }
    .stats-grid { grid-template-columns: 1fr; }
    .modal-info-panel { grid-template-columns: 1fr; }
  }

  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
</head>
<body>


<!-- PASSWORD SCREEN -->
<div id="pwd-screen">
  <div class="pwd-box">
    <h1>üç∑ Cave √† Vin</h1>
    <p>Acc√®s priv√© ‚Äî Entrez votre mot de passe</p>
    <input type="password" class="pwd-input" id="pwd-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
      onkeydown="if(event.key==='Enter') checkPwd()">
    <button class="pwd-btn" onclick="checkPwd()">Acc√©der √† ma cave</button>
    <div class="pwd-error" id="pwd-error"></div>
  </div>
</div>

<header>
  <div class="logo">üç∑ <span>Cave</span> √† Vin MMM üç∑<span></div>
  <div class="stats-bar">
    <div>Total : <b id="hdr-total">0</b> bouteilles</div>
    <div>Cave 1 : <b id="hdr-c1">0</b></div>
    <div>Cave 2 : <b id="hdr-c2">0</b></div>
    <div>Valeur estim√©e : <b id="hdr-val">0 ‚Ç¨</b></div>
  </div>
</header>

<div class="search-results-overlay" id="search-overlay" onclick="clearSearch()"></div>
<div class="search-results-panel" id="search-panel" style="display:none"></div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('view2d',this)">üó∫ Vue Cave</div>
  <div class="tab" onclick="switchTab('list',this)">üìã Liste</div>
  <div class="tab" onclick="switchTab('historique',this)">üìú Historique</div>
  <div class="tab" onclick="switchTab('apogee',this)">üîî Apog√©e</div>
  <div class="tab" onclick="switchTab('accords',this)">üçΩ Accords</div>
  <div class="tab" onclick="switchTab('stats',this)">üìä Statistiques</div>
  <div class="tab" onclick="switchTab('add',this)">‚ûï Ajouter</div>
  <div class="tab" onclick="switchTab('carte',this)">üåç Carte</div>
  <div style="flex:1"></div>
  <div class="search-wrap" style="margin:0 12px;align-self:center">
    <span class="search-icon">üîç</span>
    <input class="search-input" id="global-search" type="text" placeholder="Rechercher‚Ä¶"
      oninput="handleSearch(this.value)"
      onkeydown="if(event.key==='Escape') clearSearch()">
    <span class="search-clear" id="search-clear" onclick="clearSearch()">‚úï</span>
  </div>
</div>

<!-- ===== 2D CAVE VIEW ===== -->
<div id="view2d" class="content active">
  <div class="cave-selector">
    <button class="cave-btn active" onclick="selectCave(1,this)">Cave 1 ‚Äî 156 empl.</button>
    <button class="cave-btn" onclick="selectCave(2,this)">Cave 2 ‚Äî 110 empl.</button>
    <div class="cave-legend">
      <div class="legend-item"><div class="legend-big" style="background:#8a1828"></div> Rouge</div>
      <div class="legend-item"><div class="legend-big" style="background:#a88018"></div> Blanc</div>
      <div class="legend-item"><div class="legend-big" style="background:#b84068"></div> Ros√©</div>
      <div class="legend-item"><div class="legend-big" style="background:#204870"></div> Effervescent</div>
      <div class="legend-item"><div class="legend-big" style="background:#703090"></div> VDN</div>
      <div class="legend-item"><div class="legend-big" style="background:#504898"></div> Magnum</div>
      <div class="legend-item"><div class="legend-big" style="background:#1a1014;border:1.5px solid #4a3040"></div> Vide</div>
      <div class="legend-item"><div class="legend-small" style="background:#4a4a4a"></div> Goulot arri√®re</div>
    </div>
  </div>
  <div class="cave-2d-wrap" id="cave2dWrap">
    <div id="cave-svg-wrap" style="overflow-x:auto;-webkit-overflow-scrolling:touch"><svg id="caveSvg" style="display:block;"></svg></div>
  </div>
</div>

<!-- ===== LIST VIEW ===== -->
<div id="list" class="content">
  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="Rechercher un vin..." oninput="renderList()">
    <select id="filterCave" onchange="renderList()">
      <option value="">Toutes les caves</option>
      <option value="1">Cave 1</option>
      <option value="2">Cave 2</option>
    </select>
    <select id="filterType" onchange="renderList()">
      <option value="">Tous les types</option>
      <option value="rouge">Rouge</option>
      <option value="blanc">Blanc</option>
      <option value="ros√©">Ros√©</option>
      <option value="effervescent">Effervescent</option>
      <option value="vdn">VDN</option>
      <option value="magnum">Magnum</option>
    </select>
    <select id="sortBy" onchange="renderList()">
      <option value="nom">Trier par nom</option>
      <option value="appellation">Trier par appellation</option>
      <option value="region">Trier par r√©gion</option>
      <option value="domaine">Trier par domaine / producteur</option>
      <option value="annee">Trier par ann√©e</option>
      <option value="prix">Trier par prix</option>
      <option value="type">Trier par type</option>
    </select>
  </div>
  <div id="listContainer"></div>
</div>

<!-- ===== STATS VIEW ===== -->
<div id="stats" class="content">
  <div class="stats-grid" id="statsGrid"></div>
  <div class="charts-row">
    <div class="chart-card"><h3>R√©partition par type</h3><div class="bar-chart" id="chartType"></div></div>
    <div class="chart-card"><h3>R√©partition par mill√©sime</h3><div class="bar-chart" id="chartDecade"></div></div>
  </div>
  <div class="charts-row">
    <div class="chart-card"><h3>R√©partition par r√©gion</h3><div class="bar-chart" id="chartRegion"></div></div>
    <div class="chart-card"><h3>R√©partition par appellation</h3><div class="bar-chart" id="chartAppellation"></div></div>
  </div>
  <div class="charts-row" style="grid-template-columns:1fr">
    <div class="chart-card">
      <h3>Occupation des caves</h3>
      <div id="chartCaves" style="display:flex;gap:40px;flex-wrap:wrap;align-items:flex-end;padding:10px 0"></div>
    </div>
  </div>
</div>

<!-- ===== ADD VIEW ===== -->
<div id="add" class="content">
  <div class="add-wine-form">
    <h2>Ajouter un vin</h2>
    <div class="form-grid">
      <div class="form-row form-full">
        <label>Nom / Cuv√©e *</label>
        <input type="text" id="f-nom" placeholder="ex: Gevrey-Chambertin, La T√¢che...">
      </div>
      <div class="form-row form-full">
        <label>Appellation</label>
        <input type="text" id="f-appellation" placeholder="ex: AOC Bourgogne, AOP C√¥tes du Rh√¥ne...">
      </div>
      <div class="form-row">
        <label>Domaine / Producteur</label>
        <input type="text" id="f-domaine" placeholder="ex: Domaine Leflaive">
      </div>
      <div class="form-row">
        <label>R√©gion</label>
        <input type="text" id="f-region" placeholder="ex: Bordeaux, Bourgogne...">
      </div>
      <div class="form-row">
        <label>Type *</label>
        <select id="f-type">
          <option value="rouge">Rouge</option>
          <option value="blanc">Blanc</option>
          <option value="ros√©">Ros√©</option>
          <option value="effervescent">Effervescent (Champagne, Cr√©mant‚Ä¶)</option>
          <option value="vdn">VDN (Muscat, Banyuls, Rivesaltes‚Ä¶)</option>
          <option value="magnum">Magnum</option>
        </select>
      </div>
      <div class="form-row">
        <label>Format</label>
        <select id="f-format">
          <option value="75cl">75 cl (standard)</option>
          <option value="37.5cl">37,5 cl (demi)</option>
          <option value="62cl">62 cl (jaune)</option>
          <option value="150cl">150 cl (Magnum)</option>
          <option value="300cl">300 cl (Double Magnum)</option>
          <option value="autre">Autre</option>
        </select>
      </div>
      <div class="form-row">
        <label>Mill√©sime *</label>
        <input type="number" id="f-annee" placeholder="2018" min="1900" max="2030">
      </div>
      <div class="form-row">
        <label>Cave *</label>
        <select id="f-cave" onchange="updateEtageSelect()">
          <option value="1">Cave 1</option>
          <option value="2">Cave 2</option>
        </select>
      </div>
      <div class="form-row">
        <label>√âtage *</label>
        <select id="f-etage"></select>
      </div>
      <div class="form-row">
        <label>Emplacement *</label>
        <select id="f-slot"></select>
      </div>
      <div class="form-row">
        <label>Prix (‚Ç¨)</label>
        <input type="number" id="f-prix" placeholder="0" min="0">
      </div>
      <div class="form-row">
        <label>Note /5</label>
        <select id="f-note">
          <option value="">‚Äî</option>
          <option value="1">‚òÖ 1</option><option value="2">‚òÖ‚òÖ 2</option>
          <option value="3">‚òÖ‚òÖ‚òÖ 3</option><option value="4">‚òÖ‚òÖ‚òÖ‚òÖ 4</option>
          <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 5</option>
        </select>
      </div>
      <div class="form-row form-full">
        <label>Notes personnelles</label>
        <textarea id="f-notes" rows="3" placeholder="Ar√¥mes, accords mets-vins, occasion..."></textarea>
      </div>
      <div class="form-row">
        <label>D√©but apog√©e (ann√©e)</label>
        <input type="number" id="f-apogee-debut" placeholder="ex: 2026" min="2000" max="2060">
      </div>
      <div class="form-row">
        <label>Fin apog√©e (ann√©e)</label>
        <input type="number" id="f-apogee-fin" placeholder="ex: 2035" min="2000" max="2060">
      </div>
      <div class="form-row form-full">
        <label>Photo √©tiquette (URL)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="text" id="f-image" placeholder="https://i.imgur.com/... ou lien direct vers une image" style="flex:1">
          <button type="button" onclick="searchVivino()" style="white-space:nowrap;padding:9px 16px;background:var(--wine);border:none;color:var(--cream);font-family:'Cormorant Garamond',serif;font-size:0.95rem;letter-spacing:1px;cursor:pointer;border-radius:2px;transition:background 0.2s;flex-shrink:0" onmouseover="this.style.background='var(--wine2)'" onmouseout="this.style.background='var(--wine)'">üçá Vivino</button>
        </div>
        <div id="vivino-results" style="display:none;margin-top:10px;background:var(--bg3);border:1px solid var(--border);border-radius:3px;padding:14px">
          <div id="vivino-loading"></div>
          <div id="vivino-grid"></div>
        </div>
      </div>
    </div>
    <div style="margin-top:20px">
      <button class="btn-wine" onclick="addWine()">Ajouter √† la cave</button>
    </div>
  </div>
</div>

<!-- ===== HISTORIQUE VIEW ===== -->
<div id="historique" class="content">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <h2 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.4rem">üìú Historique des d√©gustations</h2>
    <div style="display:flex;gap:10px;align-items:center">
      <span id="histo-count" style="color:var(--text2);font-size:0.85rem"></span>
    </div>
  </div>
  <div id="histo-empty" style="display:none;text-align:center;padding:60px 0;color:var(--text2);font-style:italic">Aucune bouteille bue pour l'instant</div>
  <div id="histo-list"></div>
</div>

<!-- ===== ACCORDS VIEW ===== -->
<div id="accords" class="content">
  <div style="display:flex;gap:20px;flex-wrap:wrap;margin-bottom:28px">

    <!-- Recherche plat -> vin -->
    <div style="flex:1;min-width:280px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:22px">
      <h3 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.15rem;margin-bottom:6px">üçΩ J'ai un plat, quel vin ?</h3>
      <p style="color:var(--text2);font-size:0.85rem;margin-bottom:16px">Tapez un plat ou un ingr√©dient</p>
      <div style="display:flex;gap:8px">
        <input type="text" id="accord-plat-input" placeholder="ex: agneau, fromage, saumon..."
          style="flex:1;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:1rem;border-radius:2px;outline:none"
          onkeydown="if(event.key==='Enter') rechercherParPlat()"
          onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='var(--border)'">
        <button onclick="rechercherParPlat()" style="padding:9px 18px;background:var(--wine);border:none;color:var(--cream);font-family:'Cormorant Garamond',serif;font-size:1rem;cursor:pointer;border-radius:2px">Chercher</button>
      </div>
      <div id="accord-plat-results" style="margin-top:16px"></div>
    </div>

    <!-- Recherche vin -> plat -->
    <div style="flex:1;min-width:280px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:22px">
      <h3 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.15rem;margin-bottom:6px">üç∑ J'ai un vin, quel plat ?</h3>
      <p style="color:var(--text2);font-size:0.85rem;margin-bottom:16px">Choisissez un vin de votre cave</p>
      <select id="accord-vin-select"
        style="width:100%;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:1rem;border-radius:2px;outline:none"
        onchange="rechercherParVin(this.value)">
        <option value="">‚Äî Choisir un vin ‚Äî</option>
      </select>
      <div id="accord-vin-results" style="margin-top:16px"></div>
    </div>

  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalSlot">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modalSlot')">‚úï</button>
    <h2 id="modal-title">Emplacement</h2>
    <div id="modal-body"></div>
  </div>
</div>

<div id="tooltip">
  <div id="tt-img-wrap" style="margin-bottom:8px;display:none">
    <img id="tt-img" src="" alt="" style="width:100%;height:120px;object-fit:cover;border-radius:3px;border:1px solid var(--border)">
  </div>
  <div class="tt-name" id="tt-name"></div>
  <div class="tt-info" id="tt-info"></div>
</div>
<!-- ===== APOGEE VIEW ===== -->
<div id="apogee" class="content">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px">
    <h2 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.4rem">üîî Alertes d'apog√©e</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button onclick="filtreApogee('tous')" id="btn-ap-tous" class="cave-btn active">Tous</button>
      <button onclick="filtreApogee('maintenant')" id="btn-ap-maintenant" class="cave-btn">üü¢ √Ä boire</button>
      <button onclick="filtreApogee('bientot')" id="btn-ap-bientot" class="cave-btn">üü° Bient√¥t</button>
      <button onclick="filtreApogee('jeune')" id="btn-ap-jeune" class="cave-btn">üîµ Trop jeune</button>
      <button onclick="filtreApogee('depasse')" id="btn-ap-depasse" class="cave-btn">üî¥ D√©pass√©</button>
    </div>
  </div>
  <div id="apogee-list"></div>
</div>

<!-- ===== CARTE DES VIGNOBLES ===== -->
<div id="carte" class="content" style="padding:16px 20px">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px">
    <h2 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.4rem">üåç Carte des vignobles</h2>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div id="carte-legend" style="display:flex;gap:10px;flex-wrap:wrap;font-size:0.78rem;color:var(--text2)"></div>
      <button onclick="carteZoomIn()" style="padding:5px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:pointer;border-radius:2px;font-size:1rem">+</button>
      <button onclick="carteZoomOut()" style="padding:5px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:pointer;border-radius:2px;font-size:1rem">‚àí</button>
      <button onclick="carteReset()" style="padding:5px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:pointer;border-radius:2px;font-size:0.8rem">‚Ü∫ Reset</button>
    </div>
  </div>
  <div id="carte-wrap" style="position:relative;background:#0d1520;border:1px solid var(--border);border-radius:4px;overflow:hidden;height:500px">
    <svg id="carte-svg" style="width:100%;height:100%;display:block"></svg>
    <div id="carte-tooltip" style="display:none;position:absolute;background:var(--bg2);border:1px solid var(--gold);border-radius:3px;padding:10px 14px;pointer-events:none;z-index:10;min-width:180px;box-shadow:0 4px 20px rgba(0,0,0,0.6);font-size:0.85rem"></div>
    <div style="position:absolute;bottom:8px;right:10px;color:rgba(255,255,255,0.3);font-size:0.7rem">Molette pour zoomer ¬∑ Glisser pour d√©placer</div>
  </div>
  <div style="margin-top:14px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:16px">
    <div id="carte-region-title" style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1rem;margin-bottom:12px">Cliquez sur un point pour voir les vins</div>
    <div id="carte-region-list"></div>
  </div>
</div>

<!-- MODAL DEPLACEMENT -->
<div class="modal-overlay" id="modalDeplacer">
  <div class="modal" style="max-width:480px">
    <button class="modal-close" onclick="closeModal('modalDeplacer')">‚úï</button>
    <h2>üì¶ D√©placer la bouteille</h2>
    <p id="deplacer-wine-name" style="color:var(--cream);font-family:'Playfair Display',serif;font-size:1.1rem;margin-bottom:20px"></p>
    <div class="form-grid">
      <div class="form-row">
        <label>Cave</label>
        <select id="dep-cave" onchange="updateDepEtage()">
          <option value="1">Cave 1</option>
          <option value="2">Cave 2</option>
        </select>
      </div>
      <div class="form-row">
        <label>√âtage</label>
        <select id="dep-etage" onchange="updateDepSlot()"></select>
      </div>
      <div class="form-row form-full">
        <label>Emplacement</label>
        <select id="dep-slot"></select>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:20px">
      <button class="btn-wine" onclick="confirmerDeplacement()">üì¶ Confirmer le d√©placement</button>
      <button class="btn-outline" onclick="closeModal('modalDeplacer')">Annuler</button>
    </div>
  </div>
</div>

<!-- MODAL HISTORIQUE (retirer un vin) -->
<div class="modal-overlay" id="modalHistorique">
  <div class="modal" style="max-width:480px">
    <button class="modal-close" onclick="document.getElementById('modalHistorique').classList.remove('open')">‚úï</button>
    <h2>üç∑ Retirer de la cave</h2>
    <p style="color:var(--text2);margin-bottom:20px;font-size:0.95rem">
      Voulez-vous enregistrer <b id="histo-wine-name" style="color:var(--cream)"></b> dans l'historique avant de la retirer ?
    </p>
    <div class="form-grid">
      <div class="form-row">
        <label>Date de d√©gustation</label>
        <input type="date" id="histo-date">
      </div>
      <div class="form-row">
        <label>Note sur 5</label>
        <select id="histo-note">
          <option value="">‚Äî</option>
          <option value="1">‚òÖ 1</option>
          <option value="2">‚òÖ‚òÖ 2</option>
          <option value="3">‚òÖ‚òÖ‚òÖ 3</option>
          <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ 4</option>
          <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 5</option>
        </select>
      </div>
      <div class="form-row form-full">
        <label>Occasion</label>
        <input type="text" id="histo-occasion" placeholder="Repas en famille, anniversaire, seul...">
      </div>
      <div class="form-row form-full">
        <label>Commentaire de d√©gustation</label>
        <textarea id="histo-commentaire" rows="3" placeholder="Ar√¥mes, texture, accord, impression g√©n√©rale..."></textarea>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:20px">
      <button class="btn-wine" onclick="confirmRetirer(true)">üìú Enregistrer et retirer</button>
      <button class="btn-outline" onclick="confirmRetirer(false)">üóë Retirer sans enregistrer</button>
      <button class="btn-outline" onclick="document.getElementById('modalHistorique').classList.remove('open')">Annuler</button>
    </div>
  </div>
</div>

<iframe name="hidden-sync-frame" style="display:none"></iframe>
<div id="notif"></div>

<script>
// =====================================================================
// CONFIG
// =====================================================================
/*
  front  = bouteilles rang√©e avant (grand cercle = CUL visible)
  back   = bouteilles rang√©e arri√®re (petit cercle = GOULOT visible, c√¥te √† c√¥te)
  double = 2 couches identiques sur le m√™me √©tage
  isMagnum = marqu√© Magnum dans formulaire/liste
  slots  = total emplacements
  Cave 1 : √©tage 1 en HAUT, √©tage 8 en BAS
*/
const CAVE_CONFIG = {
  1: {
    floors: [
      { id:1, front:6, back:6, double:true,  isMagnum:false, label:'√âtage 1',           slots:24 },
      { id:2, front:6, back:6, double:false, isMagnum:false, label:'√âtage 2',           slots:12 },
      { id:3, front:6, back:6, double:false, isMagnum:false, label:'√âtage 3',           slots:12 },
      { id:4, front:6, back:6, double:false, isMagnum:false, label:'√âtage 4',           slots:12 },
      { id:5, front:6, back:6, double:false, isMagnum:false, label:'√âtage 5',           slots:12 },
      { id:6, front:6, back:6, double:true,  isMagnum:false, label:'√âtage 6',           slots:24 },
      { id:7, front:6, back:6, double:true,  isMagnum:false, label:'√âtage 7',           slots:24 },
      { id:8, front:6, back:6, double:false, isMagnum:true,  label:'√âtage 8 (Magnums)', slots:12 },
    ]
  },
  2: {
  floors: [
    { id:1, front:6, back:5, double:true, isMagnum:false, label:'√âtage 1', slots:22 },
    { id:2, front:6, back:5, double:true, isMagnum:false, label:'√âtage 2', slots:22 },
    { id:3, front:6, back:5, double:true, isMagnum:false, label:'√âtage 3', slots:22 },
    { id:4, front:6, back:5, double:true, isMagnum:false, label:'√âtage 4', slots:22 },
    { id:5, front:6, back:5, double:true, isMagnum:false, label:'√âtage 5', slots:22 },
  ]
}
};

// =====================================================================
// DATA
// =====================================================================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_GkA2thpGf_tCdgMtoVYt5-xANAztBu6Rmks9SE5-9yF8_jdbBu7iXbgS13_5iqH_6Q/exec';

let wineData = JSON.parse(localStorage.getItem('caveData') || '[]');
let currentCave = 1;
let addingToSlot = null;

const TYPE_LABELS   = { rouge:'Rouge', blanc:'Blanc', 'ros√©':'Ros√©', effervescent:'Effervescent', vdn:'VDN', magnum:'Magnum' };
const FORMAT_LABELS = { '75cl':'75 cl','37.5cl':'37,5 cl','62cl':'62 cl','150cl':'Magnum 150 cl','300cl':'Double Magnum','autre':'Autre' };
const WINE_COLORS = {
  rouge:        { fill:'#8a1828', stroke:'#c04060', small:'#5a1020' },
  blanc:        { fill:'#a88018', stroke:'#e0c060', small:'#6a5010' },
  'ros√©':       { fill:'#b84068', stroke:'#e080a0', small:'#803050' },
  effervescent: { fill:'#1e4870', stroke:'#5090c0', small:'#102840' },
  vdn:          { fill:'#703090', stroke:'#b060d0', small:'#481870' },
  magnum:       { fill:'#504898', stroke:'#9080d0', small:'#302870' },
  empty:        { fill:'#1a1014', stroke:'#4a3040', small:'#2a1a22' }
};

function saveData() {
  localStorage.setItem('caveData', JSON.stringify(wineData));
  updateHeader();
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'save', data: wineData })
  }).catch(e => console.warn('Sync Google Sheets √©chou√©e', e));
}

function loadFromSheets() {
  showNotif('Synchronisation en cours‚Ä¶');
  const cbName = 'caveCallback_' + Date.now();
  const timeout = setTimeout(() => {
    showNotif('Mode hors ligne ‚Äî donn√©es locales', true);
    delete window[cbName];
    const s = document.getElementById('jsonp-script');
    if(s) s.remove();
  }, 8000);
  window[cbName] = function(data) {
    clearTimeout(timeout);
    try {
      if(Array.isArray(data) && data.length > 0) {
        // R√©cup√©rer les images stock√©es localement avant d'√©craser les donn√©es
        const localData = JSON.parse(localStorage.getItem('caveData') || '[]');
        // Cr√©er un index des images locales par cl√© unique (cave+floor+slot)
        const localImageMap = {};
        localData.forEach(w => {
          if(w.image) {
            const key = `${w.cave}_${w.floor}_${w.slot}`;
            localImageMap[key] = w.image;
          }
        });
        wineData = data.map(w => {
          const cave  = parseInt(w.cave)  || 1;
          const floor = parseInt(w.floor) || 1;
          const slot  = parseInt(w.slot)  || 1;
          const key   = `${cave}_${floor}_${slot}`;
          return {
            ...w,
            cave,
            floor,
            slot,
            annee: parseInt(w.annee) || '',
            prix:  parseFloat(w.prix) || '',
            note:  w.note || '',
            // Conserver l'image du Sheet si elle existe, sinon celle du localStorage
            image: w.image || localImageMap[key] || ''
          };
        });
        localStorage.setItem('caveData', JSON.stringify(wineData));
        updateHeader();
        renderCave2D();
        showNotif('Cave synchronis√©e ‚úì');
        loadHistoriqueFromSheets();
      } else {
        showNotif('Sheet vide ‚Äî donn√©es locales conserv√©es');
      }
    } catch(e) {
      showNotif('Erreur de donn√©es', true);
    } finally {
      delete window[cbName];
      const s = document.getElementById('jsonp-script');
      if(s) s.remove();
    }
  };
  const script = document.createElement('script');
  script.id = 'jsonp-script';
  script.src = SCRIPT_URL + '?callback=' + cbName + '&t=' + Date.now();
  script.onerror = function() {
    clearTimeout(timeout);
    showNotif('Mode hors ligne ‚Äî donn√©es locales', true);
    delete window[cbName];
    this.remove();
  };
  const old = document.getElementById('jsonp-script');
  if(old) old.remove();
  document.head.appendChild(script);
}

function getWineAtSlot(cave, floor, slot) { return wineData.find(w => w.cave==cave && w.floor==floor && w.slot==slot); }

function updateHeader() {
  const c1 = wineData.filter(w=>w.cave==1).length;
  const c2 = wineData.filter(w=>w.cave==2).length;
  document.getElementById('hdr-total').textContent = wineData.length;
  document.getElementById('hdr-c1').textContent = c1;
  document.getElementById('hdr-c2').textContent = c2;
  const val = wineData.reduce((s,w)=>s+(parseFloat(w.prix)||0),0);
  document.getElementById('hdr-val').textContent = val.toFixed(0)+' ‚Ç¨';
}

// =====================================================================
// TABS
// =====================================================================
function switchTab(id, el) {
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(el) el.classList.add('active');
  if(id==='list')  renderList();
  if(id==='stats') renderStats();
  if(id==='accords') populateVinSelect();
  if(id==='apogee') renderApogee('tous');
  if(id==='carte') renderCarte();
  if(id==='add')   updateEtageSelect();
  if(id==='view2d') renderCave2D();
}

function selectCave(n, btn) {
  currentCave = n;
  document.querySelectorAll('.cave-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderCave2D();
}

// =====================================================================
// 2D SVG CAVE RENDERER
// =====================================================================
/*
  DISPOSITION dans l'√©tage (vue de face) :

  Sur UNE COUCHE on place d'abord les bouteilles AVANT (grand cercle = cul)
  puis imm√©diatement √† leur droite les bouteilles ARRI√àRE (petit cercle = goulot),
  toutes au m√™me niveau Y.

  Exemple : front=6, back=6
  [ O  O  O  O  O  O ][ o  o  o  o  o  o ]
    1  2  3  4  5  6    7  8  9  10 11 12

  Pour un double √©tage : deux couches identiques sur deux rang√©es Y distinctes.

  Le LABEL de l'√©tage est affich√© sur le bord gauche.
  Cave 1 : √©tage 1 en haut (affich√© en premier), √©tage 8 en bas.
  Cave 2 : √©tage 1 en bas (affich√© en dernier).
*/

const R_BIG   = 18;   // rayon grand cercle (cul)
const R_SMALL = 9;    // rayon petit cercle (goulot)
const PAD_H   = 24;   // padding horizontal gauche/droite
const PAD_V   = 18;   // padding vertical haut/bas
const ROW_GAP = 10;   // espace vertical entre les 2 couches d'un double √©tage
const SHELF_H = 4;    // √©paisseur planche
const FLOOR_GAP = 18; // espace entre √©tages

/*
  INTERCALAGE dans une rang√©e :
  On alterne cul (grand) et goulot (petit) sur le m√™me axe Y.
  Pour front=6, back=6 : O o O o O o O o O o O o
  L'espacement horizontal est calcul√© pour que le bord de chaque cercle
  soit toujours s√©par√© du suivant d'un GAP constant.

  Slot encoding :
    - slots 1..front         = rang√©e avant  (grands cercles)
    - slots front+1..front+back = rang√©e arri√®re (petits cercles)
  On intercale visuellement mais on conserve l'encodage d'origine.
*/

function renderCave2D() {
  const svg    = document.getElementById('caveSvg');
  const floors = CAVE_CONFIG[currentCave].floors;
  const GAP    = 7; // espace bord-√†-bord entre deux cercles cons√©cutifs

  // ‚îÄ‚îÄ Pr√©-calcul : positions X de chaque cercle dans une couche ‚îÄ‚îÄ
  // On alterne big / small en les centrant bord-√†-bord avec GAP constant.
  // Retourne un tableau [{cx, r, isFront, localIdx}]
  function layerPositions(front, back) {
    const seq = [];
    let f = 0, b = 0;
    // Intercalage : on alterne tant qu'il reste des deux c√¥t√©s,
    // puis on finit avec ce qui reste.
    while(f < front || b < back) {
      if(f < front)  { seq.push({isFront:true,  li:f});  f++; }
      if(b < back)   { seq.push({isFront:false, li:b});  b++; }
    }
    // Calcul des X
    const positions = [];
    let x = 0;
    seq.forEach((s, i) => {
      const r = s.isFront ? R_BIG : R_SMALL;
      if(i === 0) x = r;
      else {
        const rPrev = seq[i-1].isFront ? R_BIG : R_SMALL;
        x += rPrev + GAP + r;
      }
      positions.push({cx: x, r, isFront: s.isFront, li: s.li});
    });
    return positions;
  }

  // ‚îÄ‚îÄ Largeur max de toutes les couches ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let maxLayerW = 0;
  floors.forEach(f => {
    const pos = layerPositions(f.front, f.back);
    if(pos.length) {
      const last = pos[pos.length-1];
      const w = last.cx + last.r;
      if(w > maxLayerW) maxLayerW = w;
    }
  });

  const layerH    = R_BIG * 2;
  const floorH    = f => f.double
    ? layerH + ROW_GAP + layerH + SHELF_H + FLOOR_GAP
    : layerH + SHELF_H + FLOOR_GAP;

  const totalW = PAD_H + maxLayerW + PAD_H;
  const totalH = PAD_V + floors.reduce((s,f) => s + floorH(f), 0) + PAD_V;

  svg.setAttribute('width',   totalW);
  svg.setAttribute('height',  totalH);
  svg.setAttribute('viewBox', `0 0 ${totalW} ${totalH}`);

  let html = `
    <defs>
      <filter id="softglow" x="-20%" y="-20%" width="140%" height="140%">
        <feGaussianBlur stdDeviation="1.8" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <rect width="${totalW}" height="${totalH}" fill="#080406" rx="4"/>
    <rect x="1" y="1" width="${totalW-2}" height="${totalH-2}"
      fill="none" stroke="#3a2830" stroke-width="1" rx="3"/>
  `;

  // Bords lat√©raux bois
  const sideH = totalH - PAD_V * 2;
  html += `<rect x="${PAD_H-14}" y="${PAD_V}" width="6" height="${sideH}" fill="#1c0a04" rx="2"/>`;
  html += `<rect x="${PAD_H+maxLayerW+8}" y="${PAD_V}" width="6" height="${sideH}" fill="#1c0a04" rx="2"/>`;

  let yTop = PAD_V;

  floors.forEach(floor => {
    const layers = floor.double ? 2 : 1;
    const fH     = floorH(floor);
    const pos    = layerPositions(floor.front, floor.back);

    // Fond de l'√©tage
    html += `<rect x="${PAD_H-6}" y="${yTop-3}"
      width="${maxLayerW+12}" height="${fH - FLOOR_GAP + 3}"
      fill="${floor.double ? '#0f0a0c' : '#0b0709'}" rx="2"/>`;

    for(let layer = 0; layer < layers; layer++) {
      const yCenter    = yTop + layer * (layerH + ROW_GAP) + R_BIG;
      const slotOffset = layer * (floor.front + floor.back);

      pos.forEach(p => {
        const slot  = slotOffset + (p.isFront ? p.li + 1 : floor.front + p.li + 1);
        const wine  = getWineAtSlot(currentCave, floor.id, slot);
        const col   = wine ? (WINE_COLORS[wine.type] || WINE_COLORS.empty) : WINE_COLORS.empty;
        const empty = !wine;
        const cx      = PAD_H + p.cx;
        const cy      = yCenter;
        // Couche sup√©rieure (layer=1) : on inverse cul/goulot pour l'imbrication
        const isFront = floor.double && layer === 1 ? !p.isFront : p.isFront;
        const r       = isFront ? R_BIG : R_SMALL;

        // Cercle principal
        html += `<circle cx="${cx}" cy="${cy}" r="${r}"
          fill="${col.fill}" stroke="${col.stroke}"
          stroke-width="${empty ? 0.7 : (isFront ? 1.5 : 1.1)}"
          opacity="${empty ? 0.45 : 1}"
          ${(!empty) ? 'filter="url(#softglow)"' : ''}
          style="cursor:pointer"
          onclick="handleBottleClick(event,${currentCave},${floor.id},${slot})"
          data-cave="${currentCave}" data-floor="${floor.id}" data-slot="${slot}"/>`;

        if(isFront) {
          // Creux central du cul
          html += `<circle cx="${cx}" cy="${cy}" r="${r*0.28}"
            fill="${empty ? '#100a0e' : col.small}"
            opacity="${empty ? 0.35 : 0.88}"
            style="pointer-events:none"/>`;
          // Reflet
          if(!empty) {
            html += `<path d="M ${cx-r*0.52} ${cy-r*0.42} A ${r*0.6} ${r*0.6} 0 0 1 ${cx+r*0.28} ${cy-r*0.68}"
              stroke="rgba(255,255,255,0.20)" stroke-width="2.2" fill="none" stroke-linecap="round"
              style="pointer-events:none"/>`;
          }
        } else {
          // Petit reflet sur goulot
          if(!empty) {
            html += `<circle cx="${cx-r*0.32}" cy="${cy-r*0.35}" r="${r*0.25}"
              fill="rgba(255,255,255,0.15)" style="pointer-events:none"/>`;
          }
        }
      });
    }

    // Planche
    const shelfY = yTop + fH - FLOOR_GAP - SHELF_H;
    html += `<rect x="${PAD_H-8}" y="${shelfY}" width="${maxLayerW+16}" height="${SHELF_H}"
      fill="#200e08" rx="1"/>`;
    html += `<rect x="${PAD_H-8}" y="${shelfY+SHELF_H}" width="${maxLayerW+16}" height="3"
      fill="rgba(0,0,0,0.45)" rx="1"/>`;

    // S√©parateur couche double
    if(floor.double) {
      const midY = yTop + layerH + ROW_GAP * 0.5;
      html += `<line x1="${PAD_H}" y1="${midY}" x2="${PAD_H+maxLayerW}" y2="${midY}"
        stroke="#1e1018" stroke-width="0.5" stroke-dasharray="4,7"/>`;
    }

    yTop += fH;
  });

  svg.innerHTML = html;

  // ‚îÄ‚îÄ Tooltip au survol ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  svg.querySelectorAll('circle[data-cave]').forEach(el => {
    el.addEventListener('mouseenter', (e) => {
      const cave  = parseInt(el.dataset.cave);
      const floor = parseInt(el.dataset.floor);
      const slot  = parseInt(el.dataset.slot);
      const wine  = getWineAtSlot(cave, floor, slot);
      const tt    = document.getElementById('tooltip');
      const floorData = CAVE_CONFIG[cave].floors.find(f=>f.id===floor);
      if(wine) {
        document.getElementById('tt-name').textContent = wine.nom;
        document.getElementById('tt-info').innerHTML =
          `<span class="type-badge badge-${wine.type}" style="font-size:0.7rem">${TYPE_LABELS[wine.type]||wine.type}</span>
          ${wine.appellation ? `<br><i>${wine.appellation}</i>` : ''}
          <br>${wine.annee||'‚Äî'} ¬∑ ${wine.region||'‚Äî'}
          ${wine.prix ? `<br>${wine.prix} ‚Ç¨` : ''}
          ${wine.note ? `<br>${'‚òÖ'.repeat(parseInt(wine.note))}` : ''}
          <br><small style="color:#4a3840">√ât.${floor} ¬∑ #${slot}</small>`;
        const imgWrap = document.getElementById('tt-img-wrap');
        const imgEl   = document.getElementById('tt-img');
        if(wine.image) { imgEl.src = wine.image; imgWrap.style.display = 'block'; }
        else { imgWrap.style.display = 'none'; }
      } else {
        document.getElementById('tt-img-wrap').style.display = 'none';
        document.getElementById('tt-name').innerHTML = '<span class="tt-empty">Emplacement vide</span>';
        document.getElementById('tt-info').innerHTML =
          `${floorData?.label} ¬∑ #${slot}<br><small style="color:#5a4050">Cliquer pour ajouter</small>`;
      }
      tt.style.display = 'block';
      tt.style.left = (e.clientX + 16) + 'px';
      tt.style.top  = (e.clientY - 12) + 'px';
    });
    el.addEventListener('mousemove', (e) => {
      const tt = document.getElementById('tooltip');
      tt.style.left = (e.clientX + 16) + 'px';
      tt.style.top  = (e.clientY - 12) + 'px';
    });
    el.addEventListener('mouseleave', () => {
      document.getElementById('tooltip').style.display = 'none';
    });
  });
}

// =====================================================================
// SLOT MODAL
// =====================================================================
function openSlotModal(cave, floor, slot) {
  const wine      = getWineAtSlot(cave, floor, slot);
  const floorData = CAVE_CONFIG[cave].floors.find(f=>f.id===floor);
  document.getElementById('modal-title').textContent =
    `Cave ${cave} ¬∑ ${floorData?.label} ¬∑ Emplacement #${slot}`;
  const body = document.getElementById('modal-body');
  if(wine) {
    const stars  = '‚òÖ'.repeat(parseInt(wine.note)||0)+'‚òÜ'.repeat(5-(parseInt(wine.note)||0));
    const tLabel = TYPE_LABELS[wine.type] || wine.type;
    const fLabel = FORMAT_LABELS[wine.format] || (wine.format||'75 cl');
    const imgHtml = wine.image ? `<div style="text-align:center;margin-bottom:18px">
        <img src="${wine.image}" alt="√âtiquette" id="etiquette-img" style="max-height:200px;max-width:100%;object-fit:contain;border-radius:4px;border:1px solid #3a2830;box-shadow:0 4px 20px rgba(0,0,0,0.7);cursor:pointer;transition:max-height 0.4s ease" onclick="this.style.maxHeight=this.style.maxHeight==='200px'||!this.style.maxHeight?'520px':'200px'" title="Cliquer pour agrandir">
        <div style="font-size:0.68rem;color:var(--text2);margin-top:5px;letter-spacing:1px">‚Üï CLIQUER POUR AGRANDIR</div>
      </div>` : '';
    body.innerHTML = `
      ${imgHtml}
      <div style="display:flex;gap:20px;align-items:flex-start">
        <div style="flex:1">
          <div class="modal-info-panel">
            <div class="info-cell" style="grid-column:1/-1">
              <div class="lbl">Nom</div>
              <div class="val" style="font-size:1.15rem">${wine.nom}</div>
              ${wine.appellation?`<div style="font-size:0.85rem;color:var(--text2);font-style:italic;margin-top:2px">${wine.appellation}</div>`:''}
            </div>
            <div class="info-cell"><div class="lbl">Type</div><div class="val"><span class="type-badge badge-${wine.type}">${tLabel}</span></div></div>
            <div class="info-cell"><div class="lbl">Format</div><div class="val"><span class="format-badge">${fLabel}</span></div></div>
            <div class="info-cell"><div class="lbl">Mill√©sime</div><div class="val">${wine.annee||'‚Äî'}</div></div>
            <div class="info-cell"><div class="lbl">Prix</div><div class="val">${wine.prix?wine.prix+'‚Ç¨':'‚Äî'}</div></div>
            <div class="info-cell"><div class="lbl">Domaine</div><div class="val">${wine.domaine||'‚Äî'}</div></div>
            <div class="info-cell"><div class="lbl">R√©gion</div><div class="val">${wine.region||'‚Äî'}</div></div>
            <div class="info-cell"><div class="lbl">Note</div><div class="val rating-stars" style="font-size:1rem">${stars}</div></div>
          </div>
          ${wine.notes?`<div style="color:var(--text2);font-style:italic;margin-bottom:16px;line-height:1.6;font-size:0.95rem">"${wine.notes}"</div>`:''}
          ${wine.accords?`<div style="margin-bottom:14px"><div style="font-size:0.68rem;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Accords mets-vins</div><div style="color:var(--gold2);font-size:0.9rem">üçΩ ${wine.accords}</div></div>`:''}
          ${(wine.apogeeDebut||wine.apogeeFin)?`<div style="margin-bottom:14px"><div style="font-size:0.68rem;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Fen√™tre d'apog√©e</div><div style="font-size:0.95rem">${getApogeeLabel(wine)}</div></div>`:''}"
          <div class="modal-actions">
            <button class="btn-outline" data-edit-id="${wine.id}" onclick="openEditModal(this.dataset.editId)">‚úè Modifier</button>
            <button class="btn-outline" data-mv-id="${wine.id}"   onclick="openDeplacerModal(this.dataset.mvId)">üì¶ D√©placer</button>
            <button class="btn-danger"  data-rm-id="${wine.id}"   onclick="removeWine(this.dataset.rmId)">üóë Retirer</button>
            <button class="btn-wine"    onclick="closeModal('modalSlot')">Fermer</button>
          </div>
        </div>
      </div>`;
  } else {
    body.innerHTML = `
      <div style="text-align:center;padding:20px 0;color:var(--text2);font-style:italic;margin-bottom:20px">
        Emplacement libre${floorData?.isMagnum?' ¬∑ R√©serv√© Magnums':''}
      </div>
      <div class="modal-actions">
        <button class="btn-wine" onclick="openAddToSlot(${cave},${floor},${slot})">‚ûï Placer un vin ici</button>
        <button class="btn-outline" onclick="closeModal('modalSlot')">Fermer</button>
      </div>`;
  }
  document.getElementById('modalSlot').classList.add('open');
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function openAddToSlot(cave, floor, slot) {
  closeModal('modalSlot');
  addingToSlot = {cave, floor, slot};
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===3));
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.getElementById('add').classList.add('active');
  document.getElementById('f-cave').value = cave;
  updateEtageSelect();
  document.getElementById('f-etage').value = floor;
  updateSlotSelect();
  document.getElementById('f-slot').value = slot;
  if(CAVE_CONFIG[cave].floors.find(f=>f.id==floor)?.isMagnum) {
    document.getElementById('f-type').value   = 'magnum';
    document.getElementById('f-format').value = '150cl';
  }
  showNotif(`Cave ${cave} ¬∑ √âtage ${floor} ¬∑ Emplacement #${slot}`);
}

function openEditModal(id) {
  const wine = wineData.find(w=>String(w.id)===String(id));
  if(!wine) return;
  closeModal('modalSlot');
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===3));
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.getElementById('add').classList.add('active');
  document.getElementById('f-nom').value         = wine.nom;
  document.getElementById('f-appellation').value = wine.appellation||'';
  document.getElementById('f-domaine').value     = wine.domaine||'';
  document.getElementById('f-region').value      = wine.region||'';
  document.getElementById('f-type').value        = wine.type;
  document.getElementById('f-format').value      = wine.format||'75cl';
  document.getElementById('f-annee').value       = wine.annee||'';
  document.getElementById('f-prix').value        = wine.prix||'';
  document.getElementById('f-note').value        = wine.note||'';
  document.getElementById('f-notes').value       = wine.notes||'';
  const accordsField = document.getElementById('f-accords'); if(accordsField) accordsField.value = wine.accords||'';
  const apDebut = document.getElementById('f-apogee-debut'); if(apDebut) apDebut.value = wine.apogeeDebut||'';
  const apFin   = document.getElementById('f-apogee-fin');   if(apFin)   apFin.value   = wine.apogeeFin||'';
  const imgField = document.getElementById('f-image'); if(imgField) imgField.value = wine.image||'';
  document.getElementById('f-cave').value        = wine.cave;
  addingToSlot = {editing:String(id), cave:wine.cave, floor:wine.floor, slot:wine.slot};
  updateEtageSelect();
  document.getElementById('f-etage').value = wine.floor;
  updateSlotSelect();
  document.getElementById('f-slot').value  = wine.slot;
  showNotif('Mode √©dition ‚Äî modifiez puis validez');
}

function removeWine(id) {
  const wine = wineData.find(w=>String(w.id)===String(id));
  if(!wine) return;
  openHistoriqueModal(wine);
}

function openHistoriqueModal(wine) {
  const mo = document.getElementById('modalHistorique');
  document.getElementById('histo-wine-name').textContent = (wine.nom||'') + (wine.annee?' '+wine.annee:'');
  document.getElementById('histo-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('histo-note').value = wine.note || '';
  document.getElementById('histo-commentaire').value = '';
  document.getElementById('histo-occasion').value = '';
  mo._wine = wine;
  mo.classList.add('open');
}

function confirmRetirer(saveToHisto) {
  const mo = document.getElementById('modalHistorique');
  const wine = mo._wine;
  if(!wine) return;

  if(saveToHisto) {
    const entry = {
      id:           'h_' + Date.now(),
      date:         document.getElementById('histo-date').value,
      nom:          wine.nom || '',
      appellation:  wine.appellation || '',
      domaine:      wine.domaine || '',
      region:       wine.region || '',
      annee:        wine.annee || '',
      type:         wine.type || '',
      note:         document.getElementById('histo-note').value,
      commentaire:  document.getElementById('histo-commentaire').value,
      occasion:     document.getElementById('histo-occasion').value,
      image:        wine.image || ''
    };
    historiqueData.unshift(entry);
    saveHistoriqueToSheets(entry);
    showNotif('D√©gustation enregistr√©e ‚úì');
  }

  mo.classList.remove('open');
  wineData = wineData.filter(w=>String(w.id)!==String(wine.id));
  saveData();
  closeModal('modalSlot');
  renderCave2D();
  renderList();
  renderHistorique();
  if(!saveToHisto) showNotif('Vin retir√© ‚úì');
}

// =====================================================================
// FORM
// =====================================================================
function updateFormSelects() { updateEtageSelect(); }

function updateEtageSelect() {
  const cave = parseInt(document.getElementById('f-cave').value)||1;
  const sel  = document.getElementById('f-etage');
  sel.innerHTML = '';
  CAVE_CONFIG[cave].floors.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f.id;
    opt.textContent = f.label + (f.isMagnum?' ¬∑ Magnums':'');
    sel.appendChild(opt);
  });
  sel.onchange = updateSlotSelect;
  updateSlotSelect();
}

function updateSlotSelect() {
  const cave      = parseInt(document.getElementById('f-cave').value)||1;
  const floor     = parseInt(document.getElementById('f-etage').value)||1;
  const floorData = CAVE_CONFIG[cave].floors.find(f=>f.id===floor);
  if(!floorData) return;
  const sel = document.getElementById('f-slot');
  sel.innerHTML = '';
  for(let i=1; i<=floorData.slots; i++) {
    const taken     = getWineAtSlot(cave,floor,i);
    const editingId = addingToSlot?.editing;
    const isSelf    = editingId && String(taken?.id)===String(editingId);
    if(taken && !isSelf) continue;
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `Emplacement ${i}`;
    sel.appendChild(opt);
  }
  if(sel.options.length===0) {
    const opt = document.createElement('option');
    opt.value=''; opt.textContent='‚Äî √âtage complet ‚Äî';
    sel.appendChild(opt);
  }
}

function addWine() {
  const nom   = document.getElementById('f-nom').value.trim();
  const cave  = document.getElementById('f-cave').value;
  const floor = document.getElementById('f-etage').value;
  const slot  = document.getElementById('f-slot').value;
  if(!nom)  { showNotif('Le nom est requis', true); return; }
  if(!slot) { showNotif('Aucun emplacement disponible', true); return; }
  const editingId = addingToSlot?.editing;
  if(editingId) wineData = wineData.filter(w=>String(w.id)!==String(editingId));
  wineData.push({
    id: editingId || Date.now().toString(),
    nom,
    appellation: document.getElementById('f-appellation').value.trim(),
    domaine:     document.getElementById('f-domaine').value.trim(),
    region:      document.getElementById('f-region').value.trim(),
    type:        document.getElementById('f-type').value,
    format:      document.getElementById('f-format').value,
    annee:       document.getElementById('f-annee').value,
    prix:        document.getElementById('f-prix').value,
    note:        document.getElementById('f-note').value,
    notes:       document.getElementById('f-notes').value.trim(),
    accords:     document.getElementById('f-accords') ? document.getElementById('f-accords').value.trim() : '',
    apogeeDebut: document.getElementById('f-apogee-debut') ? document.getElementById('f-apogee-debut').value : '',
    apogeeFin:   document.getElementById('f-apogee-fin')   ? document.getElementById('f-apogee-fin').value   : '',
    image:       document.getElementById('f-image') ? document.getElementById('f-image').value.trim() : '',
    cave:  parseInt(cave), floor: parseInt(floor), slot: parseInt(slot),
    dateAjout: new Date().toISOString().split('T')[0]
  });
  saveData(); addingToSlot = null;
  ['f-nom','f-appellation','f-domaine','f-region','f-annee','f-prix','f-notes','f-image','f-accords','f-apogee-debut','f-apogee-fin'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=''});
  document.getElementById('f-note').value='';
  document.getElementById('f-type').value='rouge';
  document.getElementById('f-format').value='75cl';
  renderCave2D();
  showNotif('Vin ajout√© avec succ√®s ‚úì');
}

// =====================================================================
// LIST
// =====================================================================
function renderList() {
  const q    = document.getElementById('searchInput').value.toLowerCase();
  const cave = document.getElementById('filterCave').value;
  const type = document.getElementById('filterType').value;
  const sort = document.getElementById('sortBy').value;
  let wines  = wineData.filter(w => {
    if(cave && w.cave!=cave) return false;
    if(type && w.type!==type) return false;
    if(q && !([w.nom,w.appellation,w.region,w.domaine].join(' ').toLowerCase().includes(q))) return false;
    return true;
  });
  wines.sort((a,b) => {
    if(sort==='annee')       return (b.annee||0)-(a.annee||0);
    if(sort==='prix')        return (b.prix||0)-(a.prix||0);
    if(sort==='type')        return a.type.localeCompare(b.type);
    if(sort==='appellation') return (a.appellation||'').localeCompare(b.appellation||'');
    if(sort==='region')      return (a.region||'').localeCompare(b.region||'');
    if(sort==='domaine')     return (a.domaine||'').localeCompare(b.domaine||'');
    return a.nom.localeCompare(b.nom);
  });
  const cont = document.getElementById('listContainer');
  if(wines.length===0) {
    cont.innerHTML=`<div class="empty-state">Aucun vin ¬∑ <a href="#" onclick="document.querySelectorAll('.tab')[3].click()" style="color:var(--gold);text-decoration:none">Ajouter</a></div>`;
    return;
  }
  let html=`<table class="wine-table"><thead><tr>
    <th>Nom</th><th>Appellation</th><th>Domaine / Producteur</th><th>Type</th><th>Format</th><th>Mill√©sime</th><th>R√©gion</th><th>Cave</th><th>Position</th><th>Prix</th><th></th>
  </tr></thead><tbody>`;
  wines.forEach(w => {
    const tLabel = TYPE_LABELS[w.type]||w.type;
    const fLabel = FORMAT_LABELS[w.format]||(w.format||'75 cl');
    html += `<tr onclick="openSlotModal(${w.cave},${w.floor},${w.slot})" title="Voir">
      <td><b style="color:var(--cream)">${w.nom||'‚Äî'}</b></td>
      <td style="color:var(--text2);font-style:italic">${w.appellation||'‚Äî'}</td>
      <td style="color:var(--text2)">${w.domaine||'‚Äî'}</td>
      <td><span class="type-badge badge-${w.type}">${tLabel}</span></td>
      <td><span class="format-badge">${fLabel}</span></td>
      <td>${w.annee||'‚Äî'}</td>
      <td>${w.region||'‚Äî'}</td>
      <td>Cave ${w.cave}</td>
      <td style="white-space:nowrap">√ât.${w.floor} #${w.slot}</td>
      <td>${w.prix?w.prix+'‚Ç¨':'‚Äî'}</td>
      <td><button class="btn-danger" style="padding:4px 9px;font-size:0.78rem" onclick="event.stopPropagation();removeWine('${w.id}')">‚úï</button></td>
    </tr>`;
  });
  html += '</tbody></table>';
  cont.innerHTML = html;
}

// =====================================================================
// STATS
// =====================================================================
function renderStats() {
  const total   = wineData.length;
  const val     = wineData.reduce((s,w)=>s+(parseFloat(w.prix)||0),0);
  const avgPrix = total ? Math.round(val/total) : 0;
  const types   = {}; wineData.forEach(w=>{ const t=w.type||'autre'; types[t]=(types[t]||0)+1; });
  const decades = {}; wineData.forEach(w=>{ if(w.annee){ const d=Math.floor(w.annee/10)*10; decades[d]=(decades[d]||0)+1; }});
  const regions = {}; wineData.forEach(w=>{ if(w.region){ regions[w.region]=(regions[w.region]||0)+1; }});
  const appells = {}; wineData.forEach(w=>{ if(w.appellation){ appells[w.appellation]=(appells[w.appellation]||0)+1; }});
  const cap1    = CAVE_CONFIG[1].floors.reduce((s,f)=>s+f.slots,0);
  const cap2    = CAVE_CONFIG[2].floors.reduce((s,f)=>s+f.slots,0);
  const occ1    = wineData.filter(w=>w.cave==1).length;
  const occ2    = wineData.filter(w=>w.cave==2).length;

  // Stat cards
  document.getElementById('statsGrid').innerHTML=`
    <div class="stat-card"><div class="s-val">${total}</div><div class="s-lbl">Bouteilles total</div></div>
    <div class="stat-card"><div class="s-val" style="color:var(--green2)">${Math.round(val).toLocaleString('fr-FR')} ‚Ç¨</div><div class="s-lbl">Valeur estim√©e</div></div>
    <div class="stat-card"><div class="s-val">${avgPrix} ‚Ç¨</div><div class="s-lbl">Prix moyen / bouteille</div></div>
    <div class="stat-card"><div class="s-val">${occ1+occ2}/${cap1+cap2}</div><div class="s-lbl">Taux remplissage global</div></div>`;

  // Helper pour g√©n√©rer les barres
  function makeBarChart(elId, data, colorFn, limit=15) {
    const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]).slice(0,limit);
    const maxV = Math.max(1,...sorted.map(e=>e[1]));
    document.getElementById(elId).innerHTML = sorted.length
      ? sorted.map(([k,v])=>`
        <div class="bar-row">
          <div class="bar-label" title="${k}">${k.length>14?k.slice(0,13)+'‚Ä¶':k}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${v/maxV*100}%;${colorFn(k)}"></div></div>
          <div class="bar-count">${v}</div>
        </div>`).join('')
      : '<div style="color:var(--text2);font-style:italic;padding:10px">Aucune donn√©e</div>';
  }

  // Type
  const typeOrder = ['rouge','blanc','ros√©','effervescent','vdn','magnum'];
  const typeNames = {rouge:'Rouge',blanc:'Blanc','ros√©':'Ros√©',effervescent:'Effervescent',vdn:'VDN',magnum:'Magnum'};
  const typeColors = {rouge:'background:linear-gradient(90deg,#5a1020,#9e2a3f)',blanc:'background:linear-gradient(90deg,#7a5a10,#c9a84c)','ros√©':'background:linear-gradient(90deg,#8a3050,#c06080)',effervescent:'background:linear-gradient(90deg,#204060,#5090c0)',vdn:'background:linear-gradient(90deg,#502080,#9040c0)',magnum:'background:linear-gradient(90deg,#4a2870,#9060c0)'};
  const maxT = Math.max(1,...Object.values(types));
  document.getElementById('chartType').innerHTML = typeOrder.map(t=>`
    <div class="bar-row">
      <div class="bar-label">${typeNames[t]||t}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${((types[t]||0)/maxT*100)}%;${typeColors[t]||'background:var(--wine)'}"></div></div>
      <div class="bar-count">${types[t]||0}</div>
    </div>`).join('');

  // Mill√©sime
  const decKeys = Object.keys(decades).sort();
  const maxD = Math.max(1,...Object.values(decades));
  document.getElementById('chartDecade').innerHTML = decKeys.length
    ? decKeys.map(d=>`
      <div class="bar-row">
        <div class="bar-label">${d}s</div>
        <div class="bar-track"><div class="bar-fill" style="width:${decades[d]/maxD*100}%;background:linear-gradient(90deg,#3a1828,#9e2a3f)"></div></div>
        <div class="bar-count">${decades[d]}</div>
      </div>`).join('')
    : '<div style="color:var(--text2);font-style:italic;padding:10px">Aucune ann√©e renseign√©e</div>';

  // R√©gion
  makeBarChart('chartRegion', regions, ()=>'background:linear-gradient(90deg,#1a3a2a,#2d7a4e)');

  // Appellation (top 15)
  makeBarChart('chartAppellation', appells, ()=>'background:linear-gradient(90deg,#2a1a3a,#6040a0)', 15);

  // Caves occupation
  document.getElementById('chartCaves').innerHTML = [
    {label:'Cave 1', occ:occ1, cap:cap1, color:'#9e2a3f'},
    {label:'Cave 2', occ:occ2, cap:cap2, color:'#c9a84c'}
  ].map(c=>{
    const pct = Math.round(c.occ/c.cap*100)||0;
    return `<div style="text-align:center;min-width:160px">
      <div style="position:relative;width:120px;height:120px;margin:0 auto">
        <svg viewBox="0 0 36 36" style="width:120px;height:120px;transform:rotate(-90deg)">
          <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--bg3)" stroke-width="3"/>
          <circle cx="18" cy="18" r="15.9" fill="none" stroke="${c.color}" stroke-width="3"
            stroke-dasharray="${pct} ${100-pct}" stroke-dashoffset="0" stroke-linecap="round"/>
        </svg>
        <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">
          <div style="font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--cream)">${pct}%</div>
          <div style="font-size:0.7rem;color:var(--text2)">${c.occ}/${c.cap}</div>
        </div>
      </div>
      <div style="margin-top:10px;color:var(--text2);font-size:0.85rem;letter-spacing:1px">${c.label}</div>
    </div>`;
  }).join('');
}

// =====================================================================
// NOTIF
// =====================================================================
function showNotif(msg, error=false) {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.className = 'show'+(error?' error':'');
  setTimeout(()=>n.className='', 3000);
}


// =====================================================================
// PASSWORD
// =====================================================================
async function checkPwd() {
  const val = document.getElementById('pwd-input').value.trim();
  if(!val) return;

  // Hasher ce que l'utilisateur a tap√© avec SHA-256
  const encoder = new TextEncoder();
  const data = encoder.encode(val);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

  // R√©cup√©rer le hash stock√© dans le Google Sheet
  const cbName = 'configCallback_' + Date.now();
  const timeout = setTimeout(() => {
    delete window[cbName];
    const s = document.getElementById('config-script');
    if(s) s.remove();
    showLoginError();
  }, 8000);

  window[cbName] = function(config) {
    clearTimeout(timeout);
    delete window[cbName];
    const s = document.getElementById('config-script');
    if(s) s.remove();
    const storedHash = config.password_hash || '';
    if(hashHex === storedHash) {
      sessionStorage.setItem('cave_auth', '1');
      document.getElementById('pwd-screen').classList.add('hidden');
      loadFromSheets();
    } else {
      showLoginError();
    }
  };

  const script = document.createElement('script');
  script.id = 'config-script';
  script.src = SCRIPT_URL + '?action=getConfig&callback=' + cbName + '&t=' + Date.now();
  document.body.appendChild(script);
}

function showLoginError() {
  const inp = document.getElementById('pwd-input');
  inp.classList.add('error');
  document.getElementById('pwd-error').textContent = 'Mot de passe incorrect';
  setTimeout(() => { inp.classList.remove('error'); inp.value = ''; }, 800);
}

function initAuth() {
  if(sessionStorage.getItem('cave_auth') === '1') {
    document.getElementById('pwd-screen').classList.add('hidden');
  }
  // Sinon l'√©cran mot de passe reste visible
}

// =====================================================================
// INIT
// =====================================================================
window.addEventListener('load', () => {
  updateHeader();
  updateEtageSelect();
  renderCave2D();
  initAuth();
  if(sessionStorage.getItem('cave_auth') === '1') {
    loadFromSheets();
  }
});

// =====================================================================
// VIVINO IMAGE SEARCH
// =====================================================================
function searchVivino() {
  const nom     = (document.getElementById('f-nom')?.value     || '').trim();
  const domaine = (document.getElementById('f-domaine')?.value || '').trim();
  const annee   = (document.getElementById('f-annee')?.value   || '').trim();
  if(!nom && !domaine) { showNotif('Entrez le nom du vin ou le producteur', true); return; }
  const queryStr = [domaine, nom, annee].filter(Boolean).join(' ');
  const query = encodeURIComponent(queryStr);
  const vivinoUrl = 'https://www.vivino.com/search/wines?q=' + query;
  const resultsBox = document.getElementById('vivino-results');
  const gridEl     = document.getElementById('vivino-grid');
  resultsBox.style.display = 'block';
  gridEl.innerHTML = `<div style="color:var(--text2);font-size:0.88rem;line-height:2">
    <a href="${vivinoUrl}" target="_blank" rel="noopener" style="display:inline-block;margin-bottom:12px;padding:8px 18px;background:var(--wine);color:var(--cream);text-decoration:none;border-radius:2px;font-size:0.95rem;letter-spacing:1px">üçá Ouvrir Vivino ‚Äî ${queryStr}</a><br>
    <span style="color:var(--cream)">1.</span> Cliquez le lien ci-dessus<br>
    <span style="color:var(--cream)">2.</span> Cliquez sur le vin voulu sur Vivino<br>
    <span style="color:var(--cream)">3.</span> Clic droit sur l'√©tiquette ‚Üí <i>Copier l'adresse de l'image</i><br>
    <span style="color:var(--cream)">4.</span> Collez l'URL dans le champ ci-dessus
  </div>`;
}


// =====================================================================
// HISTORIQUE
// =====================================================================
let historiqueData = [];

function saveHistoriqueToSheets(entry) {
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'saveHistorique', data: entry })
  }).catch(e => console.warn('Sync historique √©chou√©e', e));
}

function loadHistoriqueFromSheets() {
  const cbName = 'histoCallback_' + Date.now();
  const timeout = setTimeout(() => { delete window[cbName]; }, 8000);
  window[cbName] = function(data) {
    clearTimeout(timeout);
    delete window[cbName];
    if(Array.isArray(data)) {
      historiqueData = data.map(h => ({...h}));
      renderHistorique();
    }
  };
  const script = document.createElement('script');
  script.src = SCRIPT_URL + '?sheet=Historique&callback=' + cbName + '&t=' + Date.now();
  document.body.appendChild(script);
}

function renderHistorique() {
  const container = document.getElementById('histo-list');
  const empty     = document.getElementById('histo-empty');
  const count     = document.getElementById('histo-count');
  if(!container) return;
  if(!historiqueData.length) {
    empty.style.display = 'block';
    container.innerHTML = '';
    count.textContent = '';
    return;
  }
  empty.style.display = 'none';
  count.textContent = historiqueData.length + ' bouteille' + (historiqueData.length>1?'s':'') + ' bue' + (historiqueData.length>1?'s':'');

  const TYPE_COLORS = { rouge:'#7b1c2e', blanc:'#c9a84c', rose:'#d4607a', champagne:'#e8c870', other:'#555' };

  container.innerHTML = historiqueData.map((h,i) => {
    const stars  = '‚òÖ'.repeat(parseInt(h.note)||0) + '‚òÜ'.repeat(5-(parseInt(h.note)||0));
    const tColor = TYPE_COLORS[h.type] || TYPE_COLORS.other;
    const imgHtml = h.image ? `<img src="${h.image}" alt="" style="width:50px;height:70px;object-fit:contain;border-radius:3px;flex-shrink:0;border:1px solid var(--border)">` : `<div style="width:50px;height:70px;background:var(--bg3);border-radius:3px;flex-shrink:0;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;color:var(--text2);font-size:1.4rem">üç∑</div>`;
    return `<div style="display:flex;gap:16px;align-items:flex-start;padding:16px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;margin-bottom:10px">
      ${imgHtml}
      <div style="flex:1;min-width:0">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px">
          <div>
            <div style="font-family:'Playfair Display',serif;font-size:1.05rem;color:var(--cream)">${h.nom||'‚Äî'}${h.annee?' <span style="color:var(--text2);font-size:0.9rem">'+h.annee+'</span>':''}</div>
            <div style="font-size:0.82rem;color:var(--text2);margin-top:2px">${[h.domaine,h.appellation,h.region].filter(Boolean).join(' ¬∑ ')}</div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-size:0.75rem;color:var(--text2)">${h.date||''}</div>
            <div style="color:var(--gold);font-size:0.9rem;margin-top:2px">${stars}</div>
          </div>
        </div>
        ${h.occasion?`<div style="margin-top:6px;font-size:0.8rem;color:var(--text2);font-style:italic">üìç ${h.occasion}</div>`:''}
        ${h.commentaire?`<div style="margin-top:6px;font-size:0.88rem;color:var(--text2);line-height:1.5;font-style:italic">"${h.commentaire}"</div>`:''}
      </div>
    </div>`;
  }).join('');
}


// =====================================================================
// ACCORDS METS-VINS
// =====================================================================

// Accords automatiques par type de vin
const ACCORDS_AUTO = {

  // ============================================================
  // BOURGOGNE ROUGE - Pinot Noir
  // ============================================================
  "Gevrey-Chambertin": {
    plats: ["Becasse rotie au sang","Lievre a la royale","Chevreuil sauce poivrade","Carre d'agneau en croute d'herbes","Filet de boeuf Rossini","Pigeon roti aux truffes","Faisan aux ceps","Poularde demi-deuil","Ris de veau aux morilles noires","Epoisse affine a coeur","Ami du Chambertin","Langres au marc de Bourgogne"],
    mots: ["becasse","lievre","chevreuil","agneau","filet boeuf","pigeon","faisan","poularde","ris de veau","morilles","truffe","epoisse","ami chambertin","langres","gibier","volaille"]
  },
  "Chambolle-Musigny": {
    plats: ["Poularde de Bresse a la creme","Filet de sole au beurre blanc","Turbot roti aux asperges","Caille farcie aux raisins","Saint-Jacques a la vapeur","Veau en blanquette fine","Ris de veau poele aux girolles","Citeaux frais","Chaource cr√©meux"],
    mots: ["poularde","sole","turbot","asperges","caille","saint-jacques","veau","blanquette","girolles","citeaux","chaource","volaille","poisson","creme"]
  },
  "Vosne-Romanee": {
    plats: ["Becasse rotie entiere","Lievre a la royale version Cardinale","Chevreuil grand veneur","Filet de boeuf en croute sauce Perigueux","Turbot poche beurre noisette","Homard a la nage","Ris de veau aux truffes noires","Foie gras poele aux raisins","Epoisse tres affine","Ami du Chambertin"],
    mots: ["becasse","lievre","chevreuil","filet boeuf","truffe","homard","turbot","ris de veau","foie gras","epoisse","gibier","grand veneur"]
  },
  "Nuits-Saint-Georges": {
    plats: ["Carre d'agneau roti","Gigot de chevreuil","Pintade aux champignons","Coq au Chambertin","Andouillette de Chablis","Jambon persille de Bourgogne","Epoisse","Soumaintrain affine","Boeuf bourguignon traditionnel"],
    mots: ["agneau","chevreuil","pintade","coq au vin","andouillette","jambon persille","epoisse","soumaintrain","boeuf bourguignon","champignons"]
  },
  "Pommard": {
    plats: ["Gigot d'agneau de 7 heures","Daube de boeuf provencale","Canard aux olives","Cassoulet de Castelnaudary","Civet de sanglier","Lard fume aux lentilles du Puy","Epoisses","Munster affine","Maroilles"],
    mots: ["gigot agneau","daube boeuf","canard","cassoulet","sanglier","lentilles","epoisse","munster","maroilles","gibier","charcuterie"]
  },
  "Volnay": {
    plats: ["Carre de veau roti","Poularde pochee sauce supreme","Filet de turbot au beurre blanc","Rouget barbet grille","Ris de veau a la creme","Caille aux raisins de Corinthe","Brillat-Savarin","Chaource","Brie de Meaux affine"],
    mots: ["veau","poularde","turbot","rouget","ris de veau","caille","brillat savarin","chaource","brie","poisson","volaille"]
  },
  "Beaune": {
    plats: ["Coq au vin rouge de Bourgogne","Poulet roti et pommes dauphine","Lapin a la moutarde","Terrine de gibier","Jambon a l'os persille","Oeufs en meurette","Gateau de foies blonds","Epoisse jeune","Citeaux"],
    mots: ["coq au vin","poulet","lapin moutarde","terrine gibier","jambon persille","oeufs meurette","foies blonds","epoisse","citeaux"]
  },
  "Aloxe-Corton": {
    plats: ["Carre d'agneau roti au jus","Boeuf braise a la bourguignonne","Pintade aux morilles","Faisan en cocotte","Jambon braise au madere","Soumaintrain","Epoisse","Munster"],
    mots: ["agneau","boeuf braise","pintade","faisan","jambon braise","soumaintrain","epoisse","munster","gibier"]
  },
  "Marsannay": {
    plats: ["Saucisson chaud lyonnais","Andouillette grill√©e sauce moutarde","Lapin aux pruneaux","Poulet roti aux herbes","Jambon persille","Fromage de tete","Epoisses jeune","Citeaux"],
    mots: ["saucisson","andouillette","lapin pruneaux","poulet","jambon","fromage de tete","epoisse","citeaux"]
  },

  // ============================================================
  // BOURGOGNE BLANC - Chardonnay
  // ============================================================
  "Meursault": {
    plats: ["Homard bleu beurre blanc","Turbot sauce hollandaise","Saint-Jacques a la creme de corail","Sole meuniere beurre noisette","Ris de veau aux morilles a la creme","Poularde de Bresse a la creme","Feuillete d'escargots au beurre persille","Tarte fine aux asperges blanches","Comte vieux 18 mois","Beurre blanc nantais"],
    mots: ["homard","turbot","saint-jacques","sole","ris de veau","morilles","poularde","escargots","asperges","comte","creme","beurre blanc","crustaces"]
  },
  "Puligny-Montrachet": {
    plats: ["Homard a la nage","Turbot poche beurre blanc","Sole farcie aux langoustines","Saint-Jacques aux truffes blanches","Langoustines rotis beurre corail","Troncon de turbot a l'oseille","Bar sauvage en croute de sel","Blanc de volaille aux morilles","Feuillete de ris d'agneau"],
    mots: ["homard","turbot","sole","langoustines","saint-jacques","truffe blanche","bar","volaille","ris agneau","morilles","crustaces","poisson noble"]
  },
  "Chassagne-Montrachet": {
    plats: ["Coquille Saint-Jacques au beurre d'algues","Turbot braise aux champignons","Filet de bar beurre blanc","Sandre au beurre blanc","Poulet de Bresse roti a la creme","Feuillete de homard","Comte affine","Chaource","Poule au pot"],
    mots: ["saint-jacques","turbot","bar","sandre","poulet bresse","homard","comte","chaource","poule au pot","creme","beurre"]
  },
  "Chablis": {
    plats: ["Huitres de Marenne-Oleron","Huitres de Bretagne numero 3","Palourdes au naturel","Bulots mayonnaise","Crevettes grises","Langoustines pochees","Sole meuniere","Sole normande","Fruits de mer plateau","Andouillette de Chablis","Sandre sauce gribiche"],
    mots: ["huitres","palourdes","bulots","crevettes","langoustines","sole","fruits de mer","andouillette","sandre","coquillages","plateau mer"]
  },
  "Chablis Grand Cru": {
    plats: ["Huitres speciales de Claire","Homard breton","Langouste mayonnaise","Sole farcie aux truffes","Turbot au beurre blanc","Saint-Jacques au naturel","Caviar Oscietra","Foie gras de canard mi-cuit"],
    mots: ["huitres speciales","homard","langouste","sole truffee","turbot","saint-jacques","caviar","foie gras","crustaces nobles"]
  },
  "Macon-Villages": {
    plats: ["Grenouilles persillees","Quenelles de brochet sauce Nantua","Gateau de foies blonds","Terrine de brochet","Charcuterie lyonnaise","Saucisson brioch√©","Fromage blanc aux herbes","Epoisses jeune","Charolais frais"],
    mots: ["grenouilles","quenelles","brochet","foies blonds","charcuterie lyonnaise","saucisson brioche","fromage blanc","epoisse","charolais"]
  },
  "Pouilly-Fuisse": {
    plats: ["Grenouilles a la creme d'ail","Quenelles de brochet lyonnaises","Ecrevisses a la nage","Sandre au beurre blanc","Tarte aux morilles","Volaille de Bresse en cocotte","Comte jeune 8 mois","Beaufort d'alpage"],
    mots: ["grenouilles","quenelles","ecrevisses","sandre","morilles","volaille bresse","comte","beaufort","poisson riviere"]
  },
  "Saint-Veran": {
    plats: ["Poisson de riviere grille","Truite aux amandes","Charcuterie fine","Tarte aux legumes","Fromage de chevre frais","Maquee aux herbes","Beurre blanc"],
    mots: ["truite","poisson riviere","charcuterie fine","tarte legumes","chevre frais","herbes","beurre blanc"]
  },

  // ============================================================
  // JURA
  // ============================================================
  "Arbois": {
    plats: ["Poulet aux morilles et vin jaune du Jura","Carre de porc au Comt√©","Saucisse de Morteau en croute","Jambon du Jura chaud","Croute forestiere au Comt√©","Tarte aux morilles au vin jaune","Comte 18 mois","Morbier cr√©meux","Bleu de Gex"],
    mots: ["poulet morilles","vin jaune","morteau","jambon jura","croute comt√©","morilles","comte","morbier","bleu gex","porc","charcuterie jurassienne"]
  },
  "Arbois Vin Jaune": {
    plats: ["Poulet de Bresse aux morilles et vin jaune","Comt√© vieux 24 mois","Homard sauce corail au vin jaune","Ris de veau aux morilles et vin jaune","Foie gras chaud aux morilles","Becasse au vin jaune","Faisan aux morilles et creme de vin jaune","Langouste au vin jaune"],
    mots: ["poulet morilles","comte vieux","homard","ris de veau","foie gras","becasse","faisan","langouste","morilles","vin jaune"]
  },
  "Arbois Pupillin": {
    plats: ["Saucisse de Morteau lentilles","Jambon du Jura persille","Poulet roti au Jura","Fromage de tete","Morbier","Bleu de Gex","Raclette franc-comtoise"],
    mots: ["morteau","jambon jura","poulet","fromage tete","morbier","bleu gex","raclette","charcuterie"]
  },
  "Chateau-Chalon": {
    plats: ["Comt√© Grand Cru 30 mois minimum","Poulet de Bresse aux morilles sauce vin jaune","Homard au vin jaune","Ris de veau aux truffes et vin jaune","Becasse rotie au vin jaune","Foie gras mi-cuit aux figues et vin jaune","Langouste sauce corail","Turbot braise au vin jaune"],
    mots: ["comte grand cru","poulet morilles","homard","ris de veau truffes","becasse","foie gras","langouste","turbot","vin jaune","morilles"]
  },
  "L'Etoile": {
    plats: ["Quenelles de brochet sauce Nantua","Truite du Doubs aux amandes","Grenouilles a la creme","Feuillete aux morilles","Tarte aux asperges blanches","Comte 12 mois","Gruyere de Comt√©"],
    mots: ["quenelles","truite","grenouilles","morilles","asperges","comte","gruyere","poisson riviere"]
  },
  "Cotes du Jura": {
    plats: ["Saucisse de Montbeliard aux lentilles","Fondue comtoise au Comt√©","Gratin de macaronis au Comt√©","Poulet roti en cocotte","Lapin a la moutarde","Morbier chaud","Raclette du Jura","Bleu de Gex avec pain de noix"],
    mots: ["montbeliard","fondue","gratin comt√©","poulet","lapin moutarde","morbier","raclette","bleu gex","lentilles"]
  },
  "Macvin du Jura": {
    plats: ["Foie gras de canard mi-cuit","Terrine de foie gras aux abricots","Melon de Cavaillon","Roquefort sur pain brule","Tarte aux noix du P√©rigord","Desserts aux fruits rouges","Fraises au poivre"],
    mots: ["foie gras","melon","roquefort","tarte noix","desserts","fraises","aperitif","sucre"]
  },

  // ============================================================
  // PORTO / DOURO
  // ============================================================
  "Porto Ruby": {
    plats: ["Foie gras poele aux figues fraiches","Terrine de foie gras aux abricots","Stilton 18 mois sur pain de noix","Roquefort sur pain brule","Gateau au chocolat noir 72%","Fondant au chocolat coeur coulant","Tarte aux fruits rouges","Framboises au naturel","Creme brulee aux fruits rouges"],
    mots: ["foie gras","figues","stilton","roquefort","chocolat noir","fondant","tarte fruits rouges","framboises","creme brulee","fromage persille","sucre"]
  },
  "Porto Tawny": {
    plats: ["Tarte tatin aux pommes beurre sale","Mille-feuille caramel","Tarte aux noix du Perigord","Gateau de riz caramelise","Creme brulee a la vanille de Tahiti","Canele bordelais","Figues confites aux amandes","Stilton vieux","Fourme d'Ambert","Abricots secs aux amandes grillees"],
    mots: ["tarte tatin","mille feuille","caramel","tarte noix","gateau riz","creme brulee","canele","figues confites","stilton","fourme ambert","abricots"]
  },
  "Porto LBV": {
    plats: ["Gateau au chocolat noir intense 85%","Fondant au chocolat mi-cuit","Tarte au chocolat et fleur de sel","Roquefort vieux sur pain aux noix","Stilton sur crackers","Gateau basque a la cerise noire","Cerises a l'eau de vie","Pruneaux d'Agen au vieux Porto"],
    mots: ["chocolat noir intense","fondant","tarte chocolat","roquefort","stilton","gateau basque","cerises","pruneaux","fromage persille"]
  },
  "Porto Vintage": {
    plats: ["Stilton Grand Reserve","Roquefort Papillon vieux","Bleu de Termignon","Gateau au chocolat grand cru","Tarte sombrero chocolat-caramel","Figues fraiches au miel de thym","Grenade aux epices douces","Foie gras mi-cuit aux dattes"],
    mots: ["stilton grand reserve","roquefort vieux","bleu termignon","chocolat grand cru","figues miel","grenade","foie gras dattes","fromage persille vieux"]
  },
  "Douro": {
    plats: ["Bacalhau a bras traditionnel","Bacalhau a Gomes de Sa","Caldo verde au chourico","Leitao da Bairrada au four","Alheira de Mirandela grill√©e","Cozido a portuguesa","Bifanas au vin rouge","Posta de vitela transmontana","Queijo Serra da Estrela","Queijo Azeitao","Ameijoas a bulhao pato"],
    mots: ["bacalhau","morue","caldo verde","chourico","leitao","alheira","cozido","bifanas","vitela","queijo","ameijoas","cuisine portugaise","agneau","veau","saucisse"]
  },

  // ============================================================
  // ALSACE
  // ============================================================
  "Alsace Riesling": {
    plats: ["Choucroute garnie traditionnelle","Baeckeoffe a l'alsacienne","Tarte a l'oignon aux lardons","Foie gras d'oie au torchon","Sandre a la choucroute","Truite aux amandes","Quiche lorraine","Munster au cumin"],
    mots: ["choucroute","baeckeoffe","tarte oignon","foie gras oie","sandre","truite","quiche","munster","cuisine alsacienne"]
  },
  "Alsace Gewurztraminer": {
    plats: ["Foie gras d'oie au Gewurztraminer","Munster affine au cumin","Tarte aux mirabelles","Kougelhopf sale aux noix","Canard laque aux epices","Tajine de poulet aux citrons confits","Curry de crevettes a l'indienne","Poulet tikka masala"],
    mots: ["foie gras oie","munster","mirabelles","kougelhopf","canard laque","tajine","curry","tikka masala","epices","cuisine exotique"]
  },
  "Alsace Pinot Gris": {
    plats: ["Foie gras mi-cuit aux mirabelles","Chou farci a l'alsacienne","Presskopf","Baeckeoffe au porc","Quenelles de brochet","Volaille rotie aux mirabelles","Terrine de gibier","Munster"],
    mots: ["foie gras","mirabelles","chou farci","presskopf","baeckeoffe","quenelles","volaille","terrine gibier","munster"]
  },
  "Alsace Pinot Noir": {
    plats: ["Presskopf vinaigrette","Tarte flambee aux lardons","Coq au Riesling","Lapin aux pruneaux d'Alsace","Charcuterie alsacienne","Munster jeune","Carr√© de porc aux mirabelles"],
    mots: ["presskopf","tarte flambee","coq riesling","lapin pruneaux","charcuterie alsacienne","munster","porc mirabelles"]
  },
  "Cremant d'Alsace": {
    plats: ["Feuillete au fromage blanc","Tarte aux asperges","Terrine de saumon","Saumon fume d'Ecosse","Caviar de hareng","Aperitif alsacien","Munster jeune"],
    mots: ["feuillete","asperges","saumon fume","caviar hareng","aperitif","munster","bulle","petillant"]
  },

  // ============================================================
  // BORDEAUX
  // ============================================================
  "Pomerol": {
    plats: ["Agneau de Pauillac roti","Carre d'agneau aux herbes","Filet de boeuf sauce Perigueux","Cote de boeuf aux ceps","Canard aux cepes de Bordeaux","Foie gras poele aux raisins","Magret aux figues","Truffe noire du Perigord","Fromages a pate dure"],
    mots: ["agneau pauillac","carre agneau","filet boeuf","truffe noire","ceps","canard cepes","foie gras","magret figues","fromages"]
  },
  "Saint-Emilion": {
    plats: ["Entrecote bordelaise sauce au vin","Cote de boeuf aux cepes","Agneau de lait de Pauillac","Magret de canard aux figues","Foie gras poele","Canard confit aux ceps","Fromages du Perigord","Ossau-Iraty affine"],
    mots: ["entrecote","boeuf cepes","agneau pauillac","magret canard","foie gras","canard confit","fromages perigord","ossau iraty"]
  },
  "Medoc": {
    plats: ["Entrecote a la bordelaise","Gigot d'agneau roti","Carre d'agneau persillade","Cote de boeuf grille","Canard aux olives","Pintade aux cepes","Fromages a pate pressee"],
    mots: ["entrecote bordelaise","gigot agneau","carre agneau","cote boeuf","canard","pintade cepes","fromages presses"]
  },
  "Pauillac": {
    plats: ["Agneau de Pauillac en carre","Filet de boeuf en croute truffe","Becasse rotie sur canape","Cote de boeuf maturee","Chevreuil sauce grand veneur","Ris de veau aux truffes","Cantal vieux","Salers affine"],
    mots: ["agneau pauillac","filet boeuf truffe","becasse","cote boeuf maturee","chevreuil","ris de veau truffes","cantal vieux","salers"]
  },
  "Saint-Julien": {
    plats: ["Carre d'agneau en persillade","Filet de boeuf Wellington","Pintade aux cepes","Magret de canard aux myrtilles","Lievre a la royale","Fromages a pate pressee cuite"],
    mots: ["carre agneau","filet boeuf wellington","pintade cepes","magret myrtilles","lievre","fromages presses"]
  },
  "Margaux": {
    plats: ["Filet de boeuf en croute sauce truffe","Pigeon roti aux cepes","Carre d'agneau au jus","Sole meuniere beurre noisette","Caille aux raisins","Fromages fins a pate dure"],
    mots: ["filet boeuf truffe","pigeon cepes","carre agneau","sole","caille raisins","fromages fins"]
  },
  "Graves": {
    plats: ["Lamproie a la bordelaise","Entrecote bordelaise","Alose a l'oseille","Foie de veau a la bordelaise","Jambon de Bayonne","Fromages du Sud-Ouest"],
    mots: ["lamproie","entrecote","alose","foie veau","jambon bayonne","fromages sud ouest"]
  },
  "Pessac-Leognan": {
    plats: ["Turbot a la bordelaise","Sole sauce bordelaise","Homard en salade tiede","Saint-Jacques poelees","Foie gras de canard mi-cuit","Filet de bar au beurre blanc"],
    mots: ["turbot","sole","homard","saint-jacques","foie gras","bar","poisson noble","blanc bordeaux"]
  },
  "Sauternes": {
    plats: ["Foie gras d'oie au torchon","Foie gras de canard mi-cuit aux figues","Roquefort Papillon vieux","Stilton sur pain de noix","Tarte tatin aux pommes","Creme brulee a la cardamome","Abricots rotis au miel","Tarte aux peches blanches","Desserts aux fruits jaunes"],
    mots: ["foie gras oie","foie gras figues","roquefort","stilton","tarte tatin","creme brulee","abricots","peches","desserts fruits","sucre","liquoreux"]
  },
  "Barsac": {
    plats: ["Foie gras mi-cuit","Roquefort sur pain brule","Tarte aux fruits jaunes","Creme brulee vanille","Macarons aux fruits","Desserts legers"],
    mots: ["foie gras","roquefort","tarte fruits jaunes","creme brulee","macarons","desserts","liquoreux"]
  },

  // ============================================================
  // RHONE
  // ============================================================
  "Chateauneuf-du-Pape": {
    plats: ["Gigot d'agneau en croute d'herbes","Daube provencale au vin rouge","Carre d'agneau aux olives et thym","Sanglier aux baies de genievre","Perdrix aux ceps","Taureau de Camargue braise","Tapenade noire","Fromages de brebis des Alpilles","Banon a la feuille"],
    mots: ["gigot agneau","daube provencale","sanglier","perdrix","taureau camargue","ceps","olives","thym","fromage brebis","banon","herbes provence"]
  },
  "Cote-Rotie": {
    plats: ["Becasse rotie sur canape","Pigeon roti aux olives","Caille farcie aux herbes","Filet d'agneau en croute","Chevreuil sauce poivrade","Fromage de brebis","Pelardon des Cevennes"],
    mots: ["becasse","pigeon","caille","agneau","chevreuil","fromage brebis","pelardon","gibier","viognier"]
  },
  "Hermitage": {
    plats: ["Becasse au sang","Lievre en civet","Truffes noires du Tricastin","Cote de boeuf maturee","Canard aux olives","Fromages du Massif Central","Bleu des Causses"],
    mots: ["becasse","lievre","truffes","cote boeuf","canard olives","fromages massif central","bleu causses"]
  },
  "Hermitage blanc": {
    plats: ["Homard a la provencale","Turbot aux herbes","Saint-Jacques au safran","Loup en croute de sel","Brandade de morue","Tapenade verte","Fromage de chevre frais"],
    mots: ["homard","turbot","saint-jacques","safran","loup","brandade","tapenade verte","chevre frais"]
  },
  "Condrieu": {
    plats: ["Foie gras de canard mi-cuit aux abricots","Homard a la creme de safran","Saint-Jacques a la vanille","Quenelles de brochet sauce Nantua","Poularde de Bresse a la creme","Turbot poche beurre blanc","Fromage de chevre frais du Pilat"],
    mots: ["foie gras abricots","homard safran","saint-jacques vanille","quenelles","poularde","turbot","chevre frais","viognier","creme"]
  },
  "Gigondas": {
    plats: ["Carre d'agneau aux herbes de Provence","Daube provencale","Sanglier aux airelles","Perdrix aux cepes","Fromages de brebis Provence","Tapenade noire","Magret de canard aux figues"],
    mots: ["agneau herbes","daube","sanglier","perdrix cepes","fromage brebis","tapenade","magret figues"]
  },
  "Vacqueyras": {
    plats: ["Daube d'agneau aux olives noires","Pieds et paquets marseillais","Sanglier en rago√ªt","Perdreaux rotis","Fromages de Provence"],
    mots: ["daube agneau","pieds paquets","sanglier","perdreaux","fromages provence"]
  },
  "Crozes-Hermitage": {
    plats: ["Gratin dauphinois au Raclette","Poulet roti aux olives","Cotes d'agneau grillees","Charcuteries de l'Ardeche","Fromages de ch√®vre de la Drome"],
    mots: ["gratin dauphinois","poulet olives","agneau grille","charcuteries ardeche","chevre drome"]
  },
  "Saint-Joseph": {
    plats: ["Carre d'agneau grille","Saucisson de Lyon brioch√©","Quenelles sauce aurore","Gateau de foies blonds","Fromage de chevre du Pilat"],
    mots: ["agneau grille","saucisson brioch√©","quenelles","foies blonds","chevre pilat","charcuterie lyonnaise"]
  },
  "Tavel": {
    plats: ["Bouillabaisse de Marseille","Bourride de lotte","Tapenade et anchoiade","Salade nicoise authentique","Grillades de viandes","Daurade royale grill√©e","Brandade de morue nimoise"],
    mots: ["bouillabaisse","bourride","tapenade","anchoiade","salade nicoise","grillades","daurade","brandade","mediterraneen"]
  },
  "Muscat de Beaumes-de-Venise": {
    plats: ["Melon de Cavaillon au jambon cru","Fraises de Carpentras au sucre","Peches blanches au naturel","Tarte aux fruits d'ete","Macarons aux amandes","Nougat de Montelimar","Desserts aux abricots"],
    mots: ["melon","fraises","peches","tarte fruits","macarons","nougat","abricots","desserts","doux naturel"]
  },

  // ============================================================
  // LOIRE
  // ============================================================
  "Sancerre": {
    plats: ["Crottin de Chavignol chaud sur salade","Chevre frais aux herbes","Asperges vertes beurre blanc","Saumon en papillote au fenouil","Sandre au beurre blanc nantais","Truite en papillote","Grenouilles persillees","Terrine de poisson"],
    mots: ["crottin chavignol","chevre frais","asperges","saumon","sandre","truite","grenouilles","terrine poisson","beurre blanc"]
  },
  "Pouilly-Fume": {
    plats: ["Huitres fines de Bretagne","Saumon fume irlandais","Sandre au beurre blanc","Grenouilles a la creme d'ail","Crottin de Chavignol","Chevre sec de la Loire","Asperges blanches hollandaise"],
    mots: ["huitres","saumon fume","sandre","grenouilles","crottin","chevre sec","asperges"]
  },
  "Vouvray": {
    plats: ["Rillettes de Tours","Rillons de Touraine","Andouille de Vouvray","Terrine de foie gras","Tarte tatin tourangelle","Tarte aux pommes reinettes","Fromage de chevre de Touraine","Sainte-Maure de Touraine"],
    mots: ["rillettes","rillons","andouille","foie gras","tarte tatin","tarte pommes","chevre touraine","sainte maure"]
  },
  "Muscadet": {
    plats: ["Huitres de la Baie de Bourgneuf","Moules mariniere","Palourdes farcies","Crevettes roses","Langoustines pochees","Sandre au beurre blanc nantais","Sole normande","Plateau de fruits de mer"],
    mots: ["huitres","moules","palourdes","crevettes","langoustines","sandre","sole","plateau mer","fruits de mer","beurre blanc nantais"]
  },
  "Anjou": {
    plats: ["Broche de Loire au beurre blanc","Sandre a l'oseille","Carpe en matelote","Terrine de canard","Rillettes d'Anjou","Fromage de chevre de l'Anjou"],
    mots: ["brochet","sandre","carpe","terrine canard","rillettes","chevre anjou","poisson loire"]
  },
  "Bourgueil": {
    plats: ["Carre d'agneau roti","Rillettes de Tours","Rillons de Touraine","Tarte aux rillettes","Lapin aux pruneaux","Fromages de Touraine"],
    mots: ["agneau","rillettes","rillons","tarte rillettes","lapin pruneaux","fromages touraine","cabernet franc"]
  },
  "Chinon": {
    plats: ["Rillettes de Tours chaudes","Andouillette de Troyes grill√©e","Lapin aux pruneaux de Touraine","Sainte-Maure de Touraine","Crottin de Chavignol","Poulet grille aux herbes"],
    mots: ["rillettes","andouillette","lapin pruneaux","sainte maure","crottin","poulet herbes","touraine","cabernet franc"]
  },
  "Coteaux du Layon": {
    plats: ["Foie gras de canard mi-cuit au Layon","Tarte tatin tourangelle","Tarte aux prunes Reine-Claude","Creme brulee au Cointreau","Fromage blanc a la creme","Sainte-Maure affine","Peches blanches au naturel"],
    mots: ["foie gras","tarte tatin","prunes","creme brulee","fromage blanc","sainte maure","peches","liquoreux","sucre"]
  },

  // ============================================================
  // CHAMPAGNE
  // ============================================================
  "Champagne": {
    plats: ["Huitres speciales de Claire au Champagne","Caviar Oscietra sur blinis","Foie gras de canard mi-cuit","Homard en bellevue","Langoustines pochees au Court-bouillon","Turbot en sauce Champagne","Feuillete de saint-jacques aux truffes","Aperitif raffin√©"],
    mots: ["huitres","caviar","blinis","foie gras","homard","langoustines","turbot","saint-jacques truffes","aperitif","crustaces nobles"]
  },
  "Champagne Blanc de Blancs": {
    plats: ["Huitres fines de Bretagne","Caviar Beluga ou Oscietra","Saumon fume d'Ecosse","Langoustines a la mayonnaise","Saint-Jacques au naturel","Aperitif avec petits fours sales"],
    mots: ["huitres fines","caviar","saumon fume","langoustines","saint-jacques","aperitif","fours sales"]
  },
  "Champagne Blanc de Noirs": {
    plats: ["Jambon de Reims en gelee","Andouillette de Troyes","Rillettes champenoises","Brie de Meaux affine","Langres au Marc de Bourgogne","Chaource cr√©meux"],
    mots: ["jambon reims","andouillette troyes","rillettes champenoises","brie meaux","langres","chaource","charcuterie champagne"]
  },
  "Champagne Rose": {
    plats: ["Carpaccio de boeuf aux truffes","Saumon fume avec creme fraiche","Fraises des bois au Champagne","Macarons aux fruits rouges","Foie gras en terrine","Agneau roti jus court"],
    mots: ["carpaccio","saumon fume","fraises","macarons fruits rouges","foie gras","agneau roti"]
  },

  // ============================================================
  // LANGUEDOC-ROUSSILLON
  // ============================================================
  "Banyuls": {
    plats: ["Gateau au chocolat noir 70% minimum","Fondant mi-cuit au chocolat","Tarte au chocolat fleur de sel","Souffl√© au chocolat amer","Anchois de Collioure marines","Gateau catalan","Creme catalane","Figues fraiches au miel"],
    mots: ["chocolat noir","fondant","tarte chocolat","souffle chocolat","anchois collioure","gateau catalan","creme catalane","figues miel","sucre intense"]
  },
  "Rivesaltes": {
    plats: ["Foie gras de canard aux abricots","Desserts aux fruits secs","Gateau aux pruneaux","Creme brulee a l'orange","Nougat de Montpellier","Desserts catalanes","Formage persille"],
    mots: ["foie gras abricots","fruits secs","pruneaux","creme brulee orange","nougat","catalan","fromage persille"]
  },
  "Minervois": {
    plats: ["Cassoulet de Castelnaudary","Agneau de Lozere grille","Daube languedocienne","Sanglier aux olives","Fromages du Languedoc","Pelardon des Cevennes"],
    mots: ["cassoulet","agneau lozere","daube languedoc","sanglier olives","fromages languedoc","pelardon"]
  },
  "Corbi√®res": {
    plats: ["Daurade royale grill√©e au romarin","Bouillabaisse adapt√©e","Agneau grille aux herbes","Charcuterie du Languedoc","Fromages de brebis des Corbi√®res","Tapenade et anchoiade"],
    mots: ["daurade grille","bouillabaisse","agneau herbes","charcuterie languedoc","fromage brebis","tapenade","anchois"]
  },
  "Fitou": {
    plats: ["Sanglier en daube","Lievre aux olives","Agneau des garrigues aux herbes","Fromages cors√©s du Languedoc","Charcuteries catalanes"],
    mots: ["sanglier daube","li√®vre olives","agneau garrigues","fromages corses","charcuteries catalanes"]
  },

  // ============================================================
  // SUD-OUEST
  // ============================================================
  "Madiran": {
    plats: ["Magret de canard aux figues","Confit de canard aux ceps","Cassoulet gersois","Cote de boeuf maturee","Garbure bearnaise","Fromage de brebis Pyrenees","Ossau-Iraty affine 6 mois"],
    mots: ["magret canard","confit","cassoulet","cote boeuf","garbure","ossau iraty","fromage brebis pyrenees","tannat"]
  },
  "Cahors": {
    plats: ["Magret de canard au miel","Confit de canard aux sarladaises","Foie gras poele","Truffe noire du Perigord","Daube de boeuf querycoise","Fromages du Lot","Rocamadour affine"],
    mots: ["magret miel","confit canard","foie gras","truffe noire","daube boeuf","rocamadour","fromages lot","malbec"]
  },
  "Bergerac": {
    plats: ["Magret de canard aux pruneaux","Confit aux pommes sarladaises","Foie gras de canard","Noix du Perigord","Fromages de la Dordogne","Cab√©cou frais"],
    mots: ["magret pruneaux","confit canard","foie gras","noix perigord","fromages dordogne","cabecou"]
  },
  "Monbazillac": {
    plats: ["Foie gras d'oie au torchon","Foie gras mi-cuit aux raisins","Roquefort vieux","Gateau aux noix du Perigord","Tarte aux prunes","Creme brulee au foie gras","Melon au jambon de Bayonne"],
    mots: ["foie gras oie","foie gras raisins","roquefort vieux","gateau noix","tarte prunes","melon jambon","liquoreux perigord"]
  },
  "Jurancon": {
    plats: ["Jambon de Bayonne mi-sel","Foie gras de canard frais","Fromage de brebis des Pyrenees","Ossau-Iraty","Truite de montagne","Tarte aux pommes reinettes","Gateaux basques"],
    mots: ["jambon bayonne","foie gras frais","fromage brebis","ossau iraty","truite montagne","tarte pommes","gateau basque","Manseng"]
  },
  "Armagnac": {
    plats: ["Foie gras de canard","Pruneaux d'Agen a l'Armagnac","Tarte aux pruneaux","Creme brulee a l'Armagnac","Gateau a la broche"],
    mots: ["foie gras","pruneaux agen armagnac","tarte pruneaux","creme brulee armagnac","gateau broche"]
  },

  // ============================================================
  // PROVENCE
  // ============================================================
  "Bandol": {
    plats: ["Daube provencale au vin de Bandol","Gigot d'agneau de Sisteron en croute","Carre d'agneau aux herbes de Provence","Sanglier a la provencale","Perdrix aux olives","Fromages de brebis de Provence","Banon a la feuille"],
    mots: ["daube","gigot agneau sisteron","sanglier","perdrix olives","fromage brebis","banon","herbes provence","mourv√®dre"]
  },
  "Bandol Rose": {
    plats: ["Bouillabaisse de Marseille","Bourride de lotte","Salade nicoise authentique","Grillades de viandes","Tapenade et anchoiade","Fromages de chevre frais de Provence"],
    mots: ["bouillabaisse","bourride","salade nicoise","grillades","tapenade","anchoiade","chevre frais provence"]
  },
  "Cotes de Provence": {
    plats: ["Grillades de viandes au thym","Salade nicoise","Ratatouille aux herbes","Pissaladiere","Tapenade noire","Fromages de chevre des Alpilles","Fromage de brebis Provence"],
    mots: ["grillades thym","salade","ratatouille","pissaladiere","tapenade","chevre alpilles","brebis provence","herbes"]
  },
  "Cassis": {
    plats: ["Bouillabaisse royale de Marseille","Bourride de lotte","Loup grille au fenouil","Daurade royale en croute de sel","Soupe de poissons rouille","Brandade de morue de Nimes"],
    mots: ["bouillabaisse","bourride","loup fenouil","daurade","soupe poissons","brandade","poissons mediterraeens"]
  },

  // ============================================================
  // SAVOIE
  // ============================================================
  "Roussette de Savoie": {
    plats: ["Fondue savoyarde au Beaufort","Tartiflette au Reblochon","Raclette de Savoie","Gratin dauphinois","Diots de Savoie","Poisson du lac au beurre blanc","Feras du lac L√©man poel√©es"],
    mots: ["fondue beaufort","tartiflette","raclette","gratin dauphinois","diots","poisson lac","feras leman","fromages savoie"]
  },
  "Cremant de Savoie": {
    plats: ["Aperitif savoyard","Feuillete au Beaufort","Saumon fume","Truite fum√©e du lac","Tomates au chevre frais","Tartelettes fines aux asperges"],
    mots: ["aperitif","feuillete beaufort","saumon fume","truite fumee","chevre frais","asperges"]
  },
  "Vin de Savoie": {
    plats: ["Fondue savoyarde","Raclette","Tartiflette traditionnelle","Gratin de crozets au Beaufort","Diots au vin blanc","Saucisses fumees savoyardes","Beaufort d'alpage","Reblochon fermier"],
    mots: ["fondue","raclette","tartiflette","gratin crozets","diots","saucisses fumees","beaufort","reblochon"]
  },

  // ============================================================
  // Fallback g√©n√©rique
  // ============================================================
  "rouge": {
    plats: ["Carre d'agneau roti","Boeuf en sauce","Gibier a plumes","Fromages affines","Charcuterie fine"],
    mots: ["agneau","boeuf","gibier","fromage affine","charcuterie","viande rouge"]
  },
  "blanc": {
    plats: ["Poisson noble grille","Fruits de mer","Volaille a la creme","Fromage de chevre","Asperges"],
    mots: ["poisson","fruits de mer","volaille","chevre","asperges","crustaces"]
  },
  "rose": {
    plats: ["Grillades","Salade composee","Charcuterie","Cuisine provencale"],
    mots: ["grillades","salade","charcuterie","provencal","aperitif"]
  },
  "effervescent": {
    plats: ["Aperitif","Fruits de mer","Foie gras","Desserts legers"],
    mots: ["aperitif","huitres","foie gras","desserts"]
  },
  "vdn": {
    plats: ["Foie gras","Chocolat noir","Fromage persille","Desserts"],
    mots: ["foie gras","chocolat","roquefort","stilton","desserts","sucre"]
  },
  "magnum": {
    plats: ["Grandes tablees","Repas de fete","Viandes rotis","Plateau de fromages"],
    mots: ["fete","tabl√©e","viande","fromages"]
  }
};


function populateVinSelect() {
  const sel = document.getElementById('accord-vin-select');
  if(!sel) return;
  const current = sel.value;
  sel.innerHTML = '<option value="">‚Äî Choisir un vin ‚Äî</option>';
  [...wineData].sort((a,b)=>(a.nom||'').localeCompare(b.nom||'')).forEach(w => {
    const opt = document.createElement('option');
    opt.value = w.id;
    opt.textContent = (w.nom||'Sans nom') + (w.annee?' '+w.annee:'') + (w.domaine?' ‚Äî '+w.domaine:'');
    sel.appendChild(opt);
  });
  if(current) sel.value = current;
}

function getAccordsForWine(w) {
  // Chercher par appellation exacte d'abord, puis par nom, puis par type
  const appellation = (w.appellation || '').trim();
  const nom         = (w.nom || '').trim();
  // Essayer appellation exacte
  if(appellation && ACCORDS_AUTO[appellation]) return ACCORDS_AUTO[appellation];
  // Essayer matching partiel sur les cl√©s
  const keys = Object.keys(ACCORDS_AUTO);
  const matchKey = keys.find(k => 
    appellation.toLowerCase().includes(k.toLowerCase()) || 
    k.toLowerCase().includes(appellation.toLowerCase()) ||
    nom.toLowerCase().includes(k.toLowerCase())
  );
  if(matchKey) return ACCORDS_AUTO[matchKey];
  // Fallback par type
  return ACCORDS_AUTO[w.type] || ACCORDS_AUTO["rouge"];
}

function rechercherParPlat() {
  const query = document.getElementById('accord-plat-input').value.trim().toLowerCase();
  const results = document.getElementById('accord-plat-results');
  if(!query) { results.innerHTML = ''; return; }

  const matches = wineData.filter(w => {
    // Accord manuel saisi sur le vin
    if(w.accords && w.accords.toLowerCase().includes(query)) return true;
    // Accord par appellation ou type
    const auto = getAccordsForWine(w);
    if(auto && auto.mots.some(m => query.includes(m.toLowerCase()) || m.toLowerCase().includes(query))) return true;
    return false;
  });

  if(!matches.length) {
    results.innerHTML = '<div style="color:var(--text2);font-style:italic;padding:10px 0">Aucun vin trouv√© pour ce plat dans votre cave</div>';
    return;
  }

  results.innerHTML = '<div style="font-size:0.78rem;color:var(--text2);margin-bottom:10px;letter-spacing:1px">' + matches.length + ' VIN' + (matches.length>1?'S':'') + ' SUGG√âR√â' + (matches.length>1?'S':'') + '</div>' +
    matches.map(w => wineCardHtml(w)).join('');
}

function rechercherParVin(id) {
  const results = document.getElementById('accord-vin-results');
  if(!id) { results.innerHTML = ''; return; }
  const wine = wineData.find(w=>String(w.id)===String(id));
  if(!wine) return;

  const auto  = getAccordsForWine(wine);
  const plats = wine.accords
    ? [...new Set([...wine.accords.split(',').map(s=>s.trim()), ...auto.plats])]
    : auto.plats;

  const sourceLabel = (() => {
    const appellation = (wine.appellation||'').trim();
    if(appellation && ACCORDS_AUTO[appellation]) return appellation;
    const keys = Object.keys(ACCORDS_AUTO);
    const matchKey = keys.find(k => appellation.toLowerCase().includes(k.toLowerCase()) || k.toLowerCase().includes(appellation.toLowerCase()));
    if(matchKey) return matchKey;
    return wine.type || 'G√©n√©ral';
  })();

  results.innerHTML = `
    <div style="font-size:0.78rem;color:var(--text2);margin-bottom:6px;letter-spacing:1px">ACCORDS SUGG√âR√âS <span style="color:var(--gold);margin-left:6px">‚Äî ${sourceLabel}</span></div>
    <div style="display:flex;flex-wrap:wrap;gap:8px">
      ${plats.map(p=>`<span style="padding:5px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:20px;font-size:0.85rem;color:var(--cream)">üçΩ ${p}</span>`).join('')}
    </div>`;
}

function wineCardHtml(w) {
  const tLabel = {rouge:'Rouge',blanc:'Blanc','ros√©':'Ros√©',effervescent:'Effervescent',vdn:'VDN',magnum:'Magnum'}[w.type] || w.type;
  return `<div style="display:flex;gap:12px;align-items:center;padding:10px;background:var(--bg3);border-radius:3px;margin-bottom:8px;border:1px solid var(--border)">
    ${w.image?`<img src="${w.image}" style="width:36px;height:50px;object-fit:contain;border-radius:2px;flex-shrink:0">`:'<div style="width:36px;height:50px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0">üç∑</div>'}
    <div style="flex:1;min-width:0">
      <div style="color:var(--cream);font-size:0.95rem">${w.nom||'‚Äî'}${w.annee?' <span style="color:var(--text2);font-size:0.8rem">'+w.annee+'</span>':''}</div>
      <div style="color:var(--text2);font-size:0.78rem;margin-top:2px">${[w.domaine,w.region].filter(Boolean).join(' ¬∑ ')}</div>
      ${w.accords?`<div style="color:var(--gold2);font-size:0.75rem;margin-top:3px">üçΩ ${w.accords}</div>`:''}
    </div>
    <span style="padding:2px 8px;border-radius:10px;font-size:0.7rem;background:var(--wine);color:var(--cream);flex-shrink:0">${tLabel}</span>
  </div>`;
}


// =====================================================================
// APOGEE
// =====================================================================

// Fen√™tres d'apog√©e automatiques par appellation (ann√©es apr√®s mill√©sime)
const APOGEE_AUTO = {
  // Bourgogne Grands Crus rouges
  "Gevrey-Chambertin":     { min: 8,  max: 25 },
  "Chambolle-Musigny":     { min: 6,  max: 20 },
  "Vosne-Romanee":         { min: 8,  max: 25 },
  "Nuits-Saint-Georges":   { min: 6,  max: 18 },
  "Pommard":               { min: 6,  max: 18 },
  "Volnay":                { min: 5,  max: 15 },
  "Beaune":                { min: 5,  max: 15 },
  "Aloxe-Corton":          { min: 6,  max: 18 },
  "Marsannay":             { min: 4,  max: 12 },
  // Bourgogne blancs
  "Meursault":             { min: 5,  max: 15 },
  "Puligny-Montrachet":    { min: 5,  max: 15 },
  "Chassagne-Montrachet":  { min: 5,  max: 15 },
  "Chablis Grand Cru":     { min: 5,  max: 20 },
  "Chablis Premier Cru":   { min: 4,  max: 12 },
  "Chablis":               { min: 3,  max: 8  },
  "Pouilly-Fuisse":        { min: 3,  max: 10 },
  "Macon-Villages":        { min: 2,  max: 6  },
  // Jura
  "Chateau-Chalon":        { min: 10, max: 40 },
  "Arbois Vin Jaune":      { min: 10, max: 40 },
  "Arbois":                { min: 4,  max: 15 },
  "Arbois Pupillin":       { min: 4,  max: 12 },
  "Cotes du Jura":         { min: 3,  max: 10 },
  "L'Etoile":              { min: 4,  max: 12 },
  "Macvin du Jura":        { min: 3,  max: 15 },
  // Porto / Douro
  "Porto Vintage":         { min: 15, max: 50 },
  "Porto LBV":             { min: 5,  max: 20 },
  "Porto Tawny":           { min: 0,  max: 5  },
  "Porto Ruby":            { min: 0,  max: 5  },
  "Douro":                 { min: 4,  max: 15 },
  // Bordeaux
  "Pomerol":               { min: 8,  max: 25 },
  "Saint-Emilion":         { min: 6,  max: 20 },
  "Pauillac":              { min: 10, max: 30 },
  "Saint-Julien":          { min: 8,  max: 25 },
  "Margaux":               { min: 8,  max: 25 },
  "Medoc":                 { min: 6,  max: 18 },
  "Graves":                { min: 5,  max: 15 },
  "Pessac-Leognan":        { min: 5,  max: 15 },
  "Sauternes":             { min: 8,  max: 30 },
  "Barsac":                { min: 6,  max: 25 },
  // Rh√¥ne
  "Chateauneuf-du-Pape":   { min: 6,  max: 20 },
  "Cote-Rotie":            { min: 6,  max: 20 },
  "Hermitage":             { min: 8,  max: 25 },
  "Hermitage blanc":       { min: 6,  max: 20 },
  "Condrieu":              { min: 2,  max: 6  },
  "Gigondas":              { min: 5,  max: 15 },
  "Vacqueyras":            { min: 4,  max: 12 },
  "Crozes-Hermitage":      { min: 4,  max: 12 },
  // Loire
  "Sancerre":              { min: 3,  max: 8  },
  "Pouilly-Fume":          { min: 3,  max: 8  },
  "Vouvray":               { min: 5,  max: 20 },
  "Coteaux du Layon":      { min: 8,  max: 25 },
  "Chinon":                { min: 4,  max: 12 },
  "Bourgueil":             { min: 4,  max: 12 },
  "Muscadet":              { min: 1,  max: 4  },
  // Champagne
  "Champagne":             { min: 5,  max: 15 },
  // Alsace
  "Alsace Riesling":       { min: 5,  max: 15 },
  "Alsace Gewurztraminer": { min: 4,  max: 12 },
  "Alsace Pinot Gris":     { min: 4,  max: 12 },
  // Languedoc
  "Banyuls":               { min: 5,  max: 20 },
  "Madiran":               { min: 6,  max: 18 },
  "Cahors":                { min: 5,  max: 15 },
  // Provence
  "Bandol":                { min: 5,  max: 15 },
  // Fallbacks par type
  "rouge":                 { min: 4,  max: 12 },
  "blanc":                 { min: 2,  max: 6  },
  "rose":                  { min: 1,  max: 3  },
  "effervescent":          { min: 2,  max: 8  },
  "vdn":                   { min: 5,  max: 20 },
};

function getApogeeAuto(wine) {
  if(!wine.annee) return null;
  const annee = parseInt(wine.annee);
  if(!annee) return null;
  const appellation = (wine.appellation||'').trim();
  const keys = Object.keys(APOGEE_AUTO);
  // Chercher par appellation exacte puis partielle puis type
  let rule = APOGEE_AUTO[appellation];
  if(!rule) {
    const matchKey = keys.find(k => appellation.toLowerCase().includes(k.toLowerCase()) || k.toLowerCase().includes(appellation.toLowerCase()));
    if(matchKey) rule = APOGEE_AUTO[matchKey];
  }
  if(!rule) rule = APOGEE_AUTO[wine.type] || APOGEE_AUTO["rouge"];
  return { debut: annee + rule.min, fin: annee + rule.max };
}

function getApogeeWindows(wine) {
  // Priorit√© : manuel, sinon auto
  if(wine.apogeeDebut || wine.apogeeFin) {
    return {
      debut: parseInt(wine.apogeeDebut) || null,
      fin:   parseInt(wine.apogeeFin)   || null,
      source: "manuel"
    };
  }
  const auto = getApogeeAuto(wine);
  if(auto) return { ...auto, source: "auto" };
  return null;
}

function getApogeeStatut(wine) {
  const now = new Date().getFullYear();
  const ap  = getApogeeWindows(wine);
  if(!ap || (!ap.debut && !ap.fin)) return null;
  const debut = ap.debut || 0;
  const fin   = ap.fin   || 9999;
  if(now > fin)               return "depasse";
  if(now >= debut)            return "maintenant";
  if(debut - now <= 2)        return "bientot";
  return "jeune";
}

function getApogeeLabel(wine) {
  const ap = getApogeeWindows(wine);
  if(!ap) return "";
  const now    = new Date().getFullYear();
  const statut = getApogeeStatut(wine);
  const range  = ap.debut && ap.fin ? ap.debut + " ‚Äî " + ap.fin : (ap.debut ? "√† partir de " + ap.debut : "jusqu'en " + ap.fin);
  const badges = {
    depasse:    `<span style="color:#d44;font-size:0.85rem">üî¥ D√©pass√©</span>`,
    maintenant: `<span style="color:#3da066;font-size:0.85rem">üü¢ √Ä boire maintenant</span>`,
    bientot:    `<span style="color:#c9a84c;font-size:0.85rem">üü° Apog√©e dans ${ap.debut - now} an${ap.debut - now > 1 ? "s" : ""}</span>`,
    jeune:      `<span style="color:#5090c0;font-size:0.85rem">üîµ Trop jeune encore</span>`
  };
  const src = ap.source === "auto" ? `<span style="font-size:0.7rem;color:var(--text2);margin-left:6px">(estimation)</span>` : "";
  return `${badges[statut]||""} <span style="color:var(--gold2);margin-left:8px">${range}</span>${src}`;
}

let apogeeFiltre = "tous";

function filtreApogee(filtre) {
  apogeeFiltre = filtre;
  ["tous","maintenant","bientot","jeune","depasse"].forEach(f => {
    const btn = document.getElementById("btn-ap-" + f);
    if(btn) btn.classList.toggle("active", f === filtre);
  });
  renderApogee(filtre);
}

function renderApogee(filtre) {
  const container = document.getElementById("apogee-list");
  if(!container) return;
  const now = new Date().getFullYear();

  let wines = wineData.filter(w => {
    const ap = getApogeeWindows(w);
    if(filtre === "tous") return ap !== null || w.annee;
    const statut = getApogeeStatut(w);
    return statut === filtre;
  });

  // Trier : d√©pass√©s en premier, puis √† boire, puis bient√¥t, puis jeunes
  const order = { depasse: 0, maintenant: 1, bientot: 2, jeune: 3 };
  wines.sort((a, b) => {
    const sa = order[getApogeeStatut(a)] ?? 4;
    const sb = order[getApogeeStatut(b)] ?? 4;
    if(sa !== sb) return sa - sb;
    return (parseInt(a.annee)||0) - (parseInt(b.annee)||0);
  });

  if(!wines.length) {
    container.innerHTML = `<div style="text-align:center;padding:60px 0;color:var(--text2);font-style:italic">Aucun vin dans cette cat√©gorie</div>`;
    return;
  }

  const statLabels = {
    depasse:    { color: "#d44",    icon: "üî¥", label: "D√©pass√© ‚Äî √† boire rapidement" },
    maintenant: { color: "#3da066", icon: "üü¢", label: "√Ä boire maintenant" },
    bientot:    { color: "#c9a84c", icon: "üü°", label: "Apog√©e proche" },
    jeune:      { color: "#5090c0", icon: "üîµ", label: "Encore trop jeune" }
  };

  container.innerHTML = wines.map(w => {
    const ap     = getApogeeWindows(w);
    const statut = getApogeeStatut(w);
    const st     = statLabels[statut] || { color: "var(--text2)", icon: "‚ö™", label: "Inconnu" };
    const range  = ap ? (ap.debut && ap.fin ? ap.debut + " ‚Äî " + ap.fin : (ap.debut ? "√† partir de " + ap.debut : "jusqu'en " + ap.fin)) : "‚Äî";
    const src    = ap && ap.source === "auto" ? " (est.)" : "";
    const anneeRestante = ap && ap.debut ? ap.debut - now : null;

    return `<div style="display:flex;gap:14px;align-items:center;padding:14px 16px;background:var(--bg2);border:1px solid var(--border);border-left:3px solid ${st.color};border-radius:3px;margin-bottom:8px;cursor:pointer"
      onclick="openSlotModal(${w.cave},${w.floor},${w.slot})">
      ${w.image ? `<img src="${w.image}" style="width:40px;height:56px;object-fit:contain;border-radius:2px;flex-shrink:0">` : `<div style="width:40px;height:56px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0">üç∑</div>`}
      <div style="flex:1;min-width:0">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:6px">
          <div>
            <span style="color:var(--cream);font-size:1rem">${w.nom||"‚Äî"}</span>
            ${w.annee ? `<span style="color:var(--text2);font-size:0.85rem;margin-left:6px">${w.annee}</span>` : ""}
            <div style="color:var(--text2);font-size:0.78rem;margin-top:2px">${[w.domaine,w.appellation].filter(Boolean).join(" ¬∑ ")}</div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="color:${st.color};font-size:0.82rem">${st.icon} ${st.label}</div>
            <div style="color:var(--gold2);font-size:0.82rem;margin-top:2px">Apog√©e : ${range}${src}</div>
            ${statut === "bientot" && anneeRestante ? `<div style="color:var(--text2);font-size:0.75rem">Dans ${anneeRestante} an${anneeRestante>1?"s":""}</div>` : ""}
          </div>
        </div>
      </div>
    </div>`;
  }).join("");
}


// =====================================================================
// DEPLACEMENT DE BOUTEILLES
// =====================================================================
let deplacerWineId = null;

function openDeplacerModal(id) {
  deplacerWineId = id;
  const wine = wineData.find(w => String(w.id) === String(id));
  if(!wine) return;
  closeModal('modalSlot');
  document.getElementById('deplacer-wine-name').textContent = (wine.nom||'') + (wine.annee ? ' ' + wine.annee : '');
  // Pr√©-s√©lectionner la cave actuelle
  document.getElementById('dep-cave').value = wine.cave || 1;
  updateDepEtage(wine.floor);
  document.getElementById('modalDeplacer').classList.add('open');
}

function updateDepEtage(selectedFloor) {
  const cave    = parseInt(document.getElementById('dep-cave').value) || 1;
  const sel     = document.getElementById('dep-etage');
  sel.innerHTML = '';
  CAVE_CONFIG[cave].floors.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f.id;
    opt.textContent = f.label + (f.isMagnum ? ' ¬∑ Magnums' : '');
    sel.appendChild(opt);
  });
  if(selectedFloor) sel.value = selectedFloor;
  updateDepSlot();
}

function updateDepSlot() {
  const cave    = parseInt(document.getElementById('dep-cave').value) || 1;
  const floor   = parseInt(document.getElementById('dep-etage').value) || 1;
  const floorData = CAVE_CONFIG[cave].floors.find(f => f.id === floor);
  const sel     = document.getElementById('dep-slot');
  sel.innerHTML = '';
  if(!floorData) return;
  const wine = wineData.find(w => String(w.id) === String(deplacerWineId));
  for(let i = 1; i <= floorData.slots; i++) {
    const occupant = getWineAtSlot(cave, floor, i);
    // Exclure l'emplacement actuel du vin
    if(occupant && String(occupant.id) === String(deplacerWineId)) continue;
    const opt = document.createElement('option');
    opt.value = i;
    if(occupant) {
      opt.textContent = 'Empl. ' + i + ' ‚Äî ' + (occupant.nom||'?') + (occupant.annee?' '+occupant.annee:'') + ' (√©change)';
      opt.style.color = '#c9a84c';
    } else {
      opt.textContent = 'Empl. ' + i + ' ‚Äî Libre';
    }
    sel.appendChild(opt);
  }
  if(!sel.options.length) {
    const opt = document.createElement('option');
    opt.textContent = 'Aucun emplacement disponible';
    opt.disabled = true;
    sel.appendChild(opt);
  }
}

function confirmerDeplacement() {
  const wine = wineData.find(w => String(w.id) === String(deplacerWineId));
  if(!wine) return;
  const newCave  = parseInt(document.getElementById('dep-cave').value);
  const newFloor = parseInt(document.getElementById('dep-etage').value);
  const newSlot  = parseInt(document.getElementById('dep-slot').value);
  if(!newSlot) { showNotif('Choisissez un emplacement', true); return; }

  // V√©rifier si emplacement occup√© ‚Üí √©change
  const occupant = getWineAtSlot(newCave, newFloor, newSlot);
  if(occupant && String(occupant.id) !== String(wine.id)) {
    // √âchange : mettre l'occupant √† l'ancienne place du vin d√©plac√©
    occupant.cave  = wine.cave;
    occupant.floor = wine.floor;
    occupant.slot  = wine.slot;
    showNotif('√âchange effectu√© : ' + (occupant.nom||'vin') + ' ‚Üî ' + (wine.nom||'vin') + ' ‚úì');
  } else {
    showNotif('Bouteille d√©plac√©e ‚úì');
  }

  // D√©placer le vin
  wine.cave  = newCave;
  wine.floor = newFloor;
  wine.slot  = newSlot;

  saveData();
  closeModal('modalDeplacer');
  renderCave2D();
  renderList();
  deplacerWineId = null;
}


// =====================================================================
// RECHERCHE GLOBALE
// =====================================================================
function handleSearch(query) {
  const panel   = document.getElementById('search-panel');
  const overlay = document.getElementById('search-overlay');
  const clear   = document.getElementById('search-clear');
  const q = query.trim().toLowerCase();

  clear.style.display = q ? 'block' : 'none';

  if(!q) {
    panel.style.display   = 'none';
    overlay.style.display = 'none';
    return;
  }

  const results = wineData.filter(w => {
    return [w.nom, w.domaine, w.appellation, w.region, w.annee, w.type, w.notes, w.accords]
      .some(val => val && String(val).toLowerCase().includes(q));
  });

  overlay.style.display = 'block';

  if(!results.length) {
    panel.style.display = 'block';
    panel.innerHTML = `<div class="search-count">Aucun r√©sultat pour "${query}"</div>`;
    return;
  }

  const typeColors = {rouge:'#9e2a3f',blanc:'#c9a84c','ros√©':'#c06080',effervescent:'#5090c0',vdn:'#9040c0',magnum:'#9060c0'};

  panel.style.display = 'block';
  panel.innerHTML = `<div class="search-count">${results.length} r√©sultat${results.length>1?'s':''} pour "${query}"</div>` +
    results.map(w => {
      const color  = typeColors[w.type] || 'var(--text2)';
      const loc    = `Cave ${w.cave} ¬∑ √âtage ${w.floor} ¬∑ Empl. ${w.slot}`;
      const detail = [w.appellation, w.region].filter(Boolean).join(' ¬∑ ');
      // Highlight matching text
      const nom    = highlight(w.nom||'‚Äî', q);
      const dom    = w.domaine ? highlight(w.domaine, q) : '';
      return `<div class="search-result-item" onclick="goToWine(${w.cave},${w.floor},${w.slot})">
        ${w.image ? `<img src="${w.image}" style="width:36px;height:50px;object-fit:contain;border-radius:2px;flex-shrink:0">` : `<div style="width:36px;height:50px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0">üç∑</div>`}
        <div style="flex:1;min-width:0">
          <div style="color:var(--cream);font-size:0.98rem">${nom}${w.annee?` <span style="color:var(--text2);font-size:0.82rem">${w.annee}</span>`:''}</div>
          ${dom ? `<div style="color:var(--text2);font-size:0.78rem;margin-top:1px">${dom}</div>` : ''}
          ${detail ? `<div style="color:var(--text2);font-size:0.78rem">${detail}</div>` : ''}
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div style="color:${color};font-size:0.75rem;text-transform:capitalize">${w.type||''}</div>
          <div style="color:var(--text2);font-size:0.72rem;margin-top:3px">${loc}</div>
        </div>
      </div>`;
    }).join('');
}

function highlight(text, query) {
  if(!text || !query) return text;
  const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  return String(text).replace(new RegExp('(' + escaped + ')', 'gi'),
    '<mark style="background:var(--gold);color:#1a0a10;border-radius:2px;padding:0 2px">$1</mark>');
}

function clearSearch() {
  const input   = document.getElementById('global-search');
  const panel   = document.getElementById('search-panel');
  const overlay = document.getElementById('search-overlay');
  const clear   = document.getElementById('search-clear');
  if(input)   input.value = '';
  if(panel)   panel.style.display   = 'none';
  if(overlay) overlay.style.display = 'none';
  if(clear)   clear.style.display   = 'none';
}

function goToWine(cave, floor, slot) {
  clearSearch();
  // Switcher vers vue cave et ouvrir la fiche
  const tab = document.querySelector(".tab");
  switchTab('view2d', tab);
  // S√©lectionner la bonne cave si besoin
  if(cave !== currentCave) {
    const btn = document.querySelectorAll('.cave-btn')[cave-1];
    selectCave(cave, btn);
  }
  // Ouvrir la modal apr√®s un court d√©lai pour laisser le rendu se faire
  setTimeout(() => openSlotModal(cave, floor, slot), 150);
}


// =====================================================================
// BULLE MOBILE ‚Äî 1 tap = bulle, 2 taps = fiche compl√®te
// =====================================================================
let lastTapTime   = 0;
let lastTapTarget = null;
let mobileBubbleCave  = null;
let mobileBubbleFloor = null;
let mobileBubbleSlot  = null;

function isMobile() {
  // Uniquement bas√© sur la largeur ‚Äî pas sur ontouchstart (√©vite les faux positifs desktop tactile)
  return window.matchMedia('(max-width: 768px)').matches;
}

function handleBottleClick(e, cave, floor, slot) {
  // Masquer le tooltip dans tous les cas
  document.getElementById('tooltip').style.display = 'none';

  if(!isMobile()) {
    // Desktop : comportement normal
    openSlotModal(cave, floor, slot);
    return;
  }

  const now = Date.now();
  const sameTarget = (mobileBubbleCave === cave && mobileBubbleFloor === floor && mobileBubbleSlot === slot);

  if(sameTarget && now - lastTapTime < 400) {
    // Double tap sur la m√™me bouteille ‚Üí fiche compl√®te
    closeMobileBubble();
    openSlotModal(cave, floor, slot);
    lastTapTime = 0;
    return;
  }

  // 1er tap ‚Üí bulle rapide
  lastTapTime   = now;
  mobileBubbleCave  = cave;
  mobileBubbleFloor = floor;
  mobileBubbleSlot  = slot;
  showMobileBubble(cave, floor, slot);
}

function showMobileBubble(cave, floor, slot) {
  const wine      = getWineAtSlot(cave, floor, slot);
  const floorData = CAVE_CONFIG[cave].floors.find(f => f.id === floor);
  const bubble    = document.getElementById('mobile-bubble');
  const overlay   = document.getElementById('mobile-bubble-overlay');

  if(wine) {
    document.getElementById('mb-name').textContent = wine.nom || '‚Äî';
    const stars = wine.note ? '‚òÖ'.repeat(parseInt(wine.note)) + '‚òÜ'.repeat(5 - parseInt(wine.note)) : '';
    document.getElementById('mb-info').innerHTML = [
      wine.annee ? `<b>${wine.annee}</b>` : '',
      wine.domaine || '',
      wine.appellation || '',
      wine.region || '',
      wine.prix ? wine.prix + ' ‚Ç¨' : '',
      stars ? `<span style="color:var(--gold)">${stars}</span>` : '',
      `<span style="color:var(--text2);font-size:0.75rem">Cave ${cave} ¬∑ √ât.${floor} ¬∑ #${slot} ‚Äî double tap pour la fiche</span>`
    ].filter(Boolean).join('<br>');
    const imgWrap = document.getElementById('mb-img-wrap');
    const imgEl   = document.getElementById('mb-img');
    if(wine.image) { imgEl.src = wine.image; imgWrap.style.display = 'block'; }
    else           { imgWrap.style.display = 'none'; }
    document.getElementById('mb-btn-fiche').style.display = 'block';
  } else {
    document.getElementById('mb-name').textContent = 'Emplacement vide';
    document.getElementById('mb-info').innerHTML = `${floorData?.label} ¬∑ #${slot}<br><span style="color:var(--text2);font-size:0.75rem">Double tap pour ajouter un vin</span>`;
    document.getElementById('mb-img-wrap').style.display = 'none';
    document.getElementById('mb-btn-fiche').style.display = 'block';
  }

  overlay.style.display = 'block';
  bubble.style.display  = 'block';
  requestAnimationFrame(() => bubble.classList.add('open'));
}

function closeMobileBubble() {
  const bubble  = document.getElementById('mobile-bubble');
  const overlay = document.getElementById('mobile-bubble-overlay');
  bubble.classList.remove('open');
  overlay.style.display = 'none';
  setTimeout(() => { bubble.style.display = 'none'; }, 250);
  mobileBubbleCave = mobileBubbleFloor = mobileBubbleSlot = null;
  lastTapTime = 0;
}

function mobileBubbleOpenFiche() {
  if(mobileBubbleCave !== null) {
    const c = mobileBubbleCave, f = mobileBubbleFloor, s = mobileBubbleSlot;
    // Fermer la bulle et bloquer tout nouveau tap pendant l'animation
    const bubble  = document.getElementById('mobile-bubble');
    const overlay = document.getElementById('mobile-bubble-overlay');
    bubble.classList.remove('open');
    overlay.style.display = 'none';
    mobileBubbleCave = mobileBubbleFloor = mobileBubbleSlot = null;
    lastTapTime = Date.now() + 2000; // bloquer les taps pendant 2s
    setTimeout(() => { bubble.style.display = 'none'; openSlotModal(c, f, s); }, 260);
  }
}


// =====================================================================

// =====================================================================
// CARTE DES VIGNOBLES ‚Äî Mapping r√©gions
// =====================================================================

const REGION_MAP = {
  // Bourgogne et sous-r√©gions
  "bourgogne":"Bourgogne","burgundy":"Bourgogne",
  "c√¥te de nuits":"C√¥te de Nuits","cote de nuits":"C√¥te de Nuits","gevrey":"C√¥te de Nuits","chambolle":"C√¥te de Nuits","vosne":"C√¥te de Nuits","nuits-saint-georges":"C√¥te de Nuits",
  "c√¥te de beaune":"C√¥te de Beaune","cote de beaune":"C√¥te de Beaune","meursault":"C√¥te de Beaune","puligny":"C√¥te de Beaune","chassagne":"C√¥te de Beaune","pommard":"C√¥te de Beaune","volnay":"C√¥te de Beaune","beaune":"C√¥te de Beaune","corton":"C√¥te de Beaune",
  "chablis":"Chablis","petit chablis":"Chablis",
  "m√¢con":"M√¢connais","maconnais":"M√¢connais","m√¢connais":"M√¢connais","pouilly-fuiss√©":"M√¢connais","saint-v√©ran":"M√¢connais",
  "c√¥te chalonnaise":"C√¥te Chalonnaise","mercurey":"C√¥te Chalonnaise","givry":"C√¥te Chalonnaise","rully":"C√¥te Chalonnaise","montagny":"C√¥te Chalonnaise",
  "jura":"Jura","arbois":"Jura","ch√¢teau-chalon":"Jura","vin jaune":"Jura",
  // Bordeaux
  "bordeaux":"Bordeaux",
  "m√©doc":"M√©doc","medoc":"M√©doc","pauillac":"M√©doc","saint-julien":"M√©doc","margaux":"M√©doc","saint-est√®phe":"M√©doc","moulis":"M√©doc","listrac":"M√©doc","haut-m√©doc":"M√©doc",
  "saint-√©milion":"Saint-√âmilion","saint emilion":"Saint-√âmilion","pomerol":"Saint-√âmilion","fronsac":"Saint-√âmilion","canon-fronsac":"Saint-√âmilion",
  "sauternes":"Sauternes","barsac":"Sauternes","c√©rons":"Sauternes",
  "pessac-l√©ognan":"Bordeaux","graves":"Bordeaux","entre-deux-mers":"Bordeaux",
  // Champagne
  "champagne":"Champagne",
  "montagne de reims":"Montagne de Reims","montagne reims":"Montagne de Reims",
  "vall√©e de la marne":"Vall√©e de la Marne","vall√©e marne":"Vall√©e de la Marne",
  "c√¥te des blancs":"C√¥te des Blancs","cote des blancs":"C√¥te des Blancs",
  // Alsace
  "alsace":"Alsace","alsace grand cru":"Alsace Grand Cru","riesling alsace":"Alsace","gewurztraminer":"Alsace",
  // Rh√¥ne
  "rh√¥ne":"Rh√¥ne","rhone":"Rh√¥ne",
  "c√¥te-r√¥tie":"Rh√¥ne Nord","cote rotie":"Rh√¥ne Nord","hermitage":"Rh√¥ne Nord","crozes-hermitage":"Rh√¥ne Nord","saint-joseph":"Rh√¥ne Nord","cornas":"Rh√¥ne Nord","condrieu":"Rh√¥ne Nord","saint-p√©ray":"Rh√¥ne Nord",
  "ch√¢teauneuf-du-pape":"Ch√¢teauneuf-du-Pape","chateauneuf":"Ch√¢teauneuf-du-Pape","chateauneuf-du-pape":"Ch√¢teauneuf-du-Pape",
  "gigondas":"Gigondas","vacqueyras":"Gigondas","ventoux":"C√¥tes du Rh√¥ne","luberon":"C√¥tes du Rh√¥ne",
  "c√¥tes du rh√¥ne":"C√¥tes du Rh√¥ne","cotes du rhone":"C√¥tes du Rh√¥ne","c√¥tes du rh√¥ne villages":"C√¥tes du Rh√¥ne",
  // Loire
  "loire":"Loire","val de loire":"Loire",
  "muscadet":"Muscadet","pays nantais":"Muscadet",
  "anjou":"Anjou","coteaux du layon":"Anjou","savenni√®res":"Anjou","bonnezeaux":"Anjou","quarts-de-chaume":"Anjou",
  "saumur":"Saumur","saumur-champigny":"Saumur",
  "touraine":"Touraine","chinon":"Touraine","bourgueil":"Touraine","saint-nicolas-de-bourgueil":"Touraine","vouvray":"Touraine","montlouis":"Touraine",
  "sancerre":"Sancerre","menetou-salon":"Sancerre",
  "pouilly-fum√©":"Pouilly-Fum√©","pouilly fume":"Pouilly-Fum√©",
  // Provence
  "provence":"Provence","c√¥tes de provence":"Provence","cotes de provence":"Provence",
  "bandol":"Bandol","cassis":"Cassis","palette":"Palette","les baux":"Provence","coteaux d'aix":"Provence",
  // Languedoc
  "languedoc":"Languedoc","languedoc-roussillon":"Languedoc","coteaux du languedoc":"Languedoc",
  "faug√®res":"Faug√®res","faugeres":"Faug√®res",
  "saint-chinian":"Saint-Chinian","saint chinian":"Saint-Chinian",
  "pic saint-loup":"Pic Saint-Loup","pic saint loup":"Pic Saint-Loup",
  "minervois":"Minervois","corbi√®res":"Corbi√®res","corbieres":"Corbi√®res","fitou":"Fitou",
  "clairette de bellegarde":"Languedoc","muscat de frontignan":"Languedoc","muscat de lunel":"Languedoc",
  // Sud-Ouest
  "sud-ouest":"Sud-Ouest","sud ouest":"Sud-Ouest",
  "cahors":"Cahors","madiran":"Madiran","bergerac":"Bergerac","monbazillac":"Bergerac",
  "juran√ßon":"Juran√ßon","jurancon":"Juran√ßon","pacherenc":"Madiran",
  "gaillac":"Gaillac","fronton":"Gaillac","saint-mont":"Madiran",
  // Savoie
  "savoie":"Savoie","vin de savoie":"Savoie","bugey":"Bugey","cerdon":"Bugey","roussette":"Savoie",
  // Roussillon
  "roussillon":"Roussillon","c√¥tes du roussillon":"Roussillon","cotes du roussillon":"Roussillon",
  "banyuls":"Banyuls","maury":"Maury","collioure":"Collioure","rivesaltes":"Roussillon",
  // Corse
  "corse":"Corse","corsica":"Corse","patrimonio":"Patrimonio","ajaccio":"Ajaccio","figari":"Corse","porto-vecchio":"Corse",
  // Espagne
  "rioja":"Rioja","rioja alta":"Rioja Alta","rioja alavesa":"Rioja Alavesa","rioja baja":"Rioja",
  "ribera del duero":"Ribera del Duero",
  "priorat":"Priorat","priorato":"Priorat",
  "pened√®s":"Pened√®s","penedes":"Pened√®s","cava":"Cava","torres":"Pened√®s",
  "r√≠as baixas":"R√≠as Baixas","rias baixas":"R√≠as Baixas","albari√±o":"R√≠as Baixas",
  "bierzo":"Bierzo","toro":"Toro","rueda":"Rueda","verdejo":"Rueda",
  "jerez":"Jerez","sherry":"Jerez","x√©r√®s":"Jerez","xeres":"Jerez","manzanilla":"Jerez",
  "m√°laga":"M√°laga","malaga":"M√°laga","montilla":"Montilla-Moriles",
  // Portugal
  "porto":"Porto","port":"Porto","vintage port":"Porto","tawny":"Porto",
  "douro":"Douro","duriense":"Douro",
  "minho":"Minho","vinho verde":"Minho","alvarinho":"Minho",
  "alentejo":"Alentejo","alentejano":"Alentejo",
  "d√£o":"D√£o","dao":"D√£o","bairrada":"Bairrada","baga":"Bairrada",
  "set√∫bal":"Set√∫bal","setubal":"Set√∫bal","moscatel de set√∫bal":"Set√∫bal",
  "lisboa":"Lisboa","estremadura":"Lisboa",
  "mad√®re":"Mad√®re","madeira":"Mad√®re",
  // Italie
  "toscane":"Toscane","tuscany":"Toscane","toscana":"Toscane",
  "chianti":"Chianti","chianti classico":"Chianti",
  "brunello":"Brunello","brunello di montalcino":"Brunello","rosso di montalcino":"Brunello",
  "bolgheri":"Bolgheri","sassicaia":"Bolgheri","ornellaia":"Bolgheri","super toscan":"Bolgheri","supertoscan":"Bolgheri",
  "montepulciano":"Montepulciano","vino nobile":"Montepulciano","morellino":"Toscane",
  "pi√©mont":"Piedmont","piemont":"Piedmont","piemonte":"Piedmont",
  "barolo":"Barolo","barbaresco":"Barbaresco","nebbiolo":"Barolo",
  "moscato d'asti":"Moscato d'Asti","moscato":"Moscato d'Asti","asti spumante":"Moscato d'Asti",
  "veneto":"Veneto","v√©n√©tie":"Veneto","venetie":"Veneto",
  "soave":"Soave","valpolicella":"Valpolicella","amarone":"Amarone","ripasso":"Valpolicella","recioto":"Valpolicella",
  "prosecco":"Prosecco","conegliano":"Prosecco","valdobbiadene":"Prosecco",
  "frioul":"Frioul","friuli":"Frioul","friuli-venezia":"Frioul","collio":"Frioul",
  "alto adige":"Alto Adige","s√ºdtirol":"Alto Adige","haut-adige":"Alto Adige",
  "campanie":"Campanie","campania":"Campanie","taurasi":"Taurasi","fiano":"Campanie","greco di tufo":"Campanie",
  "sicile":"Sicile","sicilia":"Sicile","sicily":"Sicile","etna":"Etna","nero d'avola":"Sicile","marsala":"Marsala",
  "sardaigne":"Sardaigne","sardegna":"Sardaigne","cannonau":"Sardaigne","vermentino":"Sardaigne",
  "abruzzo":"Abruzzo","montepulciano d'abruzzo":"Abruzzo",
  "ombrie":"Ombrie","umbria":"Ombrie","sagrantino":"Ombrie","orvieto":"Ombrie",
  // Allemagne
  "moselle":"Moselle","mosel":"Moselle","saar":"Moselle","ruwer":"Moselle",
  "rhin":"Rhin","rheingau":"Rheingau","rhein":"Rhin","rheinhessen":"Rh√©nanie-Palatinat","pfalz":"Rh√©nanie-Palatinat",
  "bade":"Bade","baden":"Bade","kaiserstuhl":"Bade",
  "wurtemberg":"Wurtemberg","w√ºrttemberg":"Wurtemberg",
  "franconie":"Franconie","franken":"Franconie","silvaner":"Franconie",
  "nahe":"Nahe","ahr":"Ahr","mittelrhein":"Rhin",
  // Autriche
  "wachau":"Wachau","gr√ºner veltliner":"Wachau","gr√ºner":"Wachau",
  "kamptal":"Kamptal","kremstal":"Kamptal","traisental":"Kamptal",
  "burgenland":"Burgenland","neusiedlersee":"Burgenland","blaufr√§nkisch":"Burgenland",
  "styrie":"Styrie","steiermark":"Styrie","morillon":"Styrie",
  // Gr√®ce
  "cr√®te":"Cr√®te","crete":"Cr√®te","p√©loponn√®se":"P√©loponn√®se","peloponnese":"P√©loponn√®se",
  "mac√©doine":"Mac√©doine","macedoine":"Mac√©doine","naoussa":"Mac√©doine",
  "santorin":"Santorin","santorini":"Santorin","assyrtiko":"Santorin",
  // Hongrie
  "tokaj":"Tokaj","tokay":"Tokaj","tokaji":"Tokaj","furmint":"Tokaj","eger":"Eger","egri bikav√©r":"Eger",
  // Roumanie
  "dealu mare":"Dealu Mare","moldova":"Moldova (RO)",
  // Suisse
  "valais":"Valais","vaud":"Vaud","gen√®ve":"Gen√®ve","geneve":"Gen√®ve","lavaux":"Vaud","d√©zaley":"Vaud",
};

const WINE_REGION_POLYGONS = {
  // FRANCE
  "Bordeaux": {
    label:"Bordeaux", country:"France", color:"#8a1828",
    coords:[[-1.28,45.52],[-0.48,45.60],[-0.08,45.30],[-0.02,44.98],[-0.18,44.52],[-0.75,44.38],[-1.20,44.62],[-1.32,45.00],[-1.28,45.52]]
  },
  "M√©doc": {
    label:"M√©doc", country:"France", color:"#9e2a3f",
    coords:[[-1.28,45.52],[-1.10,45.70],[-0.95,45.70],[-0.80,45.48],[-0.70,45.10],[-0.98,45.00],[-1.20,45.10],[-1.28,45.52]]
  },
  "Saint-√âmilion": {
    label:"Saint-√âmilion / Pomerol", country:"France", color:"#7b1c2e",
    coords:[[-0.30,44.98],[-0.08,45.02],[-0.02,44.90],[-0.12,44.80],[-0.30,44.82],[-0.30,44.98]]
  },
  "Sauternes": {
    label:"Sauternes / Barsac", country:"France", color:"#c9a84c",
    coords:[[-0.55,44.62],[-0.38,44.62],[-0.30,44.48],[-0.42,44.38],[-0.60,44.45],[-0.55,44.62]]
  },
  "Bourgogne": {
    label:"Bourgogne", country:"France", color:"#7b1c2e",
    coords:[[4.60,47.80],[5.10,47.90],[5.35,47.60],[5.30,47.20],[5.05,46.90],[4.72,46.82],[4.55,47.00],[4.58,47.50],[4.60,47.80]]
  },
  "C√¥te de Nuits": {
    label:"C√¥te de Nuits", country:"France", color:"#9e2a3f",
    coords:[[4.88,47.38],[4.98,47.38],[5.05,47.22],[4.98,47.08],[4.88,47.10],[4.82,47.22],[4.88,47.38]]
  },
  "C√¥te de Beaune": {
    label:"C√¥te de Beaune", country:"France", color:"#a03348",
    coords:[[4.80,47.08],[4.95,47.08],[5.02,46.92],[4.95,46.78],[4.82,46.78],[4.76,46.92],[4.80,47.08]]
  },
  "Chablis": {
    label:"Chablis", country:"France", color:"#c9a84c",
    coords:[[3.60,47.95],[4.00,47.98],[4.10,47.80],[3.98,47.65],[3.72,47.65],[3.60,47.78],[3.60,47.95]]
  },
  "M√¢connais": {
    label:"M√¢connais", country:"France", color:"#b89040",
    coords:[[4.65,46.65],[4.95,46.68],[5.08,46.50],[4.98,46.28],[4.72,46.22],[4.55,46.38],[4.62,46.55],[4.65,46.65]]
  },
  "Champagne": {
    label:"Champagne", country:"France", color:"#c9a84c",
    coords:[[3.52,49.38],[4.25,49.48],[4.55,49.25],[4.48,48.90],[4.10,48.72],[3.62,48.78],[3.42,49.00],[3.52,49.38]]
  },
  "Alsace": {
    label:"Alsace", country:"France", color:"#c9a84c",
    coords:[[7.18,48.85],[7.52,48.95],[7.80,48.78],[7.90,48.52],[7.85,47.88],[7.60,47.60],[7.28,47.60],[7.12,47.85],[7.10,48.32],[7.18,48.85]]
  },
  "Loire": {
    label:"Vall√©e de la Loire", country:"France", color:"#c9a84c",
    coords:[[-2.10,47.42],[-1.55,47.50],[0.00,47.58],[1.00,47.52],[1.80,47.38],[2.98,47.22],[3.12,47.08],[2.85,46.92],[2.60,47.00],[1.80,47.15],[0.80,47.28],[0.00,47.40],[-1.30,47.30],[-2.00,47.22],[-2.10,47.42]]
  },
  "Sancerre": {
    label:"Sancerre / Pouilly-Fum√©", country:"France", color:"#c9a84c",
    coords:[[2.65,47.42],[3.08,47.45],[3.18,47.22],[3.02,47.08],[2.68,47.10],[2.55,47.28],[2.65,47.42]]
  },
  "Rh√¥ne Nord": {
    label:"Rh√¥ne Septentrional", country:"France", color:"#8a1828",
    coords:[[4.55,45.62],[4.90,45.72],[5.05,45.55],[5.02,45.22],[4.88,45.08],[4.68,45.10],[4.55,45.30],[4.55,45.62]]
  },
  "Rh√¥ne Sud": {
    label:"Rh√¥ne M√©ridional", country:"France", color:"#9e2a3f",
    coords:[[4.42,44.62],[4.98,44.72],[5.15,44.52],[5.12,44.08],[4.88,43.88],[4.55,43.95],[4.30,44.12],[4.28,44.42],[4.42,44.62]]
  },
  "Ch√¢teauneuf-du-Pape": {
    label:"Ch√¢teauneuf-du-Pape", country:"France", color:"#7b1c2e",
    coords:[[4.68,44.20],[4.88,44.22],[4.98,44.08],[4.92,43.95],[4.75,43.92],[4.62,44.02],[4.68,44.20]]
  },
  "Provence": {
    label:"Provence", country:"France", color:"#c06080",
    coords:[[5.12,43.88],[5.80,43.98],[6.52,43.82],[7.08,43.72],[7.12,43.52],[6.85,43.28],[6.12,43.10],[5.42,43.12],[4.98,43.22],[4.90,43.45],[5.12,43.88]]
  },
  "Bandol": {
    label:"Bandol", country:"France", color:"#d06090",
    coords:[[5.62,43.25],[5.88,43.28],[5.98,43.12],[5.82,43.02],[5.62,43.05],[5.55,43.15],[5.62,43.25]]
  },
  "Languedoc": {
    label:"Languedoc", country:"France", color:"#7b1c2e",
    coords:[[2.12,43.90],[2.88,44.02],[3.52,43.88],[4.22,43.70],[4.52,43.48],[4.22,43.22],[3.52,43.12],[2.88,43.10],[2.18,43.28],[1.92,43.55],[2.12,43.90]]
  },
  "Roussillon": {
    label:"Roussillon", country:"France", color:"#9040c0",
    coords:[[2.10,42.90],[2.75,42.95],[3.12,42.72],[3.15,42.48],[2.88,42.35],[2.42,42.38],[2.05,42.52],[1.98,42.72],[2.10,42.90]]
  },
  "Sud-Ouest": {
    label:"Sud-Ouest", country:"France", color:"#7b1c2e",
    coords:[[-0.92,44.52],[-0.30,44.62],[0.52,44.82],[1.08,44.62],[1.55,44.18],[1.52,43.78],[1.12,43.58],[0.52,43.48],[-0.12,43.38],[-0.60,43.38],[-1.02,43.62],[-0.92,44.52]]
  },
  "Cahors": {
    label:"Cahors", country:"France", color:"#8a1828",
    coords:[[1.22,44.62],[1.72,44.68],[1.82,44.42],[1.68,44.22],[1.28,44.18],[1.05,44.32],[1.22,44.62]]
  },
  "Jura": {
    label:"Jura", country:"France", color:"#c9a84c",
    coords:[[5.48,47.08],[5.85,47.12],[5.98,46.88],[5.92,46.58],[5.72,46.42],[5.48,46.48],[5.38,46.70],[5.38,46.95],[5.48,47.08]]
  },
  "Savoie": {
    label:"Savoie", country:"France", color:"#c9a84c",
    coords:[[5.72,46.08],[6.05,46.18],[6.42,46.10],[6.75,45.88],[6.72,45.55],[6.45,45.38],[6.08,45.42],[5.82,45.62],[5.70,45.88],[5.72,46.08]]
  },
  "Corse": {
    label:"Corse", country:"France", color:"#7b1c2e",
    coords:[[8.55,42.88],[9.10,43.02],[9.55,42.88],[9.72,42.48],[9.60,41.98],[9.28,41.55],[8.78,41.35],[8.52,41.55],[8.55,42.08],[8.72,42.52],[8.55,42.88]]
  },
  // ESPAGNE
  "Rioja": {
    label:"Rioja", country:"Espagne", color:"#8a1828",
    coords:[[-3.08,42.72],[-2.28,42.92],[-1.88,42.78],[-1.72,42.52],[-1.82,42.28],[-2.28,42.18],[-2.88,42.25],[-3.12,42.42],[-3.08,42.72]]
  },
  "Ribera del Duero": {
    label:"Ribera del Duero", country:"Espagne", color:"#7b1c2e",
    coords:[[-4.52,41.88],[-3.48,41.98],[-3.08,41.82],[-2.88,41.58],[-3.08,41.35],[-3.72,41.28],[-4.28,41.38],[-4.62,41.58],[-4.52,41.88]]
  },
  "Priorat": {
    label:"Priorat", country:"Espagne", color:"#9e2a3f",
    coords:[[0.62,41.42],[0.98,41.48],[1.08,41.28],[0.95,41.08],[0.68,41.05],[0.52,41.18],[0.62,41.42]]
  },
  "Pened√®s": {
    label:"Pened√®s / Cava", country:"Espagne", color:"#c9a84c",
    coords:[[1.28,41.62],[1.92,41.72],[2.12,41.52],[2.05,41.28],[1.72,41.15],[1.32,41.22],[1.12,41.42],[1.28,41.62]]
  },
  "R√≠as Baixas": {
    label:"R√≠as Baixas", country:"Espagne", color:"#c9a84c",
    coords:[[-8.90,42.72],[-8.38,42.85],[-8.12,42.65],[-8.22,42.38],[-8.62,42.28],[-8.92,42.45],[-8.90,42.72]]
  },
  "Jerez": {
    label:"Jerez / Sherry", country:"Espagne", color:"#c9a84c",
    coords:[[-6.42,37.08],[-5.88,37.18],[-5.65,36.92],[-5.78,36.65],[-6.18,36.55],[-6.52,36.68],[-6.42,37.08]]
  },
  "Rueda": {
    label:"Rueda / Toro", country:"Espagne", color:"#c9a84c",
    coords:[[-5.38,41.58],[-4.62,41.68],[-4.38,41.45],[-4.52,41.22],[-5.08,41.12],[-5.45,41.28],[-5.38,41.58]]
  },
  // PORTUGAL
  "Douro": {
    label:"Douro / Porto", country:"Portugal", color:"#7b1c2e",
    coords:[[-8.28,41.52],[-7.55,41.62],[-7.08,41.48],[-6.92,41.18],[-7.12,40.88],[-7.68,40.88],[-8.12,41.08],[-8.28,41.52]]
  },
  "Minho": {
    label:"Vinho Verde / Minho", country:"Portugal", color:"#c9a84c",
    coords:[[-8.92,41.92],[-8.38,42.08],[-8.05,41.88],[-8.12,41.52],[-8.52,41.38],[-8.92,41.58],[-8.92,41.92]]
  },
  "Alentejo": {
    label:"Alentejo", country:"Portugal", color:"#8a1828",
    coords:[[-8.82,38.92],[-7.98,39.05],[-7.05,38.88],[-6.85,38.38],[-7.12,37.88],[-7.88,37.78],[-8.58,37.98],[-8.88,38.45],[-8.82,38.92]]
  },
  "D√£o": {
    label:"D√£o", country:"Portugal", color:"#7b1c2e",
    coords:[[-8.05,40.72],[-7.48,40.82],[-7.22,40.62],[-7.28,40.30],[-7.68,40.20],[-8.05,40.38],[-8.05,40.72]]
  },
  "Bairrada": {
    label:"Bairrada", country:"Portugal", color:"#8a1828",
    coords:[[-8.62,40.72],[-8.28,40.82],[-8.12,40.58],[-8.22,40.35],[-8.52,40.30],[-8.72,40.48],[-8.62,40.72]]
  },
  // ITALIE
  "Barolo": {
    label:"Barolo / Barbaresco", country:"Italie", color:"#7b1c2e",
    coords:[[7.72,44.82],[8.08,44.88],[8.22,44.68],[8.12,44.48],[7.78,44.42],[7.58,44.58],[7.72,44.82]]
  },
  "Chianti": {
    label:"Chianti Classico", country:"Italie", color:"#9e2a3f",
    coords:[[11.02,43.72],[11.38,43.80],[11.55,43.55],[11.48,43.28],[11.18,43.18],[10.95,43.35],[11.02,43.72]]
  },
  "Brunello": {
    label:"Brunello di Montalcino", country:"Italie", color:"#7b1c2e",
    coords:[[11.30,43.18],[11.58,43.22],[11.68,43.02],[11.55,42.85],[11.28,42.82],[11.12,42.98],[11.30,43.18]]
  },
  "Bolgheri": {
    label:"Bolgheri / Super Toscans", country:"Italie", color:"#8a1828",
    coords:[[10.45,43.38],[10.75,43.42],[10.85,43.22],[10.72,43.05],[10.45,43.08],[10.35,43.22],[10.45,43.38]]
  },
  "Valpolicella": {
    label:"Valpolicella / Amarone", country:"Italie", color:"#7b1c2e",
    coords:[[10.72,45.62],[11.12,45.70],[11.28,45.52],[11.18,45.32],[10.88,45.28],[10.65,45.42],[10.72,45.62]]
  },
  "Soave": {
    label:"Soave", country:"Italie", color:"#c9a84c",
    coords:[[11.08,45.50],[11.32,45.55],[11.45,45.38],[11.35,45.22],[11.08,45.22],[10.98,45.35],[11.08,45.50]]
  },
  "Prosecco": {
    label:"Prosecco / Conegliano", country:"Italie", color:"#c9a84c",
    coords:[[11.82,45.92],[12.18,45.98],[12.42,45.78],[12.32,45.55],[11.98,45.48],[11.72,45.62],[11.82,45.92]]
  },
  "Toscane": {
    label:"Toscane", country:"Italie", color:"#8a1828",
    coords:[[9.98,44.52],[10.72,44.58],[11.62,44.38],[12.18,43.98],[11.88,43.12],[11.28,42.75],[10.48,42.65],[9.92,43.08],[9.85,43.72],[9.98,44.52]]
  },
  "Campanie": {
    label:"Campanie / Taurasi", country:"Italie", color:"#8a1828",
    coords:[[13.78,41.32],[14.52,41.48],[15.22,41.18],[15.18,40.68],[14.72,40.28],[14.05,40.22],[13.65,40.52],[13.78,41.32]]
  },
  "Sicile": {
    label:"Sicile", country:"Italie", color:"#9e2a3f",
    coords:[[12.45,37.92],[13.38,38.22],[14.55,38.28],[15.52,37.98],[15.68,37.58],[15.22,37.00],[14.08,36.65],[12.85,36.65],[12.12,37.08],[12.45,37.92]]
  },
  // ALLEMAGNE
  "Moselle": {
    label:"Moselle", country:"Allemagne", color:"#c9a84c",
    coords:[[6.52,50.18],[6.88,50.28],[7.22,50.08],[7.28,49.72],[7.08,49.42],[6.72,49.38],[6.45,49.62],[6.52,50.18]]
  },
  "Rheingau": {
    label:"Rheingau / Rh√©nanie", country:"Allemagne", color:"#b89040",
    coords:[[7.72,50.18],[8.28,50.28],[8.52,50.08],[8.42,49.82],[7.98,49.72],[7.62,49.88],[7.72,50.18]]
  },
  "Bade": {
    label:"Bade", country:"Allemagne", color:"#c9a84c",
    coords:[[7.52,48.78],[8.05,48.98],[8.38,48.72],[8.28,48.08],[7.98,47.78],[7.62,47.82],[7.48,48.22],[7.52,48.78]]
  },
  // AUTRICHE
  "Wachau": {
    label:"Wachau / Basse-Autriche", country:"Autriche", color:"#c9a84c",
    coords:[[15.02,48.52],[15.58,48.60],[15.88,48.38],[15.78,48.12],[15.32,48.02],[15.02,48.18],[15.02,48.52]]
  },
  "Burgenland": {
    label:"Burgenland", country:"Autriche", color:"#b89040",
    coords:[[16.42,47.88],[17.08,47.98],[17.22,47.68],[17.08,47.35],[16.62,47.22],[16.28,47.42],[16.28,47.72],[16.42,47.88]]
  },
  // HONGRIE
  "Tokaj": {
    label:"Tokaj", country:"Hongrie", color:"#c9a84c",
    coords:[[21.08,48.30],[21.62,48.38],[21.88,48.12],[21.72,47.88],[21.22,47.80],[20.98,48.00],[21.08,48.30]]
  },
  // GR√àCE
  "Santorin": {
    label:"Santorin", country:"Gr√®ce", color:"#c9a84c",
    coords:[[25.32,36.50],[25.52,36.55],[25.48,36.35],[25.28,36.30],[25.18,36.42],[25.32,36.50]]
  },
  "P√©loponn√®se": {
    label:"P√©loponn√®se / Nemea", country:"Gr√®ce", color:"#8a1828",
    coords:[[21.22,38.22],[22.28,38.42],[23.08,37.98],[22.82,37.28],[22.08,37.05],[21.18,37.22],[20.85,37.72],[21.22,38.22]]
  },
  // SUISSE
  "Valais": {
    label:"Valais", country:"Suisse", color:"#c9a84c",
    coords:[[6.98,46.28],[7.55,46.38],[8.02,46.22],[8.12,46.00],[7.85,45.78],[7.22,45.72],[6.88,45.92],[6.98,46.28]]
  }
};

const TYPE_COLORS_CARTE = {
  rouge:"#9e2a3f", blanc:"#c9a84c", "ros√©":"#c06080",
  effervescent:"#5090c0", vdn:"#9040c0", magnum:"#9060c0"
};

function getRegionKey(wine) {
  const r = (wine.region || '').toLowerCase().trim();
  if(REGION_MAP[r]) return REGION_MAP[r];
  for(const [k,v] of Object.entries(REGION_MAP)) {
    if(r.includes(k) || k.includes(r)) return v;
  }
  return null;
}

// =====================================================================
// D3 MAP ENGINE
// =====================================================================

function renderCarte() {
  const container = document.getElementById('carte-wrap');
  if(!container) return;
  
  // Nettoyer
  d3.select('#carte-svg').selectAll('*').remove();
  
  carteW = container.clientWidth  || 900;
  carteH = container.clientHeight || 500;
  
  const svg = d3.select('#carte-svg')
    .attr('viewBox', `0 0 ${carteW} ${carteH}`)
    .style('background', '#0d1a2a')
    .style('cursor', 'grab');
  
  carteSvg = svg;
  
  // Projection Mercator correcte sur l'Europe, auto-fit
  carteProjection = d3.geoMercator()
    .center([10, 48])
    .scale(carteW * 0.98)
    .translate([carteW / 2, carteH / 2]);
  
  cartePath = d3.geoPath().projection(carteProjection);
  
  // Groupe principal (cible du zoom)
  const g = svg.append('g').attr('id', 'carte-map-g');
  
  // Tooltip
  const tooltip = d3.select('#carte-tooltip');
  
  // Zoom & pan D3
  carteZoomBehavior = d3.zoom()
    .scaleExtent([0.5, 30])
    .on('zoom', (event) => {
      g.attr('transform', event.transform);
    });
  
  svg.call(carteZoomBehavior)
    .on('dblclick.zoom', null);
  
  // Charger les pays (fond)
  fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
    .then(r => r.json())
    .then(topo => {
      const countries = topojson.feature(topo, topo.objects.countries);
      const wineCountryIds = new Set([250,724,620,380,276,756,40,348,528,56,300,100,642,191,705,498,642,616,203,703,826,372,208,578,752,688,807,792,20,442,233,428,440]);
      
      // Fond de mer / hors Europe
      g.append('rect')
        .attr('width', carteW * 10).attr('height', carteH * 10)
        .attr('x', -carteW * 4).attr('y', -carteH * 4)
        .attr('fill', '#0d1a2a');
      
      // Pays non-viticoles (fond gris)
      g.selectAll('.country-other')
        .data(countries.features.filter(f => !wineCountryIds.has(parseInt(f.id))))
        .enter().append('path')
        .attr('class','country-other')
        .attr('d', cartePath)
        .attr('fill', '#111e2b')
        .attr('stroke', '#1a2d3d')
        .attr('stroke-width', 0.3);
      
      // Pays viticoles (fond l√©g√®rement plus clair)
      const countryColors = {
        250:'#162412', 724:'#162014', 620:'#162014', 380:'#141828',
        276:'#121a28', 756:'#141828', 40:'#141828', 348:'#141828',
        300:'#141828', 642:'#141828', 100:'#141828', 191:'#141828',
        705:'#141828', 498:'#141828', 616:'#141828', 203:'#121a28', 703:'#121a28'
      };
      g.selectAll('.country-wine')
        .data(countries.features.filter(f => wineCountryIds.has(parseInt(f.id))))
        .enter().append('path')
        .attr('class','country-wine')
        .attr('d', cartePath)
        .attr('fill', f => countryColors[parseInt(f.id)] || '#141828')
        .attr('stroke', '#253545')
        .attr('stroke-width', 0.5);
      
      // Fronti√®res internes (borders)
      if(topo.objects.countries) {
        g.append('path')
          .datum(topojson.mesh(topo, topo.objects.countries, (a,b) => a !== b))
          .attr('fill','none')
          .attr('stroke','#2a3d52')
          .attr('stroke-width', 0.6)
          .attr('d', cartePath);
      }
    })
    .catch(() => {
      g.append('rect').attr('width',carteW).attr('height',carteH)
        .attr('fill','#12202e');
    })
    .finally(() => {
      drawWineRegionPolygons(g);
      drawWinePoints(g);
      renderCarteLegend();
    });
  
  // Zoom par d√©faut sur la France
  resetToFrance();
}

function resetToFrance() {
  if(!carteSvg || !carteZoomBehavior) return;
  // France centre ~2.3¬∞E, 46.5¬∞N ‚Üí trouver les coordonn√©es pixel
  const [cx, cy] = carteProjection([2.3, 46.5]);
  // Zoom ~3.2x, centr√© sur la France
  const scale = 3.2;
  const tx = carteW/2 - cx * scale;
  const ty = carteH/2 - cy * scale;
  carteSvg.transition().duration(600)
    .call(carteZoomBehavior.transform, d3.zoomIdentity.translate(tx, ty).scale(scale));
}

function carteZoomIn() {
  if(!carteSvg || !carteZoomBehavior) return;
  carteSvg.transition().duration(300)
    .call(carteZoomBehavior.scaleBy, 1.6);
}
function carteZoomOut() {
  if(!carteSvg || !carteZoomBehavior) return;
  carteSvg.transition().duration(300)
    .call(carteZoomBehavior.scaleBy, 0.625);
}
function carteReset() { resetToFrance(); }

function drawWineRegionPolygons(g) {
  // Dessiner les polygones des r√©gions viticoles
  const layerZones = g.append('g').attr('id','wine-zones-g');
  const layerLabels = g.append('g').attr('id','wine-labels-g');
  
  Object.entries(WINE_REGION_POLYGONS).forEach(([key, region]) => {
    const geoJson = {
      type: 'Feature',
      geometry: { type: 'Polygon', coordinates: [region.coords] }
    };
    
    // Zone color√©e
    layerZones.append('path')
      .datum(geoJson)
      .attr('class', 'wine-zone')
      .attr('data-key', key)
      .attr('d', cartePath)
      .attr('fill', region.color)
      .attr('fill-opacity', 0.22)
      .attr('stroke', region.color)
      .attr('stroke-width', 1.2)
      .attr('stroke-opacity', 0.65)
      .style('cursor', 'pointer')
      .on('mouseenter', function(event) {
        d3.select(this).attr('fill-opacity', 0.42).attr('stroke-width', 2);
        showRegionTooltip(event, key, region.label);
      })
      .on('mousemove', function(event) {
        updateTooltipPos(event);
      })
      .on('mouseleave', function() {
        const isSel = carteSelectedRegion === key;
        d3.select(this).attr('fill-opacity', isSel ? 0.42 : 0.22).attr('stroke-width', isSel ? 2 : 1.2);
        d3.select('#carte-tooltip').style('display','none');
      })
      .on('click', function() {
        // D√©s√©lectionner l'ancien
        d3.selectAll('.wine-zone').each(function() {
          const k = d3.select(this).attr('data-key');
          const isSel = k === key;
          d3.select(this).attr('fill-opacity', isSel ? 0.42 : 0.22).attr('stroke-width', isSel ? 2 : 1.2);
        });
        selectCarteRegion(key, region.label);
      });
    
    // Label de la r√©gion (centro√Øde)
    const centroid = cartePath.centroid(geoJson);
    if(centroid && !isNaN(centroid[0])) {
      layerLabels.append('text')
        .attr('x', centroid[0])
        .attr('y', centroid[1])
        .attr('text-anchor','middle')
        .attr('font-size','5.5')
        .attr('fill','rgba(255,255,255,0.7)')
        .attr('font-family','Cormorant Garamond, serif')
        .style('pointer-events','none')
        .text(region.label);
    }
  });
}

function drawWinePoints(g) {
  // Points de vins (cercles) par-dessus les zones
  const layerPoints = g.append('g').attr('id','carte-points-g');
  
  // Grouper vins par r√©gion
  const regionData = {};
  wineData.forEach(w => {
    const key = getRegionKey(w);
    if(!key) return;
    if(!regionData[key]) regionData[key] = [];
    regionData[key].push(w);
  });
  
  // Calculer le centro√Øde de chaque r√©gion pour placer le badge
  Object.entries(regionData).forEach(([key, wines]) => {
    const region = WINE_REGION_POLYGONS[key];
    if(!region) return;
    
    const geoJson = { type:'Feature', geometry:{ type:'Polygon', coordinates:[region.coords] } };
    const centroid = cartePath.centroid(geoJson);
    if(!centroid || isNaN(centroid[0])) return;
    
    const typeCount = {};
    wines.forEach(w => { typeCount[w.type] = (typeCount[w.type]||0)+1; });
    const dom = Object.entries(typeCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'rouge';
    const color = TYPE_COLORS_CARTE[dom] || '#9e2a3f';
    const isSel = carteSelectedRegion === key;
    
    const group = layerPoints.append('g')
      .attr('class','wine-point-g')
      .attr('data-key', key)
      .style('cursor','pointer');
    
    // Halo
    group.append('circle')
      .attr('cx', centroid[0]).attr('cy', centroid[1])
      .attr('r', 9).attr('fill', color).attr('opacity', 0.18)
      .style('pointer-events','none');
    
    // Cercle principal
    group.append('circle')
      .attr('cx', centroid[0]).attr('cy', centroid[1])
      .attr('r', 6.5)
      .attr('fill', color)
      .attr('opacity', isSel ? 1 : 0.9)
      .attr('stroke', isSel ? 'white' : color)
      .attr('stroke-width', isSel ? 1.5 : 0.8);
    
    // Nombre
    group.append('text')
      .attr('x', centroid[0]).attr('y', centroid[1] + 2.2)
      .attr('text-anchor','middle')
      .attr('font-size','5').attr('font-weight','bold')
      .attr('fill','white').style('pointer-events','none')
      .text(wines.length);
    
    group.on('mouseenter', (event) => {
      showWinePointTooltip(event, key, region.label, wines);
    })
    .on('mousemove', updateTooltipPos)
    .on('mouseleave', () => { d3.select('#carte-tooltip').style('display','none'); })
    .on('click', () => { selectCarteRegion(key, region.label); });
  });
}

function showRegionTooltip(event, key, label) {
  const wines = wineData.filter(w => getRegionKey(w) === key);
  const tt = d3.select('#carte-tooltip');
  tt.style('display','block')
    .html(`<div style="font-family:'Playfair Display',serif;color:var(--gold);margin-bottom:4px">${label}</div>
      ${wines.length ? `<div style="color:var(--cream)">${wines.length} bouteille${wines.length>1?'s':''}</div>` : '<div style="color:var(--text2);font-style:italic">Aucun vin stock√©</div>'}
      <div style="color:var(--text2);font-size:0.72rem;margin-top:3px;font-style:italic">Cliquer pour explorer</div>`);
  updateTooltipPos(event);
}

function showWinePointTooltip(event, key, label, wines) {
  const tc = {};
  wines.forEach(w => { tc[w.type]=(tc[w.type]||0)+1; });
  const tt = d3.select('#carte-tooltip');
  tt.style('display','block')
    .html(`<div style="font-family:'Playfair Display',serif;color:var(--gold);margin-bottom:4px">${label}</div>
      <div style="color:var(--cream)">${wines.length} bouteille${wines.length>1?'s':''}</div>
      <div style="color:var(--text2);font-size:0.75rem;margin-top:3px">${Object.entries(tc).map(([t,n])=>`${n} ${t}`).join(' ¬∑ ')}</div>
      <div style="color:var(--text2);font-size:0.72rem;margin-top:4px;font-style:italic">Cliquer pour voir les vins</div>`);
  updateTooltipPos(event);
}

function updateTooltipPos(event) {
  const wrap = document.getElementById('carte-wrap');
  const rect = wrap.getBoundingClientRect();
  const x = event.clientX - rect.left + 14;
  const y = event.clientY - rect.top  - 10;
  d3.select('#carte-tooltip')
    .style('left', Math.min(x, rect.width - 200) + 'px')
    .style('top',  Math.max(10, y) + 'px');
}

function updateCartePoints() {
  // Redessiner les points si la carte est d√©j√† initialis√©e
  if(!carteSvg) return;
  const g = d3.select('#carte-map-g');
  g.select('#carte-points-g').remove();
  g.select('#wine-labels-g').remove();
  g.select('#wine-zones-g').remove();
  drawWineRegionPolygons(g);
  drawWinePoints(g);
}

function renderCarteLegend() {
  const types = [...new Set(wineData.map(w=>w.type).filter(Boolean))];
  document.getElementById('carte-legend').innerHTML = types.map(t => `
    <div style="display:flex;align-items:center;gap:5px">
      <span style="width:10px;height:10px;border-radius:50%;background:${TYPE_COLORS_CARTE[t]||'#888'};display:inline-block"></span>
      <span style="text-transform:capitalize">${t}</span>
    </div>`).join('');
}

function selectCarteRegion(key, label) {
  carteSelectedRegion = key;
  const wines = wineData.filter(w => getRegionKey(w) === key);
  document.getElementById('carte-region-title').textContent = `${label} ‚Äî ${wines.length} bouteille${wines.length!==1?'s':''}`;

  if(!wines.length) {
    document.getElementById('carte-region-list').innerHTML = '<div style="color:var(--text2);font-style:italic">Aucun vin de cette r√©gion</div>';
    updateCartePoints(); return;
  }

  const byApp = {};
  wines.forEach(w => {
    const app = w.appellation || 'Sans appellation';
    if(!byApp[app]) byApp[app] = [];
    byApp[app].push(w);
  });

  document.getElementById('carte-region-list').innerHTML = Object.entries(byApp)
    .sort((a,b) => b[1].length - a[1].length)
    .map(([app, ws]) => `
      <div style="margin-bottom:14px">
        <div style="font-size:0.75rem;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">${app} <span style="color:var(--gold)">(${ws.length})</span></div>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          ${ws.map(w => `
            <div onclick="openSlotModal(${w.cave},${w.floor},${w.slot})"
              style="display:flex;gap:8px;align-items:center;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:3px;cursor:pointer;min-width:180px;flex:1;max-width:260px">
              ${w.image?`<img src="${w.image}" style="width:28px;height:40px;object-fit:contain;border-radius:2px;flex-shrink:0">`:`<span style="font-size:1rem;flex-shrink:0">üç∑</span>`}
              <div style="min-width:0">
                <div style="color:var(--cream);font-size:0.88rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${w.nom||'‚Äî'}</div>
                <div style="color:var(--text2);font-size:0.75rem">${w.annee||''} ${w.domaine?'¬∑ '+w.domaine:''}</div>
              </div>
            </div>`).join('')}
        </div>
      </div>`).join('');

  updateCartePoints();
}

</script>
<div id="mobile-bubble">
  <div class="mb-handle"></div>
  <div style="display:flex;gap:14px;align-items:flex-start">
    <div id="mb-img-wrap" style="display:none">
      <img id="mb-img" src="" style="width:44px;height:62px;object-fit:contain;border-radius:2px;border:1px solid var(--border)">
    </div>
    <div style="flex:1">
      <div class="mb-name" id="mb-name"></div>
      <div class="mb-info" id="mb-info"></div>
    </div>
  </div>
  <div class="mb-actions">
    <button class="btn-wine" id="mb-btn-fiche" onclick="mobileBubbleOpenFiche()">üìã Fiche compl√®te</button>
    <button class="btn-outline" onclick="closeMobileBubble()">Fermer</button>
  </div>
</div>
<div id="mobile-bubble-overlay" style="display:none;position:fixed;inset:0;z-index:299;background:rgba(0,0,0,0.3)" onclick="closeMobileBubble()"></div>
</body>
</html>
