<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cave √† Vin MMM</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0608;
    --bg2: #110c0e;
    --bg3: #1a1214;
    --wine: #7b1c2e;
    --wine2: #9e2a3f;
    --wine3: #c4364f;
    --gold: #c9a84c;
    --gold2: #e8c870;
    --cream: #f5ede0;
    --text: #e8ddd0;
    --text2: #b0a090;
    --green: #2d7a4e;
    --green2: #3da066;
    --border: #3a2830;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Cormorant Garamond', serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* HEADER */
  header {
    background: linear-gradient(180deg, #000 0%, var(--bg) 100%);
    border-bottom: 1px solid var(--border);
    padding: 18px 40px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
    backdrop-filter: blur(10px);
  }
  .logo { font-family: 'Playfair Display', serif; font-size: 1.7rem; color: var(--gold); letter-spacing: 2px; }
  .logo span { color: var(--cream); font-style: italic; }
  .stats-bar { display: flex; gap: 28px; font-size: 0.85rem; color: var(--text2); letter-spacing: 1px; }
  .stats-bar b { color: var(--gold); font-size: 1.05rem; }

  /* TABS */
  .tabs { display: flex; border-bottom: 1px solid var(--border); padding: 0 40px; background: var(--bg2); }
  .tab {
    padding: 13px 26px; cursor: pointer; color: var(--text2);
    font-size: 0.88rem; letter-spacing: 2px; text-transform: uppercase;
    border-bottom: 2px solid transparent; transition: all 0.3s;
  }
  .tab:hover { color: var(--cream); }
  .tab.active { color: var(--gold); border-bottom-color: var(--gold); }

  .content { display: none; padding: 28px 40px; }
  .content.active { display: block; }

  /* ===================== 2D CAVE VIEW ===================== */
  .cave-selector {
    display: flex; gap: 14px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;
  }
  .cave-btn {
    padding: 9px 22px; border: 1px solid var(--border);
    background: transparent; color: var(--text2); cursor: pointer;
    font-family: 'Cormorant Garamond', serif; font-size: 1rem; letter-spacing: 1px;
    transition: all 0.3s; border-radius: 2px;
  }
  .cave-btn.active, .cave-btn:hover { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.07); }

  .cave-legend {
    margin-left: auto; display: flex; gap: 18px;
    font-size: 0.78rem; color: var(--text2); align-items: center; flex-wrap: wrap;
  }
  .legend-item { display: flex; align-items: center; gap: 6px; }
  .legend-big  { width: 18px; height: 18px; border-radius: 50%; border: 1.5px solid rgba(255,255,255,0.15); }
  .legend-small{ width: 9px;  height: 9px;  border-radius: 50%; border: 1px solid rgba(255,255,255,0.15); }

  /* Cave wrapper */
  .cave-2d-wrap {
    background: #080406;
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow-x: auto;
    overflow-y: auto;
    padding: 20px;
    position: relative;
    display: flex;
    justify-content: center;
  }

  /* Tooltip */
  #tooltip {
    position: fixed;
    background: rgba(8,4,6,0.97);
    border: 1px solid var(--gold);
    padding: 12px 16px; border-radius: 3px;
    font-size: 0.84rem; pointer-events: none;
    display: none; z-index: 999; max-width: 220px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.9);
  }
  #tooltip .tt-name { font-family: 'Playfair Display', serif; color: var(--gold); margin-bottom: 4px; font-size: 0.95rem; }
  #tooltip .tt-info { color: var(--text2); line-height: 1.65; font-size: 0.79rem; }
  #tooltip .tt-empty { color: #665858; font-style: italic; }

  /* Modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.88); z-index: 200; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--bg2); border: 1px solid var(--border); padding: 32px; width: 480px; max-width: 96vw; border-radius: 4px; position: relative; max-height: 90vh; overflow-y: auto; }
  .modal h2 { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.35rem; margin-bottom: 18px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
  .modal-close { position: absolute; top: 14px; right: 16px; background: none; border: none; color: var(--text2); font-size: 1.4rem; cursor: pointer; }
  .form-row { margin-bottom: 13px; }
  .form-row label { display: block; font-size: 0.78rem; color: var(--text2); letter-spacing: 1px; margin-bottom: 4px; text-transform: uppercase; }
  .form-row input, .form-row select, .form-row textarea {
    width: 100%; padding: 9px 12px; background: var(--bg3); border: 1px solid var(--border);
    color: var(--text); font-family: 'Cormorant Garamond', serif; font-size: 1rem;
    border-radius: 2px; outline: none; transition: border-color 0.2s;
  }
  .form-row input:focus, .form-row select:focus { border-color: var(--gold); }
  .form-row select option { background: var(--bg3); }
  .btn-wine { padding: 10px 26px; background: var(--wine); border: none; color: var(--cream); font-family: 'Cormorant Garamond', serif; font-size: 1rem; letter-spacing: 1px; cursor: pointer; border-radius: 2px; transition: background 0.2s; }
  .btn-wine:hover { background: var(--wine2); }
  .btn-outline { padding: 10px 18px; background: transparent; border: 1px solid var(--border); color: var(--text2); font-family: 'Cormorant Garamond', serif; font-size: 1rem; cursor: pointer; border-radius: 2px; transition: all 0.2s; }
  .btn-outline:hover { border-color: var(--wine3); color: var(--wine3); }
  .btn-danger { padding: 10px 18px; background: transparent; border: 1px solid #6b1a1a; color: #d44; font-family: 'Cormorant Garamond', serif; font-size: 1rem; cursor: pointer; border-radius: 2px; transition: all 0.2s; }
  .btn-danger:hover { background: #6b1a1a33; }
  .modal-info-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 18px; }
  .info-cell { background: var(--bg3); padding: 9px 13px; border-radius: 2px; }
  .info-cell .lbl { font-size: 0.68rem; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
  .info-cell .val { font-size: 1.02rem; color: var(--cream); margin-top: 2px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 18px; flex-wrap: wrap; }

  /* LIST VIEW */
  .filter-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
  .filter-bar input, .filter-bar select { padding: 8px 14px; background: var(--bg2); border: 1px solid var(--border); color: var(--text); font-family: 'Cormorant Garamond', serif; font-size: 0.95rem; border-radius: 2px; outline: none; transition: border-color 0.2s; }
  .filter-bar input:focus, .filter-bar select:focus { border-color: var(--gold); }
  .filter-bar input { width: 220px; }
  .wine-table { width: 100%; border-collapse: collapse; font-size: 0.94rem; }
  .wine-table th { text-align: left; padding: 9px 13px; border-bottom: 1px solid var(--border); color: var(--text2); font-weight: 400; letter-spacing: 1px; text-transform: uppercase; font-size: 0.73rem; white-space: nowrap; }
  .wine-table td { padding: 10px 13px; border-bottom: 1px solid rgba(58,40,48,0.4); }
  .wine-table tr:hover td { background: rgba(201,168,76,0.04); cursor: pointer; }
  .type-badge { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap; }
  .badge-rouge       { background: rgba(123,28,46,0.3);   color: #e06070; border: 1px solid #7b1c2e; }
  .badge-blanc       { background: rgba(201,168,76,0.15); color: #e8c870; border: 1px solid #9a7e30; }
  .badge-ros√©        { background: rgba(200,100,120,0.2); color: #e8a0b0; border: 1px solid #a05060; }
  .badge-effervescent{ background: rgba(180,210,240,0.15);color: #a8d8f0; border: 1px solid #5080a0; }
  .badge-vdn         { background: rgba(160,80,200,0.2);  color: #d0a0f0; border: 1px solid #804090; }
  .badge-magnum      { background: rgba(80,50,100,0.3);   color: #c0a0e8; border: 1px solid #6040a0; }
  .format-badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 0.67rem; letter-spacing: 0.5px; text-transform: uppercase; background: rgba(201,168,76,0.09); color: var(--text2); border: 1px solid #3a2830; margin-left: 4px; }
  .rating-stars { color: var(--gold); letter-spacing: -1px; }
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text2); font-size: 1.1rem; font-style: italic; }

  /* STATS VIEW */
  .stats-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 28px; }
  .stat-card { background: var(--bg2); border: 1px solid var(--border); padding: 20px 22px; border-radius: 3px; position: relative; overflow: hidden; }
  .stat-card::before { content:''; position: absolute; left:0; top:0; bottom:0; width:3px; background: var(--gold); }
  .stat-card .s-val { font-family: 'Playfair Display', serif; font-size: 2.1rem; color: var(--gold); line-height: 1; }
  .stat-card .s-lbl { font-size: 0.78rem; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; margin-top: 6px; }
  .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .chart-card { background: var(--bg2); border: 1px solid var(--border); padding: 20px; border-radius: 3px; }
  .chart-card h3 { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--gold2); margin-bottom: 16px; font-weight: 400; letter-spacing: 1px; }
  .bar-chart { display: flex; flex-direction: column; gap: 8px; }
  .bar-row { display: flex; align-items: center; gap: 10px; }
  .bar-label { width: 96px; font-size: 0.79rem; color: var(--text2); text-align: right; flex-shrink: 0; }
  .bar-track { flex: 1; height: 17px; background: var(--bg3); border-radius: 2px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 2px; transition: width 0.9s ease; }
  .bar-fill-rouge        { background: linear-gradient(90deg,#5a1020,#9e2a3f); }
  .bar-fill-blanc        { background: linear-gradient(90deg,#7a5a10,#c9a84c); }
  .bar-fill-ros√©         { background: linear-gradient(90deg,#8a3050,#c06080); }
  .bar-fill-effervescent { background: linear-gradient(90deg,#204060,#5090c0); }
  .bar-fill-vdn          { background: linear-gradient(90deg,#502080,#9040c0); }
  .bar-fill-magnum       { background: linear-gradient(90deg,#4a2870,#9060c0); }
  .bar-count { width: 28px; font-size: 0.79rem; color: var(--text2); text-align: right; }

  /* ADD VIEW */
  .add-wine-form { background: var(--bg2); border: 1px solid var(--border); padding: 32px; border-radius: 4px; max-width: 600px; }
  .add-wine-form h2 { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.5rem; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .form-full { grid-column: 1/-1; }

  /* Notifications */
  #notif { position: fixed; top: 76px; right: 20px; background: var(--bg2); border: 1px solid var(--green2); color: var(--green2); padding: 12px 20px; border-radius: 3px; font-size: 0.9rem; z-index: 500; transform: translateX(110%); transition: transform 0.3s; }
  #notif.show { transform: translateX(0); }
  #notif.error { border-color: var(--wine3); color: var(--wine3); }
</style>
</head>
<body>

<header>
  <div class="logo">üç∑ <span>Cave</span> √† Vin MMMüç∑<span></div>
  <div class="stats-bar">
    <div>Total : <b id="hdr-total">0</b> bouteilles</div>
    <div>Cave 1 : <b id="hdr-c1">0</b></div>
    <div>Cave 2 : <b id="hdr-c2">0</b></div>
    <div>Valeur estim√©e : <b id="hdr-val">0 ‚Ç¨</b></div>
  </div>
</header>

<div class="tabs">
  <div class="tab active" onclick="switchTab('view2d',this)">üó∫ Vue Cave</div>
  <div class="tab" onclick="switchTab('list',this)">üìã Liste</div>
  <div class="tab" onclick="switchTab('stats',this)">üìä Statistiques</div>
  <div class="tab" onclick="switchTab('add',this)">‚ûï Ajouter</div>
</div>

<!-- ===== 2D CAVE VIEW ===== -->
<div id="view2d" class="content active">
  <div class="cave-selector">
    <button class="cave-btn active" onclick="selectCave(1,this)">Cave 1 ‚Äî 156 empl.</button>
    <button class="cave-btn" onclick="selectCave(2,this)">Cave 2 ‚Äî 110 empl.</button>
    <div class="cave-legend">
      <div class="legend-item"><div class="legend-big" style="background:#8a1828"></div> Rouge</div>
      <div class="legend-item"><div class="legend-big" style="background:#a88018"></div> Blanc</div>
      <div class="legend-item"><div class="legend-big" style="background:#b84068"></div> Ros√©</div>
      <div class="legend-item"><div class="legend-big" style="background:#204870"></div> Effervescent</div>
      <div class="legend-item"><div class="legend-big" style="background:#703090"></div> VDN</div>
      <div class="legend-item"><div class="legend-big" style="background:#504898"></div> Magnum</div>
      <div class="legend-item"><div class="legend-big" style="background:#1a1014;border:1.5px solid #4a3040"></div> Vide</div>
      <div class="legend-item"><div class="legend-small" style="background:#4a4a4a"></div> Goulot arri√®re</div>
    </div>
  </div>
  <div class="cave-2d-wrap" id="cave2dWrap">
    <svg id="caveSvg" style="display:block;"></svg>
  </div>
</div>

<!-- ===== LIST VIEW ===== -->
<div id="list" class="content">
  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="Rechercher un vin..." oninput="renderList()">
    <select id="filterCave" onchange="renderList()">
      <option value="">Toutes les caves</option>
      <option value="1">Cave 1</option>
      <option value="2">Cave 2</option>
    </select>
    <select id="filterType" onchange="renderList()">
      <option value="">Tous les types</option>
      <option value="rouge">Rouge</option>
      <option value="blanc">Blanc</option>
      <option value="ros√©">Ros√©</option>
      <option value="effervescent">Effervescent</option>
      <option value="vdn">VDN</option>
      <option value="magnum">Magnum</option>
    </select>
    <select id="sortBy" onchange="renderList()">
      <option value="nom">Trier par nom</option>
      <option value="appellation">Trier par appellation</option>
      <option value="region">Trier par r√©gion</option>
      <option value="domaine">Trier par domaine / producteur</option>
      <option value="annee">Trier par ann√©e</option>
      <option value="prix">Trier par prix</option>
      <option value="type">Trier par type</option>
    </select>
  </div>
  <div id="listContainer"></div>
</div>

<!-- ===== STATS VIEW ===== -->
<div id="stats" class="content">
  <div class="stats-grid" id="statsGrid"></div>
  <div class="charts-row">
    <div class="chart-card"><h3>R√©partition par type</h3><div class="bar-chart" id="chartType"></div></div>
    <div class="chart-card"><h3>R√©partition par d√©cennie</h3><div class="bar-chart" id="chartDecade"></div></div>
  </div>
</div>

<!-- ===== ADD VIEW ===== -->
<div id="add" class="content">
  <div class="add-wine-form">
    <h2>Ajouter un vin</h2>
    <div class="form-grid">
      <div class="form-row form-full">
        <label>Nom / Cuv√©e *</label>
        <input type="text" id="f-nom" placeholder="ex: Gevrey-Chambertin, La T√¢che...">
      </div>
      <div class="form-row form-full">
        <label>Appellation</label>
        <input type="text" id="f-appellation" placeholder="ex: AOC Bourgogne, AOP C√¥tes du Rh√¥ne...">
      </div>
      <div class="form-row">
        <label>Domaine / Producteur</label>
        <input type="text" id="f-domaine" placeholder="ex: Domaine Leflaive">
      </div>
      <div class="form-row">
        <label>R√©gion</label>
        <input type="text" id="f-region" placeholder="ex: Bordeaux, Bourgogne...">
      </div>
      <div class="form-row">
        <label>Type *</label>
        <select id="f-type">
          <option value="rouge">Rouge</option>
          <option value="blanc">Blanc</option>
          <option value="ros√©">Ros√©</option>
          <option value="effervescent">Effervescent (Champagne, Cr√©mant‚Ä¶)</option>
          <option value="vdn">VDN (Muscat, Banyuls, Rivesaltes‚Ä¶)</option>
          <option value="magnum">Magnum</option>
        </select>
      </div>
      <div class="form-row">
        <label>Format</label>
        <select id="f-format">
          <option value="75cl">75 cl (standard)</option>
          <option value="37.5cl">37,5 cl (demi)</option>
          <option value="150cl">150 cl (Magnum)</option>
          <option value="300cl">300 cl (Double Magnum)</option>
          <option value="autre">Autre</option>
        </select>
      </div>
      <div class="form-row">
        <label>Mill√©sime *</label>
        <input type="number" id="f-annee" placeholder="2018" min="1900" max="2030">
      </div>
      <div class="form-row">
        <label>Cave *</label>
        <select id="f-cave" onchange="updateEtageSelect()">
          <option value="1">Cave 1</option>
          <option value="2">Cave 2</option>
        </select>
      </div>
      <div class="form-row">
        <label>√âtage *</label>
        <select id="f-etage"></select>
      </div>
      <div class="form-row">
        <label>Emplacement *</label>
        <select id="f-slot"></select>
      </div>
      <div class="form-row">
        <label>Prix (‚Ç¨)</label>
        <input type="number" id="f-prix" placeholder="0" min="0">
      </div>
      <div class="form-row">
        <label>Note /5</label>
        <select id="f-note">
          <option value="">‚Äî</option>
          <option value="1">‚òÖ 1</option><option value="2">‚òÖ‚òÖ 2</option>
          <option value="3">‚òÖ‚òÖ‚òÖ 3</option><option value="4">‚òÖ‚òÖ‚òÖ‚òÖ 4</option>
          <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 5</option>
        </select>
      </div>
      <div class="form-row form-full">
        <label>Notes personnelles</label>
        <textarea id="f-notes" rows="3" placeholder="Ar√¥mes, accords mets-vins, occasion..."></textarea>
      </div>
    </div>
    <div style="margin-top:20px">
      <button class="btn-wine" onclick="addWine()">Ajouter √† la cave</button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalSlot">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modalSlot')">‚úï</button>
    <h2 id="modal-title">Emplacement</h2>
    <div id="modal-body"></div>
  </div>
</div>

<div id="tooltip">
  <div class="tt-name" id="tt-name"></div>
  <div class="tt-info" id="tt-info"></div>
</div>
<div id="notif"></div>

<script>
// =====================================================================
// CONFIG
// =====================================================================
/*
  front  = bouteilles rang√©e avant (grand cercle = CUL visible)
  back   = bouteilles rang√©e arri√®re (petit cercle = GOULOT visible, c√¥te √† c√¥te)
  double = 2 couches identiques sur le m√™me √©tage
  isMagnum = marqu√© Magnum dans formulaire/liste
  slots  = total emplacements
  Cave 1 : √©tage 1 en HAUT, √©tage 8 en BAS
*/
const CAVE_CONFIG = {
  1: {
    floors: [
      { id:1, front:6, back:6, double:true,  isMagnum:false, label:'√âtage 1',           slots:24 },
      { id:2, front:6, back:6, double:false, isMagnum:false, label:'√âtage 2',           slots:12 },
      { id:3, front:6, back:6, double:false, isMagnum:false, label:'√âtage 3',           slots:12 },
      { id:4, front:6, back:6, double:false, isMagnum:false, label:'√âtage 4',           slots:12 },
      { id:5, front:6, back:6, double:false, isMagnum:false, label:'√âtage 5',           slots:12 },
      { id:6, front:6, back:6, double:true,  isMagnum:false, label:'√âtage 6',           slots:24 },
      { id:7, front:6, back:6, double:true,  isMagnum:false, label:'√âtage 7',           slots:24 },
      { id:8, front:6, back:6, double:false, isMagnum:true,  label:'√âtage 8 (Magnums)', slots:12 },
    ]
  },
  2: {
    floors: [
      { id:1, front:5, back:6, double:true, isMagnum:false, label:'√âtage 1', slots:22 },
      { id:2, front:5, back:6, double:true, isMagnum:false, label:'√âtage 2', slots:22 },
      { id:3, front:5, back:6, double:true, isMagnum:false, label:'√âtage 3', slots:22 },
      { id:4, front:5, back:6, double:true, isMagnum:false, label:'√âtage 4', slots:22 },
      { id:5, front:5, back:6, double:true, isMagnum:false, label:'√âtage 5', slots:22 },
    ]
  }
};

// =====================================================================
// DATA
// =====================================================================
let wineData = JSON.parse(localStorage.getItem('caveData') || '[]');
let currentCave = 1;
let addingToSlot = null;

const TYPE_LABELS   = { rouge:'Rouge', blanc:'Blanc', 'ros√©':'Ros√©', effervescent:'Effervescent', vdn:'VDN', magnum:'Magnum' };
const FORMAT_LABELS = { '75cl':'75 cl','37.5cl':'37,5 cl','150cl':'Magnum 150 cl','300cl':'Double Magnum','autre':'Autre' };

// Couleurs de remplissage des cercles par type
const WINE_COLORS = {
  rouge:        { fill:'#8a1828', stroke:'#c04060', small:'#5a1020' },
  blanc:        { fill:'#a88018', stroke:'#e0c060', small:'#6a5010' },
  'ros√©':       { fill:'#b84068', stroke:'#e080a0', small:'#803050' },
  effervescent: { fill:'#1e4870', stroke:'#5090c0', small:'#102840' },
  vdn:          { fill:'#703090', stroke:'#b060d0', small:'#481870' },
  magnum:       { fill:'#504898', stroke:'#9080d0', small:'#302870' },
  empty:        { fill:'#1a1014', stroke:'#4a3040', small:'#2a1a22' }
};

function saveData() { localStorage.setItem('caveData', JSON.stringify(wineData)); updateHeader(); }
function getWineAtSlot(cave, floor, slot) { return wineData.find(w => w.cave==cave && w.floor==floor && w.slot==slot); }

function updateHeader() {
  const c1 = wineData.filter(w=>w.cave==1).length;
  const c2 = wineData.filter(w=>w.cave==2).length;
  document.getElementById('hdr-total').textContent = wineData.length;
  document.getElementById('hdr-c1').textContent = c1;
  document.getElementById('hdr-c2').textContent = c2;
  const val = wineData.reduce((s,w)=>s+(parseFloat(w.prix)||0),0);
  document.getElementById('hdr-val').textContent = val.toFixed(0)+' ‚Ç¨';
}

// =====================================================================
// TABS
// =====================================================================
function switchTab(id, el) {
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(el) el.classList.add('active');
  if(id==='list')  renderList();
  if(id==='stats') renderStats();
  if(id==='add')   updateEtageSelect();
  if(id==='view2d') renderCave2D();
}

function selectCave(n, btn) {
  currentCave = n;
  document.querySelectorAll('.cave-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderCave2D();
}

// =====================================================================
// 2D SVG CAVE RENDERER
// =====================================================================
/*
  DISPOSITION dans l'√©tage (vue de face) :

  Sur UNE COUCHE on place d'abord les bouteilles AVANT (grand cercle = cul)
  puis imm√©diatement √† leur droite les bouteilles ARRI√àRE (petit cercle = goulot),
  toutes au m√™me niveau Y.

  Exemple : front=6, back=6
  [ O  O  O  O  O  O ][ o  o  o  o  o  o ]
    1  2  3  4  5  6    7  8  9  10 11 12

  Pour un double √©tage : deux couches identiques sur deux rang√©es Y distinctes.

  Le LABEL de l'√©tage est affich√© sur le bord gauche.
  Cave 1 : √©tage 1 en haut (affich√© en premier), √©tage 8 en bas.
  Cave 2 : √©tage 1 en bas (affich√© en dernier).
*/

const R_BIG   = 18;   // rayon grand cercle (cul)
const R_SMALL = 9;    // rayon petit cercle (goulot)
const PAD_H   = 24;   // padding horizontal gauche/droite
const PAD_V   = 18;   // padding vertical haut/bas
const ROW_GAP = 10;   // espace vertical entre les 2 couches d'un double √©tage
const SHELF_H = 4;    // √©paisseur planche
const FLOOR_GAP = 18; // espace entre √©tages

/*
  INTERCALAGE dans une rang√©e :
  On alterne cul (grand) et goulot (petit) sur le m√™me axe Y.
  Pour front=6, back=6 : O o O o O o O o O o O o
  L'espacement horizontal est calcul√© pour que le bord de chaque cercle
  soit toujours s√©par√© du suivant d'un GAP constant.

  Slot encoding :
    - slots 1..front         = rang√©e avant  (grands cercles)
    - slots front+1..front+back = rang√©e arri√®re (petits cercles)
  On intercale visuellement mais on conserve l'encodage d'origine.
*/

function renderCave2D() {
  const svg    = document.getElementById('caveSvg');
  const floors = CAVE_CONFIG[currentCave].floors;
  const GAP    = 7; // espace bord-√†-bord entre deux cercles cons√©cutifs

  // ‚îÄ‚îÄ Pr√©-calcul : positions X de chaque cercle dans une couche ‚îÄ‚îÄ
  // On alterne big / small en les centrant bord-√†-bord avec GAP constant.
  // Retourne un tableau [{cx, r, isFront, localIdx}]
  function layerPositions(front, back) {
    const seq = [];
    let f = 0, b = 0;
    // Intercalage : on alterne tant qu'il reste des deux c√¥t√©s,
    // puis on finit avec ce qui reste.
    while(f < front || b < back) {
      if(f < front)  { seq.push({isFront:true,  li:f});  f++; }
      if(b < back)   { seq.push({isFront:false, li:b});  b++; }
    }
    // Calcul des X
    const positions = [];
    let x = 0;
    seq.forEach((s, i) => {
      const r = s.isFront ? R_BIG : R_SMALL;
      if(i === 0) x = r;
      else {
        const rPrev = seq[i-1].isFront ? R_BIG : R_SMALL;
        x += rPrev + GAP + r;
      }
      positions.push({cx: x, r, isFront: s.isFront, li: s.li});
    });
    return positions;
  }

  // ‚îÄ‚îÄ Largeur max de toutes les couches ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let maxLayerW = 0;
  floors.forEach(f => {
    const pos = layerPositions(f.front, f.back);
    if(pos.length) {
      const last = pos[pos.length-1];
      const w = last.cx + last.r;
      if(w > maxLayerW) maxLayerW = w;
    }
  });

  const layerH    = R_BIG * 2;
  const floorH    = f => f.double
    ? layerH + ROW_GAP + layerH + SHELF_H + FLOOR_GAP
    : layerH + SHELF_H + FLOOR_GAP;

  const totalW = PAD_H + maxLayerW + PAD_H;
  const totalH = PAD_V + floors.reduce((s,f) => s + floorH(f), 0) + PAD_V;

  svg.setAttribute('width',   totalW);
  svg.setAttribute('height',  totalH);
  svg.setAttribute('viewBox', `0 0 ${totalW} ${totalH}`);

  let html = `
    <defs>
      <filter id="softglow" x="-20%" y="-20%" width="140%" height="140%">
        <feGaussianBlur stdDeviation="1.8" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <rect width="${totalW}" height="${totalH}" fill="#080406" rx="4"/>
    <rect x="1" y="1" width="${totalW-2}" height="${totalH-2}"
      fill="none" stroke="#3a2830" stroke-width="1" rx="3"/>
  `;

  // Bords lat√©raux bois
  const sideH = totalH - PAD_V * 2;
  html += `<rect x="${PAD_H-14}" y="${PAD_V}" width="6" height="${sideH}" fill="#1c0a04" rx="2"/>`;
  html += `<rect x="${PAD_H+maxLayerW+8}" y="${PAD_V}" width="6" height="${sideH}" fill="#1c0a04" rx="2"/>`;

  let yTop = PAD_V;

  floors.forEach(floor => {
    const layers = floor.double ? 2 : 1;
    const fH     = floorH(floor);
    const pos    = layerPositions(floor.front, floor.back);

    // Fond de l'√©tage
    html += `<rect x="${PAD_H-6}" y="${yTop-3}"
      width="${maxLayerW+12}" height="${fH - FLOOR_GAP + 3}"
      fill="${floor.double ? '#0f0a0c' : '#0b0709'}" rx="2"/>`;

    for(let layer = 0; layer < layers; layer++) {
      const yCenter    = yTop + layer * (layerH + ROW_GAP) + R_BIG;
      const slotOffset = layer * (floor.front + floor.back);

      pos.forEach(p => {
        const slot  = slotOffset + (p.isFront ? p.li + 1 : floor.front + p.li + 1);
        const wine  = getWineAtSlot(currentCave, floor.id, slot);
        const col   = wine ? (WINE_COLORS[wine.type] || WINE_COLORS.empty) : WINE_COLORS.empty;
        const empty = !wine;
        const cx    = PAD_H + p.cx;
        const cy    = yCenter;
        const r     = p.r;

        // Cercle principal
        html += `<circle cx="${cx}" cy="${cy}" r="${r}"
          fill="${col.fill}" stroke="${col.stroke}"
          stroke-width="${empty ? 0.7 : (p.isFront ? 1.5 : 1.1)}"
          opacity="${empty ? 0.45 : 1}"
          ${(!empty) ? 'filter="url(#softglow)"' : ''}
          style="cursor:pointer"
          onclick="openSlotModal(${currentCave},${floor.id},${slot})"
          data-cave="${currentCave}" data-floor="${floor.id}" data-slot="${slot}"/>`;

        if(p.isFront) {
          // Creux central du cul
          html += `<circle cx="${cx}" cy="${cy}" r="${r*0.28}"
            fill="${empty ? '#100a0e' : col.small}"
            opacity="${empty ? 0.35 : 0.88}"
            style="pointer-events:none"/>`;
          // Reflet
          if(!empty) {
            html += `<path d="M ${cx-r*0.52} ${cy-r*0.42} A ${r*0.6} ${r*0.6} 0 0 1 ${cx+r*0.28} ${cy-r*0.68}"
              stroke="rgba(255,255,255,0.20)" stroke-width="2.2" fill="none" stroke-linecap="round"
              style="pointer-events:none"/>`;
          }
        } else {
          // Petit reflet sur goulot
          if(!empty) {
            html += `<circle cx="${cx-r*0.32}" cy="${cy-r*0.35}" r="${r*0.25}"
              fill="rgba(255,255,255,0.15)" style="pointer-events:none"/>`;
          }
        }
      });
    }

    // Planche
    const shelfY = yTop + fH - FLOOR_GAP - SHELF_H;
    html += `<rect x="${PAD_H-8}" y="${shelfY}" width="${maxLayerW+16}" height="${SHELF_H}"
      fill="#200e08" rx="1"/>`;
    html += `<rect x="${PAD_H-8}" y="${shelfY+SHELF_H}" width="${maxLayerW+16}" height="3"
      fill="rgba(0,0,0,0.45)" rx="1"/>`;

    // S√©parateur couche double
    if(floor.double) {
      const midY = yTop + layerH + ROW_GAP * 0.5;
      html += `<line x1="${PAD_H}" y1="${midY}" x2="${PAD_H+maxLayerW}" y2="${midY}"
        stroke="#1e1018" stroke-width="0.5" stroke-dasharray="4,7"/>`;
    }

    yTop += fH;
  });

  svg.innerHTML = html;

  // ‚îÄ‚îÄ Tooltip au survol ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  svg.querySelectorAll('circle[data-cave]').forEach(el => {
    el.addEventListener('mouseenter', (e) => {
      const cave  = parseInt(el.dataset.cave);
      const floor = parseInt(el.dataset.floor);
      const slot  = parseInt(el.dataset.slot);
      const wine  = getWineAtSlot(cave, floor, slot);
      const tt    = document.getElementById('tooltip');
      const floorData = CAVE_CONFIG[cave].floors.find(f=>f.id===floor);
      if(wine) {
        document.getElementById('tt-name').textContent = wine.nom;
        document.getElementById('tt-info').innerHTML =
          `<span class="type-badge badge-${wine.type}" style="font-size:0.7rem">${TYPE_LABELS[wine.type]||wine.type}</span>
          ${wine.appellation ? `<br><i>${wine.appellation}</i>` : ''}
          <br>${wine.annee||'‚Äî'} ¬∑ ${wine.region||'‚Äî'}
          ${wine.prix ? `<br>${wine.prix} ‚Ç¨` : ''}
          ${wine.note ? `<br>${'‚òÖ'.repeat(parseInt(wine.note))}` : ''}
          <br><small style="color:#4a3840">√ât.${floor} ¬∑ #${slot}</small>`;
      } else {
        document.getElementById('tt-name').innerHTML = '<span class="tt-empty">Emplacement vide</span>';
        document.getElementById('tt-info').innerHTML =
          `${floorData?.label} ¬∑ #${slot}<br><small style="color:#5a4050">Cliquer pour ajouter</small>`;
      }
      tt.style.display = 'block';
      tt.style.left = (e.clientX + 16) + 'px';
      tt.style.top  = (e.clientY - 12) + 'px';
    });
    el.addEventListener('mousemove', (e) => {
      const tt = document.getElementById('tooltip');
      tt.style.left = (e.clientX + 16) + 'px';
      tt.style.top  = (e.clientY - 12) + 'px';
    });
    el.addEventListener('mouseleave', () => {
      document.getElementById('tooltip').style.display = 'none';
    });
  });
}

// =====================================================================
// SLOT MODAL
// =====================================================================
function openSlotModal(cave, floor, slot) {
  const wine      = getWineAtSlot(cave, floor, slot);
  const floorData = CAVE_CONFIG[cave].floors.find(f=>f.id===floor);
  document.getElementById('modal-title').textContent =
    `Cave ${cave} ¬∑ ${floorData?.label} ¬∑ Emplacement #${slot}`;
  const body = document.getElementById('modal-body');
  if(wine) {
    const stars  = '‚òÖ'.repeat(parseInt(wine.note)||0)+'‚òÜ'.repeat(5-(parseInt(wine.note)||0));
    const tLabel = TYPE_LABELS[wine.type] || wine.type;
    const fLabel = FORMAT_LABELS[wine.format] || (wine.format||'75 cl');
    body.innerHTML = `
      <div class="modal-info-panel">
        <div class="info-cell" style="grid-column:1/-1">
          <div class="lbl">Nom</div>
          <div class="val" style="font-size:1.15rem">${wine.nom}</div>
          ${wine.appellation?`<div style="font-size:0.85rem;color:var(--text2);font-style:italic;margin-top:2px">${wine.appellation}</div>`:''}
        </div>
        <div class="info-cell"><div class="lbl">Type</div><div class="val"><span class="type-badge badge-${wine.type}">${tLabel}</span></div></div>
        <div class="info-cell"><div class="lbl">Format</div><div class="val"><span class="format-badge">${fLabel}</span></div></div>
        <div class="info-cell"><div class="lbl">Mill√©sime</div><div class="val">${wine.annee||'‚Äî'}</div></div>
        <div class="info-cell"><div class="lbl">Prix</div><div class="val">${wine.prix?wine.prix+'‚Ç¨':'‚Äî'}</div></div>
        <div class="info-cell"><div class="lbl">Domaine</div><div class="val">${wine.domaine||'‚Äî'}</div></div>
        <div class="info-cell"><div class="lbl">R√©gion</div><div class="val">${wine.region||'‚Äî'}</div></div>
        <div class="info-cell"><div class="lbl">Note</div><div class="val rating-stars" style="font-size:1rem">${stars}</div></div>
      </div>
      ${wine.notes?`<div style="color:var(--text2);font-style:italic;margin-bottom:16px;line-height:1.6;font-size:0.95rem">"${wine.notes}"</div>`:''}
      <div class="modal-actions">
        <button class="btn-outline" onclick="openEditModal('${wine.id}')">‚úè Modifier</button>
        <button class="btn-danger"  onclick="removeWine('${wine.id}')">üóë Retirer</button>
        <button class="btn-wine"    onclick="closeModal('modalSlot')">Fermer</button>
      </div>`;
  } else {
    body.innerHTML = `
      <div style="text-align:center;padding:20px 0;color:var(--text2);font-style:italic;margin-bottom:20px">
        Emplacement libre${floorData?.isMagnum?' ¬∑ R√©serv√© Magnums':''}
      </div>
      <div class="modal-actions">
        <button class="btn-wine" onclick="openAddToSlot(${cave},${floor},${slot})">‚ûï Placer un vin ici</button>
        <button class="btn-outline" onclick="closeModal('modalSlot')">Fermer</button>
      </div>`;
  }
  document.getElementById('modalSlot').classList.add('open');
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function openAddToSlot(cave, floor, slot) {
  closeModal('modalSlot');
  addingToSlot = {cave, floor, slot};
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===3));
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.getElementById('add').classList.add('active');
  document.getElementById('f-cave').value = cave;
  updateEtageSelect();
  document.getElementById('f-etage').value = floor;
  updateSlotSelect();
  document.getElementById('f-slot').value = slot;
  if(CAVE_CONFIG[cave].floors.find(f=>f.id==floor)?.isMagnum) {
    document.getElementById('f-type').value   = 'magnum';
    document.getElementById('f-format').value = '150cl';
  }
  showNotif(`Cave ${cave} ¬∑ √âtage ${floor} ¬∑ Emplacement #${slot}`);
}

function openEditModal(id) {
  const wine = wineData.find(w=>w.id===id);
  if(!wine) return;
  closeModal('modalSlot');
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===3));
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.getElementById('add').classList.add('active');
  document.getElementById('f-nom').value         = wine.nom;
  document.getElementById('f-appellation').value = wine.appellation||'';
  document.getElementById('f-domaine').value     = wine.domaine||'';
  document.getElementById('f-region').value      = wine.region||'';
  document.getElementById('f-type').value        = wine.type;
  document.getElementById('f-format').value      = wine.format||'75cl';
  document.getElementById('f-annee').value       = wine.annee||'';
  document.getElementById('f-prix').value        = wine.prix||'';
  document.getElementById('f-note').value        = wine.note||'';
  document.getElementById('f-notes').value       = wine.notes||'';
  document.getElementById('f-cave').value        = wine.cave;
  updateEtageSelect();
  document.getElementById('f-etage').value = wine.floor;
  updateSlotSelect();
  document.getElementById('f-slot').value  = wine.slot;
  addingToSlot = {editing:id, cave:wine.cave, floor:wine.floor, slot:wine.slot};
  showNotif('Mode √©dition ‚Äî modifiez puis validez');
}

function removeWine(id) {
  if(!confirm('Retirer ce vin de la cave ?')) return;
  wineData = wineData.filter(w=>w.id!==id);
  saveData(); closeModal('modalSlot');
  renderCave2D(); renderList();
  showNotif('Vin retir√© ‚úì');
}

// =====================================================================
// FORM
// =====================================================================
function updateFormSelects() { updateEtageSelect(); }

function updateEtageSelect() {
  const cave = parseInt(document.getElementById('f-cave').value)||1;
  const sel  = document.getElementById('f-etage');
  sel.innerHTML = '';
  CAVE_CONFIG[cave].floors.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f.id;
    opt.textContent = f.label + (f.isMagnum?' ¬∑ Magnums':'');
    sel.appendChild(opt);
  });
  sel.onchange = updateSlotSelect;
  updateSlotSelect();
}

function updateSlotSelect() {
  const cave      = parseInt(document.getElementById('f-cave').value)||1;
  const floor     = parseInt(document.getElementById('f-etage').value)||1;
  const floorData = CAVE_CONFIG[cave].floors.find(f=>f.id===floor);
  if(!floorData) return;
  const sel = document.getElementById('f-slot');
  sel.innerHTML = '';
  for(let i=1; i<=floorData.slots; i++) {
    const taken     = getWineAtSlot(cave,floor,i);
    const editingId = addingToSlot?.editing;
    const isSelf    = editingId && taken?.id===editingId;
    if(taken && !isSelf) continue;
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `Emplacement ${i}`;
    sel.appendChild(opt);
  }
  if(sel.options.length===0) {
    const opt = document.createElement('option');
    opt.value=''; opt.textContent='‚Äî √âtage complet ‚Äî';
    sel.appendChild(opt);
  }
}

function addWine() {
  const nom   = document.getElementById('f-nom').value.trim();
  const cave  = document.getElementById('f-cave').value;
  const floor = document.getElementById('f-etage').value;
  const slot  = document.getElementById('f-slot').value;
  if(!nom)  { showNotif('Le nom est requis', true); return; }
  if(!slot) { showNotif('Aucun emplacement disponible', true); return; }
  const editingId = addingToSlot?.editing;
  if(editingId) wineData = wineData.filter(w=>w.id!==editingId);
  wineData.push({
    id: editingId || Date.now().toString(),
    nom,
    appellation: document.getElementById('f-appellation').value.trim(),
    domaine:     document.getElementById('f-domaine').value.trim(),
    region:      document.getElementById('f-region').value.trim(),
    type:        document.getElementById('f-type').value,
    format:      document.getElementById('f-format').value,
    annee:       document.getElementById('f-annee').value,
    prix:        document.getElementById('f-prix').value,
    note:        document.getElementById('f-note').value,
    notes:       document.getElementById('f-notes').value.trim(),
    cave:  parseInt(cave), floor: parseInt(floor), slot: parseInt(slot),
    dateAjout: new Date().toISOString().split('T')[0]
  });
  saveData(); addingToSlot = null;
  ['f-nom','f-appellation','f-domaine','f-region','f-annee','f-prix','f-notes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-note').value='';
  document.getElementById('f-type').value='rouge';
  document.getElementById('f-format').value='75cl';
  renderCave2D();
  showNotif('Vin ajout√© avec succ√®s ‚úì');
}

// =====================================================================
// LIST
// =====================================================================
function renderList() {
  const q    = document.getElementById('searchInput').value.toLowerCase();
  const cave = document.getElementById('filterCave').value;
  const type = document.getElementById('filterType').value;
  const sort = document.getElementById('sortBy').value;
  let wines  = wineData.filter(w => {
    if(cave && w.cave!=cave) return false;
    if(type && w.type!==type) return false;
    if(q && !([w.nom,w.appellation,w.region,w.domaine].join(' ').toLowerCase().includes(q))) return false;
    return true;
  });
  wines.sort((a,b) => {
    if(sort==='annee')       return (b.annee||0)-(a.annee||0);
    if(sort==='prix')        return (b.prix||0)-(a.prix||0);
    if(sort==='type')        return a.type.localeCompare(b.type);
    if(sort==='appellation') return (a.appellation||'').localeCompare(b.appellation||'');
    if(sort==='region')      return (a.region||'').localeCompare(b.region||'');
    if(sort==='domaine')     return (a.domaine||'').localeCompare(b.domaine||'');
    return a.nom.localeCompare(b.nom);
  });
  const cont = document.getElementById('listContainer');
  if(wines.length===0) {
    cont.innerHTML=`<div class="empty-state">Aucun vin ¬∑ <a href="#" onclick="document.querySelectorAll('.tab')[3].click()" style="color:var(--gold);text-decoration:none">Ajouter</a></div>`;
    return;
  }
  let html=`<table class="wine-table"><thead><tr>
    <th>Nom</th><th>Appellation</th><th>Domaine / Producteur</th><th>Type</th><th>Format</th><th>Mill√©sime</th><th>R√©gion</th><th>Cave</th><th>Position</th><th>Prix</th><th></th>
  </tr></thead><tbody>`;
  wines.forEach(w => {
    const tLabel = TYPE_LABELS[w.type]||w.type;
    const fLabel = FORMAT_LABELS[w.format]||(w.format||'75 cl');
    html += `<tr onclick="openSlotModal(${w.cave},${w.floor},${w.slot})" title="Voir">
      <td><b style="color:var(--cream)">${w.nom||'‚Äî'}</b></td>
      <td style="color:var(--text2);font-style:italic">${w.appellation||'‚Äî'}</td>
      <td style="color:var(--text2)">${w.domaine||'‚Äî'}</td>
      <td><span class="type-badge badge-${w.type}">${tLabel}</span></td>
      <td><span class="format-badge">${fLabel}</span></td>
      <td>${w.annee||'‚Äî'}</td>
      <td>${w.region||'‚Äî'}</td>
      <td>Cave ${w.cave}</td>
      <td style="white-space:nowrap">√ât.${w.floor} #${w.slot}</td>
      <td>${w.prix?w.prix+'‚Ç¨':'‚Äî'}</td>
      <td><button class="btn-danger" style="padding:4px 9px;font-size:0.78rem" onclick="event.stopPropagation();removeWine('${w.id}')">‚úï</button></td>
    </tr>`;
  });
  html += '</tbody></table>';
  cont.innerHTML = html;
}

// =====================================================================
// STATS
// =====================================================================
function renderStats() {
  const total   = wineData.length;
  const val     = wineData.reduce((s,w)=>s+(parseFloat(w.prix)||0),0);
  const types   = {}; wineData.forEach(w=>{types[w.type]=(types[w.type]||0)+1;});
  const decades = {}; wineData.forEach(w=>{if(w.annee){const d=Math.floor(w.annee/10)*10; decades[d]=(decades[d]||0)+1;}});
  const cap1    = CAVE_CONFIG[1].floors.reduce((s,f)=>s+f.slots,0);
  const cap2    = CAVE_CONFIG[2].floors.reduce((s,f)=>s+f.slots,0);
  const occ1    = wineData.filter(w=>w.cave==1).length;
  const occ2    = wineData.filter(w=>w.cave==2).length;
  document.getElementById('statsGrid').innerHTML=`
    <div class="stat-card"><div class="s-val">${total}</div><div class="s-lbl">Bouteilles total</div></div>
    <div class="stat-card"><div class="s-val" style="color:var(--green2)">${Math.round(val)}‚Ç¨</div><div class="s-lbl">Valeur estim√©e</div></div>
    <div class="stat-card"><div class="s-val">${occ1}/${cap1}</div><div class="s-lbl">Cave 1 (${Math.round(occ1/cap1*100)||0}% remplie)</div></div>
    <div class="stat-card"><div class="s-val">${occ2}/${cap2}</div><div class="s-lbl">Cave 2 (${Math.round(occ2/cap2*100)||0}% remplie)</div></div>`;
  const typeOrder = ['rouge','blanc','ros√©','effervescent','vdn','magnum'];
  const typeNames = {rouge:'Rouge',blanc:'Blanc','ros√©':'Ros√©',effervescent:'Effervescent',vdn:'VDN',magnum:'Magnum'};
  const maxT = Math.max(1,...Object.values(types));
  document.getElementById('chartType').innerHTML = typeOrder.map(t=>`
    <div class="bar-row">
      <div class="bar-label">${typeNames[t]||t}</div>
      <div class="bar-track"><div class="bar-fill bar-fill-${t}" style="width:${((types[t]||0)/maxT*100)}%"></div></div>
      <div class="bar-count">${types[t]||0}</div>
    </div>`).join('');
  const decKeys = Object.keys(decades).sort();
  const maxD    = Math.max(1,...Object.values(decades));
  document.getElementById('chartDecade').innerHTML = decKeys.map(d=>`
    <div class="bar-row">
      <div class="bar-label">${d}s</div>
      <div class="bar-track"><div class="bar-fill" style="width:${decades[d]/maxD*100}%;background:linear-gradient(90deg,#3a1828,#9e2a3f)"></div></div>
      <div class="bar-count">${decades[d]}</div>
    </div>`).join('') || '<div style="color:var(--text2);font-style:italic;padding:10px">Aucune ann√©e renseign√©e</div>';
}

// =====================================================================
// NOTIF
// =====================================================================
function showNotif(msg, error=false) {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.className = 'show'+(error?' error':'');
  setTimeout(()=>n.className='', 3000);
}

// =====================================================================
// INIT
// =====================================================================
window.addEventListener('load', () => {
  updateHeader();
  updateEtageSelect();
  if(wineData.length===0) {
    const samples = [
      {id:'1',nom:'Gevrey-Chambertin',appellation:'AOC Gevrey-Chambertin',domaine:'Rossignol-Trapet',region:'Bourgogne',type:'rouge',format:'75cl',annee:2018,prix:65,note:5,notes:'Magnifique pinot noir',cave:1,floor:1,slot:1},
      {id:'2',nom:'Meursault Les Charmes',appellation:'AOC Meursault 1er Cru',domaine:'Domaine Leflaive',region:'Bourgogne',type:'blanc',format:'75cl',annee:2019,prix:90,note:4,notes:"Chardonnay d'exception",cave:1,floor:2,slot:1},
      {id:'3',nom:'C√¥te R√¥tie La Mouline',appellation:'AOC C√¥te-R√¥tie',domaine:'E.Guigal',region:'Rh√¥ne',type:'rouge',format:'75cl',annee:2017,prix:220,note:5,notes:'Grande Syrah',cave:1,floor:3,slot:2},
      {id:'4',nom:'Blanc de Blancs',appellation:'AOC Champagne',domaine:'Billecart-Salmon',region:'Champagne',type:'effervescent',format:'75cl',annee:2015,prix:85,note:4,notes:'Mill√©sim√©',cave:2,floor:1,slot:1},
      {id:'5',nom:'Muscat Beaumes-de-Venise',appellation:'AOC Muscat Beaumes-de-Venise',domaine:'Domaine Durban',region:'Rh√¥ne',type:'vdn',format:'75cl',annee:2020,prix:18,note:3,notes:'VDN doux et floral',cave:2,floor:2,slot:3},
      {id:'6',nom:'Roman√©e-Saint-Vivant',appellation:'AOC Roman√©e-Saint-Vivant GC',domaine:'Domaine Leroy',region:'Bourgogne',type:'rouge',format:'150cl',annee:2012,prix:1800,note:5,notes:'Format Magnum',cave:1,floor:8,slot:1},
      {id:'7',nom:'Pouilly-Fum√© Silex',appellation:'AOC Pouilly-Fum√©',domaine:'Didier Dagueneau',region:'Loire',type:'blanc',format:'75cl',annee:2020,prix:55,note:4,notes:'',cave:1,floor:1,slot:2},
      {id:'8',nom:'Bandol Rouge',appellation:'AOC Bandol',domaine:'Domaine Tempier',region:'Provence',type:'rouge',format:'75cl',annee:2019,prix:38,note:4,notes:'Mourv√®dre magistral',cave:1,floor:4,slot:5},
    ];
    samples.forEach(s=>{s.dateAjout='2024-01-01'; wineData.push(s);});
    saveData();
  }
  renderCave2D();
});
</script>
</body>
</html>
