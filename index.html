<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üç∑  Cave √† Vin MMM</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #18100f;
    --bg2: #221518;
    --bg3: #2c1c20;
    --wine: #7b1c2e;
    --wine2: #9e2a3f;
    --wine3: #c4364f;
    --gold: #c9a84c;
    --gold2: #e8c870;
    --cream: #f5ede0;
    --text: #e8ddd0;
    --text2: #b0a090;
    --green: #2d7a4e;
    --green2: #3da066;
    --border: #3a2830;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Cormorant Garamond', serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* HEADER */
  header {
    background: linear-gradient(180deg, #000 0%, var(--bg) 100%);
    border-bottom: 1px solid var(--border);
    padding: 18px 40px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
    backdrop-filter: blur(10px);
  }
  .logo { font-family: 'Playfair Display', serif; font-size: 1.7rem; color: var(--gold); letter-spacing: 2px; }
  .logo span { color: var(--cream); font-style: italic; }
  .stats-bar { display: flex; gap: 28px; font-size: 0.85rem; color: var(--text2); letter-spacing: 1px; }
  .stats-bar b { color: var(--gold); font-size: 1.05rem; }

  /* TABS */
  .tabs { display: flex; border-bottom: 1px solid var(--border); padding: 0 40px; background: var(--bg2); }
  .tab {
    padding: 13px 26px; cursor: pointer; color: var(--text2);
    font-size: 0.88rem; letter-spacing: 2px; text-transform: uppercase;
    border-bottom: 2px solid transparent; transition: all 0.3s;
  }
  .tab:hover { color: var(--cream); }
  .tab.active { color: var(--gold); border-bottom-color: var(--gold); }

  .content { display: none; padding: 28px 40px; }
  .content.active { display: block; }

  /* ===================== 2D CAVE VIEW ===================== */
  .cave-selector {
    display: flex; gap: 14px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;
  }
  .cave-btn {
    padding: 9px 22px; border: 1px solid var(--border);
    background: transparent; color: var(--text2); cursor: pointer;
    font-family: 'Cormorant Garamond', serif; font-size: 1rem; letter-spacing: 1px;
    transition: all 0.3s; border-radius: 2px;
  }
  .cave-btn.active, .cave-btn:hover { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.07); }

  .cave-legend {
    margin-left: auto; display: flex; gap: 18px;
    font-size: 0.78rem; color: var(--text2); align-items: center; flex-wrap: wrap;
  }
  .legend-item { display: flex; align-items: center; gap: 6px; }
  .legend-big  { width: 18px; height: 18px; border-radius: 50%; border: 1.5px solid rgba(255,255,255,0.15); }
  .legend-small{ width: 9px;  height: 9px;  border-radius: 50%; border: 1px solid rgba(255,255,255,0.15); }

  /* Cave wrapper */
  .cave-2d-wrap {
    background: #080406;
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow-x: auto;
    overflow-y: auto;
    padding: 20px;
    position: relative;
    display: flex;
    justify-content: center;
  }

  /* Tooltip */
  #tooltip {
    position: fixed;
    background: rgba(8,4,6,0.97);
    border: 1px solid var(--gold);
    padding: 12px 16px; border-radius: 3px;
    font-size: 0.84rem; pointer-events: none;
    display: none; z-index: 999; max-width: 280px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.9);
  }
  #tooltip .tt-name { font-family: 'Playfair Display', serif; color: var(--gold); margin-bottom: 4px; font-size: 0.95rem; }
  #tooltip .tt-info { color: var(--text2); line-height: 1.65; font-size: 0.79rem; }
  #tooltip .tt-empty { color: #665858; font-style: italic; }

  /* Modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.88); z-index: 200; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--bg2); border: 1px solid var(--border); padding: 32px; width: 760px; max-width: 96vw; border-radius: 4px; position: relative; max-height: 90vh; overflow-y: auto; }
  .modal h2 { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.35rem; margin-bottom: 18px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
  .modal-close { position: absolute; top: 14px; right: 16px; background: none; border: none; color: var(--text2); font-size: 1.4rem; cursor: pointer; }
  .form-row { margin-bottom: 13px; }
  .form-row label { display: block; font-size: 0.78rem; color: var(--text2); letter-spacing: 1px; margin-bottom: 4px; text-transform: uppercase; }
  .form-row input, .form-row select, .form-row textarea {
    width: 100%; padding: 9px 12px; background: var(--bg3); border: 1px solid var(--border);
    color: var(--text); font-family: 'Cormorant Garamond', serif; font-size: 1rem;
    border-radius: 2px; outline: none; transition: border-color 0.2s;
  }
  .form-row input:focus, .form-row select:focus { border-color: var(--gold); }
  .form-row select option { background: var(--bg3); }
  .btn-wine { padding: 10px 26px; background: var(--wine); border: none; color: var(--cream); font-family: 'Cormorant Garamond', serif; font-size: 1rem; letter-spacing: 1px; cursor: pointer; border-radius: 2px; transition: background 0.2s; }
  .btn-wine:hover { background: var(--wine2); }
  .btn-outline { padding: 10px 18px; background: transparent; border: 1px solid var(--border); color: var(--text2); font-family: 'Cormorant Garamond', serif; font-size: 1rem; cursor: pointer; border-radius: 2px; transition: all 0.2s; }
  .btn-outline:hover { border-color: var(--wine3); color: var(--wine3); }
  .btn-danger { padding: 10px 18px; background: transparent; border: 1px solid #6b1a1a; color: #d44; font-family: 'Cormorant Garamond', serif; font-size: 1rem; cursor: pointer; border-radius: 2px; transition: all 0.2s; }
  .btn-danger:hover { background: #6b1a1a33; }
  .modal-info-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 18px; }
  .info-cell { background: var(--bg3); padding: 9px 13px; border-radius: 2px; }
  .info-cell .lbl { font-size: 0.68rem; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
  .info-cell .val { font-size: 1.02rem; color: var(--cream); margin-top: 2px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 18px; flex-wrap: wrap; }

  /* LIST VIEW */
  .filter-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
  .filter-bar input, .filter-bar select { padding: 8px 14px; background: var(--bg2); border: 1px solid var(--border); color: var(--text); font-family: 'Cormorant Garamond', serif; font-size: 0.95rem; border-radius: 2px; outline: none; transition: border-color 0.2s; }
  .filter-bar input:focus, .filter-bar select:focus { border-color: var(--gold); }
  .filter-bar input { width: 220px; }
  .wine-table { width: 100%; border-collapse: collapse; font-size: 0.94rem; }
  .wine-table th { text-align: left; padding: 9px 13px; border-bottom: 1px solid var(--border); color: var(--text2); font-weight: 400; letter-spacing: 1px; text-transform: uppercase; font-size: 0.73rem; white-space: nowrap; }
  .wine-table td { padding: 10px 13px; border-bottom: 1px solid rgba(58,40,48,0.4); }
  .wine-table tr:hover td { background: rgba(201,168,76,0.04); cursor: pointer; }
  .type-badge { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap; }
  .badge-rouge       { background: rgba(123,28,46,0.3);   color: #e06070; border: 1px solid #7b1c2e; }
  .badge-blanc       { background: rgba(201,168,76,0.15); color: #e8c870; border: 1px solid #9a7e30; }
  .badge-ros√©        { background: rgba(200,100,120,0.2); color: #e8a0b0; border: 1px solid #a05060; }
  .badge-effervescent{ background: rgba(180,210,240,0.15);color: #a8d8f0; border: 1px solid #5080a0; }
  .badge-vdn         { background: rgba(160,80,200,0.2);  color: #d0a0f0; border: 1px solid #804090; }
  .badge-magnum      { background: rgba(80,50,100,0.3);   color: #c0a0e8; border: 1px solid #6040a0; }
  .format-badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 0.67rem; letter-spacing: 0.5px; text-transform: uppercase; background: rgba(201,168,76,0.09); color: var(--text2); border: 1px solid #3a2830; margin-left: 4px; }
  .rating-stars { color: var(--gold); letter-spacing: -1px; }
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text2); font-size: 1.1rem; font-style: italic; }

  /* STATS VIEW */
  .stats-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 28px; }
  .stat-card { background: var(--bg2); border: 1px solid var(--border); padding: 20px 22px; border-radius: 3px; position: relative; overflow: hidden; }
  .stat-card::before { content:''; position: absolute; left:0; top:0; bottom:0; width:3px; background: var(--gold); }
  .stat-card .s-val { font-family: 'Playfair Display', serif; font-size: 2.1rem; color: var(--gold); line-height: 1; }
  .stat-card .s-lbl { font-size: 0.78rem; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; margin-top: 6px; }
  .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .chart-card { background: var(--bg2); border: 1px solid var(--border); padding: 20px; border-radius: 3px; }
  .chart-card h3 { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--gold2); margin-bottom: 16px; font-weight: 400; letter-spacing: 1px; }
  .bar-chart { display: flex; flex-direction: column; gap: 8px; }
  .bar-row { display: flex; align-items: center; gap: 10px; }
  .bar-label { width: 96px; font-size: 0.79rem; color: var(--text2); text-align: right; flex-shrink: 0; }
  .bar-track { flex: 1; height: 17px; background: var(--bg3); border-radius: 2px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 2px; transition: width 0.9s ease; }
  .bar-fill-rouge        { background: linear-gradient(90deg,#5a1020,#9e2a3f); }
  .bar-fill-blanc        { background: linear-gradient(90deg,#7a5a10,#c9a84c); }
  .bar-fill-ros√©         { background: linear-gradient(90deg,#8a3050,#c06080); }
  .bar-fill-effervescent { background: linear-gradient(90deg,#204060,#5090c0); }
  .bar-fill-vdn          { background: linear-gradient(90deg,#502080,#9040c0); }
  .bar-fill-magnum       { background: linear-gradient(90deg,#4a2870,#9060c0); }
  .bar-count { width: 28px; font-size: 0.79rem; color: var(--text2); text-align: right; }

  /* ADD VIEW */
  .add-wine-form { background: var(--bg2); border: 1px solid var(--border); padding: 32px; border-radius: 4px; max-width: 600px; }
  .add-wine-form h2 { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.5rem; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .form-full { grid-column: 1/-1; }

  /* Notifications */
  #notif { position: fixed; top: 76px; right: 20px; background: var(--bg2); border: 1px solid var(--green2); color: var(--green2); padding: 12px 20px; border-radius: 3px; font-size: 0.9rem; z-index: 500; transform: translateX(130%); opacity: 0; visibility: hidden; transition: transform 0.3s, opacity 0.3s; }
  #notif.show { transform: translateX(0); opacity: 1; visibility: visible; }
  #notif.error { border-color: var(--wine3); color: var(--wine3); }

  /* PASSWORD SCREEN */
  #pwd-screen {
    position: fixed; inset: 0; background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999; flex-direction: column; gap: 20px;
  }
  #pwd-screen.hidden { display: none; }
  .pwd-box {
    background: var(--bg2); border: 1px solid var(--border);
    padding: 40px 48px; border-radius: 4px; text-align: center;
    box-shadow: 0 8px 40px rgba(0,0,0,0.8);
  }
  .pwd-box h1 { font-family: 'Playfair Display', serif; color: var(--gold); font-size: 2rem; margin-bottom: 6px; }
  .pwd-box p  { color: var(--text2); font-size: 0.9rem; margin-bottom: 24px; letter-spacing: 1px; }
  .pwd-input {
    width: 100%; padding: 12px 16px; background: var(--bg3);
    border: 1px solid var(--border); color: var(--text);
    font-family: 'Cormorant Garamond', serif; font-size: 1.1rem;
    border-radius: 2px; outline: none; text-align: center;
    letter-spacing: 3px; margin-bottom: 14px;
    transition: border-color 0.2s;
  }
  .pwd-input:focus { border-color: var(--gold); }
  .pwd-input.error { border-color: var(--wine3); animation: shake 0.3s; }
  .pwd-btn {
    width: 100%; padding: 12px; background: var(--wine);
    border: none; color: var(--cream); font-family: 'Cormorant Garamond', serif;
    font-size: 1rem; letter-spacing: 2px; cursor: pointer;
    border-radius: 2px; transition: background 0.2s;
  }
  .pwd-btn:hover { background: var(--wine2); }
  .pwd-error { color: var(--wine3); font-size: 0.85rem; margin-top: 10px; min-height: 18px; }
  @keyframes shake {
    0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)}
  }

</style>
</head>
<body>


<!-- PASSWORD SCREEN -->
<div id="pwd-screen">
  <div class="pwd-box">
    <h1>üç∑ Cave √† Vin</h1>
    <p>Acc√®s priv√© ‚Äî Entrez votre mot de passe</p>
    <input type="password" class="pwd-input" id="pwd-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
      onkeydown="if(event.key==='Enter') checkPwd()">
    <button class="pwd-btn" onclick="checkPwd()">Acc√©der √† ma cave</button>
    <div class="pwd-error" id="pwd-error"></div>
  </div>
</div>

<header>
  <div class="logo">üç∑ <span>Cave</span> √† Vin MMM üç∑<span></div>
  <div class="stats-bar">
    <div>Total : <b id="hdr-total">0</b> bouteilles</div>
    <div>Cave 1 : <b id="hdr-c1">0</b></div>
    <div>Cave 2 : <b id="hdr-c2">0</b></div>
    <div>Valeur estim√©e : <b id="hdr-val">0 ‚Ç¨</b></div>
  </div>
</header>

<div class="tabs">
  <div class="tab active" onclick="switchTab('view2d',this)">üó∫ Vue Cave</div>
  <div class="tab" onclick="switchTab('list',this)">üìã Liste</div>
  <div class="tab" onclick="switchTab('stats',this)">üìä Statistiques</div>
  <div class="tab" onclick="switchTab('add',this)">‚ûï Ajouter</div>
  <div class="tab" onclick="switchTab('historique',this)">üìú Historique</div>
  <div class="tab" onclick="switchTab('accords',this)">üçΩ Accords</div>
</div>

<!-- ===== 2D CAVE VIEW ===== -->
<div id="view2d" class="content active">
  <div class="cave-selector">
    <button class="cave-btn active" onclick="selectCave(1,this)">Cave 1 ‚Äî 156 empl.</button>
    <button class="cave-btn" onclick="selectCave(2,this)">Cave 2 ‚Äî 110 empl.</button>
    <div class="cave-legend">
      <div class="legend-item"><div class="legend-big" style="background:#8a1828"></div> Rouge</div>
      <div class="legend-item"><div class="legend-big" style="background:#a88018"></div> Blanc</div>
      <div class="legend-item"><div class="legend-big" style="background:#b84068"></div> Ros√©</div>
      <div class="legend-item"><div class="legend-big" style="background:#204870"></div> Effervescent</div>
      <div class="legend-item"><div class="legend-big" style="background:#703090"></div> VDN</div>
      <div class="legend-item"><div class="legend-big" style="background:#504898"></div> Magnum</div>
      <div class="legend-item"><div class="legend-big" style="background:#1a1014;border:1.5px solid #4a3040"></div> Vide</div>
      <div class="legend-item"><div class="legend-small" style="background:#4a4a4a"></div> Goulot arri√®re</div>
    </div>
  </div>
  <div class="cave-2d-wrap" id="cave2dWrap">
    <svg id="caveSvg" style="display:block;"></svg>
  </div>
</div>

<!-- ===== LIST VIEW ===== -->
<div id="list" class="content">
  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="Rechercher un vin..." oninput="renderList()">
    <select id="filterCave" onchange="renderList()">
      <option value="">Toutes les caves</option>
      <option value="1">Cave 1</option>
      <option value="2">Cave 2</option>
    </select>
    <select id="filterType" onchange="renderList()">
      <option value="">Tous les types</option>
      <option value="rouge">Rouge</option>
      <option value="blanc">Blanc</option>
      <option value="ros√©">Ros√©</option>
      <option value="effervescent">Effervescent</option>
      <option value="vdn">VDN</option>
      <option value="magnum">Magnum</option>
    </select>
    <select id="sortBy" onchange="renderList()">
      <option value="nom">Trier par nom</option>
      <option value="appellation">Trier par appellation</option>
      <option value="region">Trier par r√©gion</option>
      <option value="domaine">Trier par domaine / producteur</option>
      <option value="annee">Trier par ann√©e</option>
      <option value="prix">Trier par prix</option>
      <option value="type">Trier par type</option>
    </select>
  </div>
  <div id="listContainer"></div>
</div>

<!-- ===== STATS VIEW ===== -->
<div id="stats" class="content">
  <div class="stats-grid" id="statsGrid"></div>
  <div class="charts-row">
    <div class="chart-card"><h3>R√©partition par type</h3><div class="bar-chart" id="chartType"></div></div>
    <div class="chart-card"><h3>R√©partition par mill√©sime</h3><div class="bar-chart" id="chartDecade"></div></div>
  </div>
  <div class="charts-row">
    <div class="chart-card"><h3>R√©partition par r√©gion</h3><div class="bar-chart" id="chartRegion"></div></div>
    <div class="chart-card"><h3>R√©partition par appellation</h3><div class="bar-chart" id="chartAppellation"></div></div>
  </div>
  <div class="charts-row" style="grid-template-columns:1fr">
    <div class="chart-card">
      <h3>Occupation des caves</h3>
      <div id="chartCaves" style="display:flex;gap:40px;flex-wrap:wrap;align-items:flex-end;padding:10px 0"></div>
    </div>
  </div>
</div>

<!-- ===== ADD VIEW ===== -->
<div id="add" class="content">
  <div class="add-wine-form">
    <h2>Ajouter un vin</h2>
    <div class="form-grid">
      <div class="form-row form-full">
        <label>Nom / Cuv√©e *</label>
        <input type="text" id="f-nom" placeholder="ex: Gevrey-Chambertin, La T√¢che...">
      </div>
      <div class="form-row form-full">
        <label>Appellation</label>
        <input type="text" id="f-appellation" placeholder="ex: AOC Bourgogne, AOP C√¥tes du Rh√¥ne...">
      </div>
      <div class="form-row">
        <label>Domaine / Producteur</label>
        <input type="text" id="f-domaine" placeholder="ex: Domaine Leflaive">
      </div>
      <div class="form-row">
        <label>R√©gion</label>
        <input type="text" id="f-region" placeholder="ex: Bordeaux, Bourgogne...">
      </div>
      <div class="form-row">
        <label>Type *</label>
        <select id="f-type">
          <option value="rouge">Rouge</option>
          <option value="blanc">Blanc</option>
          <option value="ros√©">Ros√©</option>
          <option value="effervescent">Effervescent (Champagne, Cr√©mant‚Ä¶)</option>
          <option value="vdn">VDN (Muscat, Banyuls, Rivesaltes‚Ä¶)</option>
          <option value="magnum">Magnum</option>
        </select>
      </div>
      <div class="form-row">
        <label>Format</label>
        <select id="f-format">
          <option value="75cl">75 cl (standard)</option>
          <option value="37.5cl">37,5 cl (demi)</option>
          <option value="62cl">62 cl (jaune)</option>
          <option value="150cl">150 cl (Magnum)</option>
          <option value="300cl">300 cl (Double Magnum)</option>
          <option value="autre">Autre</option>
        </select>
      </div>
      <div class="form-row">
        <label>Mill√©sime *</label>
        <input type="number" id="f-annee" placeholder="2018" min="1900" max="2030">
      </div>
      <div class="form-row">
        <label>Cave *</label>
        <select id="f-cave" onchange="updateEtageSelect()">
          <option value="1">Cave 1</option>
          <option value="2">Cave 2</option>
        </select>
      </div>
      <div class="form-row">
        <label>√âtage *</label>
        <select id="f-etage"></select>
      </div>
      <div class="form-row">
        <label>Emplacement *</label>
        <select id="f-slot"></select>
      </div>
      <div class="form-row">
        <label>Prix (‚Ç¨)</label>
        <input type="number" id="f-prix" placeholder="0" min="0">
      </div>
      <div class="form-row">
        <label>Note /5</label>
        <select id="f-note">
          <option value="">‚Äî</option>
          <option value="1">‚òÖ 1</option><option value="2">‚òÖ‚òÖ 2</option>
          <option value="3">‚òÖ‚òÖ‚òÖ 3</option><option value="4">‚òÖ‚òÖ‚òÖ‚òÖ 4</option>
          <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 5</option>
        </select>
      </div>
      <div class="form-row form-full">
        <label>Notes personnelles</label>
        <textarea id="f-notes" rows="3" placeholder="Ar√¥mes, accords mets-vins, occasion..."></textarea>
      </div>
      <div class="form-row form-full">
        <label>Photo √©tiquette (URL)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="text" id="f-image" placeholder="https://i.imgur.com/... ou lien direct vers une image" style="flex:1">
          <button type="button" onclick="searchVivino()" style="white-space:nowrap;padding:9px 16px;background:var(--wine);border:none;color:var(--cream);font-family:'Cormorant Garamond',serif;font-size:0.95rem;letter-spacing:1px;cursor:pointer;border-radius:2px;transition:background 0.2s;flex-shrink:0" onmouseover="this.style.background='var(--wine2)'" onmouseout="this.style.background='var(--wine)'">üçá Vivino</button>
        </div>
        <div id="vivino-results" style="display:none;margin-top:10px;background:var(--bg3);border:1px solid var(--border);border-radius:3px;padding:14px">
          <div id="vivino-loading"></div>
          <div id="vivino-grid"></div>
        </div>
      </div>
    </div>
    <div style="margin-top:20px">
      <button class="btn-wine" onclick="addWine()">Ajouter √† la cave</button>
    </div>
  </div>
</div>

<!-- ===== HISTORIQUE VIEW ===== -->
<div id="historique" class="content">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <h2 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.4rem">üìú Historique des d√©gustations</h2>
    <div style="display:flex;gap:10px;align-items:center">
      <span id="histo-count" style="color:var(--text2);font-size:0.85rem"></span>
    </div>
  </div>
  <div id="histo-empty" style="display:none;text-align:center;padding:60px 0;color:var(--text2);font-style:italic">Aucune bouteille bue pour l'instant</div>
  <div id="histo-list"></div>
</div>

<!-- ===== ACCORDS VIEW ===== -->
<div id="accords" class="content">
  <div style="display:flex;gap:20px;flex-wrap:wrap;margin-bottom:28px">

    <!-- Recherche plat -> vin -->
    <div style="flex:1;min-width:280px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:22px">
      <h3 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.15rem;margin-bottom:6px">üçΩ J'ai un plat, quel vin ?</h3>
      <p style="color:var(--text2);font-size:0.85rem;margin-bottom:16px">Tapez un plat ou un ingr√©dient</p>
      <div style="display:flex;gap:8px">
        <input type="text" id="accord-plat-input" placeholder="ex: agneau, fromage, saumon..."
          style="flex:1;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:1rem;border-radius:2px;outline:none"
          onkeydown="if(event.key==='Enter') rechercherParPlat()"
          onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='var(--border)'">
        <button onclick="rechercherParPlat()" style="padding:9px 18px;background:var(--wine);border:none;color:var(--cream);font-family:'Cormorant Garamond',serif;font-size:1rem;cursor:pointer;border-radius:2px">Chercher</button>
      </div>
      <div id="accord-plat-results" style="margin-top:16px"></div>
    </div>

    <!-- Recherche vin -> plat -->
    <div style="flex:1;min-width:280px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:22px">
      <h3 style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.15rem;margin-bottom:6px">üç∑ J'ai un vin, quel plat ?</h3>
      <p style="color:var(--text2);font-size:0.85rem;margin-bottom:16px">Choisissez un vin de votre cave</p>
      <select id="accord-vin-select"
        style="width:100%;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:'Cormorant Garamond',serif;font-size:1rem;border-radius:2px;outline:none"
        onchange="rechercherParVin(this.value)">
        <option value="">‚Äî Choisir un vin ‚Äî</option>
      </select>
      <div id="accord-vin-results" style="margin-top:16px"></div>
    </div>

  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalSlot">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modalSlot')">‚úï</button>
    <h2 id="modal-title">Emplacement</h2>
    <div id="modal-body"></div>
  </div>
</div>

<div id="tooltip">
  <div id="tt-img-wrap" style="margin-bottom:8px;display:none">
    <img id="tt-img" src="" alt="" style="width:100%;height:120px;object-fit:cover;border-radius:3px;border:1px solid var(--border)">
  </div>
  <div class="tt-name" id="tt-name"></div>
  <div class="tt-info" id="tt-info"></div>
</div>
<!-- MODAL HISTORIQUE (retirer un vin) -->
<div class="modal-overlay" id="modalHistorique">
  <div class="modal" style="max-width:480px">
    <button class="modal-close" onclick="document.getElementById('modalHistorique').classList.remove('open')">‚úï</button>
    <h2>üç∑ Retirer de la cave</h2>
    <p style="color:var(--text2);margin-bottom:20px;font-size:0.95rem">
      Voulez-vous enregistrer <b id="histo-wine-name" style="color:var(--cream)"></b> dans l'historique avant de la retirer ?
    </p>
    <div class="form-grid">
      <div class="form-row">
        <label>Date de d√©gustation</label>
        <input type="date" id="histo-date">
      </div>
      <div class="form-row">
        <label>Note sur 5</label>
        <select id="histo-note">
          <option value="">‚Äî</option>
          <option value="1">‚òÖ 1</option>
          <option value="2">‚òÖ‚òÖ 2</option>
          <option value="3">‚òÖ‚òÖ‚òÖ 3</option>
          <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ 4</option>
          <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 5</option>
        </select>
      </div>
      <div class="form-row form-full">
        <label>Occasion</label>
        <input type="text" id="histo-occasion" placeholder="Repas en famille, anniversaire, seul...">
      </div>
      <div class="form-row form-full">
        <label>Commentaire de d√©gustation</label>
        <textarea id="histo-commentaire" rows="3" placeholder="Ar√¥mes, texture, accord, impression g√©n√©rale..."></textarea>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:20px">
      <button class="btn-wine" onclick="confirmRetirer(true)">üìú Enregistrer et retirer</button>
      <button class="btn-outline" onclick="confirmRetirer(false)">üóë Retirer sans enregistrer</button>
      <button class="btn-outline" onclick="document.getElementById('modalHistorique').classList.remove('open')">Annuler</button>
    </div>
  </div>
</div>

<iframe name="hidden-sync-frame" style="display:none"></iframe>
<div id="notif"></div>

<script>
// =====================================================================
// CONFIG
// =====================================================================
/*
  front  = bouteilles rang√©e avant (grand cercle = CUL visible)
  back   = bouteilles rang√©e arri√®re (petit cercle = GOULOT visible, c√¥te √† c√¥te)
  double = 2 couches identiques sur le m√™me √©tage
  isMagnum = marqu√© Magnum dans formulaire/liste
  slots  = total emplacements
  Cave 1 : √©tage 1 en HAUT, √©tage 8 en BAS
*/
const CAVE_CONFIG = {
  1: {
    floors: [
      { id:1, front:6, back:6, double:true,  isMagnum:false, label:'√âtage 1',           slots:24 },
      { id:2, front:6, back:6, double:false, isMagnum:false, label:'√âtage 2',           slots:12 },
      { id:3, front:6, back:6, double:false, isMagnum:false, label:'√âtage 3',           slots:12 },
      { id:4, front:6, back:6, double:false, isMagnum:false, label:'√âtage 4',           slots:12 },
      { id:5, front:6, back:6, double:false, isMagnum:false, label:'√âtage 5',           slots:12 },
      { id:6, front:6, back:6, double:true,  isMagnum:false, label:'√âtage 6',           slots:24 },
      { id:7, front:6, back:6, double:true,  isMagnum:false, label:'√âtage 7',           slots:24 },
      { id:8, front:6, back:6, double:false, isMagnum:true,  label:'√âtage 8 (Magnums)', slots:12 },
    ]
  },
  2: {
  floors: [
    { id:1, front:6, back:5, double:true, isMagnum:false, label:'√âtage 1', slots:22 },
    { id:2, front:6, back:5, double:true, isMagnum:false, label:'√âtage 2', slots:22 },
    { id:3, front:6, back:5, double:true, isMagnum:false, label:'√âtage 3', slots:22 },
    { id:4, front:6, back:5, double:true, isMagnum:false, label:'√âtage 4', slots:22 },
    { id:5, front:6, back:5, double:true, isMagnum:false, label:'√âtage 5', slots:22 },
  ]
}
};

// =====================================================================
// DATA
// =====================================================================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_GkA2thpGf_tCdgMtoVYt5-xANAztBu6Rmks9SE5-9yF8_jdbBu7iXbgS13_5iqH_6Q/exec';

let wineData = JSON.parse(localStorage.getItem('caveData') || '[]');
let currentCave = 1;
let addingToSlot = null;

const TYPE_LABELS   = { rouge:'Rouge', blanc:'Blanc', 'ros√©':'Ros√©', effervescent:'Effervescent', vdn:'VDN', magnum:'Magnum' };
const FORMAT_LABELS = { '75cl':'75 cl','37.5cl':'37,5 cl','62cl':'62 cl','150cl':'Magnum 150 cl','300cl':'Double Magnum','autre':'Autre' };
const WINE_COLORS = {
  rouge:        { fill:'#8a1828', stroke:'#c04060', small:'#5a1020' },
  blanc:        { fill:'#a88018', stroke:'#e0c060', small:'#6a5010' },
  'ros√©':       { fill:'#b84068', stroke:'#e080a0', small:'#803050' },
  effervescent: { fill:'#1e4870', stroke:'#5090c0', small:'#102840' },
  vdn:          { fill:'#703090', stroke:'#b060d0', small:'#481870' },
  magnum:       { fill:'#504898', stroke:'#9080d0', small:'#302870' },
  empty:        { fill:'#1a1014', stroke:'#4a3040', small:'#2a1a22' }
};

function saveData() {
  localStorage.setItem('caveData', JSON.stringify(wineData));
  updateHeader();
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'save', data: wineData })
  }).catch(e => console.warn('Sync Google Sheets √©chou√©e', e));
}

function loadFromSheets() {
  showNotif('Synchronisation en cours‚Ä¶');
  const cbName = 'caveCallback_' + Date.now();
  const timeout = setTimeout(() => {
    showNotif('Mode hors ligne ‚Äî donn√©es locales', true);
    delete window[cbName];
    const s = document.getElementById('jsonp-script');
    if(s) s.remove();
  }, 8000);
  window[cbName] = function(data) {
    clearTimeout(timeout);
    try {
      if(Array.isArray(data) && data.length > 0) {
        // R√©cup√©rer les images stock√©es localement avant d'√©craser les donn√©es
        const localData = JSON.parse(localStorage.getItem('caveData') || '[]');
        // Cr√©er un index des images locales par cl√© unique (cave+floor+slot)
        const localImageMap = {};
        localData.forEach(w => {
          if(w.image) {
            const key = `${w.cave}_${w.floor}_${w.slot}`;
            localImageMap[key] = w.image;
          }
        });
        wineData = data.map(w => {
          const cave  = parseInt(w.cave)  || 1;
          const floor = parseInt(w.floor) || 1;
          const slot  = parseInt(w.slot)  || 1;
          const key   = `${cave}_${floor}_${slot}`;
          return {
            ...w,
            cave,
            floor,
            slot,
            annee: parseInt(w.annee) || '',
            prix:  parseFloat(w.prix) || '',
            note:  w.note || '',
            // Conserver l'image du Sheet si elle existe, sinon celle du localStorage
            image: w.image || localImageMap[key] || ''
          };
        });
        localStorage.setItem('caveData', JSON.stringify(wineData));
        updateHeader();
        renderCave2D();
        showNotif('Cave synchronis√©e ‚úì');
        loadHistoriqueFromSheets();
      } else {
        showNotif('Sheet vide ‚Äî donn√©es locales conserv√©es');
      }
    } catch(e) {
      showNotif('Erreur de donn√©es', true);
    } finally {
      delete window[cbName];
      const s = document.getElementById('jsonp-script');
      if(s) s.remove();
    }
  };
  const script = document.createElement('script');
  script.id = 'jsonp-script';
  script.src = SCRIPT_URL + '?callback=' + cbName + '&t=' + Date.now();
  script.onerror = function() {
    clearTimeout(timeout);
    showNotif('Mode hors ligne ‚Äî donn√©es locales', true);
    delete window[cbName];
    this.remove();
  };
  const old = document.getElementById('jsonp-script');
  if(old) old.remove();
  document.head.appendChild(script);
}

function getWineAtSlot(cave, floor, slot) { return wineData.find(w => w.cave==cave && w.floor==floor && w.slot==slot); }

function updateHeader() {
  const c1 = wineData.filter(w=>w.cave==1).length;
  const c2 = wineData.filter(w=>w.cave==2).length;
  document.getElementById('hdr-total').textContent = wineData.length;
  document.getElementById('hdr-c1').textContent = c1;
  document.getElementById('hdr-c2').textContent = c2;
  const val = wineData.reduce((s,w)=>s+(parseFloat(w.prix)||0),0);
  document.getElementById('hdr-val').textContent = val.toFixed(0)+' ‚Ç¨';
}

// =====================================================================
// TABS
// =====================================================================
function switchTab(id, el) {
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(el) el.classList.add('active');
  if(id==='list')  renderList();
  if(id==='stats') renderStats();
  if(id==='accords') populateVinSelect();
  if(id==='add')   updateEtageSelect();
  if(id==='view2d') renderCave2D();
}

function selectCave(n, btn) {
  currentCave = n;
  document.querySelectorAll('.cave-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderCave2D();
}

// =====================================================================
// 2D SVG CAVE RENDERER
// =====================================================================
/*
  DISPOSITION dans l'√©tage (vue de face) :

  Sur UNE COUCHE on place d'abord les bouteilles AVANT (grand cercle = cul)
  puis imm√©diatement √† leur droite les bouteilles ARRI√àRE (petit cercle = goulot),
  toutes au m√™me niveau Y.

  Exemple : front=6, back=6
  [ O  O  O  O  O  O ][ o  o  o  o  o  o ]
    1  2  3  4  5  6    7  8  9  10 11 12

  Pour un double √©tage : deux couches identiques sur deux rang√©es Y distinctes.

  Le LABEL de l'√©tage est affich√© sur le bord gauche.
  Cave 1 : √©tage 1 en haut (affich√© en premier), √©tage 8 en bas.
  Cave 2 : √©tage 1 en bas (affich√© en dernier).
*/

const R_BIG   = 18;   // rayon grand cercle (cul)
const R_SMALL = 9;    // rayon petit cercle (goulot)
const PAD_H   = 24;   // padding horizontal gauche/droite
const PAD_V   = 18;   // padding vertical haut/bas
const ROW_GAP = 10;   // espace vertical entre les 2 couches d'un double √©tage
const SHELF_H = 4;    // √©paisseur planche
const FLOOR_GAP = 18; // espace entre √©tages

/*
  INTERCALAGE dans une rang√©e :
  On alterne cul (grand) et goulot (petit) sur le m√™me axe Y.
  Pour front=6, back=6 : O o O o O o O o O o O o
  L'espacement horizontal est calcul√© pour que le bord de chaque cercle
  soit toujours s√©par√© du suivant d'un GAP constant.

  Slot encoding :
    - slots 1..front         = rang√©e avant  (grands cercles)
    - slots front+1..front+back = rang√©e arri√®re (petits cercles)
  On intercale visuellement mais on conserve l'encodage d'origine.
*/

function renderCave2D() {
  const svg    = document.getElementById('caveSvg');
  const floors = CAVE_CONFIG[currentCave].floors;
  const GAP    = 7; // espace bord-√†-bord entre deux cercles cons√©cutifs

  // ‚îÄ‚îÄ Pr√©-calcul : positions X de chaque cercle dans une couche ‚îÄ‚îÄ
  // On alterne big / small en les centrant bord-√†-bord avec GAP constant.
  // Retourne un tableau [{cx, r, isFront, localIdx}]
  function layerPositions(front, back) {
    const seq = [];
    let f = 0, b = 0;
    // Intercalage : on alterne tant qu'il reste des deux c√¥t√©s,
    // puis on finit avec ce qui reste.
    while(f < front || b < back) {
      if(f < front)  { seq.push({isFront:true,  li:f});  f++; }
      if(b < back)   { seq.push({isFront:false, li:b});  b++; }
    }
    // Calcul des X
    const positions = [];
    let x = 0;
    seq.forEach((s, i) => {
      const r = s.isFront ? R_BIG : R_SMALL;
      if(i === 0) x = r;
      else {
        const rPrev = seq[i-1].isFront ? R_BIG : R_SMALL;
        x += rPrev + GAP + r;
      }
      positions.push({cx: x, r, isFront: s.isFront, li: s.li});
    });
    return positions;
  }

  // ‚îÄ‚îÄ Largeur max de toutes les couches ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let maxLayerW = 0;
  floors.forEach(f => {
    const pos = layerPositions(f.front, f.back);
    if(pos.length) {
      const last = pos[pos.length-1];
      const w = last.cx + last.r;
      if(w > maxLayerW) maxLayerW = w;
    }
  });

  const layerH    = R_BIG * 2;
  const floorH    = f => f.double
    ? layerH + ROW_GAP + layerH + SHELF_H + FLOOR_GAP
    : layerH + SHELF_H + FLOOR_GAP;

  const totalW = PAD_H + maxLayerW + PAD_H;
  const totalH = PAD_V + floors.reduce((s,f) => s + floorH(f), 0) + PAD_V;

  svg.setAttribute('width',   totalW);
  svg.setAttribute('height',  totalH);
  svg.setAttribute('viewBox', `0 0 ${totalW} ${totalH}`);

  let html = `
    <defs>
      <filter id="softglow" x="-20%" y="-20%" width="140%" height="140%">
        <feGaussianBlur stdDeviation="1.8" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>
    <rect width="${totalW}" height="${totalH}" fill="#080406" rx="4"/>
    <rect x="1" y="1" width="${totalW-2}" height="${totalH-2}"
      fill="none" stroke="#3a2830" stroke-width="1" rx="3"/>
  `;

  // Bords lat√©raux bois
  const sideH = totalH - PAD_V * 2;
  html += `<rect x="${PAD_H-14}" y="${PAD_V}" width="6" height="${sideH}" fill="#1c0a04" rx="2"/>`;
  html += `<rect x="${PAD_H+maxLayerW+8}" y="${PAD_V}" width="6" height="${sideH}" fill="#1c0a04" rx="2"/>`;

  let yTop = PAD_V;

  floors.forEach(floor => {
    const layers = floor.double ? 2 : 1;
    const fH     = floorH(floor);
    const pos    = layerPositions(floor.front, floor.back);

    // Fond de l'√©tage
    html += `<rect x="${PAD_H-6}" y="${yTop-3}"
      width="${maxLayerW+12}" height="${fH - FLOOR_GAP + 3}"
      fill="${floor.double ? '#0f0a0c' : '#0b0709'}" rx="2"/>`;

    for(let layer = 0; layer < layers; layer++) {
      const yCenter    = yTop + layer * (layerH + ROW_GAP) + R_BIG;
      const slotOffset = layer * (floor.front + floor.back);

      pos.forEach(p => {
        const slot  = slotOffset + (p.isFront ? p.li + 1 : floor.front + p.li + 1);
        const wine  = getWineAtSlot(currentCave, floor.id, slot);
        const col   = wine ? (WINE_COLORS[wine.type] || WINE_COLORS.empty) : WINE_COLORS.empty;
        const empty = !wine;
        const cx      = PAD_H + p.cx;
        const cy      = yCenter;
        // Couche sup√©rieure (layer=1) : on inverse cul/goulot pour l'imbrication
        const isFront = floor.double && layer === 1 ? !p.isFront : p.isFront;
        const r       = isFront ? R_BIG : R_SMALL;

        // Cercle principal
        html += `<circle cx="${cx}" cy="${cy}" r="${r}"
          fill="${col.fill}" stroke="${col.stroke}"
          stroke-width="${empty ? 0.7 : (isFront ? 1.5 : 1.1)}"
          opacity="${empty ? 0.45 : 1}"
          ${(!empty) ? 'filter="url(#softglow)"' : ''}
          style="cursor:pointer"
          onclick="openSlotModal(${currentCave},${floor.id},${slot})"
          data-cave="${currentCave}" data-floor="${floor.id}" data-slot="${slot}"/>`;

        if(isFront) {
          // Creux central du cul
          html += `<circle cx="${cx}" cy="${cy}" r="${r*0.28}"
            fill="${empty ? '#100a0e' : col.small}"
            opacity="${empty ? 0.35 : 0.88}"
            style="pointer-events:none"/>`;
          // Reflet
          if(!empty) {
            html += `<path d="M ${cx-r*0.52} ${cy-r*0.42} A ${r*0.6} ${r*0.6} 0 0 1 ${cx+r*0.28} ${cy-r*0.68}"
              stroke="rgba(255,255,255,0.20)" stroke-width="2.2" fill="none" stroke-linecap="round"
              style="pointer-events:none"/>`;
          }
        } else {
          // Petit reflet sur goulot
          if(!empty) {
            html += `<circle cx="${cx-r*0.32}" cy="${cy-r*0.35}" r="${r*0.25}"
              fill="rgba(255,255,255,0.15)" style="pointer-events:none"/>`;
          }
        }
      });
    }

    // Planche
    const shelfY = yTop + fH - FLOOR_GAP - SHELF_H;
    html += `<rect x="${PAD_H-8}" y="${shelfY}" width="${maxLayerW+16}" height="${SHELF_H}"
      fill="#200e08" rx="1"/>`;
    html += `<rect x="${PAD_H-8}" y="${shelfY+SHELF_H}" width="${maxLayerW+16}" height="3"
      fill="rgba(0,0,0,0.45)" rx="1"/>`;

    // S√©parateur couche double
    if(floor.double) {
      const midY = yTop + layerH + ROW_GAP * 0.5;
      html += `<line x1="${PAD_H}" y1="${midY}" x2="${PAD_H+maxLayerW}" y2="${midY}"
        stroke="#1e1018" stroke-width="0.5" stroke-dasharray="4,7"/>`;
    }

    yTop += fH;
  });

  svg.innerHTML = html;

  // ‚îÄ‚îÄ Tooltip au survol ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  svg.querySelectorAll('circle[data-cave]').forEach(el => {
    el.addEventListener('mouseenter', (e) => {
      const cave  = parseInt(el.dataset.cave);
      const floor = parseInt(el.dataset.floor);
      const slot  = parseInt(el.dataset.slot);
      const wine  = getWineAtSlot(cave, floor, slot);
      const tt    = document.getElementById('tooltip');
      const floorData = CAVE_CONFIG[cave].floors.find(f=>f.id===floor);
      if(wine) {
        document.getElementById('tt-name').textContent = wine.nom;
        document.getElementById('tt-info').innerHTML =
          `<span class="type-badge badge-${wine.type}" style="font-size:0.7rem">${TYPE_LABELS[wine.type]||wine.type}</span>
          ${wine.appellation ? `<br><i>${wine.appellation}</i>` : ''}
          <br>${wine.annee||'‚Äî'} ¬∑ ${wine.region||'‚Äî'}
          ${wine.prix ? `<br>${wine.prix} ‚Ç¨` : ''}
          ${wine.note ? `<br>${'‚òÖ'.repeat(parseInt(wine.note))}` : ''}
          <br><small style="color:#4a3840">√ât.${floor} ¬∑ #${slot}</small>`;
        const imgWrap = document.getElementById('tt-img-wrap');
        const imgEl   = document.getElementById('tt-img');
        if(wine.image) { imgEl.src = wine.image; imgWrap.style.display = 'block'; }
        else { imgWrap.style.display = 'none'; }
      } else {
        document.getElementById('tt-img-wrap').style.display = 'none';
        document.getElementById('tt-name').innerHTML = '<span class="tt-empty">Emplacement vide</span>';
        document.getElementById('tt-info').innerHTML =
          `${floorData?.label} ¬∑ #${slot}<br><small style="color:#5a4050">Cliquer pour ajouter</small>`;
      }
      tt.style.display = 'block';
      tt.style.left = (e.clientX + 16) + 'px';
      tt.style.top  = (e.clientY - 12) + 'px';
    });
    el.addEventListener('mousemove', (e) => {
      const tt = document.getElementById('tooltip');
      tt.style.left = (e.clientX + 16) + 'px';
      tt.style.top  = (e.clientY - 12) + 'px';
    });
    el.addEventListener('mouseleave', () => {
      document.getElementById('tooltip').style.display = 'none';
    });
  });
}

// =====================================================================
// SLOT MODAL
// =====================================================================
function openSlotModal(cave, floor, slot) {
  const wine      = getWineAtSlot(cave, floor, slot);
  const floorData = CAVE_CONFIG[cave].floors.find(f=>f.id===floor);
  document.getElementById('modal-title').textContent =
    `Cave ${cave} ¬∑ ${floorData?.label} ¬∑ Emplacement #${slot}`;
  const body = document.getElementById('modal-body');
  if(wine) {
    const stars  = '‚òÖ'.repeat(parseInt(wine.note)||0)+'‚òÜ'.repeat(5-(parseInt(wine.note)||0));
    const tLabel = TYPE_LABELS[wine.type] || wine.type;
    const fLabel = FORMAT_LABELS[wine.format] || (wine.format||'75 cl');
    const imgHtml = wine.image ? `<div style="text-align:center;margin-bottom:18px">
        <img src="${wine.image}" alt="√âtiquette" id="etiquette-img" style="max-height:200px;max-width:100%;object-fit:contain;border-radius:4px;border:1px solid #3a2830;box-shadow:0 4px 20px rgba(0,0,0,0.7);cursor:pointer;transition:max-height 0.4s ease" onclick="this.style.maxHeight=this.style.maxHeight==='200px'||!this.style.maxHeight?'520px':'200px'" title="Cliquer pour agrandir">
        <div style="font-size:0.68rem;color:var(--text2);margin-top:5px;letter-spacing:1px">‚Üï CLIQUER POUR AGRANDIR</div>
      </div>` : '';
    body.innerHTML = `
      ${imgHtml}
      <div style="display:flex;gap:20px;align-items:flex-start">
        <div style="flex:1">
          <div class="modal-info-panel">
            <div class="info-cell" style="grid-column:1/-1">
              <div class="lbl">Nom</div>
              <div class="val" style="font-size:1.15rem">${wine.nom}</div>
              ${wine.appellation?`<div style="font-size:0.85rem;color:var(--text2);font-style:italic;margin-top:2px">${wine.appellation}</div>`:''}
            </div>
            <div class="info-cell"><div class="lbl">Type</div><div class="val"><span class="type-badge badge-${wine.type}">${tLabel}</span></div></div>
            <div class="info-cell"><div class="lbl">Format</div><div class="val"><span class="format-badge">${fLabel}</span></div></div>
            <div class="info-cell"><div class="lbl">Mill√©sime</div><div class="val">${wine.annee||'‚Äî'}</div></div>
            <div class="info-cell"><div class="lbl">Prix</div><div class="val">${wine.prix?wine.prix+'‚Ç¨':'‚Äî'}</div></div>
            <div class="info-cell"><div class="lbl">Domaine</div><div class="val">${wine.domaine||'‚Äî'}</div></div>
            <div class="info-cell"><div class="lbl">R√©gion</div><div class="val">${wine.region||'‚Äî'}</div></div>
            <div class="info-cell"><div class="lbl">Note</div><div class="val rating-stars" style="font-size:1rem">${stars}</div></div>
          </div>
          ${wine.notes?`<div style="color:var(--text2);font-style:italic;margin-bottom:16px;line-height:1.6;font-size:0.95rem">"${wine.notes}"</div>`:''}
          ${wine.accords?`<div style="margin-bottom:14px"><div style="font-size:0.68rem;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">Accords mets-vins</div><div style="color:var(--gold2);font-size:0.9rem">üçΩ ${wine.accords}</div></div>`:''}
          <div class="modal-actions">
            <button class="btn-outline" data-edit-id="${wine.id}" onclick="openEditModal(this.dataset.editId)">‚úè Modifier</button>
            <button class="btn-danger"  data-rm-id="${wine.id}"   onclick="removeWine(this.dataset.rmId)">üóë Retirer</button>
            <button class="btn-wine"    onclick="closeModal('modalSlot')">Fermer</button>
          </div>
        </div>
      </div>`;
  } else {
    body.innerHTML = `
      <div style="text-align:center;padding:20px 0;color:var(--text2);font-style:italic;margin-bottom:20px">
        Emplacement libre${floorData?.isMagnum?' ¬∑ R√©serv√© Magnums':''}
      </div>
      <div class="modal-actions">
        <button class="btn-wine" onclick="openAddToSlot(${cave},${floor},${slot})">‚ûï Placer un vin ici</button>
        <button class="btn-outline" onclick="closeModal('modalSlot')">Fermer</button>
      </div>`;
  }
  document.getElementById('modalSlot').classList.add('open');
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function openAddToSlot(cave, floor, slot) {
  closeModal('modalSlot');
  addingToSlot = {cave, floor, slot};
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===3));
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.getElementById('add').classList.add('active');
  document.getElementById('f-cave').value = cave;
  updateEtageSelect();
  document.getElementById('f-etage').value = floor;
  updateSlotSelect();
  document.getElementById('f-slot').value = slot;
  if(CAVE_CONFIG[cave].floors.find(f=>f.id==floor)?.isMagnum) {
    document.getElementById('f-type').value   = 'magnum';
    document.getElementById('f-format').value = '150cl';
  }
  showNotif(`Cave ${cave} ¬∑ √âtage ${floor} ¬∑ Emplacement #${slot}`);
}

function openEditModal(id) {
  const wine = wineData.find(w=>String(w.id)===String(id));
  if(!wine) return;
  closeModal('modalSlot');
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===3));
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.getElementById('add').classList.add('active');
  document.getElementById('f-nom').value         = wine.nom;
  document.getElementById('f-appellation').value = wine.appellation||'';
  document.getElementById('f-domaine').value     = wine.domaine||'';
  document.getElementById('f-region').value      = wine.region||'';
  document.getElementById('f-type').value        = wine.type;
  document.getElementById('f-format').value      = wine.format||'75cl';
  document.getElementById('f-annee').value       = wine.annee||'';
  document.getElementById('f-prix').value        = wine.prix||'';
  document.getElementById('f-note').value        = wine.note||'';
  document.getElementById('f-notes').value       = wine.notes||'';
  const accordsField = document.getElementById('f-accords'); if(accordsField) accordsField.value = wine.accords||'';
  const imgField = document.getElementById('f-image'); if(imgField) imgField.value = wine.image||'';
  document.getElementById('f-cave').value        = wine.cave;
  addingToSlot = {editing:String(id), cave:wine.cave, floor:wine.floor, slot:wine.slot};
  updateEtageSelect();
  document.getElementById('f-etage').value = wine.floor;
  updateSlotSelect();
  document.getElementById('f-slot').value  = wine.slot;
  showNotif('Mode √©dition ‚Äî modifiez puis validez');
}

function removeWine(id) {
  const wine = wineData.find(w=>String(w.id)===String(id));
  if(!wine) return;
  openHistoriqueModal(wine);
}

function openHistoriqueModal(wine) {
  const mo = document.getElementById('modalHistorique');
  document.getElementById('histo-wine-name').textContent = (wine.nom||'') + (wine.annee?' '+wine.annee:'');
  document.getElementById('histo-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('histo-note').value = wine.note || '';
  document.getElementById('histo-commentaire').value = '';
  document.getElementById('histo-occasion').value = '';
  mo._wine = wine;
  mo.classList.add('open');
}

function confirmRetirer(saveToHisto) {
  const mo = document.getElementById('modalHistorique');
  const wine = mo._wine;
  if(!wine) return;

  if(saveToHisto) {
    const entry = {
      id:           'h_' + Date.now(),
      date:         document.getElementById('histo-date').value,
      nom:          wine.nom || '',
      appellation:  wine.appellation || '',
      domaine:      wine.domaine || '',
      region:       wine.region || '',
      annee:        wine.annee || '',
      type:         wine.type || '',
      note:         document.getElementById('histo-note').value,
      commentaire:  document.getElementById('histo-commentaire').value,
      occasion:     document.getElementById('histo-occasion').value,
      image:        wine.image || ''
    };
    historiqueData.unshift(entry);
    saveHistoriqueToSheets(entry);
    showNotif('D√©gustation enregistr√©e ‚úì');
  }

  mo.classList.remove('open');
  wineData = wineData.filter(w=>String(w.id)!==String(wine.id));
  saveData();
  closeModal('modalSlot');
  renderCave2D();
  renderList();
  renderHistorique();
  if(!saveToHisto) showNotif('Vin retir√© ‚úì');
}

// =====================================================================
// FORM
// =====================================================================
function updateFormSelects() { updateEtageSelect(); }

function updateEtageSelect() {
  const cave = parseInt(document.getElementById('f-cave').value)||1;
  const sel  = document.getElementById('f-etage');
  sel.innerHTML = '';
  CAVE_CONFIG[cave].floors.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f.id;
    opt.textContent = f.label + (f.isMagnum?' ¬∑ Magnums':'');
    sel.appendChild(opt);
  });
  sel.onchange = updateSlotSelect;
  updateSlotSelect();
}

function updateSlotSelect() {
  const cave      = parseInt(document.getElementById('f-cave').value)||1;
  const floor     = parseInt(document.getElementById('f-etage').value)||1;
  const floorData = CAVE_CONFIG[cave].floors.find(f=>f.id===floor);
  if(!floorData) return;
  const sel = document.getElementById('f-slot');
  sel.innerHTML = '';
  for(let i=1; i<=floorData.slots; i++) {
    const taken     = getWineAtSlot(cave,floor,i);
    const editingId = addingToSlot?.editing;
    const isSelf    = editingId && String(taken?.id)===String(editingId);
    if(taken && !isSelf) continue;
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `Emplacement ${i}`;
    sel.appendChild(opt);
  }
  if(sel.options.length===0) {
    const opt = document.createElement('option');
    opt.value=''; opt.textContent='‚Äî √âtage complet ‚Äî';
    sel.appendChild(opt);
  }
}

function addWine() {
  const nom   = document.getElementById('f-nom').value.trim();
  const cave  = document.getElementById('f-cave').value;
  const floor = document.getElementById('f-etage').value;
  const slot  = document.getElementById('f-slot').value;
  if(!nom)  { showNotif('Le nom est requis', true); return; }
  if(!slot) { showNotif('Aucun emplacement disponible', true); return; }
  const editingId = addingToSlot?.editing;
  if(editingId) wineData = wineData.filter(w=>String(w.id)!==String(editingId));
  wineData.push({
    id: editingId || Date.now().toString(),
    nom,
    appellation: document.getElementById('f-appellation').value.trim(),
    domaine:     document.getElementById('f-domaine').value.trim(),
    region:      document.getElementById('f-region').value.trim(),
    type:        document.getElementById('f-type').value,
    format:      document.getElementById('f-format').value,
    annee:       document.getElementById('f-annee').value,
    prix:        document.getElementById('f-prix').value,
    note:        document.getElementById('f-note').value,
    notes:       document.getElementById('f-notes').value.trim(),
    accords:     document.getElementById('f-accords') ? document.getElementById('f-accords').value.trim() : '',
    image:       document.getElementById('f-image') ? document.getElementById('f-image').value.trim() : '',
    cave:  parseInt(cave), floor: parseInt(floor), slot: parseInt(slot),
    dateAjout: new Date().toISOString().split('T')[0]
  });
  saveData(); addingToSlot = null;
  ['f-nom','f-appellation','f-domaine','f-region','f-annee','f-prix','f-notes','f-image','f-accords'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=''});
  document.getElementById('f-note').value='';
  document.getElementById('f-type').value='rouge';
  document.getElementById('f-format').value='75cl';
  renderCave2D();
  showNotif('Vin ajout√© avec succ√®s ‚úì');
}

// =====================================================================
// LIST
// =====================================================================
function renderList() {
  const q    = document.getElementById('searchInput').value.toLowerCase();
  const cave = document.getElementById('filterCave').value;
  const type = document.getElementById('filterType').value;
  const sort = document.getElementById('sortBy').value;
  let wines  = wineData.filter(w => {
    if(cave && w.cave!=cave) return false;
    if(type && w.type!==type) return false;
    if(q && !([w.nom,w.appellation,w.region,w.domaine].join(' ').toLowerCase().includes(q))) return false;
    return true;
  });
  wines.sort((a,b) => {
    if(sort==='annee')       return (b.annee||0)-(a.annee||0);
    if(sort==='prix')        return (b.prix||0)-(a.prix||0);
    if(sort==='type')        return a.type.localeCompare(b.type);
    if(sort==='appellation') return (a.appellation||'').localeCompare(b.appellation||'');
    if(sort==='region')      return (a.region||'').localeCompare(b.region||'');
    if(sort==='domaine')     return (a.domaine||'').localeCompare(b.domaine||'');
    return a.nom.localeCompare(b.nom);
  });
  const cont = document.getElementById('listContainer');
  if(wines.length===0) {
    cont.innerHTML=`<div class="empty-state">Aucun vin ¬∑ <a href="#" onclick="document.querySelectorAll('.tab')[3].click()" style="color:var(--gold);text-decoration:none">Ajouter</a></div>`;
    return;
  }
  let html=`<table class="wine-table"><thead><tr>
    <th>Nom</th><th>Appellation</th><th>Domaine / Producteur</th><th>Type</th><th>Format</th><th>Mill√©sime</th><th>R√©gion</th><th>Cave</th><th>Position</th><th>Prix</th><th></th>
  </tr></thead><tbody>`;
  wines.forEach(w => {
    const tLabel = TYPE_LABELS[w.type]||w.type;
    const fLabel = FORMAT_LABELS[w.format]||(w.format||'75 cl');
    html += `<tr onclick="openSlotModal(${w.cave},${w.floor},${w.slot})" title="Voir">
      <td><b style="color:var(--cream)">${w.nom||'‚Äî'}</b></td>
      <td style="color:var(--text2);font-style:italic">${w.appellation||'‚Äî'}</td>
      <td style="color:var(--text2)">${w.domaine||'‚Äî'}</td>
      <td><span class="type-badge badge-${w.type}">${tLabel}</span></td>
      <td><span class="format-badge">${fLabel}</span></td>
      <td>${w.annee||'‚Äî'}</td>
      <td>${w.region||'‚Äî'}</td>
      <td>Cave ${w.cave}</td>
      <td style="white-space:nowrap">√ât.${w.floor} #${w.slot}</td>
      <td>${w.prix?w.prix+'‚Ç¨':'‚Äî'}</td>
      <td><button class="btn-danger" style="padding:4px 9px;font-size:0.78rem" onclick="event.stopPropagation();removeWine('${w.id}')">‚úï</button></td>
    </tr>`;
  });
  html += '</tbody></table>';
  cont.innerHTML = html;
}

// =====================================================================
// STATS
// =====================================================================
function renderStats() {
  const total   = wineData.length;
  const val     = wineData.reduce((s,w)=>s+(parseFloat(w.prix)||0),0);
  const avgPrix = total ? Math.round(val/total) : 0;
  const types   = {}; wineData.forEach(w=>{ const t=w.type||'autre'; types[t]=(types[t]||0)+1; });
  const decades = {}; wineData.forEach(w=>{ if(w.annee){ const d=Math.floor(w.annee/10)*10; decades[d]=(decades[d]||0)+1; }});
  const regions = {}; wineData.forEach(w=>{ if(w.region){ regions[w.region]=(regions[w.region]||0)+1; }});
  const appells = {}; wineData.forEach(w=>{ if(w.appellation){ appells[w.appellation]=(appells[w.appellation]||0)+1; }});
  const cap1    = CAVE_CONFIG[1].floors.reduce((s,f)=>s+f.slots,0);
  const cap2    = CAVE_CONFIG[2].floors.reduce((s,f)=>s+f.slots,0);
  const occ1    = wineData.filter(w=>w.cave==1).length;
  const occ2    = wineData.filter(w=>w.cave==2).length;

  // Stat cards
  document.getElementById('statsGrid').innerHTML=`
    <div class="stat-card"><div class="s-val">${total}</div><div class="s-lbl">Bouteilles total</div></div>
    <div class="stat-card"><div class="s-val" style="color:var(--green2)">${Math.round(val).toLocaleString('fr-FR')} ‚Ç¨</div><div class="s-lbl">Valeur estim√©e</div></div>
    <div class="stat-card"><div class="s-val">${avgPrix} ‚Ç¨</div><div class="s-lbl">Prix moyen / bouteille</div></div>
    <div class="stat-card"><div class="s-val">${occ1+occ2}/${cap1+cap2}</div><div class="s-lbl">Taux remplissage global</div></div>`;

  // Helper pour g√©n√©rer les barres
  function makeBarChart(elId, data, colorFn, limit=15) {
    const sorted = Object.entries(data).sort((a,b)=>b[1]-a[1]).slice(0,limit);
    const maxV = Math.max(1,...sorted.map(e=>e[1]));
    document.getElementById(elId).innerHTML = sorted.length
      ? sorted.map(([k,v])=>`
        <div class="bar-row">
          <div class="bar-label" title="${k}">${k.length>14?k.slice(0,13)+'‚Ä¶':k}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${v/maxV*100}%;${colorFn(k)}"></div></div>
          <div class="bar-count">${v}</div>
        </div>`).join('')
      : '<div style="color:var(--text2);font-style:italic;padding:10px">Aucune donn√©e</div>';
  }

  // Type
  const typeOrder = ['rouge','blanc','ros√©','effervescent','vdn','magnum'];
  const typeNames = {rouge:'Rouge',blanc:'Blanc','ros√©':'Ros√©',effervescent:'Effervescent',vdn:'VDN',magnum:'Magnum'};
  const typeColors = {rouge:'background:linear-gradient(90deg,#5a1020,#9e2a3f)',blanc:'background:linear-gradient(90deg,#7a5a10,#c9a84c)','ros√©':'background:linear-gradient(90deg,#8a3050,#c06080)',effervescent:'background:linear-gradient(90deg,#204060,#5090c0)',vdn:'background:linear-gradient(90deg,#502080,#9040c0)',magnum:'background:linear-gradient(90deg,#4a2870,#9060c0)'};
  const maxT = Math.max(1,...Object.values(types));
  document.getElementById('chartType').innerHTML = typeOrder.map(t=>`
    <div class="bar-row">
      <div class="bar-label">${typeNames[t]||t}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${((types[t]||0)/maxT*100)}%;${typeColors[t]||'background:var(--wine)'}"></div></div>
      <div class="bar-count">${types[t]||0}</div>
    </div>`).join('');

  // Mill√©sime
  const decKeys = Object.keys(decades).sort();
  const maxD = Math.max(1,...Object.values(decades));
  document.getElementById('chartDecade').innerHTML = decKeys.length
    ? decKeys.map(d=>`
      <div class="bar-row">
        <div class="bar-label">${d}s</div>
        <div class="bar-track"><div class="bar-fill" style="width:${decades[d]/maxD*100}%;background:linear-gradient(90deg,#3a1828,#9e2a3f)"></div></div>
        <div class="bar-count">${decades[d]}</div>
      </div>`).join('')
    : '<div style="color:var(--text2);font-style:italic;padding:10px">Aucune ann√©e renseign√©e</div>';

  // R√©gion
  makeBarChart('chartRegion', regions, ()=>'background:linear-gradient(90deg,#1a3a2a,#2d7a4e)');

  // Appellation (top 15)
  makeBarChart('chartAppellation', appells, ()=>'background:linear-gradient(90deg,#2a1a3a,#6040a0)', 15);

  // Caves occupation
  document.getElementById('chartCaves').innerHTML = [
    {label:'Cave 1', occ:occ1, cap:cap1, color:'#9e2a3f'},
    {label:'Cave 2', occ:occ2, cap:cap2, color:'#c9a84c'}
  ].map(c=>{
    const pct = Math.round(c.occ/c.cap*100)||0;
    return `<div style="text-align:center;min-width:160px">
      <div style="position:relative;width:120px;height:120px;margin:0 auto">
        <svg viewBox="0 0 36 36" style="width:120px;height:120px;transform:rotate(-90deg)">
          <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--bg3)" stroke-width="3"/>
          <circle cx="18" cy="18" r="15.9" fill="none" stroke="${c.color}" stroke-width="3"
            stroke-dasharray="${pct} ${100-pct}" stroke-dashoffset="0" stroke-linecap="round"/>
        </svg>
        <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">
          <div style="font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--cream)">${pct}%</div>
          <div style="font-size:0.7rem;color:var(--text2)">${c.occ}/${c.cap}</div>
        </div>
      </div>
      <div style="margin-top:10px;color:var(--text2);font-size:0.85rem;letter-spacing:1px">${c.label}</div>
    </div>`;
  }).join('');
}

// =====================================================================
// NOTIF
// =====================================================================
function showNotif(msg, error=false) {
  const n = document.getElementById('notif');
  n.textContent = msg;
  n.className = 'show'+(error?' error':'');
  setTimeout(()=>n.className='', 3000);
}


// =====================================================================
// PASSWORD
// =====================================================================
async function checkPwd() {
  const val = document.getElementById('pwd-input').value.trim();
  if(!val) return;

  // Hasher ce que l'utilisateur a tap√© avec SHA-256
  const encoder = new TextEncoder();
  const data = encoder.encode(val);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

  // R√©cup√©rer le hash stock√© dans le Google Sheet
  const cbName = 'configCallback_' + Date.now();
  const timeout = setTimeout(() => {
    delete window[cbName];
    const s = document.getElementById('config-script');
    if(s) s.remove();
    showLoginError();
  }, 8000);

  window[cbName] = function(config) {
    clearTimeout(timeout);
    delete window[cbName];
    const s = document.getElementById('config-script');
    if(s) s.remove();
    const storedHash = config.password_hash || '';
    if(hashHex === storedHash) {
      sessionStorage.setItem('cave_auth', '1');
      document.getElementById('pwd-screen').classList.add('hidden');
      loadFromSheets();
    } else {
      showLoginError();
    }
  };

  const script = document.createElement('script');
  script.id = 'config-script';
  script.src = SCRIPT_URL + '?action=getConfig&callback=' + cbName + '&t=' + Date.now();
  document.body.appendChild(script);
}

function showLoginError() {
  const inp = document.getElementById('pwd-input');
  inp.classList.add('error');
  document.getElementById('pwd-error').textContent = 'Mot de passe incorrect';
  setTimeout(() => { inp.classList.remove('error'); inp.value = ''; }, 800);
}

function initAuth() {
  if(sessionStorage.getItem('cave_auth') === '1') {
    document.getElementById('pwd-screen').classList.add('hidden');
  }
  // Sinon l'√©cran mot de passe reste visible
}

// =====================================================================
// INIT
// =====================================================================
window.addEventListener('load', () => {
  updateHeader();
  updateEtageSelect();
  renderCave2D();
  initAuth();
  if(sessionStorage.getItem('cave_auth') === '1') {
    loadFromSheets();
  }
});

// =====================================================================
// VIVINO IMAGE SEARCH
// =====================================================================
function searchVivino() {
  const nom     = (document.getElementById('f-nom')?.value     || '').trim();
  const domaine = (document.getElementById('f-domaine')?.value || '').trim();
  const annee   = (document.getElementById('f-annee')?.value   || '').trim();
  if(!nom && !domaine) { showNotif('Entrez le nom du vin ou le producteur', true); return; }
  const queryStr = [domaine, nom, annee].filter(Boolean).join(' ');
  const query = encodeURIComponent(queryStr);
  const vivinoUrl = 'https://www.vivino.com/search/wines?q=' + query;
  const resultsBox = document.getElementById('vivino-results');
  const gridEl     = document.getElementById('vivino-grid');
  resultsBox.style.display = 'block';
  gridEl.innerHTML = `<div style="color:var(--text2);font-size:0.88rem;line-height:2">
    <a href="${vivinoUrl}" target="_blank" rel="noopener" style="display:inline-block;margin-bottom:12px;padding:8px 18px;background:var(--wine);color:var(--cream);text-decoration:none;border-radius:2px;font-size:0.95rem;letter-spacing:1px">üçá Ouvrir Vivino ‚Äî ${queryStr}</a><br>
    <span style="color:var(--cream)">1.</span> Cliquez le lien ci-dessus<br>
    <span style="color:var(--cream)">2.</span> Cliquez sur le vin voulu sur Vivino<br>
    <span style="color:var(--cream)">3.</span> Clic droit sur l'√©tiquette ‚Üí <i>Copier l'adresse de l'image</i><br>
    <span style="color:var(--cream)">4.</span> Collez l'URL dans le champ ci-dessus
  </div>`;
}


// =====================================================================
// HISTORIQUE
// =====================================================================
let historiqueData = [];

function saveHistoriqueToSheets(entry) {
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'saveHistorique', data: entry })
  }).catch(e => console.warn('Sync historique √©chou√©e', e));
}

function loadHistoriqueFromSheets() {
  const cbName = 'histoCallback_' + Date.now();
  const timeout = setTimeout(() => { delete window[cbName]; }, 8000);
  window[cbName] = function(data) {
    clearTimeout(timeout);
    delete window[cbName];
    if(Array.isArray(data)) {
      historiqueData = data.map(h => ({...h}));
      renderHistorique();
    }
  };
  const script = document.createElement('script');
  script.src = SCRIPT_URL + '?sheet=Historique&callback=' + cbName + '&t=' + Date.now();
  document.body.appendChild(script);
}

function renderHistorique() {
  const container = document.getElementById('histo-list');
  const empty     = document.getElementById('histo-empty');
  const count     = document.getElementById('histo-count');
  if(!container) return;
  if(!historiqueData.length) {
    empty.style.display = 'block';
    container.innerHTML = '';
    count.textContent = '';
    return;
  }
  empty.style.display = 'none';
  count.textContent = historiqueData.length + ' bouteille' + (historiqueData.length>1?'s':'') + ' bue' + (historiqueData.length>1?'s':'');

  const TYPE_COLORS = { rouge:'#7b1c2e', blanc:'#c9a84c', rose:'#d4607a', champagne:'#e8c870', other:'#555' };

  container.innerHTML = historiqueData.map((h,i) => {
    const stars  = '‚òÖ'.repeat(parseInt(h.note)||0) + '‚òÜ'.repeat(5-(parseInt(h.note)||0));
    const tColor = TYPE_COLORS[h.type] || TYPE_COLORS.other;
    const imgHtml = h.image ? `<img src="${h.image}" alt="" style="width:50px;height:70px;object-fit:contain;border-radius:3px;flex-shrink:0;border:1px solid var(--border)">` : `<div style="width:50px;height:70px;background:var(--bg3);border-radius:3px;flex-shrink:0;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;color:var(--text2);font-size:1.4rem">üç∑</div>`;
    return `<div style="display:flex;gap:16px;align-items:flex-start;padding:16px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;margin-bottom:10px">
      ${imgHtml}
      <div style="flex:1;min-width:0">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px">
          <div>
            <div style="font-family:'Playfair Display',serif;font-size:1.05rem;color:var(--cream)">${h.nom||'‚Äî'}${h.annee?' <span style="color:var(--text2);font-size:0.9rem">'+h.annee+'</span>':''}</div>
            <div style="font-size:0.82rem;color:var(--text2);margin-top:2px">${[h.domaine,h.appellation,h.region].filter(Boolean).join(' ¬∑ ')}</div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-size:0.75rem;color:var(--text2)">${h.date||''}</div>
            <div style="color:var(--gold);font-size:0.9rem;margin-top:2px">${stars}</div>
          </div>
        </div>
        ${h.occasion?`<div style="margin-top:6px;font-size:0.8rem;color:var(--text2);font-style:italic">üìç ${h.occasion}</div>`:''}
        ${h.commentaire?`<div style="margin-top:6px;font-size:0.88rem;color:var(--text2);line-height:1.5;font-style:italic">"${h.commentaire}"</div>`:''}
      </div>
    </div>`;
  }).join('');
}


// =====================================================================
// ACCORDS METS-VINS
// =====================================================================

// Accords automatiques par type de vin
const ACCORDS_AUTO = {
  rouge: {
    plats: ['Agneau r√¥ti','Boeuf bourguignon','Magret de canard','C√¥te de boeuf','Gibier','Fromages affin√©s','Charcuterie','Cassoulet','Tajine d'agneau','Entrec√¥te grill√©e'],
    mots:  ['agneau','boeuf','canard','gibier','viande rouge','fromage','charcuterie','cassoulet','entrec√¥te','magret','cochon','porc r√¥ti']
  },
  blanc: {
    plats: ['Poisson grill√©','Fruits de mer','Saumon','Saint-Jacques','Volaille en sauce','Risotto','Ch√®vre frais','Asperges','Hu√Ætres','Sole meuni√®re'],
    mots:  ['poisson','saumon','sole','bar','dorade','fruits de mer','coquille','homard','crabe','volaille','poulet','veau','asperge','hu√Ætre']
  },
  'ros√©': {
    plats: ['Grillades','Salade ni√ßoise','Pizza','Charcuterie','Ratatouille','Pissaladi√®re','Bouillabaisse','Brochettes','Tapenade'],
    mots:  ['grillades','salade','pizza','charcuterie','ratatouille','brochette','barbecue','tapas','m√©diterran√©en']
  },
  effervescent: {
    plats: ['Ap√©ritif','Hu√Ætres','Sushi','Caviar','Saumon fum√©','Risotto aux champignons','Desserts l√©gers','Macarons'],
    mots:  ['ap√©ritif','hu√Ætre','sushi','caviar','saumon fum√©','risotto','champignon','dessert','macaron','f√™te']
  },
  vdn: {
    plats: ['Foie gras','Desserts au chocolat','Roquefort','Tarte tatin','G√¢teau au chocolat','Cr√®me br√ªl√©e'],
    mots:  ['foie gras','chocolat','roquefort','dessert','tarte','g√¢teau','cr√®me','sucr√©']
  },
  magnum: {
    plats: ['Grandes occasions','Repas de f√™te','Viandes r√¥ties','Fromages vari√©s'],
    mots:  ['f√™te','occasion','repas','viande','fromage']
  }
};

function populateVinSelect() {
  const sel = document.getElementById('accord-vin-select');
  if(!sel) return;
  const current = sel.value;
  sel.innerHTML = '<option value="">‚Äî Choisir un vin ‚Äî</option>';
  [...wineData].sort((a,b)=>(a.nom||'').localeCompare(b.nom||'')).forEach(w => {
    const opt = document.createElement('option');
    opt.value = w.id;
    opt.textContent = (w.nom||'Sans nom') + (w.annee?' '+w.annee:'') + (w.domaine?' ‚Äî '+w.domaine:'');
    sel.appendChild(opt);
  });
  if(current) sel.value = current;
}

function rechercherParPlat() {
  const query = document.getElementById('accord-plat-input').value.trim().toLowerCase();
  const results = document.getElementById('accord-plat-results');
  if(!query) { results.innerHTML = ''; return; }

  // Chercher dans les accords manuels + suggestions auto
  const matches = wineData.filter(w => {
    // Accord manuel saisi sur le vin
    if(w.accords && w.accords.toLowerCase().includes(query)) return true;
    // Accord automatique par type
    const auto = ACCORDS_AUTO[w.type];
    if(auto && auto.mots.some(m => query.includes(m) || m.includes(query))) return true;
    return false;
  });

  if(!matches.length) {
    results.innerHTML = '<div style="color:var(--text2);font-style:italic;padding:10px 0">Aucun vin trouv√© pour ce plat dans votre cave</div>';
    return;
  }

  results.innerHTML = '<div style="font-size:0.78rem;color:var(--text2);margin-bottom:10px;letter-spacing:1px">' + matches.length + ' VIN' + (matches.length>1?'S':'') + ' SUGG√âR√â' + (matches.length>1?'S':'') + '</div>' +
    matches.map(w => wineCardHtml(w)).join('');
}

function rechercherParVin(id) {
  const results = document.getElementById('accord-vin-results');
  if(!id) { results.innerHTML = ''; return; }
  const wine = wineData.find(w=>String(w.id)===String(id));
  if(!wine) return;

  const auto   = ACCORDS_AUTO[wine.type] || ACCORDS_AUTO.rouge;
  const plats  = wine.accords
    ? [...new Set([...wine.accords.split(',').map(s=>s.trim()), ...auto.plats])]
    : auto.plats;

  results.innerHTML = `
    <div style="font-size:0.78rem;color:var(--text2);margin-bottom:10px;letter-spacing:1px">ACCORDS SUGG√âR√âS</div>
    <div style="display:flex;flex-wrap:wrap;gap:8px">
      ${plats.map(p=>`<span style="padding:5px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:20px;font-size:0.85rem;color:var(--cream)">üçΩ ${p}</span>`).join('')}
    </div>`;
}

function wineCardHtml(w) {
  const tLabel = {rouge:'Rouge',blanc:'Blanc','ros√©':'Ros√©',effervescent:'Effervescent',vdn:'VDN',magnum:'Magnum'}[w.type] || w.type;
  return `<div style="display:flex;gap:12px;align-items:center;padding:10px;background:var(--bg3);border-radius:3px;margin-bottom:8px;border:1px solid var(--border)">
    ${w.image?`<img src="${w.image}" style="width:36px;height:50px;object-fit:contain;border-radius:2px;flex-shrink:0">`:'<div style="width:36px;height:50px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0">üç∑</div>'}
    <div style="flex:1;min-width:0">
      <div style="color:var(--cream);font-size:0.95rem">${w.nom||'‚Äî'}${w.annee?' <span style="color:var(--text2);font-size:0.8rem">'+w.annee+'</span>':''}</div>
      <div style="color:var(--text2);font-size:0.78rem;margin-top:2px">${[w.domaine,w.region].filter(Boolean).join(' ¬∑ ')}</div>
      ${w.accords?`<div style="color:var(--gold2);font-size:0.75rem;margin-top:3px">üçΩ ${w.accords}</div>`:''}
    </div>
    <span style="padding:2px 8px;border-radius:10px;font-size:0.7rem;background:var(--wine);color:var(--cream);flex-shrink:0">${tLabel}</span>
  </div>`;
}

</script>
</body>
</html>
